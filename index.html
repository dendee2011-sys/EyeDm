<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM v35 - Enterprise Stable</title>
    
    <!-- 1. Assets (Lightweight) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 2. React Core (Production Build for Performance) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 3. Firebase (Compat v9 - Stable) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 4. Utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Lodash for Debounce -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; }
        .loader { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Pagination Styles */
        .page-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: all 0.2s; }
        .page-btn:hover:not(:disabled) { background: #eff6ff; color: #3b82f6; border-color: #3b82f6; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-active { background: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Critical Error Trap -->
    <script>
        window.onerror = function(msg, url, line) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = "position:fixed;top:0;left:0;width:100%;padding:20px;background:#fee2e2;color:#991b1b;z-index:9999;text-align:center;font-family:sans-serif;box-shadow:0 4px 12px rgba(0,0,0,0.1);";
            errDiv.innerHTML = `<strong>⚠️ ระบบหยุดทำงาน:</strong> ${msg} (บรรทัด ${line}) <button onclick="location.reload()" style="margin-left:10px;padding:5px 15px;background:white;border:1px solid #991b1b;border-radius:4px;cursor:pointer;font-weight:bold;color:#991b1b;">รีโหลดใหม่</button>`;
            document.body.appendChild(errDiv);
        };
    </script>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };
        
        try { if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // VERSION 35 ID
        const APP_ID = "sisaket_prod_v1855_stable"; 
        const COL_QUEUE = "dr_queue";   
        const COL_MASTER = "dr_master"; 
        const ADMIN_CODE = "10700";

        // Optimized Icon
        const Icon = React.memo(({name, size=18, className}) => {
            React.useEffect(()=>{if(window.lucide)window.lucide.createIcons()},[name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        });

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="h-screen flex flex-col items-center justify-center bg-slate-50 p-4 text-center"><h2 className="text-xl font-bold text-slate-800 mb-2">ระบบทำงานผิดพลาดชั่วคราว</h2><button onClick={()=>window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold">รีโหลดหน้าจอ</button></div>;
                return this.props.children;
            }
        }

        // --- AUTH SCREEN ---
        const AuthScreen = () => {
            const [pin, setPin] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); 
                if(loading) return;
                setLoading(true);
                try { await auth.signInWithEmailAndPassword(pin+"@sisaket-clinic.org", password); }
                catch(e) { 
                    if(e.code==='auth/user-not-found') {
                        try{await auth.createUserWithEmailAndPassword(pin+"@sisaket-clinic.org",password);}catch(e2){alert("ลงทะเบียนไม่สำเร็จ: "+e2.message);}
                    } else alert("รหัสไม่ถูกต้อง");
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-md shadow-xl border border-slate-200 text-center animate__animated animate__fadeIn">
                        <div className="w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-600 shadow-sm"><Icon name="shield-check" size={32}/></div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-1">EyeDM <span className="text-brand-600">v35</span></h1>
                        <p className="text-slate-400 mb-6 text-sm font-medium">Enterprise Stability Edition</p>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input className="w-full p-3 border border-slate-300 rounded-xl text-center text-lg tracking-widest font-mono focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition" placeholder="xxxxx" value={pin} onChange={e=>setPin(e.target.value.replace(/\D/g,'').slice(0,5))} required autoFocus disabled={loading}/>
                            <input className="w-full p-3 border border-slate-300 rounded-xl text-center focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition" type="password" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} required disabled={loading}/>
                            <button disabled={loading} className="w-full bg-brand-600 hover:bg-brand-700 text-white py-3.5 rounded-xl font-bold transition shadow-lg disabled:opacity-70 flex justify-center items-center gap-2">
                                {loading ? <><div className="loader"></div> กำลังโหลด...</> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('PCU');
            const [view, setView] = React.useState('dashboard');
            const [allData, setAllData] = React.useState([]); // Store ALL data in memory
            const [editData, setEditData] = React.useState(null);
            
            React.useEffect(() => auth.onAuthStateChanged(setUser), []);
            
            // 1. FETCH ALL DATA ONCE (Then handle in memory to avoid frequent re-renders/fetches)
            React.useEffect(() => {
                if(!user) return;
                
                // Limit initial fetch to 2000 to be safe, or remove limit if comfortable
                const q = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).orderBy('createdAt', 'desc').limit(2000);
                
                const unsub = q.onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => {
                        const d = doc.data();
                        const createdAt = d.createdAt?.toDate ? d.data().createdAt.toDate() : new Date();
                        return { id: doc.id, ...d, createdAt };
                    });
                    setAllData(data);
                    // Defer icon rendering
                    setTimeout(() => window.lucide && window.lucide.createIcons(), 100);
                }, err => console.error("Data Fetch Error:", err));
                
                return () => unsub();
            }, [user]);

            const handleSend = async (id, name) => { if(confirm(`ยืนยันส่งตัว: ${name}?`)) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).update({status:'Waiting', sentAt:firebase.firestore.FieldValue.serverTimestamp()}); };
            const handleDel = async (id) => { if(confirm('ยืนยันลบรายการนี้?')) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).delete(); };

            if(!user) return <AuthScreen/>;
            const isAdmin = user.email.startsWith(ADMIN_CODE);
            const Theme = role==='PCU' ? 'teal' : 'brand';

            return (
                <div className="min-h-screen flex flex-col font-sans text-slate-800 bg-slate-50">
                    {/* Navbar */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-xl text-white bg-${Theme}-600 shadow-md`}><Icon name={role==='PCU'?'home':'building-2'} size={20}/></div>
                                    <div><h1 className="font-bold text-lg">EyeDM <span className={`text-${Theme}-600`}>{role}</span></h1><p className="text-xs text-slate-400 font-mono">{user.email.split('@')[0]}</p></div>
                                </div>
                                <div className="flex gap-2 items-center">
                                    {isAdmin && <button onClick={()=>setView('import')} className="hidden md:flex items-center gap-1 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200 transition"><Icon name="file-spreadsheet" size={14}/> Import</button>}
                                    <div className="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                        <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`px-3 py-1 rounded text-xs font-bold transition ${role==='PCU'?'bg-white shadow-sm text-teal-600':'text-slate-500 hover:text-slate-700'}`}>PCU</button>
                                        <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`px-3 py-1 rounded text-xs font-bold transition ${role==='HOSPITAL'?'bg-white shadow-sm text-brand-600':'text-slate-500 hover:text-slate-700'}`}>Hospital</button>
                                    </div>
                                    <button onClick={()=>auth.signOut()} className="p-2 text-slate-400 hover:text-red-500 transition"><Icon name="log-out" size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
                        {view==='dashboard' && <Dashboard role={role} allData={allData} onNew={()=>{setEditData(null);setView('form')}} onEdit={p=>{setEditData(p);setView('form')}} onDelete={handleDel} onSend={handleSend} Theme={Theme}/>}
                        {view==='form' && <UnifiedForm db={db} user={user} data={editData} role={role} onBack={()=>setView('dashboard')} Theme={Theme}/>}
                        {view==='import' && isAdmin && <ImportView db={db} onBack={()=>setView('dashboard')}/>}
                    </main>
                </div>
            );
        }

        // --- DASHBOARD (Optimized with Pagination) ---
        const Dashboard = ({ role, allData, onNew, onEdit, onDelete, onSend, Theme }) => {
            const [search, setSearch] = React.useState('');
            const [debouncedSearch, setDebouncedSearch] = React.useState('');
            const [tab, setTab] = React.useState('registry');
            
            // Pagination State
            const [currentPage, setCurrentPage] = React.useState(1);
            const itemsPerPage = 10; // Show only 10 items at a time -> Smooth as butter

            // Debounce Search Effect
            React.useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedSearch(search);
                    setCurrentPage(1); // Reset to page 1 on search
                }, 300);
                return () => clearTimeout(handler);
            }, [search]);

            // Filtering Logic
            const filteredData = React.useMemo(() => {
                return allData.filter(p => {
                    const txt = debouncedSearch.toLowerCase();
                    const match = (p.part1?.idCard||'').includes(txt) || (p.part1?.name||'').toLowerCase().includes(txt);
                    
                    if(!match) return false;
                    
                    if(role==='PCU') return tab==='registry' ? p.status==='Registered' : (p.status!=='Registered');
                    return p.status!=='Registered';
                });
            }, [allData, debouncedSearch, tab, role]);

            // Pagination Logic
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginatedData = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const StatCard = ({title, val, icon, color}) => (
                <div className="bg-white p-4 rounded-xl shadow-soft border border-slate-200 flex items-center justify-between">
                    <div><p className="text-slate-500 text-xs font-bold uppercase mb-1">{title}</p><h3 className="text-2xl font-bold text-slate-800">{val}</h3></div>
                    <div className={`p-3 rounded-lg bg-${color}-50 text-${color}-600`}><Icon name={icon} size={20}/></div>
                </div>
            );

            return (
                <div className="space-y-6 animate__animated animate__fadeIn">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <StatCard title="ทั้งหมด" val={allData.length} icon="database" color="slate"/>
                        <StatCard title="รอส่ง" val={allData.filter(p=>p.status==='Registered').length} icon="clock" color="gray"/>
                        <StatCard title="รอตรวจ" val={allData.filter(p=>p.status==='Waiting').length} icon="eye" color="brand"/>
                        <StatCard title="เสร็จสิ้น" val={allData.filter(p=>p.status==='Completed').length} icon="check-circle" color="teal"/>
                    </div>

                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-3 rounded-xl shadow-soft border border-slate-200">
                        {role==='PCU' ? (
                            <div className="flex bg-slate-100 p-1 rounded-lg w-full md:w-auto border border-slate-200">
                                <button onClick={()=>{setTab('registry');setCurrentPage(1)}} className={`flex-1 px-4 py-2 rounded-md text-sm font-bold transition ${tab==='registry'?'bg-white shadow-sm text-slate-800':'text-slate-500 hover:text-slate-700'}`}>ทะเบียน ({allData.filter(p=>p.status==='Registered').length})</button>
                                <button onClick={()=>{setTab('sent');setCurrentPage(1)}} className={`flex-1 px-4 py-2 rounded-md text-sm font-bold transition ${tab==='sent'?'bg-white shadow-sm text-teal-600':'text-slate-500 hover:text-slate-700'}`}>ส่งแล้ว ({allData.filter(p=>p.status!=='Registered').length})</button>
                            </div>
                        ) : <div className="px-3 font-bold text-brand-700 flex items-center gap-2"><Icon name="list" size={20}/> รายการรอตรวจ</div>}
                        
                        <div className="flex w-full md:w-auto gap-2">
                            <div className="relative flex-1 md:w-64"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={16}/><input className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none text-sm transition" placeholder="ค้นหา..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
                            {role==='PCU' && tab==='registry' && <button onClick={onNew} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow-sm font-bold flex items-center gap-2 text-sm whitespace-nowrap transition"><Icon name="plus" size={16}/> เพิ่ม</button>}
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-soft border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-100 text-slate-500 font-semibold border-b border-slate-200"><tr><th className="p-4 pl-6">วันที่</th><th className="p-4">ผู้ป่วย</th><th className="p-4">HbA1C</th><th className="p-4">สถานะ</th><th className="p-4 pr-6 text-right">จัดการ</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {paginatedData.map(p => (
                                        <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 pl-6 text-slate-400 text-xs font-mono">{p.createdAt.toLocaleDateString('th-TH', {day:'numeric',month:'short',year:'2-digit'})}</td>
                                            <td className="p-4"><div className="font-bold text-slate-700">{p.part1.name}</div><div className="text-slate-400 text-xs font-mono mt-0.5">{p.part1.idCard}</div></td>
                                            <td className="p-4"><span className={`px-2 py-0.5 rounded text-xs font-bold ${parseFloat(p.part1.hba1c)>=7?'bg-red-50 text-red-600 border border-red-200':'bg-slate-100 text-slate-600 border border-slate-200'}`}>{p.part1.hba1c||'-'}</span></td>
                                            <td className="p-4">{p.status==='Registered'?<span className="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-xs border border-slate-200">ลงทะเบียน</span>:p.status==='Waiting'?<span className="px-2 py-0.5 bg-yellow-50 text-yellow-700 rounded text-xs border border-yellow-200">รอตรวจ</span>:<span className="px-2 py-0.5 bg-teal-50 text-teal-700 rounded text-xs border border-teal-200">เสร็จสิ้น</span>}</td>
                                            <td className="p-4 pr-6 text-right flex justify-end gap-2">
                                                {role==='PCU' && p.status==='Registered' && <button onClick={()=>onSend(p.id, p.part1.name)} className="px-3 py-1 bg-teal-600 hover:bg-teal-700 text-white rounded shadow text-xs font-bold transition">ส่ง</button>}
                                                <button onClick={()=>onEdit(p)} className="p-1.5 border border-slate-200 rounded text-slate-400 hover:text-brand-600 hover:border-brand-200 hover:bg-white transition"><Icon name="pencil" size={14}/></button>
                                                <button onClick={()=>onDelete(p.id)} className="p-1.5 border border-slate-200 rounded text-slate-400 hover:text-red-600 hover:border-red-200 hover:bg-red-50 transition"><Icon name="trash-2" size={14}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {paginatedData.length===0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400">ไม่พบข้อมูล</td></tr>}
                                </tbody>
                            </table>
                        </div>
                        
                        {/* Pagination Controls */}
                        {totalPages > 1 && (
                            <div className="p-3 border-t border-slate-200 bg-slate-50 flex justify-center items-center gap-2">
                                <button onClick={()=>setCurrentPage(c=>Math.max(1,c-1))} disabled={currentPage===1} className="page-btn"><Icon name="chevron-left" size={16}/></button>
                                <span className="text-xs font-bold text-slate-500">หน้า {currentPage} / {totalPages}</span>
                                <button onClick={()=>setCurrentPage(c=>Math.min(totalPages,c+1))} disabled={currentPage===totalPages} className="page-btn"><Icon name="chevron-right" size={16}/></button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- UNIFIED FORM ---
        const UnifiedForm = ({ db, user, data, role, onBack, Theme }) => {
            const isEdit = !!data;
            const isHospital = role === 'HOSPITAL';
            const [p1, setP1] = React.useState(data?.part1 || { idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [p2, setP2] = React.useState(data?.part2 || { cataract:'No', retinaFound:'Yes' });
            const [findings, setFindings] = React.useState(data?.findings || { Normal:{L:false,R:false} });
            const [saving, setSaving] = React.useState(false);
            const [suggestions, setSugg] = React.useState([]);

            const handleId = async (e) => {
                const v = e.target.value; setP1({...p1, idCard:v});
                if(!isEdit && !isHospital && v.length>=3) {
                    try { const s = await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).where(firebase.firestore.FieldPath.documentId(),'>=',v).where(firebase.firestore.FieldPath.documentId(),'<=',v+'\uf8ff').limit(5).get(); setSugg(s.docs.map(d=>({idCard:d.id, ...d.data()}))); } catch(e){}
                } else setSugg([]);
            };
            const save = async () => {
                setSaving(true);
                try {
                    const timeout = new Promise((_, r) => setTimeout(() => r(new Error("Server Timeout")), 5000));
                    await Promise.race([(async()=>{
                        if(isHospital) { await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(data.id).update({ part2:p2, findings, status:'Completed', doctorName:user.email }); }
                        else {
                            if(!p1.idCard || p1.idCard.length!==13) throw new Error("เลขบัตรไม่ถูกต้อง");
                            await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(p1.idCard).set(p1, {merge:true});
                            if(!isEdit) {
                                const d = new Date().toDateString();
                                const q = await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).where('part1.idCard','==',p1.idCard).get();
                                if(q.docs.some(x=>(x.data().createdAt?.toDate?x.data().createdAt.toDate():new Date(x.data().createdAt)).toDateString()===d)) throw new Error("ซ้ำวันนี้");
                            }
                            const pl = { part1:p1, pcuId:user.uid, updatedAt:firebase.firestore.FieldValue.serverTimestamp() };
                            if(isEdit) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(data.id).update(pl);
                            else { pl.status='Registered'; pl.createdAt=firebase.firestore.FieldValue.serverTimestamp(); await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).add(pl); }
                        }
                    })(), timeout]);
                    onBack();
                } catch(e) { alert("Error: "+e.message); } finally { setSaving(false); }
            };

            return (
                <div className={`max-w-6xl mx-auto animate__animated animate__zoomIn ${isHospital?'flex flex-col lg:flex-row gap-6 items-start':''}`}>
                    <div className={`${isHospital?'w-full lg:w-1/3 sticky-sidebar':'w-full max-w-3xl mx-auto'}`}>
                         <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="user" size={18}/> ข้อมูลผู้ป่วย</h3>
                                {!isHospital && <button onClick={onBack}><Icon name="x" className="text-slate-400"/></button>}
                            </div>
                            <div className={`p-6 space-y-4 ${isHospital?'opacity-80 pointer-events-none bg-slate-50/50':''}`}>
                                <div className="relative">
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block ml-1">เลขบัตรประชาชน</label>
                                    <input value={p1.idCard} onChange={handleId} className="w-full p-2.5 border border-slate-300 rounded font-mono text-lg tracking-widest focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition" maxLength="13" disabled={isEdit} placeholder="x-xxxx-xxxxx-xx-x"/>
                                    {suggestions.length>0 && <div className="absolute top-full left-0 w-full bg-white shadow border z-50">{suggestions.map((s,i)=><div key={i} onClick={()=>{setP1(s);setSugg([])}} className="p-2 hover:bg-slate-100 cursor-pointer border-b text-sm flex justify-between"><span>{s.idCard}</span><span className="text-slate-500">{s.name}</span></div>)}</div>}
                                </div>
                                <div className="grid gap-4"><Input l="ชื่อ-นามสกุล" v={p1.name} s={v=>setP1({...p1,name:v})} icon="user"/><div className="grid grid-cols-2 gap-4"><Input l="HbA1C" v={p1.hba1c} s={v=>setP1({...p1,hba1c:v})} icon="activity"/><Input l="BP" v={p1.bp} s={v=>setP1({...p1,bp:v})}/></div>{!isHospital && <div className="grid grid-cols-2 gap-4"><Input l="น้ำหนัก" v={p1.weight} s={v=>setP1({...p1,weight:v})}/><Input l="ส่วนสูง" v={p1.height} s={v=>setP1({...p1,height:v})}/></div>}<div className="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded border border-slate-200"><Input l="VA L" v={p1.vaLeft} s={v=>setP1({...p1,vaLeft:v})} bg="bg-white"/><Input l="VA R" v={p1.vaRight} s={v=>setP1({...p1,vaRight:v})} bg="bg-white"/></div></div>
                            </div>
                            {!isHospital && <div className="p-4 border-t bg-slate-50 flex gap-3"><button onClick={onBack} className="flex-1 border py-2.5 rounded text-slate-500 font-bold hover:bg-white transition">ยกเลิก</button><button onClick={save} disabled={saving} className="flex-[2] bg-teal-600 text-white py-2.5 rounded font-bold shadow hover:bg-teal-700 flex justify-center items-center gap-2 transition">{saving?<div className="loader w-4 h-4 border-white/30 border-t-white"></div>:<><Icon name="save"/> บันทึก</>}</button></div>}
                         </div>
                         {isHospital && <button onClick={onBack} className="mt-4 w-full py-2 bg-white border border-slate-200 rounded text-slate-500 text-sm font-bold hover:bg-slate-50">กลับหน้าหลัก</button>}
                    </div>
                    {isHospital && (
                        <div className="w-full lg:w-2/3 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                             <div className="bg-brand-50 p-5 border-b border-brand-100 flex items-center gap-3"><div className="bg-brand-100 p-2 rounded text-brand-600"><Icon name="eye" size={24}/></div><h3 className="font-bold text-lg text-brand-800">บันทึกผลตรวจ</h3></div>
                             <div className="p-6 space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded border border-slate-200"><span className="text-xs font-bold text-slate-500 block mb-2 uppercase">พบจอประสาทตา?</span><div className="flex gap-2"><button onClick={()=>setP2({...p2,retinaFound:'Yes'})} className={`flex-1 py-2 rounded font-bold text-sm border ${p2.retinaFound==='Yes'?'bg-brand-600 text-white border-brand-600':'bg-white border-slate-200'}`}>เจอ</button><button onClick={()=>setP2({...p2,retinaFound:'No'})} className={`flex-1 py-2 rounded font-bold text-sm border ${p2.retinaFound==='No'?'bg-brand-600 text-white border-brand-600':'bg-white border-slate-200'}`}>ไม่เจอ</button></div></div>
                                    <div className="bg-slate-50 p-4 rounded border border-slate-200"><span className="text-xs font-bold text-slate-500 block mb-2 uppercase">เป็นต้อกระจก?</span><div className="flex gap-2"><button onClick={()=>setP2({...p2,cataract:'Yes'})} className={`flex-1 py-2 rounded font-bold text-sm border ${p2.cataract==='Yes'?'bg-slate-700 text-white border-slate-700':'bg-white border-slate-200'}`}>ใช่</button><button onClick={()=>setP2({...p2,cataract:'No'})} className={`flex-1 py-2 rounded font-bold text-sm border ${p2.cataract==='No'?'bg-slate-700 text-white border-slate-700':'bg-white border-slate-200'}`}>ไม่ใช่</button></div></div>
                                </div>
                                <div className="border rounded overflow-hidden"><table className="w-full text-sm"><thead className="bg-slate-50 text-slate-500 font-bold"><tr><th className="p-3 pl-6 text-left">Diagnosis</th><th className="p-3 w-16 text-center">L</th><th className="p-3 w-16 text-center">R</th></tr></thead><tbody className="divide-y divide-slate-100">{['Normal','MicroAneurysm','HardExudate','FlameHemorrhage','VenousBeading'].map(k=>(<tr key={k} className="hover:bg-brand-50"><td className="p-3 pl-6 text-slate-700 font-medium">{k}</td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.L} onChange={()=>setFindings({...findings,[k]:{...findings[k],L:!findings[k]?.L}})}/></td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.R} onChange={()=>setFindings({...findings,[k]:{...findings[k],R:!findings[k]?.R}})}/></td></tr>))}</tbody></table></div>
                                <button onClick={save} disabled={saving} className="w-full bg-brand-600 hover:bg-brand-700 text-white py-3.5 rounded font-bold shadow flex justify-center items-center gap-2 transition">{saving?<div className="loader border-white/30 border-t-white"></div>:<><Icon name="check-circle"/> ยืนยันผลการตรวจ</>}</button>
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const Input = ({l, v, s, icon, bg="bg-white"}) => (<div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block ml-1">{l}</label><div className="relative">{icon&&<Icon name={icon} className="absolute left-3 top-3 text-slate-400" size={16}/>}<input value={v||''} onChange={e=>s(e.target.value)} className={`w-full ${icon?'pl-10':'p-2.5'} border border-slate-300 rounded focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition ${bg}`}/></div></div>);

        // --- IMPORT VIEW ---
        const ImportView = ({ db, user, appId, onBack }) => {
            const [csv, setCsv] = React.useState([]);
            const [imp, setImp] = React.useState(false);
            const handle = (e) => Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, encoding: 'TIS-620', complete: (r) => setCsv(r.data) });
            const run = async () => { setImp(true); let c=0; for(let row of csv) { const id=(row['เลข 13 หลัก']||row['pid']||'').replace(/\D/g,''); if(id.length===13) { const p = { idCard: id, name: row['ชื่อสกุล']||row['fullname']||'-', hba1c: row['HbA1C']||'-', bp: row['BP']||'-', source:'Import' }; try { await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(id).set(p,{merge:true}); await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).add({part1:p, status:'Registered', pcuId:'Admin', createdAt:firebase.firestore.FieldValue.serverTimestamp()}); c++; } catch(e){} } } setImp(false); alert(`Imported ${c}`); };
            return (<div className="max-w-2xl mx-auto bg-white p-10 rounded-3xl shadow-xl text-center animate__animated animate__fadeInUp"><div className="w-20 h-20 bg-brand-50 text-brand-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-sm"><Icon name="file-spreadsheet" size={40}/></div><h2 className="text-3xl font-bold text-slate-800 mb-3">Import Data</h2><p className="text-slate-500 mb-8">รองรับไฟล์ Excel (CSV TIS-620)</p><div className="p-10 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 mb-8 hover:bg-slate-100 transition cursor-pointer relative"><input type="file" accept=".csv" onChange={handle} className="absolute inset-0 opacity-0 cursor-pointer"/><div className="pointer-events-none"><Icon name="upload-cloud" className="mx-auto text-slate-400 mb-3" size={32}/><p className="text-sm text-slate-500 font-medium">คลิกเพื่อเลือกไฟล์ หรือลากมาวางที่นี่</p></div></div>{csv.length>0&&<div className="mb-8 bg-teal-50 text-teal-700 px-4 py-3 rounded-xl font-bold border border-teal-100 flex items-center justify-center gap-2"><Icon name="check-circle" size={18}/> พร้อมนำเข้า {csv.length} รายการ</div>}<div className="flex gap-4"><button onClick={onBack} className="flex-1 py-3.5 rounded-xl border-2 border-slate-100 font-bold text-slate-500 hover:bg-slate-50 hover:border-slate-200 transition">ยกเลิก</button>{csv.length>0 && <button onClick={run} disabled={imp} className="flex-1 py-3.5 rounded-xl bg-brand-600 text-white font-bold shadow-lg hover:bg-brand-700 transition disabled:opacity-70">{imp?'Processing...':'Confirm Import'}</button>}</div></div>);
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
