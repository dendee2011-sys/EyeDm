<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM Connect - ระบบส่งต่อผู้ป่วยเบาหวาน</title>
    
    <!-- 1. Import Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tesseract.js สำหรับ OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase Libraries (Compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .chk-lg { transform: scale(1.3); margin-right: 8px; cursor: pointer; }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        /* Fix checkbox alignment on mobile */
        input[type="checkbox"] { accent-color: #2563eb; width: 18px; height: 18px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        /* Scanner Overlay */
        .scanner-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; height: 100px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
            pointer-events: none;
        }
        .scanner-line {
            position: absolute;
            top: 50%; left: 5%; right: 5%;
            height: 1px;
            background: rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };

        const initFirebase = () => {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(err => console.log("Persistence disabled:", err.code));
                } catch (e) {
                    console.error("Firebase init error:", e);
                }
            }
        };
        initFirebase();

        const auth = firebase.auth();
        const db = firebase.firestore();

        const APP_ID_FIXED = "eyedm-production"; 
        const getCollection = (collectionName) => {
            return db.collection(`artifacts/${APP_ID_FIXED}/public/data/${collectionName}`);
        };
        
        // --- CONSTANTS ---
        const VA_OPTIONS = [
            "20/20 (6/6) (ปกติ)", "20/25 (6/7.5)", "20/30 (6/9)", "20/40 (6/12)", "20/50 (6/15)", 
            "20/70 (6/21)", "20/100 (6/30)", "20/200 (6/60)", "20/400 (6/120)", 
            "CF (นับนิ้ว)", "HM (โบกมือ)", "PL (เห็นแสง)", "NPL (ไม่เห็นแสง)"
        ];
        
        const DR_STAGES = [
            "No DR", 
            "Mild DR", 
            "Moderate DR", 
            "Severe DR", 
            "PDR", 
            "ไม่พบจอประสาทตา"
        ];

        const defaultFindings = { 
            Normal:{L:true,R:true}, MicroAneurysm:{L:false,R:false}, Hemorrhage:{L:false,R:false}, 
            HardExudate:{L:false,R:false}, Other:{L:false,R:false} 
        };
        const STATIC_PCU_DATA = {
            "03277": "รพ.สต.บ้านคูซอด", "03278": "รพ.สต.บ้านแทง", "03279": "รพ.สต.บ้านหนองคู", "03280": "รพ.สต.ตะดอบ",
            "03281": "รพ.สต.บ้านหนองครกใต้", "03282": "รพ.สต.บ้านกุดโง้ง", "03283": "รพ.สต.บ้านกลาง", "03284": "รพ.สต.บ้านหนองแวง",
            "03285": "รพ.สต.บ้านสร้างเรือง", "03286": "รพ.สต.บ้านโนนแกด", "03287": "รพ.สต.บ้านหนองไฮ", "03288": "รพ.สต.บ้านหนองแก้ว",
            "03289": "รพ.สต.บ้านน้ำคำ", "03290": "รพ.สต.บ้านหนองโน", "03291": "รพ.สต.บ้านโพธิ์", "03292": "รพ.สต.บ้านก้านเหลือง",
            "03293": "รพ.สต.บ้านหนองไผ่", "14422": "ศูนย์บริการสาธารณสุข 2", "15204": "ศูนย์บริการสาธารณสุข 3",
            "21986": "ศูนย์บริการสาธารณสุข 4", "23954": "ศูนย์บริการสาธารณสุข 5", "77475": "ศุนย์สุขภาพชุมชนเขตเมือง รพ.ศรีสะเกษ"
        };
        
        const CSV_HEADERS = [
            'idCard', 'name', 'dob', 'age', 'dxDate', 'dmYears', 'hba1c', 'bp', 'weight', 'height', 
            'vaRight', 'vaLeft', 'priorExam', 'priorExamCount', 'agencyCode', 'referralDate', 'drStageR', 'drStageL', 
            'lastExamDate', 'lastDrStageR', 'lastDrStageL', 
            'lastVaRight', 'lastVaLeft', 'lastHba1c', 'lastBp'
        ];
        const FOOT_RISKS = ["Low Risk (ความเสี่ยงต่ำ)", "Moderate Risk (ปานกลาง)", "High Risk (ความเสี่ยงสูง)", "Very High Risk (ความเสี่ยงสูงมาก)", "Active Ulcer (มีแผลขณะนี้)"];

        // --- UTILS ---
        const getTodayStr = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offset).toISOString().split('T')[0];
        };

        const getGenderFromName = (name) => {
            if (!name) return '';
            const n = name.trim();
            if (n.startsWith('นาย') || n.startsWith('ด.ช.') || n.startsWith('เด็กชาย') || n.startsWith('พระ') || n.startsWith('สามเณร') || n.startsWith('พลฯ')) return 'ชาย';
            if (n.startsWith('นาง') || n.startsWith('ด.ญ.') || n.startsWith('เด็กหญิง') || n.startsWith('น.ส.') || n.startsWith('ดญ') || n.startsWith('นส.')) return 'หญิง';
            return '';
        };

        const formatDateTh = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20, className = "", color }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className} style={{color}}></i>;
        };

        const MessageModal = ({ modal, setModal }) => {
            if (!modal.visible) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm animate-fade-in p-6">
                        <div className="flex items-center gap-3 mb-4">
                            <Icon name={modal.onConfirm ? "help-circle" : "info"} size={24} className={modal.onConfirm ? "text-orange-500" : "text-blue-500"} />
                            <h3 className="text-xl font-bold">{modal.title || "แจ้งเตือน"}</h3>
                        </div>
                        <p className="text-gray-700 mb-6">{modal.message}</p>
                        <div className="flex justify-end gap-3">
                            {modal.onConfirm && <button onClick={() => setModal({ ...modal, visible: false })} className="px-4 py-2 rounded border bg-gray-100">ยกเลิก</button>}
                            <button onClick={() => { if (modal.onConfirm) modal.onConfirm(); else setModal({ ...modal, visible: false }); }} className={`px-4 py-2 rounded text-white ${modal.onConfirm ? 'bg-red-600' : 'bg-blue-600'}`}>ตกลง</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QueueStatusBar = ({ patients, role, agencyCode, selectedDate }) => {
            const myPatients = useMemo(() => {
                return patients.filter(p => {
                    if (p.isDeleted) return false;
                    if (p.status === 'Imported') return false; 

                    if (role === 'PCU' && p.referringAgencyCode !== agencyCode) return false;
                    
                    if (selectedDate) {
                        const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                        const offset = pDate.getTimezoneOffset() * 60000;
                        const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];
                        if (pDateStr !== selectedDate) return false;
                    }
                    
                    return true;
                });
            }, [patients, role, agencyCode, selectedDate]);

            const totalPatients = myPatients.length;
            const waitingEye = myPatients.filter(p => p.status === 'Waiting').length;
            const waitingFoot = myPatients.filter(p => p.status === 'Waiting' && !p.footExam).length;

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 animate-fade-in">
                      <div className="bg-white border-l-4 border-emerald-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-emerald-100 p-2 rounded-full text-emerald-600"><Icon name="users" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">ผู้ป่วยทั้งหมด (Total)</div><div className="text-xl font-bold text-emerald-700 leading-none">{totalPatients} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                      <div className="bg-white border-l-4 border-blue-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Icon name="eye" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">รอตรวจตา (Eye Queue)</div><div className="text-xl font-bold text-blue-700 leading-none">{waitingEye} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                      <div className="bg-white border-l-4 border-pink-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-pink-100 p-2 rounded-full text-pink-600"><Icon name="footprints" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">รอตรวจเท้า (Foot Queue)</div><div className="text-xl font-bold text-pink-700 leading-none">{waitingFoot} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                </div>
            );
        };

        const AuthScreen = () => {
            const [agencyCode, setAgencyCode] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                const code = agencyCode.trim();
                if (code.length !== 5) { setError('กรุณากรอกรหัสหน่วยงาน 5 หลัก'); return; }
                if (!password) { setError('กรุณากรอกรหัสผ่าน'); return; }
                
                setLoading(true);
                try {
                    const email = `${code}@eyedm.com`;
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    console.error(err);
                    setError('รหัสหน่วยงานหรือรหัสผ่านไม่ถูกต้อง');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-cyan-500 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="lock" size={40} /></div>
                            <h1 className="text-3xl font-bold text-gray-800">EyeDM Connect</h1>
                            <p className="text-slate-500 mt-2">ระบบส่งต่อผู้ป่วยเบาหวานเข้าจอประสาทตา</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-xs font-semibold text-gray-500 mb-1">รหัสหน่วยงาน (User ID)</label><input type="text" inputMode="numeric" maxLength="5" value={agencyCode} onChange={e=>setAgencyCode(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl text-lg font-mono" placeholder="เช่น 10700" required /></div>
                            <div><label className="block text-xs font-semibold text-gray-500 mb-1">รหัสผ่าน (Password)</label><input type="password" placeholder="กรอกรหัสผ่าน..." value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl text-lg" required /></div>
                            {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg text-sm border border-red-300 flex items-center gap-2"><Icon name="alert-circle" size={16}/> {error}</div>}
                            <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-md">{loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ role, patients, onNew, onSelect, onEdit, setModal, agencyCode, agencyName, agenciesMap, selectedDate, setSelectedDate }) => {
            const [term, setTerm] = useState('');
            const [agencyFilter, setAgencyFilter] = useState('All');
            const allAgenciesMap = useMemo(() => ({ ...STATIC_PCU_DATA, ...agenciesMap }), [agenciesMap]);
            
            // [ADDED] ฟังก์ชัน Export CSV สำหรับ PCU
            const exportData = () => {
                const headers = ["Date", "ID Card", "Name", "Gender", "Age", "DM Years", "VA (R)", "VA (L)", "HbA1c", "Foot Risk", "Status", "Result (R)", "Result (L)"];
                const BOM = "\uFEFF"; 
                let csv = BOM + headers.join(",") + "\n";
                
                filtered.forEach(p => {
                    const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString('th-TH') : '-';
                    const safe = (s) => `"${String(s || '').replace(/"/g, '""')}"`;
                    const risk = p.footExam?.riskLevel?.split(' ')[0] || '-';
                    
                    csv += [
                        safe(date),
                        safe(`'${p.part1?.idCard}`), // ใส่ ' นำหน้าเพื่อป้องกัน Excel แปลงเป็นวิทยาศาสตร์
                        safe(p.part1?.name),
                        safe(p.part1?.gender),
                        safe(p.part1?.age),
                        safe(p.part1?.dmYears),
                        safe(p.part1?.vaRight),
                        safe(p.part1?.vaLeft),
                        safe(p.part1?.hba1c),
                        safe(risk),
                        safe(p.status),
                        safe(p.part2?.drStageR || '-'),
                        safe(p.part2?.drStageL || '-')
                    ].join(",") + "\n";
                });
                
                const url = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                const link = document.createElement("a");
                link.href = url;
                link.download = `pcu_export_${selectedDate}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getFootBadge = (p) => {
                if (!p.footExam) return null;
                const risk = p.footExam.riskLevel || '';
                const isHigh = risk.includes('High') || risk.includes('Ulcer');
                const color = isHigh ? 'text-red-600 bg-red-50 border-red-100' : 'text-emerald-600 bg-emerald-50 border-emerald-100';
                return (
                    <div className={`text-[10px] px-1.5 py-0.5 rounded border ${color} inline-flex items-center gap-1 mt-1 w-fit`}>
                        <Icon name="footprints" size={10}/> 
                        <span className="truncate max-w-[80px]">{risk.split(' ')[0]}</span>
                    </div>
                );
            };
            
            const filtered = useMemo(() => {
                return patients.filter(p => {
                    if (p.isDeleted) return false;
                    
                    // [MODIFIED] ปรับเงื่อนไข: ถ้ามีการค้นหา (term มีค่า) ให้แสดงข้อมูล Imported/ประวัติเก่าได้ทั้งหมด
                    // แต่ถ้าไม่ได้ค้นหา (ดูรายวันปกติ) ให้ซ่อน Imported ไว้ตามเดิมเพื่อไม่ให้รก
                    if (term.length === 0 && p.status === 'Imported') return false;

                    const searchStr = (p.part1?.idCard || '') + (p.part1?.name || '');
                    const matchesTerm = searchStr.toLowerCase().includes(term.toLowerCase());
                    
                    const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                    const offset = pDate.getTimezoneOffset() * 60000;
                    const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];
                    const matchesDate = pDateStr === selectedDate;

                    let matchesAgency = true;
                    if (role === 'HOSPITAL') {
                        matchesAgency = agencyFilter === 'All' || p.referringAgencyCode === agencyFilter;
                    } else {
                        matchesAgency = p.referringAgencyCode === agencyCode;
                    }
                    
                    if (term.length > 0) {
                        return matchesAgency && matchesTerm;
                    } else {
                        return matchesAgency && matchesDate;
                    }
                });
            }, [patients, term, role, agencyCode, agencyFilter, selectedDate]);

            const getStatusBadge = (status) => {
                switch(status) {
                    case 'Waiting': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">รอตรวจ</span>;
                    case 'Completed': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">เรียบร้อย</span>;
                    case 'Imported': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">ฐานข้อมูล</span>;
                    default: return <span className="bg-gray-100">N/A</span>;
                }
            };
            const formatDate = (dateObj) => {
                if (dateObj && typeof dateObj.toLocaleDateString === 'function') { try { return dateObj.toLocaleDateString('th-TH'); } catch(e) { return '-'; } } return '-';
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3">
                        <div>
                            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon name={role==='PCU'?'home':'building'} className={role==='PCU'?'text-green-600':'text-blue-600'} />{role === 'PCU' ? 'ทะเบียนผู้ป่วย' : 'รายการส่งตัว (Hospital)'}</h2>
                            {role === 'PCU' && <div className="text-sm text-green-700 mt-1 font-semibold">{agencyCode} - {agencyName}</div>}
                        </div>
                        {/* [MODIFIED] ปรับปุ่มเพิ่มผู้ป่วยให้ใหญ่ เด่นชัด และกดง่ายขึ้น */}
                        {role === 'PCU' && (
                            <button 
                                onClick={() => onNew()} 
                                className="bg-green-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 font-bold text-base hover:bg-green-700 hover:scale-105 transition-all active:scale-95"
                            >
                                <Icon name="plus-circle" size={20}/> เพิ่มผู้ป่วยใหม่
                            </button>
                        )}
                    </div>
                    <div className="bg-white p-2 rounded-xl shadow-sm border flex flex-col sm:flex-row items-center gap-2">
                        <div className={`flex items-center gap-1 border rounded p-1 transition-colors ${term ? 'bg-gray-100 border-gray-200 opacity-50' : 'bg-blue-50 border-blue-100'}`}>
                            <span className="text-xs font-bold text-blue-600 px-2">วันที่:</span>
                            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none rounded p-1 text-sm text-blue-800 font-bold cursor-pointer outline-none" disabled={!!term}/>
                        </div>

                        {role === 'HOSPITAL' && (
                            <select value={agencyFilter} onChange={e => setAgencyFilter(e.target.value)} className="w-full sm:w-auto p-2 border bg-gray-50 rounded text-sm">
                                <option value="All">ทุกหน่วยงาน (All PCU)</option>
                                {Object.keys(allAgenciesMap).sort().map(code => <option key={code} value={code}>{code} - {allAgenciesMap[code]}</option>)}
                            </select>
                        )}
                        <div className="flex-1 flex items-center w-full border rounded px-2 bg-white ring-1 ring-transparent focus-within:ring-blue-500">
                            <Icon name="search" className="text-gray-400"/>
                            {/* [MODIFIED] ปรับข้อความ Placeholder ให้สื่อถึงการค้นหาประวัติเดิม */}
                            <input type="text" value={term} onChange={e=>setTerm(e.target.value)} placeholder="ค้นหาประวัติ/ชื่อ/เลขบัตร..." className="flex-1 p-2 outline-none text-sm w-full" />
                            {term && <button onClick={()=>setTerm('')} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={14}/></button>}
                        </div>
                        
                        {/* [MODIFIED] เพิ่มปุ่มเพิ่มผู้ป่วยใหม่ในแถบค้นหา (Quick Add) - ส่ง term ไปด้วย */}
                        {role === 'PCU' && (
                            <div className="flex gap-2">
                                <button onClick={() => onNew(term)} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm hover:bg-green-700 whitespace-nowrap"><Icon name="plus-circle" size={16}/> เพิ่มผู้ป่วย</button>
                                <button onClick={exportData} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm hover:bg-blue-700 whitespace-nowrap"><Icon name="download" size={16}/> Export</button>
                            </div>
                        )}
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-x-auto">
                        <table className="w-full text-sm text-left whitespace-nowrap">
                            <thead className="bg-gray-50 border-b text-gray-500">
                                <tr>
                                    {/* [ADDED] เพิ่มหัวตารางลำดับ */}
                                    <th className="p-3 text-center w-10">#</th>
                                    <th className="p-3">วันที่</th>
                                    <th className="p-3">ผู้ป่วย / ID</th>
                                    <th className="p-3">หน่วยงาน</th>
                                    <th className="p-3 text-center">สถานะ</th>
                                    <th className="p-3 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filtered.map((p, index) => {
                                    const gender = p.part1?.gender || getGenderFromName(p.part1?.name);
                                    return (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                            {/* [ADDED] แสดงลำดับที่ (index + 1) */}
                                            <td className="p-3 text-center align-top text-gray-400 font-bold">{index + 1}</td>
                                            
                                            <td className="p-3 text-gray-500 align-top">{formatDate(p.createdAt)}</td>
                                            <td className="p-3 align-top">
                                                <div className="font-mono text-blue-600 font-bold">{p.part1?.idCard || 'N/A'}</div>
                                                <div className="flex items-center gap-2">
                                                    <span>{p.part1?.name || 'N/A'}</span>
                                                    {gender === 'ชาย' && <Icon name="user" size={14} className="text-blue-500"/>}
                                                    {gender === 'หญิง' && <Icon name="user" size={14} className="text-pink-500"/>}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1 flex gap-2">
                                                     <span>VA: {p.part1?.vaRight || '-'}/{p.part1?.vaLeft || '-'}</span>
                                                     <span className="text-blue-600 font-semibold">HbA1c: {p.part1?.hba1c || '-'}</span>
                                                </div>
                                                {getFootBadge(p)}
                                            </td>
                                            <td className="p-3 align-top text-gray-500">{p.referringAgencyCode ? <div className="flex flex-col"><span className="bg-gray-100 px-2 py-1 rounded text-xs font-mono w-fit mb-1">{p.referringAgencyCode}</span><span className="text-xs truncate max-w-[150px]">{allAgenciesMap[p.referringAgencyCode] || '-'}</span></div> : <span>-</span>}</td>
                                            <td className="p-3 text-center align-top">{getStatusBadge(p.status)}</td>
                                            <td className="p-3 text-right align-top">
                                                <div className="flex justify-end gap-2">
                                                    {p.status !== 'Completed' && <button onClick={()=>onEdit(p)} className="text-blue-500 hover:bg-blue-50 p-2 rounded-lg"><Icon name="pencil" size={16}/></button>}
                                                    {role === 'HOSPITAL' && p.status === 'Waiting' && <button onClick={()=>onSelect(p)} className="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">ตรวจ</button>}
                                                    {p.status === 'Completed' && <button onClick={()=>onSelect(p)} className="bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-xs">ดูผล</button>}
                                                    
                                                    {/* [MODIFIED] ปุ่มลบแบบ Soft Delete: ไม่ลบข้อมูลจริง แต่ทำเครื่องหมายว่าลบ และบันทึกว่าใครลบ/ลบเมื่อไหร่ */}
                                                    {!(role === 'PCU' && p.status === 'Completed') && <button onClick={() => { 
                                                        setModal({ visible: true, title: "ลบข้อมูล", message: "ยืนยันการลบ? (ข้อมูลจะถูกเก็บไว้ในฐานข้อมูล แต่ซ่อนจากหน้านี้)", onConfirm: async () => { 
                                                            try { 
                                                                await getCollection('patients_referrals').doc(p.id).update({ 
                                                                    isDeleted: true,
                                                                    deletedAt: new Date(), // บันทึกเวลาที่ลบ
                                                                    deletedBy: agencyCode  // บันทึกรหัสหน่วยงานคนที่ลบ
                                                                }); 
                                                                setModal({ visible: false }); 
                                                            } 
                                                            catch(e) { alert(e.message); } 
                                                        } }); 
                                                    }} className="text-red-500 hover:bg-red-50 p-2 rounded-lg"><Icon name="trash-2" size={16}/></button>}
                                                </div>
                                            </td>
                                    </tr>
                                );})}
                                {filtered.length===0 && <tr><td colSpan="6" className="p-6 text-center text-gray-400">ไม่พบข้อมูลในวันที่เลือก</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PCUForm = ({ onBack, existingPatients, setModal, patientToEdit, agencyCode, initialId }) => {
            const isEditing = !!patientToEdit;
            const defaultForm = { idCard: initialId || '', name:'', gender:'', age:'', dob:'', dxDate:'', dmYears:'', hba1c:'', bp:'', weight:'', height:'', vaRight:'', vaLeft:'', priorExam:'No', priorExamCount: 0, wheelchair: false };
            const [form, setForm] = useState(isEditing ? { ...defaultForm, ...patientToEdit.part1 } : defaultForm);
            const [showScanner, setShowScanner] = useState(false);
            const [scanStatus, setScanStatus] = useState('');
            
            const [recordDate, setRecordDate] = useState(() => {
                if (isEditing && patientToEdit.createdAt) {
                    const d = new Date(patientToEdit.createdAt);
                    const offset = d.getTimezoneOffset() * 60000;
                    return new Date(d.getTime() - offset).toISOString().split('T')[0];
                }
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                return new Date(now.getTime() - offset).toISOString().split('T')[0];
            });

            const [saving, setSaving] = useState(false);
            const [foundOld, setFoundOld] = useState(false);
            const [footStatus, setFootStatus] = useState(null);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const validateThaiID = (id) => {
                if (id.length !== 13) return false;
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += parseFloat(id.charAt(i)) * (13 - i);
                }
                const checkDigit = (11 - sum % 11) % 10;
                return checkDigit === parseFloat(id.charAt(12));
            };

            // [MODIFIED] Scanner Effect: Adaptive OCR
            useEffect(() => {
                if (!showScanner) return;

                let stream = null;
                let scanInterval = null;
                let isScanning = false; 

                const startCamera = async () => {
                    try {
                        // Use high res for better OCR
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                        });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.onloadedmetadata = () => {
                                videoRef.current.play();
                                setScanStatus('วางเลข 13 หลัก ในกรอบ (ถือนิ่งๆ)...');
                                startScanLoop();
                            };
                        }
                    } catch (err) {
                        console.error("Camera Error", err);
                        alert("ไม่สามารถเปิดกล้องได้: " + err.message);
                        setShowScanner(false);
                    }
                };

                const startScanLoop = () => {
                    scanInterval = setInterval(async () => {
                        if (isScanning || !videoRef.current || !canvasRef.current) return;
                        isScanning = true;

                        try {
                            const video = videoRef.current;
                            const canvas = canvasRef.current;
                            
                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                const w = video.videoWidth;
                                const h = video.videoHeight;
                                
                                // Crop Logic: Expand to 90% width to handle variable distance/position
                                const cropW = w * 0.90; 
                                const cropH = h * 0.20; 
                                const startX = (w - cropW) / 2;
                                const startY = (h - cropH) / 2;
                                
                                const scale = 2; // Upscale for clearer text
                                canvas.width = cropW * scale;
                                canvas.height = cropH * scale;
                                const ctx = canvas.getContext('2d');
                                
                                ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, canvas.width, canvas.height);
                                
                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const data = imageData.data;

                                // Adaptive Thresholding
                                let totalBrightness = 0;
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = data[i];
                                    const g = data[i + 1];
                                    const b = data[i + 2];
                                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                    totalBrightness += gray;
                                }
                                const avgBrightness = totalBrightness / (data.length / 4);
                                const threshold = avgBrightness * 0.70; 

                                // Binarization
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = data[i];
                                    const g = data[i + 1];
                                    const b = data[i + 2];
                                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                    const contrast = gray > threshold ? 255 : 0; 
                                    data[i] = contrast; data[i + 1] = contrast; data[i + 2] = contrast;
                                }
                                ctx.putImageData(imageData, 0, 0);

                                const { data: { text } } = await Tesseract.recognize(
                                    canvas, 
                                    'eng',
                                    { 
                                        tessedit_char_whitelist: '0123456789', 
                                        tessedit_pageseg_mode: '6' 
                                    }
                                );
                                
                                const digits = text.replace(/[^0-9]/g, '');
                                
                                if (digits.length >= 13) {
                                    for (let i = 0; i <= digits.length - 13; i++) {
                                        const potentialID = digits.substring(i, i + 13);
                                        if (validateThaiID(potentialID)) {
                                            if (navigator.vibrate) navigator.vibrate(200);
                                            setForm(prev => ({ ...prev, idCard: potentialID }));
                                            
                                            clearInterval(scanInterval);
                                            if (stream) stream.getTracks().forEach(track => track.stop());
                                            setShowScanner(false);
                                            isScanning = false;
                                            return;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            // console.error("OCR Error", e);
                        } finally {
                            isScanning = false;
                        }
                    }, 500); 
                };

                const initScanner = async () => {
                     if (!window.Tesseract) { 
                        await new Promise(r => setTimeout(r, 500));
                        if (!window.Tesseract) {
                            alert("ระบบสแกนยังโหลดไม่เสร็จ"); 
                            setShowScanner(false); 
                            return; 
                        }
                    }
                    startCamera();
                };
                initScanner();

                return () => {
                    if (scanInterval) clearInterval(scanInterval);
                    if (stream) stream.getTracks().forEach(track => track.stop());
                };
            }, [showScanner]);

            const handleNameChange = (e) => {
                const val = e.target.value;
                const detectedGender = getGenderFromName(val);
                setForm(prev => ({ 
                    ...prev, 
                    name: val, 
                    gender: detectedGender !== '' ? detectedGender : prev.gender 
                }));
            };

            useEffect(() => {
                const refDate = new Date(recordDate);
                let newAge = form.age;
                let newDmYears = form.dmYears;
                let hasUpdates = false;

                if (form.dob) {
                    const birthDate = new Date(form.dob);
                    if (!isNaN(birthDate)) {
                        let a = refDate.getFullYear() - birthDate.getFullYear();
                        const m = refDate.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && refDate.getDate() < birthDate.getDate())) a--;
                        const calculatedAge = Math.max(0, a);
                        if (Number(calculatedAge) !== Number(form.age)) {
                            newAge = calculatedAge;
                            hasUpdates = true;
                        }
                    }
                }

                if (form.dxDate) {
                    const dxDate = new Date(form.dxDate);
                    if (!isNaN(dxDate)) {
                        let y = refDate.getFullYear() - dxDate.getFullYear();
                        const m = refDate.getMonth() - dxDate.getMonth();
                        if (m < 0 || (m === 0 && refDate.getDate() < dxDate.getDate())) y--;
                        const calculatedDmYears = Math.max(0, y);
                        if (Number(calculatedDmYears) !== Number(form.dmYears)) {
                            newDmYears = calculatedDmYears;
                            hasUpdates = true;
                        }
                    }
                }

                if (hasUpdates) {
                    setForm(prev => ({ ...prev, age: newAge, dmYears: newDmYears }));
                }
            }, [recordDate, form.dob, form.dxDate]);

            // [MODIFIED] Logic กลับมาเติมข้อมูลอัตโนมัติทันทีเมื่อครบ 13 หลัก (ไม่ต้องถาม)
            useEffect(() => {
                if (!isEditing && form.idCard && form.idCard.length === 13 && existingPatients) {
                    // 1. ค้นหาประวัติทั้งหมด
                    const historyMatches = existingPatients.filter(p => p.part1?.idCard === form.idCard);
                    
                    if(historyMatches.length > 0) { 
                        setFoundOld(true); 
                        
                        // 2. เรียงลำดับจาก ใหม่ -> เก่า
                        historyMatches.sort((a, b) => b.createdAt - a.createdAt);
                        const latestRecord = historyMatches[0];

                        // 3. เตรียมข้อมูลที่จะเติม
                        let loadedPart1 = { ...latestRecord.part1 };
                        
                        // ถ้าข้อมูลเก่าไม่มีเพศ ให้ลอง Auto-detect จากชื่อใหม่
                        if (!loadedPart1.gender && loadedPart1.name) {
                            loadedPart1.gender = getGenderFromName(loadedPart1.name);
                        }

                        // 4. เติมข้อมูลลงฟอร์มทันที (คงเลขบัตรที่พิมพ์ไว้)
                        setForm(f => ({...f, ...loadedPart1, idCard: form.idCard})); 
                        
                        // ดึงความเสี่ยงเท้าล่าสุดมาแสดง
                        if (latestRecord.footExam) setFootStatus(latestRecord.footExam.riskLevel);
                    } else { 
                        setFoundOld(false); 
                        setFootStatus(null);
                    }
                }
            }, [form.idCard, existingPatients, isEditing]);

            const save = async () => {
                if(!form.idCard || form.idCard.length !== 13 || !form.name) { setModal({visible:true, message: "กรุณากรอกข้อมูลให้ครบ"}); return; }
                
                const parts = recordDate.split('-');
                const targetDate = new Date(parts[0], parts[1]-1, parts[2]); 
                const now = new Date();
                targetDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

                if (!isEditing && existingPatients) {
                    const duplicate = existingPatients.find(p => {
                        if (p.isDeleted) return false; 
                        if (p.part1?.idCard !== form.idCard) return false; 
                        const pDate = p.createdAt;
                        return pDate.getDate() === targetDate.getDate() &&
                               pDate.getMonth() === targetDate.getMonth() &&
                               pDate.getFullYear() === targetDate.getFullYear();
                    });

                    if (duplicate) {
                        setModal({ 
                            visible: true, 
                            title: "ไม่สามารถบันทึกได้", 
                            message: `ผู้ป่วยรายนี้ (${form.name}) มีรายการส่งตัวในวันที่เลือก (${recordDate}) แล้ว` 
                        });
                        return;
                    }
                }

                setSaving(true);
                try {
                    const collection = getCollection('patients_referrals');
                    const data = { 
                        part1: form, 
                        // [MODIFIED] ถ้าเป็นการแก้ไข (isEditing) ให้ใช้รหัสหน่วยงานเดิม (patientToEdit.referringAgencyCode)
                        // เพื่อป้องกันกรณี Hospital แก้ไขข้อมูลแล้วกลายเป็นของ Hospital เอง
                        referringAgencyCode: isEditing ? patientToEdit.referringAgencyCode : agencyCode, 
                        createdAt: targetDate,
                        ...(isEditing ? {} : { status: 'Waiting', isDeleted: false }) 
                    };
                    if (isEditing) await collection.doc(patientToEdit.id).update(data); else await collection.add(data);
                    setModal({ visible: true, title: "สำเร็จ", message: "บันทึกข้อมูลเรียบร้อย", onConfirm: () => { setModal({ visible: false }); onBack(); } });
                } catch(e) { setModal({visible:true, message: "เกิดข้อผิดพลาด: "+e.message}); }
                setSaving(false);
            };

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="text-gray-500 mb-4 flex items-center gap-1"><Icon name="arrow-left" size={16}/> ยกเลิก</button>
                    <div className="bg-white rounded-2xl shadow-xl border border-green-100 overflow-hidden">
                        <div className="bg-green-600 p-4 text-white flex items-center justify-between">
                            <div className="flex items-center gap-2"><Icon name="file-text" className="text-white"/><h2 className="font-bold">{isEditing ? 'แก้ไขข้อมูล' : 'แบบฟอร์มส่งตัว'}</h2></div>
                            {footStatus && <div className="bg-white/20 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><Icon name="footprints" size={12}/> {footStatus.split(' ')[0]}</div>}
                        </div>
                        <div className="p-6 space-y-4">
                            
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                <label className="block text-xs font-bold text-blue-900 mb-1 flex items-center gap-2"><Icon name="calendar" size={16}/> วันที่ส่งตรวจ (Date)</label>
                                <input 
                                    type="date" 
                                    value={recordDate} 
                                    onChange={e => setRecordDate(e.target.value)} 
                                    className="w-full p-2 border rounded-lg text-lg font-semibold text-gray-700 cursor-pointer"
                                />
                            </div>

                            <div className={`p-4 rounded-xl border ${foundOld ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
                                <label className="block text-xs font-bold text-gray-700 mb-1">เลขบัตรประชาชน 13 หลัก *</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type="text" inputMode="numeric" maxLength="13" value={form.idCard} onChange={e=>setForm({...form, idCard:e.target.value})} className="w-full p-2 border rounded-lg text-lg font-mono" disabled={isEditing}/>
                                        {foundOld && !isEditing && <span className="absolute right-2 top-2 text-green-700 text-xs font-bold bg-green-100 px-2 py-1 rounded">มีประวัติเก่า</span>}
                                    </div>
                                    {/* ปุ่มเปิดสแกนเนอร์ */}
                                    <button onClick={() => setShowScanner(true)} className="bg-blue-600 text-white px-3 rounded-lg flex items-center gap-1 text-sm whitespace-nowrap shadow hover:bg-blue-700 transition-all"><Icon name="camera" size={16}/> สแกน/ถ่าย</button>
                                </div>
                            </div>

                            {/* [MODIFIED] Only OCR Camera Modal */}
                            {showScanner && (
                                <div className="fixed inset-0 z-50 bg-black bg-opacity-95 flex flex-col items-center justify-center p-4">
                                    <div className="relative w-full max-w-md rounded-xl overflow-hidden border-2 border-white/30 shadow-2xl bg-black h-64">
                                        <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover"></video>
                                        <canvas ref={canvasRef} className="hidden"></canvas>
                                        <div className="scanner-overlay"><div className="scanner-line"></div></div>
                                        
                                        <div className="absolute top-2 left-0 w-full text-center text-white text-xs bg-black/50 py-1 z-10">
                                            {scanStatus}
                                        </div>
                                    </div>
                                    <p className="text-white text-sm mt-4 text-center">
                                        วางเฉพาะตัวเลข 13 หลัก ให้อยู่ในกรอบ<br/><span className="text-xs text-gray-400">ระบบจะอ่านเฉพาะตัวเลขเท่านั้น</span>
                                    </p>
                                    <button onClick={() => setShowScanner(false)} className="mt-6 text-white bg-red-600 px-8 py-2 rounded-full font-bold hover:bg-red-700 transition-all">ปิดกล้อง</button>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 sm:grid-cols-12 gap-3">
                                <div className="sm:col-span-6">
                                    <label className="text-xs text-gray-500 mb-1">ชื่อ-สกุล</label>
                                    <input type="text" value={form.name || ''} onChange={handleNameChange} className="w-full p-2 border rounded-lg" placeholder="เช่น นายสมชาย ใจดี"/>
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1">เพศ</label>
                                    <select value={form.gender} onChange={e=>setForm({...form, gender:e.target.value})} className="w-full p-2 border rounded-lg bg-white">
                                        <option value="">-</option>
                                        <option value="ชาย">ชาย</option>
                                        <option value="หญิง">หญิง</option>
                                    </select>
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1 text-blue-600">วันเกิด (DOB)</label>
                                    <input type="date" value={form.dob || ''} onChange={e=>setForm({...form, dob: e.target.value})} className="w-full p-2 border rounded-lg text-xs"/>
                                    {form.dob && <div className="text-[10px] text-blue-600 mt-1 text-right font-bold">{formatDateTh(form.dob)}</div>}
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1">อายุ (ปี)</label>
                                    <input type="number" value={form.age || ''} onChange={e=>setForm({...form, age:e.target.value})} className="w-full p-2 border rounded-lg bg-gray-50"/>
                                </div>
                                
                                <div className="sm:col-span-6 sm:col-start-7">
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 mb-1 text-blue-600">วันที่วินิจฉัย (Dx Date)</label>
                                            <input type="date" value={form.dxDate || ''} onChange={e => setForm({...form, dxDate: e.target.value})} className="w-full p-2 border rounded-lg text-xs"/>
                                            {form.dxDate && <div className="text-[10px] text-blue-600 mt-1 text-right font-bold">{formatDateTh(form.dxDate)}</div>}
                                        </div>
                                        <div className="w-1/3">
                                            <label className="text-xs text-gray-500 mb-1">เป็น DM (ปี)</label>
                                            <input type="number" value={form.dmYears || ''} onChange={e=>setForm({...form, dmYears:e.target.value})} className="w-full p-2 border rounded-lg bg-gray-50"/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div><label className="text-xs text-gray-500 mb-1">HbA1C (%)</label><input type="text" value={form.hba1c || ''} onChange={e=>setForm({...form, hba1c:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">BP (mmHg)</label><input type="text" value={form.bp || ''} onChange={e => { let val = e.target.value.replace(/[^0-9]/g, ''); if (val.length > 3) val = val.slice(0, 3) + '/' + val.slice(3); setForm({...form, bp: val}); }} className="w-full p-2 border rounded-lg" placeholder="120/80"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">น้ำหนัก (kg)</label><input type="number" value={form.weight || ''} onChange={e=>setForm({...form, weight:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">ส่วนสูง (cm)</label><input type="number" value={form.height || ''} onChange={e=>setForm({...form, height:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                                <h3 className="text-sm font-bold text-gray-700">ข้อมูลเพิ่มเติม</h3>
                                <div className="flex items-center gap-4">
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded"><input type="checkbox" checked={form.wheelchair || false} onChange={e=>setForm({...form, wheelchair:e.target.checked})} className="scale-125 text-green-600 rounded"/> <span className="text-sm">นั่งรถเข็น</span></label>
                                </div>
                                <div className="flex items-center gap-3 flex-wrap">
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded"><input type="checkbox" checked={form.priorExam === 'Yes'} onChange={e => { const newVal = e.target.checked ? 'Yes' : 'No'; setForm({...form, priorExam: newVal, priorExamCount: newVal === 'No' ? 0 : form.priorExamCount}); }} className="scale-125 text-green-600 rounded"/> <span className="text-sm">เคยตรวจจอประสาทตา</span></label>
                                    {form.priorExam === 'Yes' && (<div className="flex items-center gap-2 animate-fade-in ml-2"><span className="text-sm text-gray-600">จำนวน:</span><input type="number" value={form.priorExamCount} onChange={e=>setForm({...form, priorExamCount:e.target.value})} className="w-16 p-1 border rounded text-sm text-center"/><span className="text-sm text-gray-600">ครั้ง</span></div>)}
                                </div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 className="text-sm font-bold text-gray-700 mb-3">ค่าสายตา (Visual Acuity)</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <select value={form.vaRight || ''} onChange={e=>setForm({...form, vaRight:e.target.value})} className="w-full p-2 border rounded text-sm"><option value="">ขวา (Right)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                    <select value={form.vaLeft || ''} onChange={e=>setForm({...form, vaLeft:e.target.value})} className="w-full p-2 border rounded text-sm"><option value="">ซ้าย (Left)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                </div>
                            </div>
                            <button onClick={save} disabled={saving} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">{saving ? 'บันทึก...' : 'บันทึกและส่งตัว'}</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [agencyCode, setAgencyCode] = useState(null);
            const [agencyName, setAgencyName] = useState(null);
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [agenciesMap, setAgenciesMap] = useState({});
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [modal, setModal] = useState({ visible: false, title: '', message: '', onConfirm: null });
            
            const [currentDate, setCurrentDate] = useState(getTodayStr());

            // [ADDED] Quick Add State for passing search term
            const [quickAddId, setQuickAddId] = useState('');

            // [ADDED] ดึงข้อมูลผู้ป่วยแบบ Real-time จาก ID ที่เลือก เพื่อให้ได้ข้อมูลล่าสุดเสมอ (เช่น history ที่เพิ่ง import)
            const activePatient = useMemo(() => {
                if (!selectedPatient) return null;
                return patients.find(p => p.id === selectedPatient.id) || selectedPatient;
            }, [patients, selectedPatient]);

            useEffect(() => {
                return auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u && u.email) {
                        const code = u.email.split('@')[0];
                        setAgencyCode(code);
                        if (code === '20000') {
                            setRole('FOOT'); setAgencyName('คลินิกเท้าเบาหวาน'); setView('foot_dashboard');
                        } else if (code === '10700') { 
                            setRole('HOSPITAL'); setAgencyName('โรงพยาบาลศรีสะเกษ'); setView('dashboard');
                        } else { 
                            setRole('PCU'); setAgencyName(STATIC_PCU_DATA[code] || `PCU ${code}`); setView('dashboard');
                        }
                    } else { setRole(null); setAgencyCode(null); }
                });
            }, []); 

            useEffect(() => {
                if(!user || !role) return;
                const collection = getCollection('patients_referrals');
                const unsub = collection.onSnapshot(snap => {
                    const newPatients = snap.docs.map(d => { 
                        const data = d.data(); 
                        return { id: d.id, ...data, createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt) }; 
                    });
                    // [MODIFIED] เรียงลำดับจาก "เก่าไปใหม่" (ใครมาก่อนอยู่อันดับ 1, 2, 3...)
                    // ใช้ a - b แทน b - a
                    newPatients.sort((a, b) => (a.createdAt?.getTime() || 0) - (b.createdAt?.getTime() || 0));
                    setPatients(newPatients);
                });
                return () => unsub();
            }, [user, role, agencyCode]);

            useEffect(() => {
                if(!user) return;
                const collection = getCollection('agencies');
                const unsub = collection.onSnapshot(snap => {
                    const map = {}; snap.docs.forEach(d => map[d.id] = d.data().name); setAgenciesMap(map);
                    if (role === 'PCU' && agencyCode && map[agencyCode]) setAgencyName(map[agencyCode]);
                });
                return () => unsub();
            }, [user, role, agencyCode]);

            if(!role) return <AuthScreen />;

            if (role === 'FOOT') {
                return (
                    <div className="max-w-5xl mx-auto p-4">
                        <nav className="flex justify-between items-center mb-6 bg-white p-3 rounded-xl shadow-md sticky top-4 z-10">
                            <h1 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="footprints" size={20} className="text-pink-600"/> EyeDM Foot Clinic</h1>
                            <button onClick={()=>auth.signOut()} className="text-gray-500 hover:text-red-600"><Icon name="log-out" size={18}/></button>
                        </nav>
                        <QueueStatusBar patients={patients} role={role} agencyCode={agencyCode} selectedDate={currentDate} />
                        {/* ใช้ activePatient แทน selectedPatient */}
                        {view === 'foot_dashboard' && <FootDashboard patients={patients} agenciesMap={agenciesMap} onSelect={(p)=>{setSelectedPatient(p);setView('foot_form');}} selectedDate={currentDate} setSelectedDate={setCurrentDate} />}
                        {view === 'foot_form' && activePatient && <FootForm patient={activePatient} onBack={()=>{setSelectedPatient(null);setView('foot_dashboard');}} setModal={setModal} />}
                        <MessageModal modal={modal} setModal={setModal} />
                    </div>
                );
            }

            return (
                <div className="max-w-5xl mx-auto p-4">
                    <nav className="flex justify-between items-center mb-6 bg-white p-3 rounded-xl shadow-md sticky top-4 z-10">
                        <h1 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="activity" size={20} className="text-blue-600"/> EyeDM Connect ({role})</h1>
                        <div className="flex gap-2">{role === 'HOSPITAL' && <button onClick={() => setView('admin_home')} className="text-gray-500 hover:text-blue-600"><Icon name="settings" size={18}/></button>}<button onClick={()=>auth.signOut()} className="text-gray-500 hover:text-red-600"><Icon name="log-out" size={18}/></button></div>
                    </nav>
                    <QueueStatusBar patients={patients} role={role} agencyCode={agencyCode} selectedDate={currentDate} />
                    {view === 'dashboard' && <Dashboard 
                        role={role} 
                        agencyCode={agencyCode} 
                        agencyName={agencyName} 
                        agenciesMap={agenciesMap} 
                        patients={patients} 
                        onNew={(searchTerm) => {
                            // [MODIFIED] รับค่า search term จาก dashboard เพื่อ pre-fill
                            if (typeof searchTerm === 'string' && /^\d{13}$/.test(searchTerm)) {
                                setQuickAddId(searchTerm);
                            } else {
                                setQuickAddId('');
                            }
                            setView('pcu_form');
                            setSelectedPatient(null);
                        }} 
                        onEdit={(p)=>{
                            setQuickAddId(''); // Clear quick add ID when editing
                            setSelectedPatient(p);
                            setView('pcu_form');
                        }} 
                        onSelect={(p)=>{setSelectedPatient(p);setView('hospital');}} 
                        setModal={setModal} 
                        selectedDate={currentDate} 
                        setSelectedDate={setCurrentDate} 
                    />}
                    
                    {/* ใช้ activePatient แทน selectedPatient เพื่อให้ข้อมูล history อัปเดตทันที */}
                    {/* [MODIFIED] Pass quickAddId as initialId */}
                    {view === 'pcu_form' && activePatient && <PCUForm onBack={()=>{setSelectedPatient(null);setView('dashboard');}} existingPatients={patients} setModal={setModal} patientToEdit={activePatient} agencyCode={agencyCode} />}
                    {view === 'pcu_form' && !activePatient && <PCUForm onBack={()=>{setSelectedPatient(null);setView('dashboard');}} existingPatients={patients} setModal={setModal} patientToEdit={null} agencyCode={agencyCode} initialId={quickAddId} />}
                    
                    {view === 'hospital' && activePatient && <HospitalForm patient={activePatient} patients={patients} role={role} onBack={()=>{setSelectedPatient(null);setView('dashboard');}} setModal={setModal} />}
                    
                    {role === 'HOSPITAL' && view === 'admin_home' && <AdminHome onNavigate={setView} />}
                    {role === 'HOSPITAL' && view === 'manage_agencies' && <ManageAgencies onBack={setView} agenciesMap={agenciesMap} />}
                    {role === 'HOSPITAL' && view === 'import_csv' && <HospitalImport onBack={setView} setModal={setModal} />}
                    {role === 'HOSPITAL' && view === 'reports' && <ReportsPage onBack={() => setView('admin_home')} patients={patients} agenciesMap={agenciesMap} />}
                    <MessageModal modal={modal} setModal={setModal} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
