<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลผู้ป่วยเบาหวาน</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load SheetJS (xlsx.js) for Excel Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .font-['Inter'] {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better visibility */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
        }
    </style>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,     
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc,
            addDoc,
            setDoc,
            deleteDoc,  
            setLogLevel, 
            query,      
            where,      
            getDocs,
            getDoc,
            collection,
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- START: Configuration (Using Canvas Globals) ---
        const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        // Fallback Config to prevent Firebase Config Error
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
            ? JSON.parse(__firebase_config)
            : { apiKey: "FAKE_API_KEY", authDomain: "fake.firebaseapp.com", projectId: "fake-project" };
        
        // **Hardcoded Staff Name Mapping (Updated based on user image)**
        const STAFF_MAPPING = {
            // รพ.สต. และ ศูนย์สุขภาพชุมชน
            "03277": "รพ.สต.ตำบลดูนฮูด",
            "03278": "รพ.สต.ตำบลบ้านแหง",
            "03279": "รพ.สต.ตำบลกุจิง",
            "03280": "รพ.สต.ตำบลตะค่อม",
            "03281": "รพ.สต.บ้านหนองครก",
            "03282": "รพ.สต.บ้านกุดโง้ง",
            "03283": "รพ.สต.ตำบลบ้านกลาง",
            "03284": "รพ.สต.ตำบลบ้านหนองแวง",
            "03285": "รพ.สต.ตำบลบ้านสร้างเรื่อง",
            "03286": "รพ.สต.ตำบลบ้านโนนแกด",
            "03287": "รพ.สต.ตำบลบ้านหนองฮู",
            "03288": "รพ.สต.ตำบลบ้านหนองแก้ว",
            "12019": "รพ.สต.บ้านหนองแก้ว (ID 12019)", 
            "03289": "รพ.สต.ตำบลบ้านน้ำคำ",
            "03290": "รพ.สต.ตำบลบ้านหนองโน",
            "123456": "รพ.สต.บ้านหนองโน (ID 123456)",
            "03291": "รพ.สต.ตำบลบ้านโพธิ์",
            "03292": "รพ.สต.ตำบลบ้านค้อเหลือง",
            "03293": "รพ.สต.ตำบลบ้านหนองไผ่",
            "14422": "ศูนย์บริการสาธารณสุข 2",
            "15204": "ศูนย์บริการสาธารณสุข 3",
            "21986": "ศูนย์บริการสาธารณสุข 4",
            "23954": "ศูนย์บริการสาธารณสุข 5",
            
            // ADMIN / โรงพยาบาล
            "10700": "โรงพยาบาลศรีสะเกษ (Admin)", // โรงพยาบาลศรีสะเกษ
            "77475": "ศูนย์สุขภาพชุมชนเขตเมือง รพ.ศรีสะเกษ (Admin)",
            "99999": "ฝ่ายไอทีโรงพยาบาล",
        };

        const ADMIN_IDS = ["10700", "77475", "99999"]; // กำหนด ID ที่ถือเป็น Admin

        let app, db, auth;
        let isFirebaseReady = false; 
        let currentUserId = null;
        let currentStaffName = null;
        let currentStaffId = null;
        let currentView = 'pcu_form'; 
        let currentRecordDocId = null; 
        let isAdmin = false; 
        let queueUnsubscribe = null; // Holds the unsubscribe function for the queue listener

        // --- END: Configuration ---
        
        
        // --- Firebase Initialization ---
        setLogLevel('Debug');

        async function initializeFirebase(config) {
            try {
                if (config && config.apiKey && config.apiKey !== "FAKE_API_KEY") {
                    app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Initial Firebase Auth failed:", e);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            isFirebaseReady = true;
                            currentUserId = user.uid;
                            
                            // Only show modal if no role has been selected yet
                            if (!currentStaffName) { 
                                document.getElementById('login-modal').classList.remove('hidden');
                                document.getElementById('staff-name-display').textContent = 'กรุณาเลือกบทบาทเจ้าหน้าที่';
                            } 

                        } else {
                            isFirebaseReady = false;
                            currentUserId = null;
                            currentStaffName = null;
                            cleanupListeners(); // Cleanup on sign out
                            displayUserId(null); 
                            document.getElementById('login-modal').classList.remove('hidden');
                            document.getElementById('main-app-content').classList.add('opacity-20', 'pointer-events-none');
                        }
                    });
                } else {
                    // Handle FAKE_API_KEY case for smooth UI startup
                    // Set to true so UI loads, but db remains undefined
                    isFirebaseReady = true; 
                    document.getElementById('login-modal').classList.remove('hidden');
                }
                
                // Ensure content is clickable when ready, even if role not selected yet
                document.getElementById('main-app-content').classList.remove('opacity-20', 'pointer-events-none');
                document.getElementById('fatal-error-box').classList.add('hidden');
            } catch (error) {
                console.error("Firebase Initialization failed:", error);
                displayFatalError("Firebase Init Error", `เชื่อมต่อล้มเหลว: ${error.message}`);
            }
        }

        // Function to clean up all active listeners
        function cleanupListeners() {
            if (queueUnsubscribe) {
                queueUnsubscribe();
                queueUnsubscribe = null;
            }
        }
        
        // Login Function (Role Selection)
        function handleLogin() { 
            const userIdInput = document.getElementById('login-user-id').value.trim();
            const loginStatus = document.getElementById('login-status');
            const loginButton = document.getElementById('login-button');

            if (!userIdInput) {
                loginStatus.textContent = "กรุณากรอกชื่อผู้ใช้";
                return;
            }
            
            loginButton.disabled = true;
            loginStatus.textContent = 'กำลังกำหนดบทบาท...'; 

            try {
                currentStaffId = userIdInput;
                // Use mapping name or fallback
                currentStaffName = STAFF_MAPPING[currentStaffId] || `Admin/รพ. (ID: ${currentStaffId})`; 
                
                // Determine access rights and initial view
                isAdmin = ADMIN_IDS.includes(currentStaffId); // Use new Admin check
                currentView = isAdmin ? 'daily_queue' : 'pcu_form';
                
                // FIX: Check if auth object exists before accessing currentUser
                displayUserId(auth ? auth.currentUser : null); 

                renderView(currentView);
                validateSaveButton();
                
                loginStatus.textContent = `เข้าสู่ระบบในฐานะ: ${currentStaffName} (สำเร็จ)`;
                
                // Hide modal immediately for better user experience
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('opacity-20', 'pointer-events-none');


            } catch (error) {
                console.error("Role Selection Error:", error);
                loginStatus.textContent = `เกิดข้อผิดพลาดในการกำหนดบทบาท: ${error.message}`;
            } finally {
                // Ensure button is always re-enabled
                loginButton.disabled = false;
            }
        }
        
        // Logout Function (Role reset)
        async function handleLogout() {
             try {
                cleanupListeners(); // Ensure listeners are cleaned up
                currentStaffName = null; 
                currentStaffId = null;
                isAdmin = false;
                document.getElementById('login-user-id').value = "";
                document.getElementById('login-password').value = ""; 
                
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('main-app-content').classList.add('opacity-20', 'pointer-events-none');
                displayUserId(null);
             } catch (error) {
                 console.error("Logout FAILED:", error);
                 displayMessage(`ออกจากระบบล้มเหลว: ${error.message}`, 'error');
             }
        }
        
        // View Rendering
        function renderView(viewName) {
            cleanupListeners(); // Always cleanup when changing views
            currentView = viewName;
            
            // Hide all views
            ['pcu_form_view', 'daily_queue_view', 'admin_view_view'].forEach(id => 
                document.getElementById(id).classList.add('hidden')
            );
            // Remove active class from all navs
            ['nav-pcu_form', 'nav-daily_queue', 'nav-admin_view'].forEach(id => 
                document.getElementById(id).classList.remove('bg-blue-600', 'text-white')
            );

            // Show current view and set active nav
            document.getElementById(viewName + '_view').classList.remove('hidden');
            document.getElementById('nav-' + viewName).classList.add('bg-blue-600', 'text-white');
            
            if (viewName === 'daily_queue') {
                fetchAndRenderQueue(); // This now sets up the real-time listener
            }

            // Show/Hide Admin button based on role
            document.getElementById('nav-admin_view').classList.toggle('hidden', !isAdmin);
        }

        // Helper to get element value/checked state safely
        const getElementValue = (id) => document.getElementById(id)?.value || '';
        const getElementNumber = (id) => Number(document.getElementById(id)?.value) || null;
        const getElementChecked = (id) => document.getElementById(id)?.checked || false;

        // Populate Form (Used by PCU Autocomplete, PCU Edit, Admin Edit, Admin Search)
        function populateForm(data, prefix = '') {
            currentRecordDocId = data.docId || null;
            
            // --- Section 1 ---
            document.getElementById(prefix + 'patient-id').value = data.patientId || '';
            document.getElementById(prefix + 'patient-name').value = data.patientName || '';
            document.getElementById(prefix + 'diabetes-years').value = data.diabetesYears || '';
            document.getElementById(prefix + 'hba1c').value = data.hba1c || '';
            document.getElementById(prefix + 'blood-pressure').value = data.bloodPressure || '';
            document.getElementById(prefix + 'weight').value = data.weight || '';
            document.getElementById(prefix + 'height').value = data.height || '';
            document.getElementById(prefix + 'va-od').value = data.vaOD || '';
            document.getElementById(prefix + 'va-os').value = data.vaOS || '';
            document.getElementById(prefix + 'is-wheelchair').checked = data.isWheelchair || false;
            const hasExam = data.hasPreviousExam || false;
            document.getElementById(prefix + 'has-previous-exam').checked = hasExam;
            togglePreviousExamCount(hasExam, prefix);
            document.getElementById(prefix + 'previous-exam-count').value = data.previousExamCount || '';
            
            // --- Sections 2 & 3 (Admin Only) ---
            if (prefix === 'admin-') {
                document.getElementById('admin-has-cataract').checked = data.hasCataract || false;
                document.getElementById('admin-hearing-clear').checked = data.hearingClear || false;
                document.getElementById('admin-can-sit-chair').checked = data.canSitChair || false;
                document.getElementById('admin-needs-eyelid-lift').checked = data.needsEyelidLift || false;

                // Populate Findings Checkboxes
                const findingKeys = ['normal', 'microaneurysm', 'hardexudate', 'flame', 'venous', 'irma', 'newvessel', 'preretinal', 'vitreous', 'fibrous'];
                const findings = data.findings || {};
                findingKeys.forEach(key => {
                    // Check for key case sensitivity in existing data and use defaults
                    const findingsKeyMap = {
                        'microaneurysm': findings.microaneurysm, 
                        'hardexudate': findings.hardExudate, 
                        'flame': findings.flameHemorrhage, 
                        'venous': findings.venousBeading,
                        'irma': findings.irma,
                        'newvessel': findings.newVessel,
                        'preretinal': findings.preretinalHemorrhage,
                        'vitreous': findings.vitreousHemorrhage,
                        'fibrous': findings.fibrousProliferation,
                        'normal': findings.normal,
                    };
                    const currentFinding = findingsKeyMap[key] || {};

                    const orEl = document.getElementById(`admin-finding-${key}-or`);
                    const olEl = document.getElementById(`admin-finding-${key}-ol`);
                    if (orEl) orEl.checked = currentFinding.or || false;
                    if (olEl) olEl.checked = currentFinding.ol || false;
                });

                document.getElementById('admin-referral-needed').checked = data.referralNeeded || false;
            }

            const resultsContainer = document.getElementById('autocomplete-results');
            if (resultsContainer) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
            }
            validateSaveButton();
            hideMessage();
        }

        // Clear Form (Used by PCU and Admin)
        function clearForm(prefix = '') {
            currentRecordDocId = null;
            const formElements = document.querySelectorAll(`[id^="${prefix}"]`);

            formElements.forEach(el => {
                const id = el.id;
                if (id.startsWith(prefix + 'patient-id') || id.startsWith(prefix + 'patient-name') || id.startsWith(prefix + 'diabetes-years')) {
                    el.value = '';
                } else if (el.tagName === 'INPUT' && el.type === 'number') {
                    el.value = ''; 
                } else if (el.tagName === 'INPUT' && el.type === 'text') {
                    el.value = '';
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else if (el.tagName === 'INPUT' && el.type === 'checkbox') {
                    el.checked = false;
                }
            });

            togglePreviousExamCount(false, prefix);
            hideMessage();
            if (prefix === '') { // Only for PCU form
                document.getElementById('autocomplete-results')?.classList.add('hidden');
            } else if (prefix === 'admin-') {
                 document.getElementById('admin-edit-form-container')?.classList.remove('hidden'); // Show form but clear data
                 document.getElementById('search-status').textContent = 'กรุณาป้อนเลข 13 หลักเพื่อค้นหาประวัติ';
            }
            validateSaveButton();
        }

        // Function to handle autocomplete selection for PCU
        function handleAutocompleteSelect(patientData) {
            populateForm({ ...patientData, docId: patientData.docId }, ''); 
            displayMessage(`โหลดข้อมูลผู้ป่วยสำเร็จ (Record ID: ${patientData.docId}). หากบันทึกอีกครั้งจะเป็นการอัปเดต`, 'success');
        }

        // Function to toggle previous exam count visibility
        function togglePreviousExamCount(isChecked, prefix = '') {
            const container = document.getElementById(prefix + 'previous-exam-count-container');
            if (container) {
                if (isChecked) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                    const inputEl = document.getElementById(prefix + 'previous-exam-count');
                    if (inputEl) inputEl.value = '';
                }
            }
        }
        
        // --- PCU Save/Update Record Function ---
        async function savePatientData() {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady || !currentStaffId) { 
                displayMessage('กรุณาเลือกบทบาทเจ้าหน้าที่และล็อกอินก่อนบันทึกข้อมูล', 'error');
                return;
            }
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const uploaderInfo = `${currentStaffId}_${currentUserId || 'anonymous'}`; 
            
            const patientId = getElementValue('patient-id');
            const patientName = getElementValue('patient-name');
            
            if (patientId.length !== 13 || !/^\d+$/.test(patientId) || patientName.trim() === '') {
                 displayMessage('กรุณากรอกเลขบัตรประชาชน 13 หลักและชื่อผู้ป่วยให้ถูกต้อง', 'error');
                 return;
            }
            
            const saveButton = document.getElementById('save-button');
            const buttonText = document.getElementById('save-button-text');
            const spinner = document.getElementById('save-spinner');
            saveButton.disabled = true;
            buttonText.textContent = 'กำลังบันทึก...';
            spinner.classList.remove('hidden');
            hideMessage();
            
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            let successMessage = "";
            
            try {
                // 1. Prepare Data (Only Section 1 + Defaults for 2 & 3)
                const recordData = {
                    patientId: patientId,
                    patientName: patientName,
                    diabetesYears: getElementNumber('diabetes-years'),
                    hba1c: getElementValue('hba1c'),
                    bloodPressure: getElementValue('blood-pressure'),
                    weight: getElementNumber('weight'),
                    height: getElementNumber('height'),
                    vaOD: getElementValue('va-od'),
                    vaOS: getElementValue('va-os'),
                    isWheelchair: getElementChecked('is-wheelchair'),
                    hasPreviousExam: getElementChecked('has-previous-exam'),
                    previousExamCount: getElementChecked('has-previous-exam') ? getElementNumber('previous-exam-count') : null,
                    // Sections 2 & 3 Defaults 
                    hasCataract: false, hearingClear: false, canSitChair: false, needsEyelidLift: false, findings: {}, referralNeeded: false,
                    // Metadata
                    updatedTimestamp: new Date().toISOString(), 
                };

                if (currentRecordDocId) {
                    // --- Update Existing Record ---
                    const docRef = doc(db, collectionPath, currentRecordDocId);
                    
                    // We need to fetch existing data to preserve Sections 2/3 
                    const existingDoc = await getDoc(docRef);
                    const existingData = existingDoc.exists() ? existingDoc.data() : {};
                    
                    const updateData = {
                        ...existingData, 
                        ...recordData,
                        // Ensure original metadata is preserved unless explicitly updating
                        uploaderId: existingData.uploaderId, 
                        queueNumber: existingData.queueNumber,
                        // Only update the PCU-editable fields 
                        diabetesYears: recordData.diabetesYears,
                        hba1c: recordData.hba1c,
                        bloodPressure: recordData.bloodPressure,
                        weight: recordData.weight,
                        height: recordData.height,
                        vaOD: recordData.vaOD,
                        vaOS: recordData.vaOS,
                        isWheelchair: recordData.isWheelchair,
                        hasPreviousExam: recordData.hasPreviousExam,
                        previousExamCount: recordData.previousExamCount,
                        updatedTimestamp: recordData.updatedTimestamp,
                    };

                    await setDoc(docRef, updateData);
                    successMessage = `อัปเดตข้อมูลผู้ป่วย ${patientName} สำเร็จ!`;

                } else {
                    // --- Add New Record ---
                    
                    // 2. Calculate Daily Queue Number
                    // IMPORTANT: We use getDocs here to calculate the queue number before saving the new document
                    const allRecordsSnapshot = await getDocs(query(collection(db, collectionPath)));
                    const todayDateISO = new Date().toISOString().substring(0, 10);
                    let todayRecords = allRecordsSnapshot.docs.map(doc => doc.data()).filter(data => (data.timestamp || data.updatedTimestamp || '').startsWith(todayDateISO));
                    const newQueueNumber = todayRecords.length + 1; 

                    const newData = {
                        ...recordData,
                        timestamp: new Date().toISOString(),
                        uploaderId: uploaderInfo, 
                        queueNumber: newQueueNumber, 
                    };
                    
                    await addDoc(collection(db, collectionPath), newData);
                    successMessage = `บันทึกข้อมูลผู้ป่วยสำเร็จ! คิววันนี้คือ: #${newQueueNumber} (${patientName})`;
                }
                
                // 3. Display Message
                displayMessage(successMessage, 'success');
                clearForm(''); 
                
                // NEW: Switch to the queue view to show the result and activate the listener
                renderView('daily_queue'); 

            } catch (error) {
                console.error("Error saving patient data:", error);
                displayMessage(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`, 'error');
            } finally {
                // IMPORTANT: Ensure the button is always reset
                validateSaveButton(); 
                buttonText.textContent = currentRecordDocId ? 'อัปเดตข้อมูลผู้ป่วย' : 'บันทึกข้อมูลผู้ป่วยใหม่';
                spinner.classList.add('hidden');
                currentRecordDocId = null; // Clear docId after save/update
            }
        }

        // --- Admin Update Existing Record Function ---
        async function adminUpdateData() {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady || !currentRecordDocId) {
                displayMessage('ไม่พบ Record ID สำหรับการอัปเดต หรือ Firebase ไม่พร้อม', 'error');
                return;
            }
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const updateButton = document.getElementById('admin-update-button');
            const buttonText = document.getElementById('admin-update-button-text');
            const spinner = document.getElementById('admin-update-spinner');
            updateButton.disabled = true;
            buttonText.textContent = 'กำลังอัปเดต...';
            spinner.classList.remove('hidden');
            hideMessage();

            try {
                // 1. Prepare Full Data (Reading from 'admin-' prefixed fields)
                const updatedData = {
                    patientId: getElementValue('admin-patient-id'),
                    patientName: getElementValue('admin-patient-name'),
                    diabetesYears: getElementNumber('admin-diabetes-years'),
                    hba1c: getElementValue('admin-hba1c'),
                    bloodPressure: getElementValue('admin-blood-pressure'),
                    weight: getElementNumber('admin-weight'),
                    height: getElementNumber('admin-height'),
                    vaOD: getElementValue('admin-va-od'),
                    vaOS: getElementValue('admin-va-os'),
                    isWheelchair: getElementChecked('admin-is-wheelchair'),
                    hasPreviousExam: getElementChecked('admin-has-previous-exam'),
                    previousExamCount: getElementChecked('admin-has-previous-exam') ? getElementNumber('admin-previous-exam-count') : null,
                    hasCataract: getElementChecked('admin-has-cataract'),
                    hearingClear: getElementChecked('admin-hearing-clear'),
                    canSitChair: getElementChecked('admin-can-sit-chair'),
                    needsEyelidLift: getElementChecked('admin-needs-eyelid-lift'),
                    findings: {
                        normal: { or: getElementChecked('admin-finding-normal-or'), ol: getElementChecked('admin-finding-normal-ol') },
                        microaneurysm: { or: getElementChecked('admin-finding-microaneurysm-or'), ol: getElementChecked('admin-finding-microaneurysm-ol') },
                        hardExudate: { or: getElementChecked('admin-finding-hardexudate-or'), ol: getElementChecked('admin-finding-hardexudate-ol') },
                        flameHemorrhage: { or: getElementChecked('admin-finding-flame-or'), ol: getElementChecked('admin-finding-flame-ol') },
                        venousBeading: { or: getElementChecked('admin-finding-venous-or'), ol: getElementChecked('admin-finding-venous-ol') },
                        irma: { or: getElementChecked('admin-finding-irma-or'), ol: getElementChecked('admin-finding-irma-ol') },
                        newVessel: { or: getElementChecked('admin-finding-newvessel-or'), ol: getElementChecked('admin-finding-newvessel-ol') },
                        preretinalHemorrhage: { or: getElementChecked('admin-finding-preretinal-or'), ol: getElementChecked('admin-finding-preretinal-ol') },
                        vitreousHemorrhage: { or: getElementChecked('admin-finding-vitreous-or'), ol: getElementChecked('admin-finding-vitreous-ol') },
                        fibrousProliferation: { or: getElementChecked('admin-finding-fibrous-or'), ol: getElementChecked('admin-finding-fibrous-ol') }
                    },
                    referralNeeded: getElementChecked('admin-referral-needed'),
                    updatedTimestamp: new Date().toISOString(), 
                };
                
                // Get existing record to preserve uneditable metadata like original timestamp/uploader
                const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                const docRef = doc(db, collectionPath, currentRecordDocId);
                const existingDoc = await getDoc(docRef);
                const existingData = existingDoc.exists() ? existingDoc.data() : {};

                // 2. Update Data in Firestore (Merge)
                const finalUpdate = {
                    ...existingData, // Preserve timestamp, uploaderId, queueNumber
                    ...updatedData,  // Overwrite everything else
                    // Ensure patient ID/Name are also preserved from form
                    patientId: updatedData.patientId,
                    patientName: updatedData.patientName,
                };
                
                await setDoc(docRef, finalUpdate);

                displayMessage(`อัปเดตข้อมูลผู้ป่วย ${updatedData.patientName} สำเร็จ!`, 'success');
                clearForm('admin-');
                
            } catch (error) {
                console.error("Error updating patient data:", error);
                displayMessage(`เกิดข้อผิดพลาดในการอัปเดต: ${error.message}`, 'error');
            } finally {
                updateButton.disabled = false;
                buttonText.textContent = 'อัปเดตข้อมูลผู้ป่วย';
                spinner.classList.add('hidden');
            }
        }

        // --- Custom Confirmation Modal Logic ---
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('custom-confirm-title').textContent = title;
            document.getElementById('custom-confirm-message').textContent = message;

            const modal = document.getElementById('custom-confirm-modal');
            modal.classList.remove('hidden');

            const confirmBtn = document.getElementById('confirm-action-button');
            const cancelBtn = document.getElementById('cancel-action-button');

            // Clear previous listeners (important)
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;

            // Set new listeners
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };

            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // --- Delete Record Function (Admin Only) ---
        async function handleDeleteQueueItem(docId, patientName) {
            // CRITICAL FIX: Check if db is initialized
            if (!isAdmin) {
                displayMessage('ไม่มีสิทธิ์ลบข้อมูล', 'error');
                return;
            }
             if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            
            // Use custom modal instead of window.confirm()
            showConfirmModal(
                'ยืนยันการลบข้อมูล',
                `คุณแน่ใจหรือไม่ที่จะลบข้อมูลของผู้ป่วย: ${patientName} ออกจากคิว? การดำเนินการนี้ไม่สามารถยกเลิกได้`,
                async () => {
                    try {
                        const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                        const docRef = doc(db, collection(db, collectionPath).path, docId);
                        await deleteDoc(docRef);
                        displayMessage(`ลบข้อมูลของ ${patientName} สำเร็จ`, 'success');
                        // No need to manually refresh, onSnapshot handles it
                    } catch (error) {
                        console.error("Error deleting document:", error);
                        displayMessage(`เกิดข้อผิดพลาดในการลบ: ${error.message}`, 'error');
                    }
                }
            );
        }
        window.handleDeleteQueueItem = handleDeleteQueueItem; // Make function accessible from inline HTML

        // --- Edit Record Function (All Roles) ---
        async function handleEditQueueItem(docId, role) {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady) return;
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            
            try {
                 const docRef = doc(db, collection(db, collectionPath).path, docId);
                 const record = await getDoc(docRef);
                 
                 if (record.exists()) {
                     const data = { docId: record.id, ...record.data() };
                     
                     if (role === 'admin') {
                         renderView('admin_view');
                         populateForm(data, 'admin-');
                         document.getElementById('admin-edit-form-container').classList.remove('hidden');
                         document.getElementById('search-status').textContent = `กำลังแก้ไขข้อมูล Record ID: ${data.docId}`;
                         document.getElementById('admin-update-button-text').textContent = 'อัปเดตข้อมูลผู้ป่วย'; // Ensure update button is ready
                     } else { // PCU Role
                         // Check if PCU is the original uploader (optional extra security, currently not implemented)
                         renderView('pcu_form');
                         populateForm(data, '');
                         document.getElementById('save-button-text').textContent = 'อัปเดตข้อมูลผู้ป่วย'; // Change button text to indicate update
                         displayMessage(`กำลังแก้ไขข้อมูลผู้ป่วย ${data.patientName} (เฉพาะส่วนที่ 1). กด "อัปเดต" เพื่อบันทึก`, 'info');
                     }
                 } else {
                     displayMessage('ไม่พบ Record ID ที่ต้องการโหลด', 'error');
                 }
            } catch (error) {
                console.error("Error loading specific record for edit:", error);
                displayMessage(`ข้อผิดพลาดในการโหลด: ${error.message}`, 'error');
            }
        }
        window.handleEditQueueItem = handleEditQueueItem; // Make function accessible from inline HTML

        // Fetch and Render Queue (Now Real-time using onSnapshot)
        function fetchAndRenderQueue() {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady || !currentStaffId) return;
            if (!db) {
                 document.getElementById('queue-list').innerHTML = '<li class="p-4 text-center text-red-500">ไม่สามารถเชื่อมต่อฐานข้อมูลได้</li>';
                 return;
            }
            
            const queueList = document.getElementById('queue-list');
            queueList.innerHTML = '<li class="p-4 text-center text-gray-500">กำลังโหลดคิว...</li>';
            
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            const q = query(collection(db, collectionPath));
            
            const today = new Date();
            const todayDateISO = today.toISOString().substring(0, 10);
            
            // Set the date display once
            document.getElementById('queue-date').textContent = new Date().toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });

            // Start real-time listener and store the unsubscribe function
            queueUnsubscribe = onSnapshot(q, (snapshot) => {
                let todayRecords = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if ((data.timestamp || data.updatedTimestamp || '').startsWith(todayDateISO)) {
                         todayRecords.push({ docId: doc.id, ...data });
                    }
                });

                // Sort in memory by queueNumber
                todayRecords.sort((a, b) => (a.queueNumber || 0) - (b.queueNumber || 0));
                
                queueList.innerHTML = '';
                if (todayRecords.length === 0) {
                    queueList.innerHTML = '<li class="p-4 text-center text-gray-500">ไม่พบผู้ป่วยในคิววันนี้</li>';
                } else {
                    todayRecords.forEach(record => {
                        const staffUploaderId = record.uploaderId || '';
                        const staffIdMatch = staffUploaderId.match(/^(\d+)_/);
                        const staffId = staffIdMatch ? staffIdMatch[1] : 'N/A';
                        const staffName = STAFF_MAPPING[staffId] || staffId;
                        
                        const actionsHtml = `
                            <div class="flex space-x-2 mt-2 sm:mt-0">
                                <button onclick="handleEditQueueItem('${record.docId}', '${isAdmin ? 'admin' : 'pcu'}')" 
                                    class="px-3 py-1 text-xs font-semibold bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                                    แก้ไข
                                </button>
                                ${isAdmin ? `
                                <button onclick="handleDeleteQueueItem('${record.docId}', '${record.patientName}')" 
                                    class="px-3 py-1 text-xs font-semibold bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                                    ลบ
                                </button>
                                ` : ''}
                            </div>
                        `;

                        queueList.innerHTML += `
                            <li class="p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-gray-200 last:border-b-0 hover:bg-white transition duration-150">
                                <span class="text-3xl font-extrabold text-blue-600 w-full sm:w-16 mb-2 sm:mb-0">#${record.queueNumber || 'N/A'}</span>
                                <div class="flex-grow">
                                    <p class="text-lg font-semibold text-gray-800">${record.patientName}</p>
                                    <p class="text-sm text-gray-500">รพ.สต. ผู้บันทึก: ${staffName}</p>
                                </div>
                                <div class="flex flex-col items-start sm:items-end">
                                    <span class="text-sm text-gray-400">${record.patientId}</span>
                                    ${actionsHtml}
                                </div>
                            </li>
                        `;
                    });
                }
            }, (error) => {
                console.error("Error fetching real-time queue:", error);
                queueList.innerHTML = `<li class="p-4 text-center text-red-500">ข้อผิดพลาดในการโหลดคิว: ${error.message}</li>`;
            });
        }
        // --- Export to Excel Function (Admin View) ---
        async function exportDailyDataToExcel() {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady || !isAdmin) {
                displayMessage('ไม่มีสิทธิ์ส่งออกข้อมูล', 'error');
                return;
            }
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const exportDate = getElementValue('export-date');
            const exportButton = document.getElementById('export-button');
            const exportStatus = document.getElementById('export-status');

            if (!exportDate) {
                exportStatus.textContent = 'กรุณาเลือกวันที่ที่ต้องการส่งออกข้อมูล';
                return;
            }
            
            exportButton.disabled = true;
            exportStatus.textContent = 'กำลังดึงข้อมูล...';

            try {
                const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                const allRecordsSnapshot = await getDocs(query(collection(db, collectionPath)));
                
                let recordsToExport = [];
                allRecordsSnapshot.forEach(doc => {
                    const data = doc.data();
                    // Check timestamp or updatedTimestamp for matching the selected date
                    if ((data.timestamp || data.updatedTimestamp || '').startsWith(exportDate)) {
                        recordsToExport.push({ docId: doc.id, ...data });
                    }
                });

                if (recordsToExport.length === 0) {
                    exportStatus.textContent = `ไม่พบข้อมูลที่บันทึกในวันที่ ${exportDate}`;
                    exportButton.disabled = false;
                    return;
                }

                // Prepare CSV/Excel Header
                const headers = [
                    "คิว", "วันที่บันทึก", "รพ.สต. ผู้บันทึก", "เลขบัตรประชาชน", "ชื่อ-สกุล", 
                    "ป่วยเบาหวานปี", "HbA1C", "ความดัน", "น้ำหนัก (kg)", "ส่วนสูง (cm)", 
                    "VA (OD)", "VA (OS)", "นั่งรถเข็น", "เคยตรวจจอประสาทตา", "จำนวนครั้ง",
                    "ต้อกระจก", "การได้ยินชัดเจน", "นั่งเก้าอี้ตรวจได้", "ช่วยยกหนังตา", 
                    "Normal OR", "Normal OL", "Micro aneurysm OR", "Micro aneurysm OL", 
                    "Hard exudate OR", "Hard exudate OL", "Flame hemorrhage OR", "Flame hemorrhage OL", 
                    "Venous beading OR", "Venous beading OL", "IRMA OR", "IRMA OL",
                    "New vessel OR", "New vessel OL", "Preretinal hemorrhage OR", "Preretinal hemorrhage OL", 
                    "Vitreous hemorrhage OR", "Vitreous hemorrhage OL", "Fibrous proliferation OR", "Fibrous proliferation OL",
                    "ส่งต่อ"
                ];

                // Map data to rows
                const rows = recordsToExport.sort((a, b) => a.queueNumber - b.queueNumber).map(record => {
                    const staffUploaderId = record.uploaderId || '';
                    const staffIdMatch = staffUploaderId.match(/^(\d+)_/);
                    const staffId = staffIdMatch ? staffIdMatch[1] : 'N/A';
                    const staffName = STAFF_MAPPING[staffId] || staffId;
                    
                    // Handle findings mapping with case safety
                    const findings = record.findings || {};
                    const getFinding = (key) => {
                        const keyMap = {
                            'microaneurysm': findings.microaneurysm, 
                            'hardexudate': findings.hardExudate, 
                            'flame': findings.flameHemorrhage, 
                            'venous': findings.venousBeading,
                            'irma': findings.irma,
                            'newvessel': findings.newVessel,
                            'preretinal': findings.preretinalHemorrhage,
                            'vitreous': findings.vitreousHemorrhage,
                            'fibrous': findings.fibrousProliferation,
                            'normal': findings.normal,
                        };
                        return keyMap[key] || {};
                    };

                    return [
                        record.queueNumber || '',
                        new Date(record.timestamp || record.updatedTimestamp).toLocaleString('th-TH'),
                        staffName,
                        record.patientId || '',
                        record.patientName || '',
                        record.diabetesYears || '',
                        record.hba1c || '',
                        record.bloodPressure || '',
                        record.weight || '',
                        record.height || '',
                        record.vaOD || '',
                        record.vaOS || '',
                        record.isWheelchair ? 'ใช่' : 'ไม่',
                        record.hasPreviousExam ? 'ใช่' : 'ไม่',
                        record.previousExamCount || '',
                        record.hasCataract ? 'ใช่' : 'ไม่',
                        record.hearingClear ? 'ใช่' : 'ไม่',
                        record.canSitChair ? 'ใช่' : 'ไม่',
                        record.needsEyelidLift ? 'ใช่' : 'ไม่',
                        getFinding('normal').or ? 'ใช่' : 'ไม่',
                        getFinding('normal').ol ? 'ใช่' : 'ไม่',
                        getFinding('microaneurysm').or ? 'ใช่' : 'ไม่',
                        getFinding('microaneurysm').ol ? 'ใช่' : 'ไม่',
                        getFinding('hardexudate').or ? 'ใช่' : 'ไม่',
                        getFinding('hardexudate').ol ? 'ใช่' : 'ไม่',
                        getFinding('flame').or ? 'ใช่' : 'ไม่',
                        getFinding('flame').ol ? 'ใช่' : 'ไม่',
                        getFinding('venous').or ? 'ใช่' : 'ไม่',
                        getFinding('venous').ol ? 'ใช่' : 'ไม่',
                        getFinding('irma').or ? 'ใช่' : 'ไม่',
                        getFinding('irma').ol ? 'ใช่' : 'ไม่',
                        getFinding('newvessel').or ? 'ใช่' : 'ไม่',
                        getFinding('newvessel').ol ? 'ใช่' : 'ไม่',
                        getFinding('preretinal').or ? 'ใช่' : 'ไม่',
                        getFinding('preretinal').ol ? 'ใช่' : 'ไม่',
                        getFinding('vitreous').or ? 'ใช่' : 'ไม่',
                        getFinding('vitreous').ol ? 'ใช่' : 'ไม่',
                        getFinding('fibrous').or ? 'ใช่' : 'ไม่',
                        getFinding('fibrous').ol ? 'ใช่' : 'ไม่',
                        record.referralNeeded ? 'ใช่' : 'ไม่'
                    ];
                });

                // Convert to worksheet
                const dataForSheet = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");

                // Download file
                const filename = `Diabetic_Data_${exportDate}.xlsx`;
                XLSX.writeFile(wb, filename);

                exportStatus.textContent = `ส่งออกข้อมูล ${recordsToExport.length} รายการสำหรับวันที่ ${exportDate} สำเร็จ!`;

            } catch (error) {
                console.error("Error exporting data:", error);
                exportStatus.textContent = `เกิดข้อผิดพลาดในการส่งออก: ${error.message}`;
            } finally {
                exportButton.disabled = false;
            }
        }
        
        // --- General Helpers (kept from original) ---
        function displayFatalError(title, message) { 
            const errorBox = document.getElementById('fatal-error-box');
            if (errorBox) {
                document.getElementById('error-title').textContent = title;
                document.getElementById('error-message').textContent = message;
                errorBox.classList.remove('hidden');
            }
            document.getElementById('main-app-content').classList.add('opacity-20', 'pointer-events-none');
            document.getElementById('login-modal').classList.add('hidden');
        }
        function displayUserId(user, errorMessage = null) { 
            const logoutButton = document.getElementById('logout-button');
            const staffNameDisplay = document.getElementById('staff-name-display');

            if (errorMessage) {
                logoutButton.classList.add('hidden');
                staffNameDisplay.textContent = 'ไม่ได้เข้าสู่ระบบ';
            } else if (currentStaffName) {
                staffNameDisplay.innerHTML = `<span class="text-base font-bold text-blue-800">${currentStaffName}</span>`;
                logoutButton.classList.remove('hidden');
            } else {
                staffNameDisplay.textContent = 'กรุณาเลือกบทบาทเจ้าหน้าที่';
                logoutButton.classList.add('hidden');
            }
        }
        let searchTimeout;
        function debounce(func, delay = 300) { 
            return function(...args) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        const debouncedSearchPatient = debounce(async () => {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady) return; 
            if (!db) return;
            
            validateSaveButton(); 
            const searchId = getElementValue('patient-id');
            const resultsContainer = document.getElementById('autocomplete-results');
            if (searchId.length < 5) {
                resultsContainer?.classList.add('hidden');
                return;
            }
            
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`; 
            // Query for partial match - Note: requires Firestore indices
            const q = query(
                collection(db, collectionPath),
                where("patientId", ">=", searchId),
                where("patientId", "<=", searchId + '\uf8ff')
            );
            try {
                const querySnapshot = await getDocs(q);
                const patientMap = new Map();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Use patientId as key and keep the latest record based on timestamp
                    const timestampToUse = new Date(data.timestamp || data.updatedTimestamp || 0).getTime();
                    // If no existing map entry, or current record is newer, update map
                    if (!patientMap.has(data.patientId) || timestampToUse > new Date(patientMap.get(data.patientId).timestamp || patientMap.get(data.patientId).updatedTimestamp || 0).getTime()) {
                         patientMap.set(data.patientId, { docId: doc.id, ...data });
                    }
                });
                
                const patientList = Array.from(patientMap.values()).sort((a, b) => a.patientId.localeCompare(b.patientId));
                
                resultsContainer.innerHTML = ''; 
                if (patientList.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">ไม่พบข้อมูล</div>';
                } else {
                    patientList.forEach((patientData) => {
                        const item = document.createElement('div');
                        item.className = 'p-2 text-sm text-gray-800 hover:bg-blue-100 cursor-pointer';
                        const staffUploaderId = patientData.uploaderId || '';
                        const staffIdMatch = staffUploaderId.match(/^(\d+)_/);
                        const staffInfo = staffIdMatch ? STAFF_MAPPING[staffIdMatch[1]] || staffIdMatch[1] : 'N/A';
                        item.textContent = `${patientData.patientId} - ${patientData.patientName} (บันทึกโดย ${staffInfo})`;
                        item.onclick = (e) => {
                            e.stopPropagation(); 
                            handleAutocompleteSelect(patientData);
                        };
                        resultsContainer.appendChild(item);
                    });
                }
                resultsContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Error during partial search:", error);
                resultsContainer.innerHTML = '<div class="p-2 text-red-500 text-sm">เกิดข้อผิดพลาด</div>';
                resultsContainer.classList.remove('hidden');
            }
        }, 300);
        
        function validateSaveButton() {
            const patientId = getElementValue('patient-id');
            const patientName = getElementValue('patient-name');
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button'); 
            const isValid = patientId.length === 13 && /^\d+$/.test(patientId) && patientName.trim() !== '';
            const isAnythingToClear = patientId.trim() !== '' || patientName.trim() !== '';
            
            // Disable save button if Firebase is not ready OR staff ID is missing OR db is null (important fix)
            saveButton.disabled = !isValid || !isFirebaseReady || !currentStaffId || !db; 
            clearButton.disabled = !isAnythingToClear; 
            
            // Update button text
            const buttonText = document.getElementById('save-button-text');
            if (buttonText) {
                buttonText.textContent = currentRecordDocId ? 'อัปเดตข้อมูลผู้ป่วย' : 'บันทึกข้อมูลผู้ป่วยใหม่';
            }
        }
        
        function displayMessage(message, type = 'info') { 
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'mt-8 p-4 rounded-xl text-center';
            box.classList.remove('hidden');
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-blue-100', 'text-blue-700');
            }
        }
        function hideMessage() { 
            document.getElementById('message-box').classList.add('hidden');
        }

        function convertExcelBoolean(value) { 
            if (typeof value === 'boolean') return value;
            if (typeof value === 'string') {
                const lower = value.toLowerCase().trim();
                return lower === 'true' || lower === 'yes' || lower === 'ใช่' || lower === 'y';
            }
            return !!value;
        }

        async function importFromExcel() { 
             // CRITICAL FIX: Check if db is initialized
             if (!isFirebaseReady || !isAdmin || !currentStaffId) {
                displayMessage('ไม่มีสิทธิ์นำเข้าข้อมูล', 'error');
                return;
            }
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const uploaderInfo = `${currentStaffId}_${currentUserId || 'anonymous'}`; 
            
            const fileInput = document.getElementById('excel-file-input');
            const importButton = document.getElementById('import-button');
            const buttonText = document.getElementById('import-button-text');
            const spinner = document.getElementById('import-spinner');
            const statusEl = document.getElementById('import-status');
            const file = fileInput.files[0];
            if (!file) {
                statusEl.textContent = 'กรุณาเลือกไฟล์ Excel (.xlsx) ก่อนครับ';
                statusEl.className = 'text-red-600 text-sm';
                return;
            }
            
            importButton.disabled = true;
            buttonText.textContent = 'กำลังนำเข้า...';
            spinner.classList.remove('hidden');
            statusEl.textContent = 'กำลังอ่านไฟล์...';
            statusEl.className = 'text-gray-600 text-sm';
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                // Use header: 1 to get array of arrays, then explicitly map by index if Thai headers are used,
                // or keep as 'json' but ensure headers match exactly. Stick to json and exact matching.
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                if (jsonData.length === 0) {
                    throw new Error("ไฟล์ Excel ว่างเปล่า หรือไม่มีข้อมูลใน Sheet แรก");
                }
                statusEl.textContent = `พบข้อมูล ${jsonData.length} รายการ กำลังนำเข้า...`;
                const result = await processImport(jsonData, uploaderInfo);
                statusEl.textContent = `นำเข้าสำเร็จ ${result.successCount} รายการ, เกิดข้อผิดพลาด ${result.errorCount} รายการ`;
                statusEl.className = (result.errorCount > 0) ? 'text-yellow-700 text-sm font-semibold' : 'text-green-700 text-sm font-semibold';
                if (result.errorCount > 0) {
                     statusEl.textContent += ' (กรุณาตรวจสอบ Console log สำหรับข้อมูลที่ผิดพลาด)';
                }
                fileInput.value = '';
            } catch (error) {
                console.error("Error importing from Excel:", error);
                statusEl.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
                statusEl.className = 'text-red-600 text-sm';
            } finally {
                importButton.disabled = false;
                buttonText.textContent = 'เริ่มนำเข้า';
                spinner.classList.add('hidden');
                // No need to manually refresh/fetch, onSnapshot will trigger if active
            }
        }
        
        async function processImport(jsonData, uploaderInfo) {
            // CRITICAL FIX: Check if db is initialized
            if (!db) throw new Error("ฐานข้อมูลไม่พร้อมใช้งาน");
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            let successCount = 0;
            let errorCount = 0;
            const statusEl = document.getElementById('import-status');
            
            const todayDateISO = new Date().toISOString().substring(0, 10);
            
            // Get current max queue number for today
            const allRecordsSnapshot = await getDocs(query(collection(db, collectionPath)));
            const todayRecords = allRecordsSnapshot.docs.map(doc => doc.data()).filter(data => (data.timestamp || data.updatedTimestamp || '').startsWith(todayDateISO));
            let currentQueueSize = todayRecords.length;
            
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                statusEl.textContent = `กำลังประมวลผล ${i + 1} / ${jsonData.length}...`;
                try {
                    const hasPreviousExam = convertExcelBoolean(row["เคยตรวจ"]);
                    
                    const patientId = String(row["เลขบัตรประชาชน"] || "").trim();
                    const patientName = String(row["ชื่อ-สกุล"] || "").trim();

                    if (!patientId || patientId.length !== 13 || !/^\d+$/.test(patientId) || !patientName) {
                        console.warn(`Skipping row ${i+1} (Missing or Invalid ID, or Missing Name):`, row);
                        errorCount++;
                        continue;
                    }

                    currentQueueSize++; // Increment queue size for each successful record

                    const mappedData = {
                        patientId: patientId,
                        patientName: patientName,
                        diabetesYears: Number(row["ป่วยเบาหวานปี"]) || null,
                        hba1c: String(row["HbA1C"] || "").trim(),
                        bloodPressure: String(row["ความดัน"] || "").trim(),
                        weight: Number(row["น้ำหนัก"]) || null,
                        height: Number(row["ส่วนสูง"]) || null,
                        vaOD: String(row["VA (OD)"] || "").trim(),
                        vaOS: String(row["VA (OS)"] || "").trim(),
                        isWheelchair: convertExcelBoolean(row["นั่งรถเข็น"]),
                        hasPreviousExam: hasPreviousExam,
                        previousExamCount: hasPreviousExam ? (Number(row["จำนวนครั้ง"]) || null) : null,
                        // Sections 2 & 3 Defaults (Admin can edit later)
                        hasCataract: false, hearingClear: false, canSitChair: false, needsEyelidLift: false, findings: {}, referralNeeded: false,
                        timestamp: new Date().toISOString(),
                        uploaderId: uploaderInfo, 
                        queueNumber: currentQueueSize, 
                    };
                    
                    await addDoc(collection(db, collectionPath), mappedData);
                    successCount++;
                } catch (err) {
                    console.error(`Error importing row ${i+1}:`, row, err);
                    errorCount++;
                }
            }
            return { successCount, errorCount };
        }

        // --- Search Function for Admin View ---
        async function searchPatientRecords() {
            // CRITICAL FIX: Check if db is initialized
            if (!isFirebaseReady || !isAdmin) {
                displayMessage('ไม่มีสิทธิ์ค้นหาข้อมูล', 'error');
                return;
            }
            if (!db) {
                 displayMessage('Firebase ฐานข้อมูลไม่พร้อมใช้งาน กรุณาตรวจสอบการตั้งค่า.', 'error');
                 return;
            }

            const searchId = getElementValue('search-id');
            const searchStatus = document.getElementById('search-status');
            const resultsTableBody = document.getElementById('results-table-body');
            const searchButton = document.getElementById('search-button');

            if (searchId.length !== 13 || !/^\d+$/.test(searchId)) {
                searchStatus.textContent = 'กรุณาป้อนเลขบัตรประชาชน 13 หลักให้ถูกต้อง';
                document.getElementById('search-results-table').classList.add('hidden');
                return;
            }

            searchButton.disabled = true;
            searchButton.textContent = 'กำลังค้นหา...';
            searchStatus.textContent = 'กำลังค้นหาข้อมูลในฐานข้อมูล...';
            document.getElementById('search-results-table').classList.add('hidden');
            document.getElementById('admin-edit-form-container').classList.add('hidden');
            resultsTableBody.innerHTML = '';
            
            try {
                const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                const q = query(
                    collection(db, collectionPath),
                    where("patientId", "==", searchId)
                );
                const querySnapshot = await getDocs(q);
                const records = [];
                querySnapshot.forEach((doc) => {
                    records.push({ docId: doc.id, ...doc.data() });
                });

                if (records.length === 0) {
                    searchStatus.textContent = `ไม่พบประวัติการตรวจสำหรับเลขบัตรประชาชน ${searchId}`;
                    // Clear the edit form if no records found
                    clearForm('admin-');
                } else {
                    records.sort((a, b) => new Date(b.timestamp || b.updatedTimestamp) - new Date(a.timestamp || a.updatedTimestamp));
                    const latestRecord = records[0];
                    searchStatus.textContent = `พบ ${records.length} รายการสำหรับ ${latestRecord.patientName} (ID: ${searchId}). กำลังแสดงรายการล่าสุดในแบบฟอร์มแก้ไข.`;
                    
                    // Show edit form with latest record
                    populateForm(latestRecord, 'admin-');
                    document.getElementById('admin-edit-form-container').classList.remove('hidden');

                    // Show table of all records
                    document.getElementById('search-results-table').classList.remove('hidden');
                    records.forEach(record => {
                        const date = new Date(record.timestamp || record.updatedTimestamp).toLocaleString('th-TH', { 
                            year: 'numeric', month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit' 
                        });
                        const staffIdMatch = (record.uploaderId || '').match(/^(\d+)_/);
                        const staffId = staffIdMatch ? staffIdMatch[1] : 'N/A';
                        const staffName = STAFF_MAPPING[staffId] || staffId;
                        
                        let findingsSummary = record.findings && Object.keys(record.findings).some(key => key !== 'normal' && (record.findings[key]?.or || record.findings[key]?.ol)) ? 'พบความผิดปกติ' : 'Normal';
                        
                        const row = `
                            <tr class="hover:bg-blue-50 transition duration-150 cursor-pointer" onclick="handleEditQueueItem('${record.docId}', 'admin')">
                                <td class="px-4 py-2 text-sm text-gray-500">${date}</td>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">${record.patientName}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${staffName}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">#${record.queueNumber || 'N/A'}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${record.vaOD || 'N/A'} / ${record.vaOS || 'N/A'}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${findingsSummary}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${record.referralNeeded ? '<span class="font-bold text-red-600">ใช่</span>' : 'ไม่'}</td>
                            </tr>
                        `;
                        resultsTableBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error("Error searching Firestore:", error);
                searchStatus.textContent = `เกิดข้อผิดพลาดในการค้นหา: ${error.message}`;
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'ค้นหาข้อมูล';
            }
        }


        // --- Setup Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('login-modal').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // PCU View Listeners
            document.getElementById('patient-id').addEventListener('input', debouncedSearchPatient);
            document.getElementById('patient-name').addEventListener('input', validateSaveButton);
            document.getElementById('patient-id').addEventListener('input', validateSaveButton); 
            document.getElementById('has-previous-exam').addEventListener('change', (e) => togglePreviousExamCount(e.target.checked, ''));
            document.getElementById('clear-button').addEventListener('click', () => clearForm(''));
            document.getElementById('save-button').addEventListener('click', savePatientData);
            
            // Admin View Listeners
            document.getElementById('import-button').addEventListener('click', importFromExcel);
            document.getElementById('search-button').addEventListener('click', searchPatientRecords);
            document.getElementById('export-button').addEventListener('click', exportDailyDataToExcel);

            const adminUpdateBtn = document.getElementById('admin-update-button');
            if (adminUpdateBtn) adminUpdateBtn.addEventListener('click', adminUpdateData);
            const adminClearBtn = document.getElementById('admin-clear-button');
            if (adminClearBtn) adminClearBtn.addEventListener('click', () => clearForm('admin-'));
            const adminHasPrevExam = document.getElementById('admin-has-previous-exam');
            if (adminHasPrevExam) adminHasPrevExam.addEventListener('change', (e) => togglePreviousExamCount(e.target.checked, 'admin-'));


            // Navigation Listeners
            document.getElementById('nav-pcu_form').addEventListener('click', () => renderView('pcu_form'));
            document.getElementById('nav-daily_queue').addEventListener('click', () => renderView('daily_queue'));
            document.getElementById('nav-admin_view').addEventListener('click', () => renderView('admin_view'));


            // Initial Setup
            validateSaveButton();
            initializeFirebase(firebaseConfig);
        });

    </script>
</head>
<body class="bg-gray-50 p-4 sm:p-8 min-h-screen flex items-center justify-center font-['Inter']">

    <!-- Fatal Error Box -->
    <div id="fatal-error-box" class="hidden fixed inset-0 bg-red-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg text-center">
            <svg class="w-12 h-12 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 id="error-title" class="text-2xl font-bold text-red-700 mb-2">ข้อผิดพลาดร้ายแรงในการเริ่มต้นระบบ</h2>
            <p id="error-message" class="text-gray-700 mb-4 text-sm">
                ไม่สามารถเชื่อมต่อ Firebase ได้ กรุณาตรวจสอบ Firebase Config หรือการตั้งค่า Authentication ใน Console
            </p>
            <p class="text-xs text-gray-500">กรุณาดู Console Log สำหรับรายละเอียดเพิ่มเติม</p>
        </div>
    </div>

    <!-- Login Modal (Role Selection) -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-blue-800 mb-2 text-center">เลือกบทบาทเจ้าหน้าที่</h2>
            <p class="text-gray-600 mb-6 text-center text-sm">
                กรุณาป้อน ID เพื่อกำหนดบทบาทและสิทธิ์การเข้าถึง
            </p>
            <div class="space-y-4">
                <div>
                    <label for="login-user-id" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้ (ID รพ.สต./รพ.)</label>
                    <input type="text" id="login-user-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500" placeholder="เช่น 03280" value="03280">
                    <p class="text-xs text-gray-400 mt-1">ตัวอย่าง ID Admin: 10700. ID รพ.สต.: 03280</p>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (ใช้สำหรับ UI เท่านั้น)</label>
                    <input type="password" id="login-password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500" placeholder="รหัสผ่าน" value="03280">
                </div>
            </div>
            <button id="login-button" class="mt-6 w-full px-10 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                ยืนยันบทบาท
            </button>
            <p id="login-status" class="text-center text-sm text-red-500 mt-4"></p>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (For Delete Operations) -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-40">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center">
            <svg class="w-12 h-12 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <h2 id="custom-confirm-title" class="text-xl font-bold text-gray-800 mb-2"></h2>
            <p id="custom-confirm-message" class="text-gray-600 mb-6 text-sm"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-action-button" class="px-6 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 transition duration-300">
                    ยกเลิก
                </button>
                <button id="confirm-action-button" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    ยืนยันการลบ
                </button>
            </div>
        </div>
    </div>


    <!-- Main Container -->
    <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full max-w-6xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-2 text-center">
            ระบบบันทึกข้อมูลผู้ป่วยเบาหวาน
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            บันทึกและค้นหาข้อมูลการตรวจจอประสาทตา (ตามแบบฟอร์ม รพ.ศรีสะเกษ)
        </p>

        <!-- ส่วนแสดงสถานะและปุ่ม Logout -->
        <div class="flex justify-between items-center mb-4 border-b pb-3">
             <div id="staff-name-display" class="text-base font-bold text-gray-800 flex-grow">
                 กำลังโหลด...
            </div>
            <button id="logout-button" class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition duration-150 hidden shadow-sm">
                ออกจากระบบ (เปลี่ยนบทบาท)
            </button>
        </div>
        
        <!-- Navigation Bar (Tabs) -->
        <div class="flex justify-start space-x-2 mb-6 overflow-x-auto custom-scroll">
            <button id="nav-pcu_form" class="flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 transition duration-150 shadow-md">
                1. บันทึกข้อมูล (PCU)
            </button>
            <button id="nav-daily_queue" class="flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 transition duration-150 shadow-md">
                2. คิวผู้ป่วยวันนี้
            </button>
            <button id="nav-admin_view" class="flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 transition duration-150 hidden shadow-md">
                3. ข้อมูลทั้งหมด (Admin)
            </button>
        </div>


        <!-- เนื้อหาหลักจะถูกเปิดใช้งานเมื่อ Firebase Ready และ Role Selected -->
        <div id="main-app-content" class="transition duration-300">
            
            <!-- VIEW 1: บันทึกข้อมูล (PCU Form) -->
            <div id="pcu_form_view">
                <!-- Section 1: Patient Info (from PCU) -->
                <div class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200 shadow-lg">
                    <h2 class="text-xl font-bold text-blue-700 mb-4">ส่วนที่ 1: ข้อมูลผู้ป่วย (จาก รพ.สต./PCU)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="relative"> 
                            <label for="patient-id" class="block text-sm font-medium text-gray-700">เลขบัตรประชาชน 13 หลัก</label>
                            <div class="flex mt-1">
                                <input type="text" id="patient-id" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ตัวอย่าง: XXXXXXXXXXXXX" maxlength="13" autocomplete="off">
                            </div>
                            <!-- Autocomplete results for PCU view -->
                            <div id="autocomplete-results" class="absolute top-full left-0 right-0 w-full bg-white border border-gray-300 rounded-b-lg shadow-xl z-20 hidden overflow-y-auto max-h-48 custom-scroll">
                            </div>
                        </div>
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล ผู้ป่วย</label>
                            <input type="text" id="patient-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="กรุณาระบุชื่อ">
                        </div>
                        <div>
                            <label for="diabetes-years" class="block text-sm font-medium text-gray-700">ป่วยเป็นเบาหวานมาแล้ว (ปี)</label>
                            <input type="number" id="diabetes-years" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label for="hba1c" class="block text-sm font-medium text-gray-700">HbA1C (ล่าสุด)</label>
                            <input type="text" id="hba1c" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="เช่น 7.5">
                        </div>
                         <div>
                            <label for="blood-pressure" class="block text-sm font-medium text-gray-700">ค่าความดัน (BP)</label>
                            <input type="text" id="blood-pressure" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="เช่น 130/80">
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700">น้ำหนัก (kg)</label>
                            <input type="number" id="weight" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0.0">
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700">ส่วนสูง (cm)</label>
                            <input type="number" id="height" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="va-od" class="block text-sm font-medium text-gray-700">VA (ตาขวา - OD)</label>
                            <select id="va-od" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- เลือกค่าสายตา --</option>
                                <option value="20/20">20/20</option><option value="20/25">20/25</option><option value="20/30">20/30</option><option value="20/40">20/40</option><option value="20/50">20/50</option><option value="20/60">20/60</option><option value="20/70">20/70</option><option value="20/80">20/80</option><option value="20/100">20/100</option><option value="20/200">20/200</option><option value="20/400">20/400</option><option value="CF 1ft">CF 1ft</option><option value="CF 2ft">CF 2ft</option><option value="CF 3ft">CF 3ft</option><option value="HM">HM (Hand Motion)</option><option value="LP">LP (Light Perception)</option><option value="NLP">NLP (No Light Perception)</option><option value="N/A">N/A (ตรวจไม่ได้)</option>
                            </select>
                        </div>
                        <div>
                            <label for="va-os" class="block text-sm font-medium text-gray-700">VA (ตาซ้าย - OS)</label>
                             <select id="va-os" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                <option value="">-- เลือกค่าสายตา --</option>
                                <option value="20/20">20/20</option><option value="20/25">20/25</option><option value="20/30">20/30</option><option value="20/40">20/40</option><option value="20/50">20/50</option><option value="20/60">20/60</option><option value="20/70">20/70</option><option value="20/80">20/80</option><option value="20/100">20/100</option><option value="20/200">20/200</option><option value="20/400">20/400</option><option value="CF 1ft">CF 1ft</option><option value="CF 2ft">CF 2ft</option><option value="CF 3ft">CF 3ft</option><option value="HM">HM (Hand Motion)</option><option value="LP">LP (Light Perception)</option><option value="NLP">NLP (No Light Perception)</option><option value="N/A">N/A (ตรวจไม่ได้)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <div class="flex items-center">
                                <input id="is-wheelchair" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="is-wheelchair" class="ml-2 block text-sm font-medium text-gray-700">นั่งรถเข็น (Wheelchair)</label>
                            </div>
                        </div>
                        <div class="flex items-end">
                            <div class="flex flex-col">
                                <div class="flex items-center">
                                    <input id="has-previous-exam" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="has-previous-exam" class="ml-2 block text-sm font-medium text-gray-700">เคยตรวจจอประสาทตา</label>
                                </div>
                                <div id="previous-exam-count-container" class="mt-2 hidden">
                                    <label for="previous-exam-count" class="block text-xs font-medium text-gray-600">ถ้าเคย, กี่ครั้ง?</label>
                                    <input type="number" id="previous-exam-count" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Sections 2 & 3 removed from PCU view -->

                <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <button id="clear-button" class="w-full sm:w-auto px-10 py-3 bg-gray-500 text-white font-bold rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                        ล้างข้อมูล (Clear Form)
                    </button>
                    <button id="save-button" class="w-full sm:w-auto px-10 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                        <span id="save-button-text">บันทึกข้อมูลผู้ป่วยใหม่</span>
                        <svg id="save-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <div id="message-box" class="mt-8 p-4 rounded-lg text-center hidden"></div>
            </div> <!-- End pcu_form_view -->
            
            <!-- VIEW 2: คิวผู้ป่วยวันนี้ -->
            <div id="daily_queue_view" class="hidden">
                 <div class="p-6 bg-white rounded-xl shadow-md border border-blue-200">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        คิวผู้ป่วยที่ลงทะเบียนวันนี้ (<span id="queue-date"></span>)
                    </h2>
                    <ul id="queue-list" class="divide-y divide-gray-100 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                        <li class="p-4 text-center text-gray-500">กรุณาเลือกบทบาทเจ้าหน้าที่เพื่อโหลดคิว</li>
                    </ul>
                </div>
            </div> <!-- End daily_queue_view -->

            <!-- VIEW 3: ข้อมูลทั้งหมด (Admin View) -->
            <div id="admin_view_view" class="hidden">
                
                <!-- Import Section -->
                <div class="mt-4 p-6 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200">
                    <h2 class="text-2xl font-bold text-yellow-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        นำเข้าข้อมูลจาก Excel (.xlsx)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        อัปโหลดไฟล์ Excel (.xlsx) เพื่อนำเข้าข้อมูลผู้ป่วยหลายคนพร้อมกัน
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="flex-grow block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200 cursor-pointer">
                        <button id="import-button" class="flex-shrink-0 px-6 py-2 bg-yellow-600 text-white font-bold rounded-xl shadow-md hover:bg-yellow-700 transition duration-300 flex items-center justify-center">
                            <span id="import-button-text">เริ่มนำเข้า</span>
                            <svg id="import-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="import-status" class="text-gray-600 text-sm"></div>
                    <details class="mt-4">
                        <summary class="cursor-pointer text-sm font-medium text-yellow-700 hover:text-yellow-900">
                            คลิกเพื่อดูรูปแบบคอลัมน์ที่จำเป็น (แถวแรกใน Excel)
                        </summary>
                        <pre class="text-xs bg-white p-3 rounded-md mt-2 overflow-x-auto border border-yellow-300 shadow-sm">
    คอลัมน์ที่จำเป็น (ต้องตรงกันทุกตัวอักษร):
    - เลขบัตรประชาชน, ชื่อ-สกุล, ป่วยเบาหวานปี, HbA1C, ความดัน, น้ำหนัก, ส่วนสูง, VA (OD), VA (OS), นั่งรถเข็น, เคยตรวจ, จำนวนครั้ง
                        </pre>
                    </details>
                </div>

                <!-- Export Section -->
                <div class="mt-10 p-6 bg-pink-50 rounded-xl shadow-inner border border-pink-200">
                    <h2 class="text-2xl font-bold text-pink-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        ส่งออกข้อมูลเป็น Excel (.xlsx)
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-grow">
                            <label for="export-date" class="block text-sm font-medium text-gray-700">เลือกวันที่ต้องการส่งออกข้อมูลที่บันทึก/แก้ไข:</label>
                            <input type="date" id="export-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <button id="export-button" class="flex-shrink-0 mt-6 sm:mt-0 px-6 py-2 bg-pink-600 text-white font-bold rounded-xl shadow-md hover:bg-pink-700 transition duration-300 h-10">
                            ดึงข้อมูล & ส่งออกเป็น Excel
                        </button>
                    </div>
                     <div id="export-status" class="text-gray-600 text-sm"></div>
                </div>

                <!-- Search Section -->
                <div class="mt-10 p-6 bg-gray-100 rounded-xl shadow-inner">
                    <h2 class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        ค้นหาประวัติการตรวจ (ด้วยเลข 13 หลัก)
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="search-id" class="flex-grow rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="กรุณาป้อนเลขบัตรประชาชน 13 หลักที่ต้องการค้นหา" maxlength="13">
                        <button id="search-button" class="flex-shrink-0 px-6 py-2 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300">
                            ค้นหาข้อมูล
                        </button>
                    </div>
                    <div id="search-results-container" class="mt-4">
                        <p id="search-status" class="text-gray-600">กรุณาป้อนเลข 13 หลักเพื่อค้นหาประวัติ</p>
                        
                        <!-- Admin Edit Form -->
                        <div id="admin-edit-form-container" class="mt-8 p-6 bg-white rounded-xl shadow-2xl border border-blue-400 hidden">
                            <h3 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">แบบฟอร์มแก้ไขข้อมูลผู้ป่วยฉบับเต็ม</h3>
                            
                            <!-- Section 1: Patient Info (Admin Edit - Note: IDs prefixed with admin-) -->
                            <div class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
                                <h2 class="text-xl font-bold text-blue-700 mb-4">ส่วนที่ 1: ข้อมูลผู้ป่วย (จาก รพ.สต./PCU)</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div class="relative"> 
                                        <label for="admin-patient-id" class="block text-sm font-medium text-gray-700">เลขบัตรประชาชน 13 หลัก</label>
                                        <input type="text" id="admin-patient-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ตัวอย่าง: XXXXXXXXXXXXX" maxlength="13">
                                    </div>
                                    <div>
                                        <label for="admin-patient-name" class="block text-sm font-medium text-gray-700">ชื่อ-นามสกุล ผู้ป่วย</label>
                                        <input type="text" id="admin-patient-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="กรุณาระบุชื่อ">
                                    </div>
                                    <div>
                                        <label for="admin-diabetes-years" class="block text-sm font-medium text-gray-700">ป่วยเป็นเบาหวานมาแล้ว (ปี)</label>
                                        <input type="number" id="admin-diabetes-years" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label for="admin-hba1c" class="block text-sm font-medium text-gray-700">HbA1C (ล่าสุด)</label>
                                        <input type="text" id="admin-hba1c" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="เช่น 7.5">
                                    </div>
                                    <div>
                                        <label for="admin-blood-pressure" class="block text-sm font-medium text-gray-700">ค่าความดัน (BP)</label>
                                        <input type="text" id="admin-blood-pressure" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="เช่น 130/80">
                                    </div>
                                    <div>
                                        <label for="admin-weight" class="block text-sm font-medium text-gray-700">น้ำหนัก (kg)</label>
                                        <input type="number" id="admin-weight" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0.0">
                                    </div>
                                    <div>
                                        <label for="admin-height" class="block text-sm font-medium text-gray-700">ส่วนสูง (cm)</label>
                                        <input type="number" id="admin-height" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label for="admin-va-od" class="block text-sm font-medium text-gray-700">VA (ตาขวา - OD)</label>
                                        <select id="admin-va-od" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- เลือกค่าสายตา --</option>
                                            <option value="20/20">20/20</option><option value="20/25">20/25</option><option value="20/30">20/30</option><option value="20/40">20/40</option><option value="20/50">20/50</option><option value="20/60">20/60</option><option value="20/70">20/70</option><option value="20/80">20/80</option><option value="20/100">20/100</option><option value="20/200">20/200</option><option value="20/400">20/400</option><option value="CF 1ft">CF 1ft</option><option value="CF 2ft">CF 2ft</option><option value="CF 3ft">CF 3ft</option><option value="HM">HM (Hand Motion)</option><option value="LP">LP (Light Perception)</option><option value="NLP">NLP (No Light Perception)</option><option value="N/A">N/A (ตรวจไม่ได้)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="admin-va-os" class="block text-sm font-medium text-gray-700">VA (ตาซ้าย - OS)</label>
                                         <select id="admin-va-os" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                            <option value="">-- เลือกค่าสายตา --</option>
                                            <option value="20/20">20/20</option><option value="20/25">20/25</option><option value="20/30">20/30</option><option value="20/40">20/40</option><option value="20/50">20/50</option><option value="20/60">20/60</option><option value="20/70">20/70</option><option value="20/80">20/80</option><option value="20/100">20/100</option><option value="20/200">20/200</option><option value="20/400">20/400</option><option value="CF 1ft">CF 1ft</option><option value="CF 2ft">CF 2ft</option><option value="CF 3ft">CF 3ft</option><option value="HM">HM (Hand Motion)</option><option value="LP">LP (Light Perception)</option><option value="NLP">NLP (No Light Perception)</option><option value="N/A">N/A (ตรวจไม่ได้)</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <div class="flex items-center">
                                            <input id="admin-is-wheelchair" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label for="admin-is-wheelchair" class="ml-2 block text-sm font-medium text-gray-700">นั่งรถเข็น (Wheelchair)</label>
                                        </div>
                                    </div>
                                    <div class="flex items-end">
                                        <div class="flex flex-col">
                                            <div class="flex items-center">
                                                <input id="admin-has-previous-exam" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                                <label for="admin-has-previous-exam" class="ml-2 block text-sm font-medium text-gray-700">เคยตรวจจอประสาทตา</label>
                                            </div>
                                            <div id="admin-previous-exam-count-container" class="mt-2 hidden">
                                                <label for="admin-previous-exam-count" class="block text-xs font-medium text-gray-600">ถ้าเคย, กี่ครั้ง?</label>
                                                <input type="number" id="admin-previous-exam-count" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 2: Hospital Info (Admin Edit) -->
                            <div class="mb-8 p-6 bg-gray-100 rounded-xl border border-gray-200">
                                <h2 class="text-xl font-bold text-gray-700 mb-4">ส่วนที่ 2: ข้อมูลสำหรับเจ้าหน้าที่ (Hospital)</h2>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="flex items-center">
                                        <input id="admin-has-cataract" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="admin-has-cataract" class="ml-2 block text-sm font-medium text-gray-700">เป็นต้อกระจก (Cataract)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="admin-hearing-clear" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="admin-hearing-clear" class="ml-2 block text-sm font-medium text-gray-700">การได้ยินชัดเจน</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="admin-can-sit-chair" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="admin-can-sit-chair" class="ml-2 block text-sm font-medium text-gray-700">นั่งเก้าอี้ตรวจตาได้</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="admin-needs-eyelid-lift" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="admin-needs-eyelid-lift" class="ml-2 block text-sm font-medium text-gray-700">ต้องช่วยยกหนังตา</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 3: Retina Findings (Admin Edit) -->
                            <div class="mb-8 p-6 bg-green-50 rounded-xl border border-green-200">
                                <h2 class="text-xl font-bold text-green-700 mb-4">ส่วนที่ 3: ผลการตรวจจอประสาทตา</h2>
                                <div class="grid grid-cols-3 gap-4 mb-2">
                                    <div class="font-bold text-gray-700">ผลการตรวจ (Findings)</div>
                                    <div class="font-bold text-gray-700 text-center">ตาขวา (OR)</div>
                                    <div class="font-bold text-gray-700 text-center">ตาซ้าย (OL)</div>
                                </div>
                                <div class="space-y-3" id="admin-section3-findings">
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-normal-or" class="font-medium text-gray-800">Normal</label>
                                        <input id="admin-finding-normal-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-normal-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-microaneurysm-or" class="font-medium text-gray-800">Micro aneurysm / Dot-Blot HE</label>
                                        <input id="admin-finding-microaneurysm-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-microaneurysm-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-hardexudate-or" class="font-medium text-gray-800">Hard exudate</label>
                                        <input id="admin-finding-hardexudate-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-hardexudate-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-flame-or" class="font-medium text-gray-800">Flame-shaped hemorrhage</label>
                                        <input id="admin-finding-flame-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-flame-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-venous-or" class="font-medium text-gray-800">Venous beading</label>
                                        <input id="admin-finding-venous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-venous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-irma-or" class="font-medium text-gray-800">IRMA</label>
                                        <input id="admin-finding-irma-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-irma-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-newvessel-or" class="font-medium text-gray-800">New vessel (neovascularization)</label>
                                        <input id="admin-finding-newvessel-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-newvessel-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid col-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-preretinal-or" class="font-medium text-gray-800">Preretinal hemorrhage</label>
                                        <input id="admin-finding-preretinal-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-preretinal-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-vitreous-or" class="font-medium text-gray-800">Vitreous hemorrhage</label>
                                        <input id="admin-finding-vitreous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-vitreous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                                        <label for="admin-finding-fibrous-or" class="font-medium text-gray-800">Fibrous proliferation</label>
                                        <input id="admin-finding-fibrous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                        <input id="admin-finding-fibrous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                                    </div>
                                </div>
                                <div class="mt-6 border-t border-green-200 pt-4">
                                       <div class="flex items-center">
                                            <input id="admin-referral-needed" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                            <label for="admin-referral-needed" class="ml-2 block text-sm font-medium text-red-700">ส่งต่อ (Referral Needed)</label>
                                        </div>
                                </div>
                            </div>

                            <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                                <button id="admin-clear-button" class="w-full sm:w-auto px-10 py-3 bg-gray-500 text-white font-bold rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 flex items-center justify-center">
                                    ยกเลิกการแก้ไข / ล้างฟอร์ม
                                </button>
                                <button id="admin-update-button" class="w-full sm:w-auto px-10 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-300 flex items-center justify-center">
                                    <span id="admin-update-button-text">อัปเดตข้อมูลผู้ป่วย</span>
                                    <svg id="admin-update-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </button>
                            </div>

                        </div>
                        
                        <!-- Search Results Table -->
                        <div id="search-results-table" class="hidden mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">รายการที่พบทั้งหมด (คลิกเพื่อแก้ไข):</h3>
                            <div class="overflow-x-auto rounded-xl border border-gray-300 shadow-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">วัน/เวลา</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ชื่อ-สกุล</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">รพ.สต. ผู้บันทึก</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">คิว</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">VA (OD/OS)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ผลตรวจ (ย่อ)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ส่งต่อ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End admin_view_view -->
        </div> <!-- จบ main-app-content -->
    </div>
    
</body>
</html>
