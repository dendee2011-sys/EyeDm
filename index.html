<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - Login 5 ‡∏´‡∏•‡∏±‡∏Å</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Offline persistence
        db.enablePersistence({ synchronizeTabs: true }).catch(err => {});

        const DB_COLLECTION = db.collection('artifacts').doc('diabetic-sisaket-v4').collection('public_patients');

        // --- Constants ---
        const VA_OPTIONS = ["20/20 (‡∏õ‡∏Å‡∏ï‡∏¥)", "20/40", "20/50", "20/70", "20/200", "CF", "HM", "PL", "NPL"];
        
        const DR_GRADING_OPTIONS = [
            'No DR', 
            'Mild NPDR', 
            'Moderate NPDR', 
            'Severe NPDR', 
            'PDR'
        ];

        const INITIAL_FINDINGS = {
            MicroAneurysm: {L:false,R:false, name: 'MicroAneurysm (MA)'}, 
            Hemorrhage: {L:false,R:false, name: 'Hemorrhage (‡∏à‡∏∏‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å)'},
            HardExudate: {L:false,R:false, name: 'Hard Exudate (HE)'},
            CottonWool: {L:false,R:false, name: 'Cotton Wool Spot (CWS)'},
            VenousBeading: {L:false,R:false, name: 'Venous Beading (VB)'},
            IRMA: {L:false,R:false, name: 'IRMA'},
            Neovascularization: {L:false,R:false, name: 'Neovascularization (NV)'},
        };

        // CSV Required Headers
        const REQUIRED_HEADERS = ['idCard', 'name', 'age', 'hba1c', 'bp', 'vaRight', 'vaLeft'];

        // --- Helper Function: Check if date is today ---
        const isToday = (date) => {
            if (!date) return false;
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        };

        // --- Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            const iconName = name.toLowerCase().replace(/([A-Z])/g, "-$1").replace(/^-/, ""); 
            return <i data-lucide={iconName} width={size} height={size} className={className}></i>;
        };

        // --- Auth Screen (5-Digit Login) ---
        const AuthScreen = () => {
            const [unitId, setUnitId] = useState('');
            const [password, setPassword] = useState('');
            const [isRegister, setIsRegister] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const DUMMY_DOMAIN = "@eyedm.com";

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if(unitId.length < 5) {
                    setError("‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏´‡∏•‡∏±‡∏Å");
                    return;
                }

                setLoading(true);
                setError('');

                const fakeEmail = unitId + DUMMY_DOMAIN;

                try {
                    if (isRegister) {
                        await auth.createUserWithEmailAndPassword(fakeEmail, password);
                        alert(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${unitId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    } else {
                        await auth.signInWithEmailAndPassword(fakeEmail, password);
                    }
                } catch (err) {
                    console.error(err);
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                        setError("‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    } else if (err.code === 'auth/email-already-in-use') {
                        setError("‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
                    } else if (err.code === 'auth/weak-password') {
                        setError("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");
                    } else {
                        setError("Error: " + err.message);
                    }
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-cyan-500 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-4 border-white/50">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                <Icon name="building-2" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">{isRegister ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}</h1>
                            <p className="text-slate-500 text-sm">EyeDM Connect (Secure System)</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å)</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        inputMode="numeric" 
                                        pattern="[0-9]*" 
                                        maxLength="5"
                                        value={unitId} 
                                        onChange={e=>setUnitId(e.target.value.replace(/[^0-9]/g, ''))} 
                                        className="w-full p-3 pl-10 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-lg font-mono tracking-widest font-bold text-gray-700" 
                                        placeholder="xxxxx" 
                                        required 
                                    />
                                    <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="hash" size={18}/></div>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={e=>setPassword(e.target.value)} 
                                        className="w-full p-3 pl-10 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" 
                                        required 
                                    />
                                    <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="lock" size={18}/></div>
                                </div>
                            </div>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm border border-red-200 flex gap-2"><Icon name="alert-circle" size={16}/> {error}</div>}

                            <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 disabled:opacity-50">
                                {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...' : (isRegister ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')}
                            </button>
                        </form>

                        <div className="mt-6 text-center text-sm">
                            <button onClick={()=>{setIsRegister(!isRegister); setError('');}} className="text-blue-600 hover:underline font-medium">
                                {isRegister ? '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà'}
                            </button>
                        </div>
                        
                        {!isRegister && <div className="mt-4 pt-4 border-t text-center text-xs text-gray-400">
                            * ‡∏£‡∏´‡∏±‡∏™ <b>10700</b> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏°‡πà‡∏Ç‡πà‡∏≤‡∏¢<br/>
                            * ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏£‡∏û.‡∏™‡∏ï.
                        </div>}
                    </div>
                </div>
            );
        };

        // --- CSV Parsing Function ---
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return { headers: [], data: [] };

            // Trim headers and handle potential surrounding quotes (simple case)
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Skip empty lines
                
                // Simple splitting by comma (may not handle commas inside quotes)
                const values = lines[i].split(','); 
                const obj = {};
                
                // Map values to headers
                headers.forEach((header, index) => {
                    if (header && values[index] !== undefined) {
                        // Trim and remove surrounding quotes
                        obj[header] = values[index].trim().replace(/"/g, ''); 
                    }
                });
                data.push(obj);
            }
            return { headers, data };
        };

        // --- Bulk Import Screen (CSV) ---
        const BulkImportScreen = ({ onBack, userId }) => {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            
            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    setMessage(null);
                }
            };

            const handleImport = async () => {
                if (!file) {
                    setMessage({ type: 'error', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô' });
                    return;
                }

                setLoading(true);
                let successCount = 0;
                let failureCount = 0;
                let patientData = [];
                let headers = [];

                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const csvText = event.target.result;
                        const parsed = parseCSV(csvText);
                        patientData = parsed.data;
                        headers = parsed.headers;

                        // 1. Validate Headers
                        const missingHeaders = REQUIRED_HEADERS.filter(h => !headers.includes(h));
                        if (missingHeaders.length > 0) {
                            setMessage({ type: 'error', text: `Header ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ‡∏Ç‡∏≤‡∏î ${missingHeaders.join(', ')}` });
                            setLoading(false);
                            return;
                        }
                        
                        if (patientData.length === 0) {
                            setMessage({ type: 'error', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 2)' });
                            setLoading(false);
                            return;
                        }

                        // 2. Process Batches
                        const chunkSize = 499; 
                        let batches = [];
                        for (let i = 0; i < patientData.length; i += chunkSize) {
                            batches.push(patientData.slice(i, i + chunkSize));
                        }

                        for (const chunk of batches) {
                            const currentBatch = db.batch();
                            
                            for (const item of chunk) {
                                // Basic validation for mandatory fields in data row
                                if (!item.idCard || !item.name || String(item.idCard).length !== 13) {
                                    failureCount++;
                                    continue; 
                                }

                                const newDocRef = DB_COLLECTION.doc(); 
                                
                                currentBatch.set(newDocRef, {
                                    part1: {
                                        idCard: String(item.idCard).trim(), 
                                        name: item.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                                        age: String(item.age || ''),
                                        hba1c: String(item.hba1c || ''),
                                        bp: String(item.bp || ''),
                                        vaRight: item.vaRight || '',
                                        vaLeft: item.vaLeft || '',
                                    },
                                    status: 'Waiting', 
                                    senderId: userId,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                successCount++;
                            }
                            
                            await currentBatch.commit();
                        }
                        
                        setLoading(false);
                        setMessage({ 
                            type: 'success', 
                            text: `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${patientData.length} ‡πÅ‡∏ñ‡∏ß)` 
                        });
                        setFile(null);
                    };

                    reader.onerror = () => {
                        setMessage({ type: 'error', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ' });
                        setLoading(false);
                    };

                    reader.readAsText(file);

                } catch (e) {
                    setLoading(false);
                    setMessage({ type: 'error', text: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ${e.message}` });
                }
            };
            
            const HEADER_EXAMPLE = REQUIRED_HEADERS.join(', ');

            return (
                <div className="max-w-4xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="mb-4 flex gap-1 text-gray-500 hover:text-gray-800 transition-colors"><Icon name="arrow-left" size={16}/> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard</button>
                    <div className="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden">
                        <div className="bg-blue-600 p-4 text-white flex items-center gap-2">
                            <Icon name="upload" className="text-white"/>
                            <h2 className="font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å (CSV Import)</h2>
                        </div>
                        <div className="p-6 space-y-6">
                            
                            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h3 className="font-bold text-yellow-800 text-sm mb-2 flex items-center gap-2"><Icon name="file-text" size={16}/> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h3>
                                <p className="text-xs text-gray-700 mb-2">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Header ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma `,`):</p>
                                <pre className="bg-white p-3 rounded text-sm font-mono overflow-x-auto border text-gray-700 font-semibold">{HEADER_EXAMPLE}</pre>
                                <p className="text-xs text-yellow-700 mt-2">* ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå `idCard` (13 ‡∏´‡∏•‡∏±‡∏Å) ‡πÅ‡∏•‡∏∞ `name` ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢</p>
                            </div>

                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</label>
                                <div className="flex items-center gap-4 p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                    <input
                                        type="file"
                                        accept=".csv"
                                        onChange={handleFileChange}
                                        className="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                        disabled={loading}
                                    />
                                    {file && <span className="text-sm font-medium text-gray-700">{file.name}</span>}
                                </div>
                            </div>

                            {message && (
                                <div className={`p-3 rounded-lg text-sm border flex items-center gap-2 ${
                                    message.type === 'error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-green-50 text-green-600 border-green-200'
                                }`}>
                                    <Icon name={message.type === 'error' ? 'x-circle' : 'check-circle'} size={16}/>
                                    {message.text}
                                </div>
                            )}

                            <button onClick={handleImport} disabled={loading || !file} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-all shadow-md disabled:opacity-50 flex items-center justify-center gap-2">
                                {loading ? <><Icon name="loader-2" className="animate-spin" size={20}/> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠)...</> : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Bulk Import)'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Dashboard (Main) ---
        const Dashboard = ({ role, patients, onNew, onSelect, onBulkImport }) => {
            const [term, setTerm] = useState('');
            
            // --- Stats Calculation Logic ---
            const stats = useMemo(() => {
                const todayPatients = patients.filter(p => isToday(p.createdAt));
                
                return {
                    overall: {
                        total: patients.length,
                        waiting: patients.filter(p => p.status === 'Waiting').length,
                        completed: patients.filter(p => p.status === 'Completed').length
                    },
                    today: {
                        total: todayPatients.length,
                        waiting: todayPatients.filter(p => p.status === 'Waiting').length,
                        completed: todayPatients.filter(p => p.status === 'Completed').length
                    }
                };
            }, [patients]);
            // --- End Stats Calculation Logic ---


            const filtered = useMemo(() => patients.filter(p => (p.part1?.idCard+p.part1?.name).includes(term)), [patients, term]);
            
            const handleDelete = async (id) => {
                if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) await DB_COLLECTION.doc(id).delete();
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    
                    {/* STATS SECTION */}
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                        <div className="mb-3 border-b pb-2 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icon name="bar-chart-2" size={20}/> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h3>
                            <span className="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 border-b pb-4 mb-4">
                            {/* Today Stats */}
                            <div className="space-y-2">
                                <h4 className="text-sm font-bold text-blue-600 border-b border-blue-100 pb-1">üìä ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                                <StatItem label="‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={stats.today.total} color="text-gray-700"/>
                                <StatItem label="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à" value={stats.today.waiting} color="text-orange-600" bg="bg-orange-50"/>
                                <StatItem label="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à" value={stats.today.completed} color="text-green-600" bg="bg-green-50"/>
                            </div>
                            {/* Overall Stats */}
                            <div className="space-y-2 border-l pl-4">
                                <h4 className="text-sm font-bold text-gray-500 border-b pb-1">üìÖ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                                <StatItem label="‡πÄ‡∏Ñ‡∏™‡∏£‡∏ß‡∏°" value={stats.overall.total} color="text-gray-700"/>
                                <StatItem label="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à" value={stats.overall.waiting} color="text-orange-400"/>
                                <StatItem label="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à" value={stats.overall.completed} color="text-green-400"/>
                            </div>
                        </div>
                    </div>
                    {/* END STATS SECTION */}


                    <div className="flex flex-col md:flex-row justify-between md:items-end gap-4">
                        <div>
                            <h2 className="2xl font-bold flex items-center gap-2 text-slate-800">
                                <Icon name={role==='PCU'?'home':'building-2'} className={role==='PCU'?'text-green-600':'text-blue-600'} />
                                {role === 'PCU' ? '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß'}
                            </h2>
                        </div>
                        {role === 'PCU' && <button onClick={onNew} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 font-bold items-center"><Icon name="plus-circle" size={18}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button>}
                        {role === 'HOSPITAL' && <button onClick={onBulkImport} className="bg-purple-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 font-bold items-center hover:bg-purple-700 transition-colors"><Icon name="upload" size={18}/> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>}
                    </div>

                    <div className="bg-white p-2 rounded-xl shadow border flex gap-2 items-center">
                        <Icon name="search" className="text-gray-400 ml-2"/>
                        <input type="text" value={term} onChange={e=>setTerm(e.target.value)} placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠..." className="flex-1 p-2 outline-none" />
                    </div>

                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th className="p-3">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th><th className="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th className="p-3 text-right">Action</th></tr></thead>
                            <tbody className="divide-y">
                                {filtered.map(p => (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                        <td className="p-3 text-gray-500 align-top">
                                            {p.createdAt?.toLocaleDateString('th-TH')}
                                            <div className="text-xs text-gray-400">{p.createdAt?.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div>
                                        </td>
                                        <td className="p-3 align-top">
                                            <div className="font-bold text-blue-600 font-mono text-base">{p.part1.idCard}</div>
                                            <div className="font-medium text-gray-800">{p.part1.name}</div>
                                            {p.part1.vaRight && <div className="text-xs text-gray-500 mt-1 bg-gray-100 w-fit px-1 rounded">VA: {p.part1.vaRight}/{p.part1.vaLeft}</div>}
                                        </td>
                                        <td className="p-3 align-top"><span className={`px-2 py-1 rounded-full text-xs font-bold inline-flex items-center gap-1 ${p.status==='Waiting'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'}`}>
                                            <span className={`w-1.5 h-1.5 rounded-full ${p.status==='Waiting'?'bg-orange-500':'bg-green-500'}`}></span>
                                            {p.status==='Waiting'?'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à':'‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß'}
                                        </span></td>
                                        <td className="p-3 text-right align-top">
                                            <div className="flex justify-end gap-2">
                                                {role === 'HOSPITAL' ? (
                                                    <button onClick={()=>onSelect(p)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-bold text-xs shadow-sm">‡∏ï‡∏£‡∏ß‡∏à</button>
                                                ) : <span className="text-gray-400 text-xs bg-gray-100 px-2 py-1 rounded">‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß</span>}
                                                <button onClick={()=>handleDelete(p.id)} className="text-red-400 hover:bg-red-50 p-1 rounded border border-transparent hover:border-red-100"><Icon name="trash-2" size={16}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400 flex flex-col items-center"><Icon name="inbox" size={32} className="mb-2 opacity-50"/>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Helper component for stat cards
        const StatItem = ({ label, value, color, bg }) => (
            <div className={`flex justify-between items-center p-2 rounded-lg ${bg}`}>
                <span className="text-xs font-medium text-gray-600">{label}</span>
                <span className={`text-lg font-extrabold ${color}`}>{value}</span>
            </div>
        );
        
        const PCUForm = ({ onBack, userId, existingPatients }) => {
            const [form, setForm] = useState({ idCard:'', name:'', age:'', hba1c:'', bp:'', vaRight:'', vaLeft:'' });
            const [saving, setSaving] = useState(false);
            const [foundOld, setFoundOld] = useState(false); 

            // --- Auto-fill Logic: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ---
            useEffect(() => {
                if(form.idCard.length === 13 && existingPatients) {
                    const old = existingPatients
                        .filter(p => p.part1?.idCard === form.idCard)
                        .sort((a, b) => b.createdAt - a.createdAt)[0]; 
                    
                    if(old) {
                        setFoundOld(true);
                        setForm(f => ({
                            ...f, 
                            name: old.part1.name || '', 
                            age: old.part1.age || '',
                        }));
                    } else {
                        setFoundOld(false);
                    }
                } else {
                     setFoundOld(false);
                }
            }, [form.idCard, existingPatients]);
            // --- End Auto-fill Logic ---
            
            const save = async () => {
                if(!form.idCard) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô");
                setSaving(true);
                try { await DB_COLLECTION.add({ part1: form, status: 'Waiting', senderId: userId, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); onBack(); } 
                catch(e){alert(e.message); setSaving(false);}
            };

            return (
                <div className="max-w-xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="mb-4 flex gap-1 text-gray-500 hover:text-gray-800 transition-colors"><Icon name="arrow-left" size={16}/> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <div className="bg-white rounded-xl shadow-lg border border-green-100 overflow-hidden">
                         <div className="bg-green-600 p-4 text-white flex items-center gap-2">
                            <Icon name="file-plus" className="text-white"/>
                            <h2 className="font-bold">‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Referral)</h2>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                                <div className={`relative p-3 rounded-lg border-2 transition-all ${foundOld ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>
                                    <input 
                                        className="w-full text-lg font-mono tracking-wide focus:ring-0 outline-none bg-transparent" 
                                        maxLength="13" 
                                        placeholder="xxxxxxxxxxxxx" 
                                        value={form.idCard} 
                                        onChange={e=>setForm({...form, idCard:e.target.value})} 
                                    />
                                    {foundOld && <span className="absolute right-2 top-1/2 -translate-y-1/2 text-green-700 text-xs font-bold flex items-center gap-1 animate-fade-in"><Icon name="history" size={16}/> ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡∏¥‡∏°</span>}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input className="w-full p-2 border rounded" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                                <div><label className="text-xs font-bold text-gray-500">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" className="w-full p-2 border rounded" value={form.age} onChange={e=>setForm({...form, age:e.target.value})} /></div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded border">
                                <div className="text-xs font-bold text-gray-500 mb-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ (VA)</div>
                                <div className="grid grid-cols-2 gap-4">
                                     <select className="p-2 border rounded bg-white" value={form.vaRight} onChange={e=>setForm({...form, vaRight:e.target.value})}><option value="">‡∏Ç‡∏ß‡∏≤ (Right)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                     <select className="p-2 border rounded bg-white" value={form.vaLeft} onChange={e=>setForm({...form, vaLeft:e.target.value})}><option value="">‡∏ã‡πâ‡∏≤‡∏¢ (Left)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                 <div><label className="text-xs font-bold text-gray-500">HbA1C</label><input className="w-full p-2 border rounded" value={form.hba1c} onChange={e=>setForm({...form, hba1c:e.target.value})} /></div>
                                 <div><label className="text-xs font-bold text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (BP)</label><input className="w-full p-2 border rounded" value={form.bp} onChange={e=>setForm({...form, bp:e.target.value})} /></div>
                            </div>
                            <button onClick={save} disabled={saving} className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 transition-all shadow-md disabled:opacity-50">{saving?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HospitalForm = ({ patient, onBack }) => {
            // Part 2: State Initialization with expanded findings and grading
            const getInitialFindings = () => {
                const initial = {};
                Object.keys(INITIAL_FINDINGS).forEach(key => {
                    initial[key] = patient.findings?.[key] || INITIAL_FINDINGS[key];
                });
                return initial;
            };

            const [p2, setP2] = useState(patient.part2 || { 
                cataract:'No', 
                retinaFound: 'Yes',
                dilation: 'No',
                drGradeL: 'No DR', // New
                drGradeR: 'No DR', // New
                advice: '' // New
            });
            const [findings, setFindings] = useState(getInitialFindings());
            const [saving, setSaving] = useState(false);

            const toggle = (k,s) => setFindings(f => ({...f, [k]:{...f[k], [s]:!f[k][s]}}));

            const save = async () => {
                setSaving(true);
                try { 
                    await DB_COLLECTION.doc(patient.id).update({ 
                        part2: p2, 
                        findings, 
                        status: 'Completed',
                        examinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }); 
                    onBack(); 
                } catch(e){alert(e.message); setSaving(false);}
            };
            
            return (
                <div className="flex flex-col lg:flex-row gap-4 animate-fade-in pb-20">
                    {/* Patient Info (Part 1 Summary) */}
                    <div className="w-full lg:w-1/3">
                        <button onClick={onBack} className="mb-4 flex gap-1 text-gray-500 hover:text-gray-800"><Icon name="arrow-left" size={16}/> ‡∏Å‡∏•‡∏±‡∏ö</button>
                        <div className="bg-white p-4 rounded-xl shadow border">
                            <h3 className="font-bold text-lg border-b pb-2 mb-2 flex items-center gap-2 text-gray-700"><Icon name="user" size={20}/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Part 1)</h3>
                            <div className="font-mono text-blue-600 font-bold text-lg">{patient.part1.idCard}</div>
                            <div className="text-xl mb-2 font-bold text-gray-800">{patient.part1.name}</div>
                            <div className="bg-gray-50 p-3 rounded text-sm space-y-2">
                                <div className="flex justify-between"><span>VA:</span> <b>{patient.part1.vaRight}/{patient.part1.vaLeft}</b></div>
                                <div className="flex justify-between"><span>HbA1C:</span> <b>{patient.part1.hba1c}</b></div>
                                <div className="flex justify-between"><span>BP:</span> <b>{patient.part1.bp}</b></div>
                            </div>
                        </div>
                    </div>

                    {/* Examination Form (Part 2 Detail) */}
                    <div className="w-full lg:w-2/3 bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden">
                        <div className="bg-blue-600 p-4 text-white font-bold flex items-center gap-2"><Icon name="eye" className="text-white"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤ (Part 2)</div>
                        <div className="p-6 space-y-6">
                            
                            {/* General Exam Status */}
                            <div className="bg-blue-50 p-4 rounded border border-blue-100 space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="font-medium text-blue-700">‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏à‡∏Å (Cataract)?</span>
                                    <div className="flex gap-2">
                                        {['Yes','No'].map(opt => (
                                            <button key={opt} onClick={()=>setP2({...p2, cataract:opt})} className={`px-3 py-1 rounded text-xs border font-bold ${p2.cataract===opt ? (opt==='Yes'?'bg-red-500 text-white':'bg-green-500 text-white') : 'bg-white text-gray-600'}`}>{opt}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="font-medium text-blue-700">‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ç‡∏¢‡∏≤‡∏¢‡∏°‡πà‡∏≤‡∏ô‡∏ï‡∏≤ (Dilation)?</span>
                                    <div className="flex gap-2">
                                        {['Yes','No'].map(opt => (
                                            <button key={opt} onClick={()=>setP2({...p2, dilation:opt})} className={`px-3 py-1 rounded text-xs border font-bold ${p2.dilation===opt ? 'bg-blue-500 text-white' : 'bg-white text-gray-600'}`}>{opt}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Findings Checklist */}
                            <div>
                                <h4 className="font-bold text-sm text-gray-700 mb-2">Findings Checklist (L/R)</h4>
                                <div className="border rounded-lg overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-100"><tr><th className="p-2 text-left">Condition</th><th className="w-12 text-center">L</th><th className="w-12 text-center">R</th></tr></thead>
                                        <tbody className="divide-y">
                                            {Object.keys(INITIAL_FINDINGS).map(k => (
                                                <tr key={k} className="hover:bg-gray-50/50">
                                                    <td className="p-2">{INITIAL_FINDINGS[k].name}</td>
                                                    <td className="text-center bg-gray-50"><input type="checkbox" checked={findings[k]?.L || false} onChange={()=>toggle(k,'L')}/></td>
                                                    <td className="text-center bg-gray-50"><input type="checkbox" checked={findings[k]?.R || false} onChange={()=>toggle(k,'R')}/></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {/* DR Grading */}
                            <div className="bg-green-50 p-4 rounded border border-green-100">
                                <h4 className="font-bold text-sm text-green-700 uppercase mb-2">Diabetic Retinopathy (DR) Grading</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">Right (‡∏Ç‡∏ß‡∏≤)</label>
                                        <select value={p2.drGradeR} onChange={e=>setP2({...p2, drGradeR:e.target.value})} className="p-2 border rounded bg-white w-full text-sm"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î --</option>{DR_GRADING_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">Left (‡∏ã‡πâ‡∏≤‡∏¢)</label>
                                        <select value={p2.drGradeL} onChange={e=>setP2({...p2, drGradeL:e.target.value})} className="p-2 border rounded bg-white w-full text-sm"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î --</option>{DR_GRADING_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                    </div>
                                </div>
                            </div>

                            {/* Advice */}
                            <div>
                                <label className="text-xs font-bold text-gray-700 uppercase block mb-1">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ / Follow-up Plan</label>
                                <textarea rows="2" value={p2.advice} onChange={e=>setP2({...p2, advice:e.target.value})} className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"></textarea>
                            </div>

                            <button onClick={save} disabled={saving} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition-all shadow-md disabled:opacity-50">{saving?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...':'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [patients, setPatients] = useState([]);
            const [view, setView] = useState('dashboard');
            const [selectedPatient, setSelectedPatient] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if(!user) return;
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                return DB_COLLECTION.orderBy('createdAt', 'desc').onSnapshot(s => {
                    setPatients(s.docs.map(d => ({id: d.id, ...d.data(), createdAt: d.data().createdAt?.toDate()})));
                    if(window.lucide) setTimeout(()=>window.lucide.createIcons(), 100);
                });
            }, [user]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold animate-pulse">Connecting...</div>;
            if (!user) return <AuthScreen />;

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Role ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            const unitName = user.email ? user.email.split('@')[0] : 'Unknown';
            const role = unitName === '10700' ? 'HOSPITAL' : 'PCU';
            
            // --- Dashboard Filtering Logic (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ---
            const dashboardPatients = useMemo(() => {
                // HOSPITAL (10700) sees all data
                if (role === 'HOSPITAL') {
                    return patients;
                } 
                
                // PCU sees only their own submitted cases (filtered by senderId, which is user.uid)
                return patients.filter(p => p.senderId === user.uid);

            }, [patients, role, user]);
            // --- End Dashboard Filtering Logic ---


            return (
                <div className="max-w-4xl mx-auto p-4">
                    <nav className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border">
                        <div className="flex items-center gap-2 font-bold text-gray-700 text-lg"><Icon name="activity" className="text-blue-600"/> EyeDM</div>
                        <div className="flex items-center gap-3">
                            <div className="hidden sm:flex flex-col items-end">
                                <span className="text-sm font-bold text-gray-800">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: {unitName}</span>
                                <span className="text-xs text-gray-500">{role === 'HOSPITAL' ? '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•' : '‡∏£‡∏û.‡∏™‡∏ï.'}</span>
                            </div>
                            <button onClick={()=>auth.signOut()} className="text-red-500 hover:bg-red-50 p-2 rounded border border-transparent hover:border-red-100 transition-colors" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"><Icon name="log-out" size={20}/></button>
                        </div>
                    </nav>
                    
                    {/* ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà Dashboard */}
                    {view === 'dashboard' && <Dashboard role={role} patients={dashboardPatients} onNew={()=>setView('pcu')} onSelect={p=>{setSelectedPatient(p); setView('hospital');}} onBulkImport={()=>setView('bulk_import')}/>}
                    {/* PCUForm ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (patients) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Auto-fill */}
                    {view === 'pcu' && <PCUForm onBack={()=>setView('dashboard')} userId={user.uid} existingPatients={patients} />}
                    {view === 'hospital' && <HospitalForm patient={selectedPatient} onBack={()=>setView('dashboard')} />}
                    {view === 'bulk_import' && <BulkImportScreen onBack={()=>setView('dashboard')} userId={user.uid} />}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
