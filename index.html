<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - Login 5 หลัก</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Offline persistence
        db.enablePersistence({ synchronizeTabs: true }).catch(err => {});

        const DB_COLLECTION = db.collection('artifacts').doc('diabetic-sisaket-v4').collection('public_patients');

        // --- Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            const iconName = name.toLowerCase().replace(/([A-Z])/g, "-$1").replace(/^-/, ""); 
            return <i data-lucide={iconName} width={size} height={size} className={className}></i>;
        };

        const VA_OPTIONS = ["20/20 (ปกติ)", "20/40", "20/50", "20/70", "20/200", "CF", "HM", "PL", "NPL"];

        // --- Auth Screen (5-Digit Login) ---
        const AuthScreen = () => {
            const [unitId, setUnitId] = useState('');
            const [password, setPassword] = useState('');
            const [isRegister, setIsRegister] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // เทคนิค: แปลงเลข 5 หลักเป็นอีเมลหลอกๆ เพื่อให้ Firebase ยอมรับ
            const DUMMY_DOMAIN = "@eyedm.com";

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if(unitId.length < 5) {
                    setError("รหัสหน่วยงานต้องมีอย่างน้อย 5 หลัก");
                    return;
                }

                setLoading(true);
                setError('');

                const fakeEmail = unitId + DUMMY_DOMAIN; // เช่น 10700@eyedm.com

                try {
                    if (isRegister) {
                        await auth.createUserWithEmailAndPassword(fakeEmail, password);
                        alert(`ลงทะเบียนรหัสหน่วยงาน ${unitId} สำเร็จ!`);
                    } else {
                        await auth.signInWithEmailAndPassword(fakeEmail, password);
                    }
                } catch (err) {
                    console.error(err);
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                        setError("รหัสหน่วยงาน หรือ รหัสผ่าน ไม่ถูกต้อง");
                    } else if (err.code === 'auth/email-already-in-use') {
                        setError("รหัสหน่วยงานนี้ถูกลงทะเบียนไปแล้ว");
                    } else if (err.code === 'auth/weak-password') {
                        setError("รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร");
                    } else {
                        setError("Error: " + err.message);
                    }
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-cyan-500 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-4 border-white/50">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600">
                                <Icon name="building-2" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">{isRegister ? 'ลงทะเบียนหน่วยงาน' : 'เข้าสู่ระบบ'}</h1>
                            <p className="text-slate-500 text-sm">EyeDM Connect (Secure System)</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">รหัสหน่วยงาน (5 หลัก)</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        inputMode="numeric" 
                                        pattern="[0-9]*" 
                                        maxLength="5"
                                        value={unitId} 
                                        onChange={e=>setUnitId(e.target.value.replace(/[^0-9]/g, ''))} 
                                        className="w-full p-3 pl-10 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-lg font-mono tracking-widest font-bold text-gray-700" 
                                        placeholder="xxxxx" 
                                        required 
                                    />
                                    <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="hash" size={18}/></div>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">รหัสผ่าน (Password)</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={e=>setPassword(e.target.value)} 
                                        className="w-full p-3 pl-10 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" 
                                        placeholder="อย่างน้อย 6 ตัวอักษร" 
                                        required 
                                    />
                                    <div className="absolute left-3 top-3.5 text-gray-400"><Icon name="lock" size={18}/></div>
                                </div>
                            </div>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm border border-red-200 flex gap-2"><Icon name="alert-circle" size={16}/> {error}</div>}

                            <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 disabled:opacity-50">
                                {loading ? 'กำลังประมวลผล...' : (isRegister ? 'ลงทะเบียน' : 'เข้าสู่ระบบ')}
                            </button>
                        </form>

                        <div className="mt-6 text-center text-sm">
                            <button onClick={()=>{setIsRegister(!isRegister); setError('');}} className="text-blue-600 hover:underline font-medium">
                                {isRegister ? 'มีบัญชีอยู่แล้ว? เข้าสู่ระบบ' : 'ยังไม่มีบัญชี? ลงทะเบียนใหม่'}
                            </button>
                        </div>
                        
                        {!isRegister && <div className="mt-4 pt-4 border-t text-center text-xs text-gray-400">
                            * รหัส <b>10700</b> สำหรับโรงพยาบาลแม่ข่าย<br/>
                            * รหัสอื่นๆ สำหรับ รพ.สต.
                        </div>}
                    </div>
                </div>
            );
        };

        // --- Dashboard (Main) ---
        const Dashboard = ({ role, patients, onNew, onSelect }) => {
            const [term, setTerm] = useState('');
            const filtered = useMemo(() => patients.filter(p => (p.part1?.idCard+p.part1?.name).includes(term)), [patients, term]);
            
            const handleDelete = async (id) => {
                if(confirm("ยืนยันการลบ?")) await DB_COLLECTION.doc(id).delete();
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex flex-col md:flex-row justify-between md:items-end gap-4">
                        <div>
                            <h2 className="text-2xl font-bold flex items-center gap-2 text-slate-800">
                                <Icon name={role==='PCU'?'home':'building-2'} className={role==='PCU'?'text-green-600':'text-blue-600'} />
                                {role === 'PCU' ? 'ทะเบียนผู้ป่วย (รพ.สต.)' : 'รายการส่งตัว (Hospital)'}
                            </h2>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="relative flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                                <p className="text-xs text-green-600 font-bold">Online Real-time</p>
                            </div>
                        </div>
                        {role === 'PCU' && <button onClick={onNew} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow flex gap-2 font-bold items-center"><Icon name="plus-circle" size={18}/> เพิ่มผู้ป่วยใหม่</button>}
                    </div>

                    <div className="bg-white p-2 rounded-xl shadow border flex gap-2 items-center">
                        <Icon name="search" className="text-gray-400 ml-2"/>
                        <input type="text" value={term} onChange={e=>setTerm(e.target.value)} placeholder="ค้นหาด้วยเลขบัตรประชาชน หรือ ชื่อ..." className="flex-1 p-2 outline-none" />
                    </div>

                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-3">วันที่</th><th className="p-3">ผู้ป่วย</th><th className="p-3">สถานะ</th><th className="p-3 text-right">Action</th></tr></thead>
                            <tbody className="divide-y">
                                {filtered.map(p => (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                        <td className="p-3 text-gray-500 align-top">
                                            {p.createdAt?.toLocaleDateString('th-TH')}
                                            <div className="text-xs text-gray-400">{p.createdAt?.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div>
                                        </td>
                                        <td className="p-3 align-top">
                                            <div className="font-bold text-blue-600 font-mono text-base">{p.part1.idCard}</div>
                                            <div className="font-medium text-gray-800">{p.part1.name}</div>
                                            {p.part1.vaRight && <div className="text-xs text-gray-500 mt-1 bg-gray-100 w-fit px-1 rounded">VA: {p.part1.vaRight}/{p.part1.vaLeft}</div>}
                                        </td>
                                        <td className="p-3 align-top"><span className={`px-2 py-1 rounded-full text-xs font-bold inline-flex items-center gap-1 ${p.status==='Waiting'?'bg-orange-100 text-orange-700':'bg-green-100 text-green-700'}`}>
                                            <span className={`w-1.5 h-1.5 rounded-full ${p.status==='Waiting'?'bg-orange-500':'bg-green-500'}`}></span>
                                            {p.status==='Waiting'?'รอตรวจ':'ตรวจแล้ว'}
                                        </span></td>
                                        <td className="p-3 text-right align-top">
                                            <div className="flex justify-end gap-2">
                                                {role === 'HOSPITAL' ? (
                                                    <button onClick={()=>onSelect(p)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-bold text-xs shadow-sm">ตรวจ</button>
                                                ) : <span className="text-gray-400 text-xs bg-gray-100 px-2 py-1 rounded">ส่งตัวแล้ว</span>}
                                                <button onClick={()=>handleDelete(p.id)} className="text-red-400 hover:bg-red-50 p-1 rounded border border-transparent hover:border-red-100"><Icon name="trash-2" size={16}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400 flex flex-col items-center"><Icon name="inbox" size={32} className="mb-2 opacity-50"/>ไม่พบข้อมูลผู้ป่วย</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PCUForm = ({ onBack, userId }) => {
            const [form, setForm] = useState({ idCard:'', name:'', age:'', hba1c:'', bp:'', vaRight:'', vaLeft:'' });
            const [saving, setSaving] = useState(false);
            
            const save = async () => {
                if(!form.idCard) return alert("กรุณากรอกเลขบัตรประชาชน");
                setSaving(true);
                try { await DB_COLLECTION.add({ part1: form, status: 'Waiting', senderId: userId, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); onBack(); } 
                catch(e){alert(e.message); setSaving(false);}
            };

            return (
                <div className="max-w-xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="mb-4 flex gap-1 text-gray-500 hover:text-gray-800 transition-colors"><Icon name="arrow-left" size={16}/> ยกเลิก</button>
                    <div className="bg-white rounded-xl shadow-lg border border-green-100 overflow-hidden">
                         <div className="bg-green-600 p-4 text-white flex items-center gap-2">
                            <Icon name="file-plus" className="text-white"/>
                            <h2 className="font-bold">ส่งตัวผู้ป่วย (Referral)</h2>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">เลขบัตรประชาชน</label>
                                <input className="w-full p-3 border rounded-lg text-lg font-mono tracking-wide focus:ring-2 focus:ring-green-500 outline-none" maxLength="13" placeholder="xxxxxxxxxxxxx" value={form.idCard} onChange={e=>setForm({...form, idCard:e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500">ชื่อ-สกุล</label><input className="w-full p-2 border rounded" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                                <div><label className="text-xs font-bold text-gray-500">อายุ</label><input type="number" className="w-full p-2 border rounded" value={form.age} onChange={e=>setForm({...form, age:e.target.value})} /></div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded border">
                                <div className="text-xs font-bold text-gray-500 mb-2">ค่าสายตา (VA)</div>
                                <div className="grid grid-cols-2 gap-4">
                                     <select className="p-2 border rounded bg-white" value={form.vaRight} onChange={e=>setForm({...form, vaRight:e.target.value})}><option value="">ขวา (Right)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                     <select className="p-2 border rounded bg-white" value={form.vaLeft} onChange={e=>setForm({...form, vaLeft:e.target.value})}><option value="">ซ้าย (Left)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                 <div><label className="text-xs font-bold text-gray-500">HbA1C</label><input className="w-full p-2 border rounded" value={form.hba1c} onChange={e=>setForm({...form, hba1c:e.target.value})} /></div>
                                 <div><label className="text-xs font-bold text-gray-500">ความดัน (BP)</label><input className="w-full p-2 border rounded" value={form.bp} onChange={e=>setForm({...form, bp:e.target.value})} /></div>
                            </div>
                            <button onClick={save} disabled={saving} className="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 transition-all shadow-md disabled:opacity-50">{saving?'กำลังส่ง...':'บันทึกและส่งตัว'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HospitalForm = ({ patient, onBack }) => {
            const [p2, setP2] = useState(patient.part2 || { cataract:'No' });
            const [saving, setSaving] = useState(false);
            const save = async () => {
                setSaving(true);
                try { await DB_COLLECTION.doc(patient.id).update({ part2: p2, status: 'Completed' }); onBack(); } catch(e){alert(e.message); setSaving(false);}
            };
            return (
                <div className="max-w-xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="mb-4 flex gap-1 text-gray-500 hover:text-gray-800"><Icon name="arrow-left" size={16}/> กลับ</button>
                    <div className="bg-white rounded-xl shadow-lg border border-blue-100 overflow-hidden">
                        <div className="bg-blue-600 p-4 text-white flex items-center gap-2">
                            <Icon name="eye" className="text-white"/>
                            <h2 className="font-bold">บันทึกผลตรวจ (Hospital)</h2>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="bg-blue-50 p-4 rounded border border-blue-100">
                                <div className="text-xs text-blue-500 font-bold uppercase mb-1">ผู้ป่วย</div>
                                <div className="font-bold text-xl text-blue-700">{patient.part1.name}</div>
                                <div className="font-mono text-sm text-gray-600">{patient.part1.idCard}</div>
                                <div className="mt-2 text-sm flex gap-3">
                                    <span className="bg-white px-2 py-1 rounded border">VA: {patient.part1.vaRight}/{patient.part1.vaLeft}</span>
                                    <span className="bg-white px-2 py-1 rounded border">HbA1C: {patient.part1.hba1c}</span>
                                </div>
                            </div>
                            <div className="flex justify-between items-center p-2">
                                <span className="font-bold text-gray-700">ต้อกระจก (Cataract)?</span>
                                <div className="flex gap-2">
                                    <button onClick={()=>setP2({cataract:'Yes'})} className={`px-4 py-2 rounded border font-bold transition-all ${p2.cataract==='Yes'?'bg-red-500 text-white border-red-600 shadow-md':'bg-white text-gray-500 hover:bg-gray-50'}`}>Yes</button>
                                    <button onClick={()=>setP2({cataract:'No'})} className={`px-4 py-2 rounded border font-bold transition-all ${p2.cataract==='No'?'bg-green-500 text-white border-green-600 shadow-md':'bg-white text-gray-500 hover:bg-gray-50'}`}>No</button>
                                </div>
                            </div>
                            <button onClick={save} disabled={saving} className="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 transition-all shadow-md disabled:opacity-50">{saving?'กำลังบันทึก...':'ยืนยันผลการตรวจ'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [patients, setPatients] = useState([]);
            const [view, setView] = useState('dashboard');
            const [selectedPatient, setSelectedPatient] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if(!user) return;
                return DB_COLLECTION.orderBy('createdAt', 'desc').onSnapshot(s => {
                    setPatients(s.docs.map(d => ({id: d.id, ...d.data(), createdAt: d.data().createdAt?.toDate()})));
                    if(window.lucide) setTimeout(()=>window.lucide.createIcons(), 100);
                });
            }, [user]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold animate-pulse">Connecting...</div>;
            if (!user) return <AuthScreen />;

            // ตัดเอาเฉพาะชื่อหน่วยงาน (เลข 5 หลัก) มาแสดง
            const unitName = user.email ? user.email.split('@')[0] : 'Unknown';
            const role = unitName === '10700' ? 'HOSPITAL' : 'PCU';

            return (
                <div className="max-w-4xl mx-auto p-4">
                    <nav className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border">
                        <div className="flex items-center gap-2 font-bold text-gray-700 text-lg"><Icon name="activity" className="text-blue-600"/> EyeDM</div>
                        <div className="flex items-center gap-3">
                            <div className="hidden sm:flex flex-col items-end">
                                <span className="text-sm font-bold text-gray-800">หน่วยงาน: {unitName}</span>
                                <span className="text-xs text-gray-500">{role === 'HOSPITAL' ? 'โรงพยาบาล' : 'รพ.สต.'}</span>
                            </div>
                            <button onClick={()=>auth.signOut()} className="text-red-500 hover:bg-red-50 p-2 rounded border border-transparent hover:border-red-100 transition-colors" title="ออกจากระบบ"><Icon name="log-out" size={20}/></button>
                        </div>
                    </nav>
                    
                    {view === 'dashboard' && <Dashboard role={role} patients={patients} onNew={()=>setView('pcu')} onSelect={p=>{setSelectedPatient(p); setView('hospital');}} />}
                    {view === 'pcu' && <PCUForm onBack={()=>setView('dashboard')} userId={user.uid} />}
                    {view === 'hospital' && <HospitalForm patient={selectedPatient} onBack={()=>setView('dashboard')} />}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
