<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - ระบบทะเบียน (Fast Load)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body{font-family:'Sarabun',sans-serif;background:#f1f5f9}.loader{border:3px solid #f3f3f3;border-top:3px solid #3b82f6;border-radius:50%;width:20px;height:20px;animation:s 1s linear infinite}@keyframes s{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID_KEY = "sisaket_prod_v9_registry";
        const ADMIN_CODE = "10700";
        const LIMIT_PER_PAGE = 50; // จำกัดการโหลดครั้งละ 50 รายการ เพื่อกันค้าง

        const Icon = ({name,size=18,className}) => {
            React.useEffect(()=>{if(window.lucide)window.lucide.createIcons()},[name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- AUTH ---
        const AuthScreen = () => {
            const [pin, setPin] = React.useState('');
            const [pass, setPass] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const login = async (e) => {
                e.preventDefault(); setLoading(true);
                try { await auth.signInWithEmailAndPassword(pin+"@sisaket-clinic.org", pass); }
                catch(e) { 
                    if(e.code==='auth/user-not-found') {
                        try{await auth.createUserWithEmailAndPassword(pin+"@sisaket-clinic.org",pass);}catch(e2){alert(e2.message);}
                    } else alert(e.message); 
                }
                setLoading(false);
            };
            return (
                <div className="h-screen flex items-center justify-center bg-slate-900 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-md shadow-xl text-center">
                        <h1 className="text-2xl font-bold text-gray-800 mb-6">EyeDM Login</h1>
                        <form onSubmit={login} className="space-y-4">
                            <input className="w-full p-3 border rounded text-center text-lg tracking-widest" placeholder="รหัส 5 หลัก" value={pin} onChange={e=>setPin(e.target.value.replace(/\D/g,'').slice(0,5))} required autoFocus/>
                            <input className="w-full p-3 border rounded text-center" type="password" placeholder="รหัสผ่าน" value={pass} onChange={e=>setPass(e.target.value)} required/>
                            <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded font-bold disabled:opacity-50">{loading?'...':'เข้าสู่ระบบ'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MAIN ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('PCU');
            const [view, setView] = React.useState('dashboard');
            const [queue, setQueue] = React.useState([]);
            const [editData, setEditData] = React.useState(null);
            const [limitCount, setLimitCount] = React.useState(LIMIT_PER_PAGE);

            React.useEffect(() => auth.onAuthStateChanged(setUser), []);
            
            React.useEffect(() => {
                if (!user) return;
                // LIMIT DATA: Load only recent items to prevent freezing
                const q = db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue')
                    .orderBy('createdAt', 'desc')
                    .limit(limitCount);
                
                return q.onSnapshot(s => {
                    setQueue(s.docs.map(d => ({ id: d.id, ...d.data(), createdAt: d.data().createdAt?.toDate() || new Date() })));
                    setTimeout(() => window.lucide?.createIcons(), 100);
                });
            }, [user, limitCount]);

            const isAdmin = user?.email?.startsWith(ADMIN_CODE);

            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 font-sans text-sm">
                    <nav className="bg-white shadow px-4 py-3 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex gap-3 items-center">
                            <div className={`p-2 rounded text-white ${role==='PCU'?'bg-green-600':'bg-blue-600'}`}><Icon name={role==='PCU'?'home':'hospital'}/></div>
                            <div className="font-bold text-lg text-gray-700">EyeDM <span className="text-gray-400 text-sm font-normal">| {role}</span></div>
                        </div>
                        <div className="flex gap-2">
                            {isAdmin && <button onClick={()=>setView('import')} className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded font-bold hidden md:flex gap-1"><Icon name="upload"/> Import</button>}
                            <div className="bg-gray-100 p-1 rounded flex"><button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`px-3 py-1 rounded ${role==='PCU'?'bg-white shadow':''}`}>PCU</button><button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`px-3 py-1 rounded ${role==='HOSPITAL'?'bg-white shadow':''}`}>Roph</button></div>
                            <button onClick={()=>auth.signOut()} className="text-red-500 p-2 hover:bg-red-50 rounded-full"><Icon name="log-out"/></button>
                        </div>
                    </nav>

                    <main className="flex-1 p-4 max-w-6xl mx-auto w-full">
                        {view === 'dashboard' && <Dashboard role={role} queue={queue} onNew={()=>{setEditData(null);setView('form')}} onEdit={p=>{setEditData(p);setView('form')}} onLoadMore={()=>setLimitCount(c=>c+50)} />}
                        {view === 'form' && <Form db={db} user={user} data={editData} role={role} onBack={()=>setView('dashboard')} />}
                        {view === 'import' && isAdmin && <ImportView db={db} onBack={()=>setView('dashboard')} />}
                    </main>
                </div>
            );
        }

        // --- DASHBOARD (Optimized) ---
        const Dashboard = ({ role, queue, onNew, onEdit, onLoadMore }) => {
            const [search, setSearch] = React.useState('');
            const [tab, setTab] = React.useState('registry');

            // Use Memo to prevent heavy filtering on every render
            const filtered = React.useMemo(() => {
                return queue.filter(p => {
                    const txt = search.toLowerCase();
                    const match = (p.part1?.idCard||'').includes(txt) || (p.part1?.name||'').includes(txt);
                    if (!match) return false;
                    if (role === 'PCU') return tab === 'registry' ? p.status === 'Registered' : (p.status === 'Waiting' || p.status === 'Completed');
                    return p.status === 'Waiting' || p.status === 'Completed';
                });
            }, [queue, search, tab, role]);

            const handleSend = async (id) => {
                if(confirm('ส่งตัวผู้ป่วยรายนี้?')) await db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue').doc(id).update({status:'Waiting',sentAt:firebase.firestore.FieldValue.serverTimestamp()});
            };
            const handleDel = async (id) => {
                if(confirm('ลบข้อมูล?')) await db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue').doc(id).delete();
            };

            return (
                <div className="space-y-4 animate-in fade-in">
                    {role === 'PCU' && <div className="flex bg-gray-200 p-1 rounded-lg max-w-sm"><button onClick={()=>setTab('registry')} className={`flex-1 py-1.5 rounded text-center ${tab==='registry'?'bg-white shadow':''}`}>ทะเบียน</button><button onClick={()=>setTab('sent')} className={`flex-1 py-1.5 rounded text-center ${tab==='sent'?'bg-white shadow':''}`}>ส่งแล้ว</button></div>}
                    
                    <div className="flex gap-2">
                        <div className="relative flex-1"><Icon name="search" className="absolute left-3 top-2.5 text-gray-400"/><input className="w-full pl-10 pr-4 py-2 border rounded-lg" placeholder="ค้นหา..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
                        {role==='PCU' && tab==='registry' && <button onClick={onNew} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow flex gap-1"><Icon name="plus"/> เพิ่ม</button>}
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-3">วันที่</th><th className="p-3">ผู้ป่วย</th><th className="p-3">สถานะ</th><th className="p-3 text-right">จัดการ</th></tr></thead>
                            <tbody className="divide-y">
                                {filtered.map(p => (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                        <td className="p-3 text-gray-500 whitespace-nowrap">{p.createdAt.toLocaleDateString('th-TH')}</td>
                                        <td className="p-3">
                                            <div className="font-bold text-blue-700">{p.part1.idCard}</div>
                                            <div className="text-gray-600">{p.part1.name}</div>
                                            {p.part1.hba1c && <div className="text-xs bg-gray-100 inline-block px-1 rounded mt-1">A1C: {p.part1.hba1c}</div>}
                                        </td>
                                        <td className="p-3">{p.status==='Registered'?<span className="px-2 py-1 bg-gray-100 rounded border text-xs">ลงทะเบียน</span>:p.status==='Waiting'?<span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded border text-xs">รอตรวจ</span>:<span className="px-2 py-1 bg-green-100 text-green-800 rounded border text-xs">เสร็จสิ้น</span>}</td>
                                        <td className="p-3 text-right flex justify-end gap-2">
                                            {role==='PCU' && p.status==='Registered' && <button onClick={()=>handleSend(p.id)} className="p-2 bg-green-100 text-green-700 rounded hover:bg-green-200"><Icon name="send" size={16}/></button>}
                                            <button onClick={()=>onEdit(p)} className="p-2 border rounded hover:bg-gray-50 text-blue-600"><Icon name={role==='HOSPITAL'&&p.status==='Waiting'?'stethoscope':'pencil'} size={16}/></button>
                                            <button onClick={()=>handleDel(p.id)} className="p-2 border rounded hover:bg-red-50 text-red-500"><Icon name="trash-2" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">ไม่พบข้อมูล</td></tr>}
                            </tbody>
                        </table>
                        <div className="p-2 text-center border-t bg-gray-50">
                            <button onClick={onLoadMore} className="text-blue-600 text-xs hover:underline">โหลดข้อมูลเพิ่ม...</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- UNIFIED FORM (PCU & Hospital Logic in One) ---
        const Form = ({ db, user, data, role, onBack }) => {
            const isEdit = !!data;
            const isHospital = role === 'HOSPITAL';
            
            // State
            const [p1, setP1] = React.useState(data?.part1 || { idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [p2, setP2] = React.useState(data?.part2 || { cataract:'No', retinaFound:'Yes' });
            const [findings, setFindings] = React.useState(data?.findings || { Normal:{L:false,R:false} });
            
            const [saving, setSaving] = React.useState(false);
            const [suggestions, setSugg] = React.useState([]);

            // PCU Logic: Auto Search
            const handleId = async (e) => {
                const v = e.target.value; setP1({...p1, idCard:v});
                if(!isEdit && !isHospital && v.length>=3) {
                    try {
                        const s = await db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue').where('part1.idCard','>=',v).where('part1.idCard','<=',v+'\uf8ff').limit(5).get();
                        setSugg(s.docs.map(d=>d.data().part1).filter((v,i,a)=>a.findIndex(t=>t.name===v.name)===i));
                    } catch(e){}
                } else setSugg([]);
            };

            const save = async () => {
                setSaving(true);
                const ref = db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue');
                
                if (isHospital) {
                    // Hospital Save
                    await ref.doc(data.id).update({ part2: p2, findings, status: 'Completed', doctorName: user.email });
                } else {
                    // PCU Save
                    if(!p1.idCard) return alert('ระบุเลขบัตร');
                    
                    // Check Dup Today (Only new)
                    if (!isEdit) {
                        const today = new Date().toDateString();
                        const dup = await ref.where('part1.idCard','==',p1.idCard).get();
                        if(dup.docs.some(d=>(d.data().createdAt?.toDate?d.data().createdAt.toDate():new Date(d.data().createdAt)).toDateString()===today)) {
                            alert('ส่งซ้ำวันนี้ไม่ได้'); setSaving(false); return;
                        }
                    }

                    const payload = { part1: p1, pcuId: user.uid, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                    if(isEdit) await ref.doc(data.id).update(payload);
                    else { payload.status='Registered'; payload.createdAt=firebase.firestore.FieldValue.serverTimestamp(); await ref.add(payload); }
                }
                onBack();
            };

            return (
                <div className="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow border animate-in zoom-in duration-200">
                    <div className="flex justify-between mb-4 border-b pb-2">
                        <h2 className="font-bold text-lg">{isHospital ? 'บันทึกผลตรวจ' : (isEdit?'แก้ไข':'ลงทะเบียน')}</h2>
                        <button onClick={onBack} className="text-gray-400">ปิด</button>
                    </div>

                    {/* Part 1: Patient Info */}
                    <div className={`space-y-4 ${isHospital ? 'opacity-70 pointer-events-none' : ''}`}>
                        <div className="relative">
                            <label className="block text-xs text-gray-500">เลขบัตร</label>
                            <input value={p1.idCard} onChange={handleId} className="w-full p-2 border rounded" maxLength="13"/>
                            {suggestions.length>0 && <div className="absolute z-10 w-full bg-white border shadow-xl rounded mt-1">{suggestions.map((s,i)=><div key={i} onClick={()=>{setP1(s);setSugg([])}} className="p-2 hover:bg-blue-50 cursor-pointer text-sm">{s.idCard} - {s.name}</div>)}</div>}
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <Input label="ชื่อ-สกุล" val={p1.name} set={v=>setP1({...p1,name:v})}/>
                            <Input label="HbA1C" val={p1.hba1c} set={v=>setP1({...p1,hba1c:v})}/>
                        </div>
                        {!isHospital && <div className="grid grid-cols-3 gap-3"><Input label="BP" val={p1.bp} set={v=>setP1({...p1,bp:v})}/><Input label="Wt" val={p1.weight} set={v=>setP1({...p1,weight:v})}/><Input label="Ht" val={p1.height} set={v=>setP1({...p1,height:v})}/></div>}
                        <div className="grid grid-cols-2 gap-3 p-3 bg-gray-50 rounded border"><Input label="VA L" val={p1.vaLeft} set={v=>setP1({...p1,vaLeft:v})}/><Input label="VA R" val={p1.vaRight} set={v=>setP1({...p1,vaRight:v})}/></div>
                    </div>

                    {/* Part 2: Hospital Only */}
                    {isHospital && (
                        <div className="mt-6 pt-4 border-t border-blue-200">
                             <h3 className="font-bold text-blue-800 mb-3">ผลตรวจจอประสาทตา</h3>
                             <div className="flex gap-4 mb-4">
                                <BtnToggle label="พบจอประสาทตา" val={p2.retinaFound} set={v=>setP2({...p2,retinaFound:v})}/>
                                <BtnToggle label="ต้อกระจก" val={p2.cataract} set={v=>setP2({...p2,cataract:v})}/>
                             </div>
                             <table className="w-full text-sm border rounded mb-4">
                                <thead className="bg-gray-100"><tr><th className="p-2 text-left">Condition</th><th className="p-2 text-center w-12">L</th><th className="p-2 text-center w-12">R</th></tr></thead>
                                <tbody className="divide-y">{['Normal','MicroAneurysm','HardExudate','FlameHemorrhage'].map(k=>(<tr key={k}><td className="p-2">{k}</td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.L} onChange={()=>setFindings({...findings,[k]:{...findings[k],L:!findings[k]?.L}})}/></td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.R} onChange={()=>setFindings({...findings,[k]:{...findings[k],R:!findings[k]?.R}})}/></td></tr>))}</tbody>
                             </table>
                        </div>
                    )}

                    <div className="mt-6 flex gap-3">
                        <button onClick={onBack} className="flex-1 border py-2 rounded text-gray-500">ยกเลิก</button>
                        <button onClick={save} disabled={saving} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold shadow">{saving?'Saving...':isHospital?'ยืนยันผล':'บันทึก'}</button>
                    </div>
                </div>
            );
        };

        const Input = ({label, val, set}) => (<div><label className="text-xs text-gray-500">{label}</label><input value={val||''} onChange={e=>set(e.target.value)} className="w-full p-2 border rounded"/></div>);
        const BtnToggle = ({label, val, set}) => (<div className="flex items-center gap-2"><span className="text-sm">{label}:</span><button onClick={()=>set('Yes')} className={`px-2 py-0.5 text-xs rounded border ${val==='Yes'?'bg-blue-600 text-white':''}`}>ใช่</button><button onClick={()=>set('No')} className={`px-2 py-0.5 text-xs rounded border ${val==='No'?'bg-blue-600 text-white':''}`}>ไม่</button></div>);

        // --- IMPORT (Admin) ---
        const ImportView = ({db, onBack}) => {
            const [data, setData] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const handle = (e) => Papa.parse(e.target.files[0], {header:true, skipEmptyLines:true, encoding:'TIS-620', complete:r=>setData(r.data)});
            const run = async () => {
                if(!data.length)return; setLoading(true);
                let c=0;
                // Batch 50 to avoid freezing
                for(let i=0; i<data.length; i++) {
                    const row = data[i];
                    const id = (row['เลข 13 หลัก']||row['pid']||'').toString().replace(/\D/g,'');
                    if(id.length===13) {
                        await db.collection('artifacts').doc(APP_ID_KEY).collection('dr_queue').add({
                           part1:{idCard:id, name:row['ชื่อสกุล']||row['fullname']||'-', hba1c:row['HbA1C']||'-', source:'Import'},
                           status:'Registered', createdAt:firebase.firestore.FieldValue.serverTimestamp()
                        });
                        c++;
                    }
                    if(i%50===0) await new Promise(r=>setTimeout(r,50)); // Breathe
                }
                setLoading(false); alert(`Imported ${c}`);
            };
            return (
                <div className="bg-white p-6 rounded shadow max-w-2xl mx-auto">
                    <h2 className="font-bold text-xl mb-4">Import Excel (CSV TIS-620)</h2>
                    <input type="file" accept=".csv" onChange={handle} className="mb-4 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    {data.length>0 && <div className="mb-4 text-sm text-gray-600">พบ {data.length} แถว (ตัวอย่าง: {data[0]['ชื่อสกุล']||data[0]['fullname']})</div>}
                    <div className="flex gap-2"><button onClick={onBack} className="border px-4 py-2 rounded">กลับ</button><button onClick={run} disabled={loading} className="bg-green-600 text-white px-4 py-2 rounded font-bold shadow">{loading?`Importing...`:'Start'}</button></div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
