<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load SheetJS (xlsx.js) for Excel Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,     
            setLogLevel, 
            query,      
            where,      
            getDocs,
            Timestamp // **‡πÄ‡∏û‡∏¥‡πà‡∏°** Timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ query ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- START: Configuration ---
        // Config ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ (Hardcoded)
        const firebaseConfig = {
          apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
          authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
          projectId: "eyedm-3ebc8-7c029",
          storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
          messagingSenderId: "327117771686",
          appId: "1:327117771686:web:e66c7683e4613d5b8db567",
          measurementId: "G-N48NPP7K9J"
        };
        
        // Domain ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Firebase (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô Console)
        const LOGIN_EMAIL_SUFFIX = "@sisaket-clinic.org"; 
        
        // Hardcoded Staff Name Mapping (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏û.‡∏™‡∏ï. ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
        const STAFF_MAPPING = {
            "03280": "‡∏£‡∏û.‡∏™‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏£‡∏Å",
            // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà: "ID": "‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏û.‡∏™‡∏ï.",
        };

        let app, db, auth;
        let globalAppId = firebaseConfig.appId || "default-app-id";
        let isFirebaseReady = false; 
        let currentUserId = null;
        let currentStaffName = null;
        // --- END: Configuration ---
        
        
        // --- Firebase Initialization ---
        setLogLevel('Debug');

        async function initializeFirebase(config) {
            try {
                if (config.apiKey) {
                    app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    globalAppId = config.appId || 'default-app-id'; 

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Auth State Changed: Logged IN", user.uid, user.email);
                            isFirebaseReady = true;
                            currentUserId = user.uid;
                            
                            const staffId = user.email ? user.email.split('@')[0] : user.uid;
                            currentStaffName = STAFF_MAPPING[staffId] || `User ID: ${staffId}`;
                            
                            displayUserId(user); 
                            validateSaveButton(); 
                            
                            // ‡∏ã‡πà‡∏≠‡∏ô Login Modal ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            document.getElementById('login-modal').classList.add('hidden');
                            document.getElementById('main-app-content').classList.remove('opacity-20', 'pointer-events-none');
                            
                            // **NEW** ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Sections 2 ‡πÅ‡∏•‡∏∞ 3 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏£‡∏û.‡∏™‡∏ï./PCU
                            toggleSectionsReadOnly(true); 

                        } else {
                            console.log("Auth State Changed: Logged OUT");
                            isFirebaseReady = false;
                            currentUserId = null;
                            currentStaffName = null;
                            displayUserId(null); 
                            validateSaveButton(); 
                            
                            // ‡πÅ‡∏™‡∏î‡∏á Login Modal ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            document.getElementById('login-modal').classList.remove('hidden');
                            document.getElementById('main-app-content').classList.add('opacity-20', 'pointer-events-none');
                            
                            // **NEW** ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ) ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà
                            toggleSectionsReadOnly(false); 
                        }
                    });

                } else {
                    console.error("Firebase configuration is missing or empty.");
                    displayUserId(null, "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Config missing)");
                }
            } catch (error) {
                console.error("Firebase Initialization failed:", error);
                displayUserId(null, `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Init Error)`);
            }
        }
        
        // **NEW** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Sections
        function toggleSectionsReadOnly(disable) {
            const sections = [
                document.getElementById('section2-container'),
                document.getElementById('section3-container')
            ];
            
            sections.forEach(section => {
                if (section) {
                    section.classList.toggle('opacity-50', disable);
                    section.classList.toggle('pointer-events-none', disable);
                    section.title = disable ? "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏£‡∏û.‡∏™‡∏ï./PCU ‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1" : "";
                }
            });
        }
        
        async function handleLogin() {
            const userIdInput = document.getElementById('login-user-id').value.trim();
            const passwordInput = document.getElementById('login-password').value.trim();
            const loginStatus = document.getElementById('login-status');
            const loginButton = document.getElementById('login-button');

            if (!userIdInput || !passwordInput) {
                loginStatus.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
                return;
            }
            
            const email = userIdInput + LOGIN_EMAIL_SUFFIX;

            loginButton.disabled = true;
            loginStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

            try {
                await signInWithEmailAndPassword(auth, email, passwordInput);
                loginStatus.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            } catch (error) {
                console.error("Login FAILED:", error);
                let errorMessage = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                } else {
                    errorMessage = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                }
                loginStatus.textContent = errorMessage;
            } finally {
                loginButton.disabled = false;
            }
        }
        
        async function handleLogout() {
             try {
                await signOut(auth);
                hideMessage();
             } catch (error) {
                 console.error("Logout FAILED:", error);
                 displayMessage(`‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
             }
        }

        // --- Global App Logic ---

        function displayUserId(user, errorMessage = null) {
            const userIdElement = document.getElementById('user-info');
            const logoutButton = document.getElementById('logout-button');
            const staffNameDisplay = document.getElementById('staff-name-display');

            if (errorMessage) {
                userIdElement.innerHTML = `<span class="font-bold text-red-600">${errorMessage}</span>`;
                logoutButton.classList.add('hidden');
                staffNameDisplay.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            } else if (user) {
                userIdElement.innerHTML = `<span class="font-bold text-green-600">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span> | UID: <span class="text-xs">${user.uid.substring(0, 10)}...</span>`;
                staffNameDisplay.textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentStaffName}`;
                userIdElement.className = "text-sm text-gray-700";
                logoutButton.classList.remove('hidden');
            } else {
                userIdElement.innerHTML = `<span class="font-bold text-red-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>`;
                staffNameDisplay.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                userIdElement.className = "text-sm text-red-600";
                logoutButton.classList.add('hidden');
            }
        }
        
        const debouncedSearchPatient = debounce(async () => {
            if (!isFirebaseReady) return; 
            validateSaveButton(); 
            const searchId = document.getElementById('patient-id').value.trim();
            const resultsContainer = document.getElementById('autocomplete-results');
            if (searchId.length <= 3) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                return;
            }
            if (!db || !currentUserId) {
                console.warn("DB not ready for autocomplete");
                return;
            }
            
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`; 

            const q = query(
                collection(db, collectionPath),
                where("patientId", ">=", searchId),
                where("patientId", "<=", searchId + '\uf8ff')
            );
            try {
                const querySnapshot = await getDocs(q);
                const patientMap = new Map();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!patientMap.has(data.patientId) || new Date(data.timestamp) > new Date(patientMap.get(data.patientId).timestamp)) {
                         patientMap.set(data.patientId, data);
                    }
                });
                resultsContainer.innerHTML = ''; 
                if (patientMap.size === 0) {
                    resultsContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                } else {
                    patientMap.forEach((patientData, patientId) => {
                        const staffId = (patientData.uploaderId || '').split('@')[0];
                        const staffName = STAFF_MAPPING[staffId] || staffId;
                        const queueNo = patientData.queueNumber || 'N/A';
                        
                        const item = document.createElement('div');
                        item.className = 'p-2 text-sm text-gray-800 hover:bg-blue-100 cursor-pointer';
                        item.textContent = `${patientId} - ${patientData.patientName} (‡∏Ñ‡∏¥‡∏ß: ${queueNo}, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${staffName})`;
                        item.onclick = (e) => {
                            e.stopPropagation(); 
                            populateFormWithPatientData(patientData);
                        };
                        resultsContainer.appendChild(item);
                    });
                }
                resultsContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Error during partial search:", error);
                resultsContainer.innerHTML = '<div class="p-2 text-red-500 text-sm">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
                resultsContainer.classList.remove('hidden');
            }
        }, 300);

        function populateFormWithPatientData(data) {
            // ... (populateFormWithPatientData logic remains the same)
            const findingsContainer = document.getElementById('section3-findings');
            findingsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('patient-id').value = data.patientId || '';
            document.getElementById('patient-name').value = data.patientName || '';
            document.getElementById('diabetes-years').value = data.diabetesYears || '';
            document.getElementById('hba1c').value = data.hba1c || '';
            document.getElementById('blood-pressure').value = data.bloodPressure || '';
            document.getElementById('weight').value = data.weight || '';
            document.getElementById('height').value = data.height || '';
            document.getElementById('va-od').value = data.vaOD || '';
            document.getElementById('va-os').value = data.vaOS || '';
            document.getElementById('is-wheelchair').checked = data.isWheelchair || false;
            const hasExam = data.hasPreviousExam || false;
            document.getElementById('has-previous-exam').checked = hasExam;
            togglePreviousExamCount(hasExam);
            document.getElementById('previous-exam-count').value = data.previousExamCount || '';
            document.getElementById('has-cataract').checked = data.hasCataract || false;
            document.getElementById('hearing-clear').checked = data.hearingClear || false;
            document.getElementById('can-sit-chair').checked = data.canSitChair || false;
            document.getElementById('needs-eyelid-lift').checked = data.needsEyelidLift || false;
            if (data.findings) {
                const f = data.findings;
                document.getElementById('finding-normal-or').checked = f.normal?.or || false;
                document.getElementById('finding-normal-ol').checked = f.normal?.ol || false;
                document.getElementById('finding-microaneurysm-or').checked = f.microaneurysm?.or || false;
                document.getElementById('finding-microaneurysm-ol').checked = f.microaneurysm?.ol || false;
                document.getElementById('finding-hardexudate-or').checked = f.hardExudate?.or || false;
                document.getElementById('finding-hardexudate-ol').checked = f.hardExudate?.ol || false;
                document.getElementById('finding-flame-or').checked = f.flameHemorrhage?.or || false;
                document.getElementById('finding-flame-ol').checked = f.flameHemorrhage?.ol || false;
                document.getElementById('finding-venous-or').checked = f.venousBeading?.or || false;
                document.getElementById('finding-venous-ol').checked = f.venousBeading?.ol || false;
                document.getElementById('finding-irma-or').checked = f.irma?.or || false;
                document.getElementById('finding-irma-ol').checked = f.irma?.ol || false;
                document.getElementById('finding-newvessel-or').checked = f.newVessel?.or || false;
                document.getElementById('finding-newvessel-ol').checked = f.newVessel?.ol || false;
                document.getElementById('finding-preretinal-or').checked = f.preretinalHemorrhage?.or || false;
                document.getElementById('finding-preretinal-ol').checked = f.preretinalHemorrhage?.ol || false;
                document.getElementById('finding-vitreous-or').checked = f.vitreousHemorrhage?.or || false;
                document.getElementById('finding-vitreous-ol').checked = f.vitreousHemorrhage?.ol || false;
                document.getElementById('finding-fibrous-or').checked = f.fibrousProliferation?.or || false;
                document.getElementById('finding-fibrous-ol').checked = f.fibrousProliferation?.ol || false;
            }
            document.getElementById('referral-needed').checked = data.referralNeeded || false;
            const resultsContainer = document.getElementById('autocomplete-results');
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            validateSaveButton();
            displayMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'success');
        }

        // ... (other helper functions remain the same)
        function togglePreviousExamCount(isChecked) {
            const container = document.getElementById('previous-exam-count-container');
            if (isChecked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                document.getElementById('previous-exam-count').value = '';
            }
        }

        function displayMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'mt-8 p-4 rounded-xl text-center';
            box.classList.remove('hidden');
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-blue-100', 'text-blue-700');
            }
        }
        
        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        function validateSaveButton() {
            const patientId = document.getElementById('patient-id').value;
            const patientName = document.getElementById('patient-name').value;
            const saveButton = document.getElementById('save-button');
            const clearButton = document.getElementById('clear-button'); 
            const isValid = patientId.length === 13 && /^\d+$/.test(patientId) && patientName.trim() !== '';
            const isAnythingToClear = patientId.trim() !== '' || patientName.trim() !== '';
            
            saveButton.disabled = !isValid || !isFirebaseReady; 
            clearButton.disabled = !isAnythingToClear; 
        }

        function clearForm() {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            togglePreviousExamCount(false);
            hideMessage();
            const resultsContainer = document.getElementById('autocomplete-results');
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            validateSaveButton();
        }
        
        // **NEW** Helper Function to get today's queue count
        async function getTodayQueueNumber() {
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            
            // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (00:00:00 ‡∏ñ‡∏∂‡∏á 23:59:59 ‡πÉ‡∏ô Local Time)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á today@00:00:00 ‡∏ñ‡∏∂‡∏á tomorrow@00:00:00
            const q = query(
                collection(db, collectionPath),
                where("queueDate", "==", today.toISOString().split('T')[0]) // ‡πÉ‡∏ä‡πâ date string ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            );
            
            try {
                const querySnapshot = await getDocs(q);
                // ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö + 1
                return querySnapshot.size + 1;
            } catch (error) {
                console.error("Error fetching today's queue count:", error);
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏£‡∏Å
                return 1;
            }
        }
        
        // **NEW** Function to display queue result
        function displayQueueResult(patientName, queueNumber, staffName) {
            const queueBox = document.getElementById('queue-display-box');
            queueBox.innerHTML = `
                <div class="p-6 bg-yellow-100 border border-yellow-300 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-extrabold text-yellow-800 mb-2">üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                    <p class="text-6xl font-black text-red-600 mb-4">${queueNumber}</p>
                    <p class="text-lg font-semibold text-gray-800">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${patientName}</p>
                    <p class="text-sm text-gray-600 mt-2">‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}</p>
                    <p class="text-xs text-gray-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${staffName}</p>
                </div>
            `;
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß
            document.getElementById('main-app-content').classList.add('hidden');
            queueBox.classList.remove('hidden');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                queueBox.classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                clearForm();
            }, 5000);
        }


        async function savePatientData() {
            if (!isFirebaseReady || !currentUserId) {
                displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }
            const userEmail = auth.currentUser.email; 
            const saveButton = document.getElementById('save-button');
            const buttonText = document.getElementById('save-button-text');
            const spinner = document.getElementById('save-spinner');
            saveButton.disabled = true;
            buttonText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            spinner.classList.remove('hidden');
            hideMessage();
            try {
                // **NEW** 1. Get today's queue number
                const queueNumber = await getTodayQueueNumber();
                const todayDateString = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
                
                const recordData = {
                    patientId: document.getElementById('patient-id').value.trim(),
                    patientName: document.getElementById('patient-name').value.trim(),
                    diabetesYears: Number(document.getElementById('diabetes-years').value) || null,
                    hba1c: document.getElementById('hba1c').value.trim(),
                    bloodPressure: document.getElementById('blood-pressure').value.trim(),
                    weight: Number(document.getElementById('weight').value) || null,
                    height: Number(document.getElementById('height').value) || null,
                    vaOD: document.getElementById('va-od').value,
                    vaOS: document.getElementById('va-os').value,
                    isWheelchair: document.getElementById('is-wheelchair').checked,
                    hasPreviousExam: document.getElementById('has-previous-exam').checked,
                    previousExamCount: document.getElementById('has-previous-exam').checked ? Number(document.getElementById('previous-exam-count').value) : null,
                    
                    // **‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡∏∞ 3 ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ ‡∏£‡∏û.‡∏™‡∏ï./PCU ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å**
                    hasCataract: false,
                    hearingClear: false,
                    canSitChair: false,
                    needsEyelidLift: false,
                    findings: {}, 
                    referralNeeded: false,
                    // -----------------------------------------------------------------

                    timestamp: new Date().toISOString(),
                    uploaderId: userEmail,
                    queueNumber: queueNumber, // **NEW** Queue Number
                    queueDate: todayDateString // **NEW** Date for queue grouping
                };
                const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                await addDoc(collection(db, collectionPath), recordData);
                
                // **NEW** 2. Display the Queue Result
                displayQueueResult(recordData.patientName, queueNumber, currentStaffName);

            } catch (error) {
                console.error("Error saving patient data:", error);
                displayMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`, 'error');
            } finally {
                validateSaveButton(); 
                buttonText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
                spinner.classList.add('hidden');
            }
        }
        // ... (importFromExcel logic needs uploaderEmail)
        async function importFromExcel() {
            if (!isFirebaseReady || !currentUserId) {
                displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }
            const userEmail = auth.currentUser.email;
            const fileInput = document.getElementById('excel-file-input');
            const importButton = document.getElementById('import-button');
            const buttonText = document.getElementById('import-button-text');
            const spinner = document.getElementById('import-spinner');
            const statusEl = document.getElementById('import-status');
            const file = fileInput.files[0];
            if (!file) {
                statusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö';
                statusEl.className = 'text-red-600 text-sm';
                return;
            }
            if (!db) {
                statusEl.textContent = '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                statusEl.className = 'text-red-600 text-sm';
                return;
            }
            importButton.disabled = true;
            buttonText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...';
            spinner.classList.remove('hidden');
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...';
            statusEl.className = 'text-gray-600 text-sm';
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                if (jsonData.length === 0) {
                    throw new Error("‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡πÅ‡∏£‡∏Å");
                }
                statusEl.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${jsonData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...`;
                // **NEW** Pass uploader email for tracking
                const result = await processImport(jsonData, userEmail); 
                statusEl.textContent = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${result.errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                statusEl.className = (result.errorCount > 0) ? 'text-yellow-700 text-sm font-semibold' : 'text-green-700 text-sm font-semibold';
                if (result.errorCount > 0) {
                     statusEl.textContent += ' (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)';
                }
                fileInput.value = '';
            } catch (error) {
                console.error("Error importing from Excel:", error);
                statusEl.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                statusEl.className = 'text-red-600 text-sm';
            } finally {
                importButton.disabled = false;
                buttonText.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤';
                spinner.classList.add('hidden');
            }
        }
        
        function convertExcelBoolean(value) {
            if (typeof value === 'boolean') return value;
            if (typeof value === 'string') {
                const lower = value.toLowerCase().trim();
                return lower === 'true' || lower === 'yes' || lower === '‡πÉ‡∏ä‡πà' || lower === 'y';
            }
            return !!value;
        }

        async function processImport(jsonData, uploaderEmail) {
            if (!db || !currentUserId) throw new Error("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
            const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
            let successCount = 0;
            let errorCount = 0;
            const statusEl = document.getElementById('import-status');
            const todayDateString = new Date().toISOString().split('T')[0];
            
            // **NEW** ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            let currentQueue = await getTodayQueueNumber(); 
            currentQueue--; // ‡∏•‡∏î‡∏•‡∏á 1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ queueNumber++ ‡πÉ‡∏ô loop

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                statusEl.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${i + 1} / ${jsonData.length}...`;
                try {
                    currentQueue++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                    const mappedData = {
                        patientId: String(row["‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"] || "").trim(),
                        patientName: String(row["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"] || "").trim(),
                        diabetesYears: Number(row["‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡∏µ"]) || null,
                        hba1c: String(row["HbA1C"] || "").trim(),
                        bloodPressure: String(row["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô"] || "").trim(),
                        weight: Number(row["‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å"]) || null,
                        height: Number(row["‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á"]) || null,
                        vaOD: String(row["VA (OD)"] || "").trim(),
                        vaOS: String(row["VA (OS)"] || "").trim(),
                        isWheelchair: convertExcelBoolean(row["‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô"]),
                        hasPreviousExam: convertExcelBoolean(row["‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à"]),
                        previousExamCount: Number(row["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á"]) || null,
                        hasCataract: false, hearingClear: false, canSitChair: false, needsEyelidLift: false, findings: {}, referralNeeded: false,
                        timestamp: new Date().toISOString(),
                        uploaderId: uploaderEmail,
                        queueNumber: currentQueue, // **NEW** Queue Number
                        queueDate: todayDateString // **NEW** Date for queue grouping
                    };
                    if (!mappedData.patientId || mappedData.patientId.length !== 13 || !/^\d+$/.test(mappedData.patientId) || !mappedData.patientName) {
                        console.warn("Skipping row (Missing or Invalid ID, or Missing Name):", row);
                        errorCount++;
                        continue;
                    }
                    await addDoc(collection(db, collectionPath), mappedData);
                    successCount++;
                } catch (err) {
                    console.error("Error importing row:", row, err);
                    errorCount++;
                }
            }
            return { successCount, errorCount };
        }

        async function searchPatientRecords() {
            if (!isFirebaseReady || !currentUserId) {
                displayMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }
            const searchId = document.getElementById('search-id').value.trim();
            const searchStatus = document.getElementById('search-status');
            const resultsContainer = document.getElementById('search-results');
            const resultsTableBody = document.getElementById('results-table-body');
            const searchButton = document.getElementById('search-button');
            if (searchId.length !== 13 || !/^\d+$/.test(searchId)) {
                searchStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                resultsContainer.classList.add('hidden');
                return;
            }
            if (!db) {
                searchStatus.textContent = '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Firebase configuration missing).';
                resultsContainer.classList.add('hidden');
                return;
            }
            searchButton.disabled = true;
            searchButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            searchStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            resultsContainer.classList.add('hidden');
            resultsTableBody.innerHTML = '';
            try {
                const collectionPath = `/artifacts/${globalAppId}/public/data/retina_records`;
                const q = query(
                    collection(db, collectionPath),
                    where("patientId", "==", searchId)
                );
                const querySnapshot = await getDocs(q);
                const records = [];
                querySnapshot.forEach((doc) => {
                    records.push(doc.data());
                });
                if (records.length === 0) {
                    searchStatus.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô ${searchId}`;
                    resultsContainer.classList.add('hidden');
                } else {
                    // Sort by queueDate and then queueNumber (if available) or timestamp
                    records.sort((a, b) => {
                        const dateA = a.queueDate || a.timestamp;
                        const dateB = b.queueDate || b.timestamp;
                        if (dateB > dateA) return 1;
                        if (dateB < dateA) return -1;
                        // Secondary sort by queueNumber if dates are the same
                        const qA = a.queueNumber || 9999;
                        const qB = b.queueNumber || 9999;
                        return qA - qB;
                    });
                    
                    searchStatus.textContent = `‡∏û‡∏ö ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${records[0].patientName} (ID: ${searchId})`;
                    resultsContainer.classList.remove('hidden');
                    records.forEach(record => {
                        const date = new Date(record.timestamp).toLocaleDateString('th-TH', { 
                            year: 'numeric', month: 'short', day: 'numeric', 
                            hour: '2-digit', minute: '2-digit' 
                        });
                        let findingsSummary = "Normal";
                        if (record.findings) {
                            const found = Object.keys(record.findings).filter(key => 
                                key !== 'normal' && (record.findings[key].or || record.findings[key].ol)
                            );
                            if (found.length > 0) {
                                findingsSummary = found.length > 0 ? "‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à" : "Normal";
                            } else if (!record.findings.normal?.or && !record.findings.normal?.ol) {
                                findingsSummary = "N/A";
                            }
                        }
                        const referralText = record.referralNeeded ? '<span class="font-bold text-red-600">‡πÉ‡∏ä‡πà</span>' : '‡πÑ‡∏°‡πà';
                        
                        const staffEmail = record.uploaderId || '';
                        const staffId = staffEmail.split('@')[0];
                        const staffName = STAFF_MAPPING[staffId] || staffId;
                        const queueNo = record.queueNumber || 'N/A';

                        const row = `
                            <tr class="hover:bg-blue-50 transition duration-150">
                                <td class="px-4 py-2 text-sm text-gray-500">${date}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${queueNo}</td>
                                <td class="px-4 py-2 text-sm font-medium text-gray-900">${record.patientName}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${staffName}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${record.vaOD || 'N/A'}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${findingsSummary}</td>
                                <td class="px-4 py-2 text-sm text-gray-700">${referralText}</td>
                            </tr>
                        `;
                        resultsTableBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error("Error searching Firestore:", error);
                searchStatus.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${error.message}`;
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }


        // --- Setup Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            document.getElementById('login-modal').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            document.getElementById('patient-id').addEventListener('input', debouncedSearchPatient);
            document.getElementById('patient-name').addEventListener('input', validateSaveButton);
            document.getElementById('patient-id').addEventListener('input', validateSaveButton); 
            document.getElementById('has-previous-exam').addEventListener('change', (e) => togglePreviousExamCount(e.target.checked));
            document.getElementById('clear-button').addEventListener('click', clearForm);
            document.getElementById('save-button').addEventListener('click', savePatientData);
            document.getElementById('import-button').addEventListener('click', importFromExcel);
            document.getElementById('search-button').addEventListener('click', searchPatientRecords);
            
            validateSaveButton();
            initializeFirebase(firebaseConfig);
        });

    </script>
</head>
<body class="bg-gray-50 p-4 sm:p-8 min-h-screen flex items-center justify-center font-['Inter']">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-blue-800 mb-2 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h2>
            <p class="text-gray-600 mb-6 text-center text-sm">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ ID ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            </p>
            <div class="space-y-4">
                <div>
                    <label for="login-user-id" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (ID ‡∏£‡∏û.‡∏™‡∏ï.)</label>
                    <input type="text" id="login-user-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 03280" value="03280">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="login-password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value="03280">
                </div>
            </div>
            <button id="login-button" class="mt-6 w-full px-10 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <p id="login-status" class="text-center text-sm text-red-500 mt-4"></p>
        </div>
    </div>


    <!-- Main Container -->
    <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full max-w-6xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-2 text-center">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤ (‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏£‡∏û.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©)
        </p>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
        <div class="flex justify-between items-center mb-4 border-b pb-3">
             <div id="staff-name-display" class="text-base font-bold text-gray-800 flex-grow">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </div>
            <button id="logout-button" class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition duration-150 hidden">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
        <div class="flex justify-end mb-4">
            <div id="user-info" class="text-sm text-right text-gray-500">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
            </div>
        </div>

        <!-- **NEW** Queue Display Box (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà) -->
        <div id="queue-display-box" class="fixed inset-0 bg-gray-50 bg-opacity-75 flex items-center justify-center p-4 z-40 hidden">
            <div class="w-full max-w-md text-center">
                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JS -->
            </div>
            <button onclick="document.getElementById('queue-display-box').classList.add('hidden'); document.getElementById('main-app-content').classList.remove('hidden'); clearForm();" class="absolute top-4 right-4 text-gray-700 hover:text-gray-900 text-3xl">&times;</button>
        </div>


        <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏∞‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
        <div id="main-app-content" class="transition duration-300 opacity-20 pointer-events-none">
            <!-- Section 1: Patient Info (from PCU) -->
            <div class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
                <h2 class="text-xl font-bold text-blue-700 mb-4">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏à‡∏≤‡∏Å ‡∏£‡∏û.‡∏™‡∏ï./PCU)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="relative"> 
                        <label for="patient-id" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å</label>
                        <div class="flex mt-1">
                            <input type="text" id="patient-id" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: XXXXXXXXXXXXX" maxlength="13" autocomplete="off">
                        </div>
                        <div id="autocomplete-results" class="absolute top-full left-0 right-0 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg z-20 hidden overflow-y-auto max-h-48">
                        </div>
                    </div>
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                        <input type="text" id="patient-name" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">
                    </div>
                    <div>
                        <label for="diabetes-years" class="block text-sm font-medium text-gray-700">‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏µ)</label>
                        <input type="number" id="diabetes-years" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="hba1c" class="block text-sm font-medium text-gray-700">HbA1C (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</label>
                        <input type="text" id="hba1c" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 7.5">
                    </div>
                     <div>
                        <label for="blood-pressure" class="block text-sm font-medium text-gray-700">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (BP)</label>
                        <input type="text" id="blood-pressure" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 130/80">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                        <input type="number" id="weight" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0.0">
                    </div>
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (cm)</label>
                        <input type="number" id="height" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label for="va-od" class="block text-sm font-medium text-gray-700">VA (‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ - OD)</label>
                        <select id="va-od" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ --</option>
                            <option value="20/20">20/20</option>
                            <option value="20/25">20/25</option>
                            <option value="20/30">20/30</option>
                            <option value="20/40">20/40</option>
                            <option value="20/50">20/50</option>
                            <option value="20/60">20/60</option>
                            <option value="20/70">20/70</option>
                            <option value="20/80">20/80</option>
                            <option value="20/100">20/100</option>
                            <option value="20/200">20/200</option>
                            <option value="20/400">20/400</option>
                            <option value="CF 1ft">CF 1ft</option>
                            <option value="CF 2ft">CF 2ft</option>
                            <option value="CF 3ft">CF 3ft</option>
                            <option value="HM">HM (Hand Motion)</option>
                            <option value="LP">LP (Light Perception)</option>
                            <option value="NLP">NLP (No Light Perception)</option>
                            <option value="N/A">N/A (‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</option>
                        </select>
                    </div>
                    <div>
                        <label for="va-os" class="block text-sm font-medium text-gray-700">VA (‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ - OS)</label>
                         <select id="va-os" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ --</option>
                            <option value="20/20">20/20</option>
                            <option value="20/25">20/25</option>
                            <option value="20/30">20/30</option>
                            <option value="20/40">20/40</option>
                            <option value="20/50">20/50</option>
                            <option value="20/60">20/60</option>
                            <option value="20/70">20/70</option>
                            <option value="20/80">20/80</option>
                            <option value="20/100">20/100</option>
                            <option value="20/200">20/200</option>
                            <option value="20/400">20/400</option>
                            <option value="CF 1ft">CF 1ft</option>
                            <option value="CF 2ft">CF 2ft</option>
                            <option value="CF 3ft">CF 3ft</option>
                            <option value="HM">HM (Hand Motion)</option>
                            <option value="LP">LP (Light Perception)</option>
                            <option value="NLP">NLP (No Light Perception)</option>
                            <option value="N/A">N/A (‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center">
                            <input id="is-wheelchair" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="is-wheelchair" class="ml-2 block text-sm font-medium text-gray-700">‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô (Wheelchair)</label>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <div class="flex flex-col">
                            <div class="flex items-center">
                                <input id="has-previous-exam" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="has-previous-exam" class="ml-2 block text-sm font-medium text-gray-700">‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤</label>
                            </div>
                            <div id="previous-exam-count-container" class="mt-2 hidden">
                                <label for="previous-exam-count" class="block text-xs font-medium text-gray-600">‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢, ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á?</label>
                                <input type="number" id="previous-exam-count" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- **NEW** Section 2 Container (Disabled for PCU) -->
            <div id="section2-container" class="mb-8 p-6 bg-gray-100 rounded-xl border border-gray-200 transition duration-300">
                <h2 class="text-xl font-bold text-gray-700 mb-4">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Hospital)</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="flex items-center">
                        <input id="has-cataract" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="has-cataract" class="ml-2 block text-sm font-medium text-gray-700">‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏à‡∏Å (Cataract)</label>
                    </div>
                    <div class="flex items-center">
                        <input id="hearing-clear" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="hearing-clear" class="ml-2 block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</label>
                    </div>
                    <div class="flex items-center">
                        <input id="can-sit-chair" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="can-sit-chair" class="ml-2 block text-sm font-medium text-gray-700">‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤‡πÑ‡∏î‡πâ</label>
                    </div>
                    <div class="flex items-center">
                        <input id="needs-eyelid-lift" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="needs-eyelid-lift" class="ml-2 block text-sm font-medium text-gray-700">‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏ï‡∏≤</label>
                    </div>
                </div>
            </div>

            <!-- **NEW** Section 3 Container (Disabled for PCU) -->
            <div id="section3-container" class="mb-8 p-6 bg-green-50 rounded-xl border border-green-200 transition duration-300">
                <h2 class="text-xl font-bold text-green-700 mb-4">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏ï‡∏≤</h2>
                <div class="grid grid-cols-3 gap-4 mb-2">
                    <div class="font-bold text-gray-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (Findings)</div>
                    <div class="font-bold text-gray-700 text-center">‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤ (OR)</div>
                    <div class="font-bold text-gray-700 text-center">‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (OL)</div>
                </div>
                <div class="space-y-3" id="section3-findings">
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-normal-or" class="font-medium text-gray-800">Normal</label>
                        <input id="finding-normal-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-normal-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-microaneurysm-or" class="font-medium text-gray-800">Micro aneurysm / Dot-Blot HE</label>
                        <input id="finding-microaneurysm-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-microaneurysm-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-hardexudate-or" class="font-medium text-gray-800">Hard exudate</label>
                        <input id="finding-hardexudate-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-hardexudate-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-flame-or" class="font-medium text-gray-800">Flame-shaped hemorrhage</label>
                        <input id="finding-flame-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-flame-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-venous-or" class="font-medium text-gray-800">Venous beading</label>
                        <input id="finding-venous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-venous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-irma-or" class="font-medium text-gray-800">IRMA</label>
                        <input id="finding-irma-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-irma-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-newvessel-or" class="font-medium text-gray-800">New vessel (neovascularization)</label>
                        <input id="finding-newvessel-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-newvessel-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-preretinal-or" class="font-medium text-gray-800">Preretinal hemorrhage</label>
                        <input id="finding-preretinal-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-preretinal-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-vitreous-or" class="font-medium text-gray-800">Vitreous hemorrhage</label>
                        <input id="finding-vitreous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-vitreous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                    <div class="grid grid-cols-3 gap-4 p-2 rounded-lg hover:bg-green-100">
                        <label for="finding-fibrous-or" class="font-medium text-gray-800">Fibrous proliferation</label>
                        <input id="finding-fibrous-or" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                        <input id="finding-fibrous-ol" type="checkbox" class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500 justify-self-center">
                    </div>
                </div>
                <div class="mt-6 border-t border-green-200 pt-4">
                     <div class="flex items-center">
                        <input id="referral-needed" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                        <label for="referral-needed" class="ml-2 block text-sm font-medium text-red-700">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (Referral Needed)</label>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="clear-button" class="w-full sm:w-auto px-10 py-3 bg-gray-500 text-white font-bold rounded-xl shadow-lg hover:bg-gray-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Clear Form)
                </button>
                <button id="save-button" class="w-full sm:w-auto px-10 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                    <span id="save-button-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                    <svg id="save-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <div class="mt-10 p-6 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200">
                <h2 class="text-2xl font-bold text-yellow-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (.xlsx)
                </h2>
                <p class="text-sm text-gray-600 mb-4">
                    ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1)
                </p>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="file" id="excel-file-input" accept=".xlsx, .xls" class="flex-grow block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200 cursor-pointer">
                    <button id="import-button" class="px-6 py-2 bg-yellow-600 text-white font-bold rounded-xl shadow-md hover:bg-yellow-700 transition duration-300" id="import-button">
                        <span id="import-button-text">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
                        <svg id="import-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                <div id="import-status" class="text-gray-600 text-sm"></div>
                <details class="mt-4">
                    <summary class="cursor-pointer text-sm font-medium text-yellow-700 hover:text-yellow-900">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÉ‡∏ô Excel)
                    </summary>
                    <pre class="text-xs bg-white p-3 rounded-md mt-2 overflow-x-auto">
    ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£):
    - ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
    - ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
    - ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡∏µ
    - HbA1C
    - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô
    - ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
    - ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á
    - VA (OD)
    - VA (OS)
    - ‡∏ô‡∏±‡πà‡∏á‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô (‡πÉ‡∏™‡πà TRUE, Yes, ‡∏´‡∏£‡∏∑‡∏≠ '‡πÉ‡∏ä‡πà')
    - ‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏£‡∏ß‡∏à (‡πÉ‡∏™‡πà TRUE, Yes, ‡∏´‡∏£‡∏∑‡∏≠ '‡πÉ‡∏ä‡πà')
    - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </pre>
                </details>
            </div>

            <div id="message-box" class="mt-8 p-4 rounded-lg text-center hidden"></div>
            
            <div class="mt-10 p-6 bg-gray-100 rounded-xl shadow-inner">
                <h2 class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å)
                </h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <input type="text" id="search-id" class="flex-grow rounded-lg border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" maxlength="13">
                    <button id="search-button" class="px-6 py-2 bg-green-600 text-white font-bold rounded-xl shadow-md hover:bg-green-700 transition duration-300">
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
                <div id="search-results-container" class="mt-4">
                    <p id="search-status" class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
                    <div id="search-results" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-300">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏Ñ‡∏¥‡∏ß</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏£‡∏û.‡∏™‡∏ï. ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">VA (OD)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (‡∏¢‡πà‡∏≠)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- ‡∏à‡∏ö main-app-content -->
    </div>
    
</body>
</html>
