<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM v19 - Modern UI</title>
    
    <!-- 1. Assets & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 3. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 4. Utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        pcu: { 50:'#ecfdf5', 100:'#d1fae5', 500:'#10b981', 600:'#059669', 700:'#047857' },
                        hosp: { 50:'#eff6ff', 100:'#dbeafe', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f0f2f5; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .btn-press:active { transform: scale(0.97); }
        .loader { width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG (Same Stable Logic) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };
        try { if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e){}
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "sisaket_prod_v1855_stable"; // Same DB as previous stable version
        const COL_QUEUE = "dr_queue";   
        const COL_MASTER = "dr_master"; 
        const ADMIN_CODE = "10700";

        const Icon = ({name, size=20, className}) => {
            React.useEffect(()=>{if(window.lucide)window.lucide.createIcons()},[name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50 p-4">
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-red-100 max-w-md text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500"><Icon name="alert-triangle" size={32}/></div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">ระบบขัดข้องชั่วคราว</h2>
                            <p className="text-gray-500 text-sm mb-6 font-mono bg-gray-100 p-2 rounded">{this.state.error?.toString()}</p>
                            <button onClick={()=>window.location.reload()} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700">รีโหลดหน้าจอ</button>
                        </div>
                    </div>
                );
                return this.props.children;
            }
        }

        // --- MODERN AUTH ---
        const AuthScreen = () => {
            const [pin, setPin] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true);
                try { await auth.signInWithEmailAndPassword(pin+"@sisaket-clinic.org", password); }
                catch(e) { 
                    if(e.code==='auth/user-not-found') {
                        try{await auth.createUserWithEmailAndPassword(pin+"@sisaket-clinic.org",password);}catch(e2){alert(e2.message);}
                    } else alert("เข้าสู่ระบบไม่สำเร็จ: "+e.message);
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1532938911079-1b06ac7ceec7?q=80&w=2532&auto=format&fit=crop')] bg-cover bg-center">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
                    <div className="relative bg-white/90 backdrop-blur-md p-8 rounded-3xl w-full max-w-md shadow-2xl border border-white/30 animate__animated animate__fadeInUp">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-tr from-pcu-500 to-hosp-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-white transform rotate-3 hover:rotate-0 transition-transform duration-500">
                                <Icon name="eye" size={40}/>
                            </div>
                            <h1 className="text-3xl font-bold text-slate-800 tracking-tight">EyeDM <span className="text-pcu-600">v19</span></h1>
                            <p className="text-slate-500 mt-1">ระบบคัดกรองเบาหวานเข้าจอประสาทตา</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-5">
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">รหัสเจ้าหน้าที่ (5 หลัก)</label>
                                <div className="relative">
                                    <Icon name="user" className="absolute left-4 top-3.5 text-slate-400" size={18}/>
                                    <input className="w-full pl-12 pr-4 py-3 rounded-xl bg-white border border-slate-200 focus:border-pcu-500 focus:ring-4 focus:ring-pcu-500/20 outline-none transition font-mono text-lg tracking-widest text-slate-700" placeholder="xxxxx" value={pin} onChange={e=>setPin(e.target.value.replace(/\D/g,'').slice(0,5))} required autoFocus/>
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">รหัสผ่าน</label>
                                <div className="relative">
                                    <Icon name="lock" className="absolute left-4 top-3.5 text-slate-400" size={18}/>
                                    <input type="password" className="w-full pl-12 pr-4 py-3 rounded-xl bg-white border border-slate-200 focus:border-pcu-500 focus:ring-4 focus:ring-pcu-500/20 outline-none transition" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} required/>
                                </div>
                            </div>
                            <button disabled={loading} className="w-full bg-slate-800 hover:bg-slate-900 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all btn-press flex justify-center items-center gap-2">
                                {loading ? <div className="loader"></div> : <>เข้าสู่ระบบ <Icon name="arrow-right" size={18}/></>}
                            </button>
                        </form>
                        <div className="mt-8 pt-6 border-t border-slate-200/60 text-center">
                            <p className="text-xs text-slate-400">สำหรับเจ้าหน้าที่ รพ.สต. และ โรงพยาบาลศรีสะเกษ</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('PCU'); // PCU or HOSPITAL
            const [view, setView] = React.useState('dashboard');
            const [queue, setQueue] = React.useState([]);
            const [editingData, setEditingData] = React.useState(null);
            const [limitCount, setLimitCount] = React.useState(50);

            React.useEffect(() => auth.onAuthStateChanged(setUser), []);
            React.useEffect(() => {
                if(!user) return;
                const unsub = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE)
                    .orderBy('createdAt', 'desc').limit(limitCount)
                    .onSnapshot(s => {
                        setQueue(s.docs.map(d=>({id:d.id,...d.data(),createdAt:d.data().createdAt?.toDate()||new Date()})));
                        setTimeout(()=>window.lucide?.createIcons(), 100);
                    });
                return () => unsub();
            }, [user, limitCount]);

            // Actions
            const handleSend = async (id, name) => {
                if(confirm(`ยืนยันส่งตัว: ${name}?`)) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).update({status:'Waiting', sentAt:firebase.firestore.FieldValue.serverTimestamp()});
            };
            const handleDel = async (id) => {
                if(confirm('ลบรายการ?')) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).delete();
            };

            if(!user) return <AuthScreen/>;
            const isAdmin = user.email.startsWith(ADMIN_CODE);
            const Theme = role==='PCU' ? 'pcu' : 'hosp';

            return (
                <div className="min-h-screen flex flex-col font-sans text-slate-800">
                    {/* Navbar */}
                    <nav className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2.5 rounded-xl text-white shadow-lg shadow-${Theme}-500/30 bg-gradient-to-br from-${Theme}-500 to-${Theme}-600`}>
                                        <Icon name={role==='PCU'?'home':'building-2'} size={24}/>
                                    </div>
                                    <div className="leading-tight">
                                        <h1 className="font-bold text-lg text-slate-800">EyeDM <span className={`text-${Theme}-600`}>{role}</span></h1>
                                        <div className="flex items-center gap-1.5">
                                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                            <p className="text-xs text-slate-500 font-medium">{user.email.split('@')[0]}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {isAdmin && <button onClick={()=>setView('import')} className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-200 transition"><Icon name="file-spreadsheet" size={16}/> Import</button>}
                                    <div className="hidden md:flex bg-slate-100 p-1 rounded-lg">
                                        <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${role==='PCU'?'bg-white shadow text-pcu-600':'text-slate-500 hover:text-slate-700'}`}>PCU</button>
                                        <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${role==='HOSPITAL'?'bg-white shadow text-hosp-600':'text-slate-500 hover:text-slate-700'}`}>Hospital</button>
                                    </div>
                                    <button onClick={()=>auth.signOut()} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition"><Icon name="log-out"/></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Content */}
                    <main className="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full animate__animated animate__fadeIn">
                        <div className="md:hidden flex bg-white p-1 rounded-xl shadow-sm mb-4 border border-slate-100">
                            <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`flex-1 py-2.5 rounded-lg font-bold text-sm ${role==='PCU'?'bg-pcu-50 text-pcu-700':'text-slate-400'}`}>รพ.สต.</button>
                            <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`flex-1 py-2.5 rounded-lg font-bold text-sm ${role==='HOSPITAL'?'bg-hosp-50 text-hosp-700':'text-slate-400'}`}>โรงพยาบาล</button>
                        </div>

                        {view==='dashboard' && <Dashboard role={role} queue={queue} onNew={()=>{setEditingData(null);setView('form')}} onEdit={p=>{setEditingData(p);setView('form')}} onDelete={handleDel} onSend={handleSend} onLoadMore={()=>setLimitCount(c=>c+50)} Theme={Theme}/>}
                        {view==='form' && <UnifiedForm db={db} user={user} data={editingData} role={role} onBack={()=>setView('dashboard')} Theme={Theme}/>}
                        {view==='import' && isAdmin && <ImportView db={db} onBack={()=>setView('dashboard')}/>}
                    </main>
                </div>
            );
        }

        // --- MODERN DASHBOARD ---
        const Dashboard = ({ role, queue, onNew, onEdit, onDelete, onSend, onLoadMore, Theme }) => {
            const [search, setSearch] = React.useState('');
            const [tab, setTab] = React.useState('registry');
            
            const filtered = React.useMemo(() => queue.filter(p => {
                const txt = search.toLowerCase();
                const match = (p.part1?.idCard||'').includes(txt) || (p.part1?.name||'').includes(txt);
                if(!match) return false;
                if(role==='PCU') return tab==='registry' ? p.status==='Registered' : (p.status!=='Registered');
                return p.status!=='Registered';
            }), [queue, search, tab, role]);

            const StatCard = ({title, val, icon, color}) => (
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 card-hover flex items-center justify-between">
                    <div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800 mt-1">{val}</p></div>
                    <div className={`p-3 rounded-xl bg-${color}-50 text-${color}-600`}><Icon name={icon}/></div>
                </div>
            );

            return (
                <div className="space-y-6">
                    {/* Stats Row */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <StatCard title="ทั้งหมดในระบบ" val={queue.length} icon="database" color="slate"/>
                        <StatCard title="รอส่งตรวจ" val={queue.filter(p=>p.status==='Registered').length} icon="clock" color="gray"/>
                        <StatCard title="รอตรวจตา" val={queue.filter(p=>p.status==='Waiting').length} icon="eye" color="amber"/>
                        <StatCard title="ตรวจเสร็จสิ้น" val={queue.filter(p=>p.status==='Completed').length} icon="check-circle" color="emerald"/>
                    </div>

                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                        {role==='PCU' ? (
                            <div className="flex bg-slate-100 p-1 rounded-xl w-full md:w-auto">
                                <button onClick={()=>setTab('registry')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${tab==='registry'?'bg-white shadow text-slate-800':'text-slate-500'}`}>ทะเบียน</button>
                                <button onClick={()=>setTab('sent')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${tab==='sent'?'bg-white shadow text-pcu-600':'text-slate-500'}`}>ส่งแล้ว</button>
                            </div>
                        ) : <div className="font-bold text-hosp-700 px-4">รายการผู้ป่วยรอตรวจ (Hospital Queue)</div>}

                        <div className="flex w-full md:w-auto gap-2">
                            <div className="relative flex-1 md:w-64">
                                <Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                <input className="w-full pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition bg-slate-50 focus:bg-white" placeholder="ค้นหาชื่อ / เลขบัตร..." value={search} onChange={e=>setSearch(e.target.value)}/>
                            </div>
                            {role==='PCU' && tab==='registry' && <button onClick={onNew} className="bg-pcu-600 hover:bg-pcu-700 text-white px-4 py-2 rounded-xl font-bold shadow-lg shadow-pcu-500/30 btn-press flex items-center gap-2 whitespace-nowrap"><Icon name="plus"/> เพิ่มรายใหม่</button>}
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                                <tr>
                                    <th className="p-4 w-32">วันที่</th>
                                    <th className="p-4">ผู้ป่วย</th>
                                    <th className="p-4">HbA1C</th>
                                    <th className="p-4">สถานะ</th>
                                    <th className="p-4 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(p => (
                                    <tr key={p.id} className="hover:bg-slate-50/80 transition group">
                                        <td className="p-4 text-slate-400 font-mono text-xs">{p.createdAt.toLocaleDateString('th-TH')}</td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-700 text-base">{p.part1.name}</div>
                                            <div className="text-slate-400 text-xs font-mono flex items-center gap-1 mt-0.5"><Icon name="credit-card" size={12}/> {p.part1.idCard}</div>
                                        </td>
                                        <td className="p-4"><span className={`px-2 py-1 rounded font-bold text-xs ${p.part1.hba1c>7?'bg-red-100 text-red-600':'bg-slate-100 text-slate-600'}`}>{p.part1.hba1c||'-'}</span></td>
                                        <td className="p-4">
                                            {p.status==='Registered' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800"><span className="w-1.5 h-1.5 bg-slate-400 rounded-full mr-1.5"></span> ลงทะเบียน</span>}
                                            {p.status==='Waiting' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800"><span className="w-1.5 h-1.5 bg-amber-500 rounded-full mr-1.5 animate-pulse"></span> รอตรวจ</span>}
                                            {p.status==='Completed' && <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800"><span className="w-1.5 h-1.5 bg-emerald-500 rounded-full mr-1.5"></span> เสร็จสิ้น</span>}
                                        </td>
                                        <td className="p-4 text-right">
                                            <div className="flex justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                                {role==='PCU' && p.status==='Registered' && <button onClick={()=>onSend(p.id, p.part1.name)} className="px-3 py-1.5 bg-pcu-600 text-white rounded-lg shadow text-xs font-bold hover:bg-pcu-700 btn-press flex items-center gap-1"><Icon name="send" size={14}/> ส่ง</button>}
                                                <button onClick={()=>onEdit(p)} className="p-2 border border-slate-200 rounded-lg text-slate-500 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition"><Icon name={role==='HOSPITAL'&&p.status==='Waiting'?'stethoscope':'pencil'} size={16}/></button>
                                                <button onClick={()=>onDelete(p.id)} className="p-2 border border-slate-200 rounded-lg text-slate-500 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition"><Icon name="trash-2" size={16}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400"><div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2"><Icon name="inbox" size={32}/></div>ไม่พบข้อมูล</td></tr>}
                            </tbody>
                        </table>
                        <button onClick={onLoadMore} className="w-full py-3 text-xs font-bold text-slate-500 hover:bg-slate-50 border-t transition">โหลดข้อมูลเก่าเพิ่มเติม...</button>
                    </div>
                </div>
            );
        };

        // --- UNIFIED FORM COMPONENT (Smart & Modern) ---
        const UnifiedForm = ({ db, user, data, role, onBack, Theme }) => {
            const isEdit = !!data;
            const isHospital = role === 'HOSPITAL';
            
            // State
            const [p1, setP1] = React.useState(data?.part1 || { idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [p2, setP2] = React.useState(data?.part2 || { cataract:'No', retinaFound:'Yes' });
            const [findings, setFindings] = React.useState(data?.findings || { Normal:{L:false,R:false} });
            const [saving, setSaving] = React.useState(false);
            const [suggestions, setSugg] = React.useState([]);

            // PCU Logic
            const handleId = async (e) => {
                const v = e.target.value; setP1({...p1, idCard:v});
                if(!isEdit && !isHospital && v.length>=3) {
                    try {
                        const q = db.collection('artifacts').doc(APP_ID).collection(COL_MASTER)
                            .where(firebase.firestore.FieldPath.documentId(), '>=', v)
                            .where(firebase.firestore.FieldPath.documentId(), '<=', v+'\uf8ff').limit(5);
                        const s = await q.get();
                        setSugg(s.docs.map(d=>({idCard:d.id, ...d.data()})));
                    } catch(e){}
                } else setSugg([]);
            };

            const save = async () => {
                setSaving(true);
                try {
                    // Timeout Protection
                    const timeout = new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 5000));
                    await Promise.race([
                        (async()=>{
                            if (isHospital) {
                                await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(data.id).update({ part2: p2, findings, status: 'Completed', doctorName: user.email });
                            } else {
                                if(!p1.idCard || p1.idCard.length!==13) throw new Error("เลขบัตรไม่ถูกต้อง");
                                // 1. Master
                                await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(p1.idCard).set(p1, {merge:true});
                                // 2. Check Dup (Only new)
                                if(!isEdit) {
                                    const today = new Date().toDateString();
                                    const q = await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).where('part1.idCard','==',p1.idCard).get();
                                    if(q.docs.some(d=>(d.data().createdAt?.toDate?d.data().createdAt.toDate():new Date(d.data().createdAt)).toDateString()===today)) throw new Error("ส่งซ้ำวันนี้ไม่ได้");
                                }
                                // 3. Queue
                                const pl = { part1: p1, pcuId: user.uid, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                                if(isEdit) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(data.id).update(pl);
                                else { pl.status='Registered'; pl.createdAt=firebase.firestore.FieldValue.serverTimestamp(); await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).add(pl); }
                            }
                        })(),
                        timeout
                    ]);
                    onBack();
                } catch(e) { alert(e.message); } finally { setSaving(false); }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-xl border border-slate-100 animate__animated animate__zoomIn">
                    <div className="flex justify-between items-center mb-8 border-b border-slate-100 pb-4">
                        <div className="flex items-center gap-3">
                            <div className={`p-2.5 rounded-xl bg-${Theme}-100 text-${Theme}-600`}><Icon name={isHospital?'stethoscope':'user-plus'} size={28}/></div>
                            <div>
                                <h2 className="font-bold text-2xl text-slate-800">{isHospital?'บันทึกผลตรวจ':'ข้อมูลผู้ป่วย'}</h2>
                                <p className="text-slate-400 text-sm">{isEdit?'แก้ไขข้อมูล':'ลงทะเบียนรายใหม่'}</p>
                            </div>
                        </div>
                        <button onClick={onBack} className="p-2 text-slate-400 hover:bg-slate-100 rounded-full"><Icon name="x"/></button>
                    </div>

                    <div className="space-y-6">
                        {/* Patient Info Section */}
                        <div className={`grid gap-6 ${isHospital?'opacity-80 pointer-events-none':''}`}>
                            <div className="relative bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">เลขบัตรประชาชน (13 หลัก)</label>
                                <div className="relative">
                                    <Icon name="credit-card" className="absolute left-4 top-3.5 text-slate-400"/>
                                    <input value={p1.idCard} onChange={handleId} className="w-full pl-12 pr-4 py-3 rounded-xl border-slate-200 focus:ring-2 focus:ring-pcu-500/50 font-mono text-lg tracking-widest" placeholder="x-xxxx-xxxxx-xx-x" maxLength="13" disabled={isEdit}/>
                                    {suggestions.length>0 && <div className="absolute top-full left-0 w-full bg-white shadow-xl rounded-xl mt-2 border z-50 overflow-hidden">{suggestions.map((s,i)=><div key={i} onClick={()=>{setP1(s);setSugg([])}} className="p-3 hover:bg-pcu-50 cursor-pointer border-b flex justify-between text-sm"><span>{s.idCard}</span><span className="text-slate-500">{s.name}</span></div>)}</div>}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="ชื่อ-นามสกุล" val={p1.name} set={v=>setP1({...p1,name:v})} icon="user"/>
                                <Input label="HbA1C" val={p1.hba1c} set={v=>setP1({...p1,hba1c:v})} icon="activity"/>
                            </div>
                            {!isHospital && <div className="grid grid-cols-3 gap-4">
                                <Input label="ความดัน (BP)" val={p1.bp} set={v=>setP1({...p1,bp:v})}/>
                                <Input label="น้ำหนัก (kg)" val={p1.weight} set={v=>setP1({...p1,weight:v})}/>
                                <Input label="ส่วนสูง (cm)" val={p1.height} set={v=>setP1({...p1,height:v})}/>
                            </div>}
                            <div className="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <Input label="VA ตาซ้าย" val={p1.vaLeft} set={v=>setP1({...p1,vaLeft:v})} bg="white"/>
                                <Input label="VA ตาขวา" val={p1.vaRight} set={v=>setP1({...p1,vaRight:v})} bg="white"/>
                            </div>
                        </div>

                        {/* Hospital Exam Section */}
                        {isHospital && (
                            <div className="pt-6 border-t border-slate-200 animate__animated animate__fadeInUp">
                                <h3 className="font-bold text-xl text-hosp-700 mb-4 flex items-center gap-2"><Icon name="eye"/> ผลการตรวจจอประสาทตา</h3>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-hosp-50 p-4 rounded-xl border border-hosp-100">
                                        <label className="block text-sm font-bold text-hosp-800 mb-2">พบจอประสาทตา?</label>
                                        <div className="flex gap-2"><button onClick={()=>setP2({...p2,retinaFound:'Yes'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.retinaFound==='Yes'?'bg-hosp-600 text-white shadow':'bg-white text-slate-600'}`}>เจอ</button><button onClick={()=>setP2({...p2,retinaFound:'No'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.retinaFound==='No'?'bg-hosp-600 text-white shadow':'bg-white text-slate-600'}`}>ไม่เจอ</button></div>
                                    </div>
                                    <div className="bg-slate-100 p-4 rounded-xl">
                                        <label className="block text-sm font-bold text-slate-700 mb-2">เป็นต้อกระจก?</label>
                                        <div className="flex gap-2"><button onClick={()=>setP2({...p2,cataract:'Yes'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.cataract==='Yes'?'bg-slate-600 text-white shadow':'bg-white text-slate-600'}`}>ใช่</button><button onClick={()=>setP2({...p2,cataract:'No'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.cataract==='No'?'bg-slate-600 text-white shadow':'bg-white text-slate-600'}`}>ไม่ใช่</button></div>
                                    </div>
                                </div>
                                <div className="border rounded-xl overflow-hidden">
                                    <table className="w-full text-sm"><thead className="bg-slate-50"><tr><th className="p-3 text-left">Diagnosis</th><th className="p-3 w-16 text-center">Left</th><th className="p-3 w-16 text-center">Right</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{['Normal','MicroAneurysm','HardExudate','FlameHemorrhage'].map(k=>(<tr key={k}><td className="p-3 font-medium text-slate-700">{k}</td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.L} onChange={()=>setFindings({...findings,[k]:{...findings[k],L:!findings[k]?.L}})} className="w-5 h-5 accent-hosp-600"/></td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.R} onChange={()=>setFindings({...findings,[k]:{...findings[k],R:!findings[k]?.R}})} className="w-5 h-5 accent-hosp-600"/></td></tr>))}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        <div className="pt-4 flex gap-3">
                            <button onClick={onBack} className="flex-1 py-3.5 rounded-xl border border-slate-200 text-slate-500 font-bold hover:bg-slate-50 transition">ยกเลิก</button>
                            <button onClick={save} disabled={saving} className={`flex-[2] text-white py-3.5 rounded-xl font-bold shadow-lg transition btn-press flex justify-center items-center gap-2 ${isHospital?'bg-hosp-600 hover:bg-hosp-700':'bg-pcu-600 hover:bg-pcu-700'}`}>
                                {saving ? <div className="loader w-5 h-5 border-white/30 border-t-white"></div> : <><Icon name="save"/> {isHospital?'ยืนยันผล':'บันทึกข้อมูล'}</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Input = ({label, val, set, icon, bg="bg-white"}) => (<div><label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">{label}</label><div className="relative">{icon&&<Icon name={icon} className="absolute left-3 top-3 text-slate-400" size={18}/>}<input value={val||''} onChange={e=>set(e.target.value)} className={`w-full ${icon?'pl-10':'p-3'} p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-pcu-500/20 focus:border-pcu-500 outline-none transition ${bg}`}/></div></div>);

        // --- IMPORT VIEW ---
        const ImportView = ({ db, user, appId, onBack }) => {
            const [csvData, setCsvData] = React.useState([]);
            const [importing, setImporting] = React.useState(false);
            const handleFile = (e) => Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, encoding: 'TIS-620', complete: (res) => setCsvData(res.data) });
            const run = async () => {
                setImporting(true); let c=0;
                for(let row of csvData) {
                    const id = (row['เลข 13 หลัก']||row['pid']||'').toString().replace(/\D/g,'');
                    if(id.length===13) {
                        const p1 = { idCard: id, name: row['ชื่อสกุล']||row['fullname']||'-', hba1c: row['HbA1C']||'-', bp: row['BP']||'-', source:'Import' };
                        try { await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(id).set(p1,{merge:true}); await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).add({part1:p1, status:'Registered', pcuId:'Admin', createdAt:firebase.firestore.FieldValue.serverTimestamp()}); c++; } catch(e){}
                    }
                }
                setImporting(false); alert(`Imported ${c}`);
            };
            return (<div className="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl text-center"><h2 className="text-2xl font-bold text-indigo-800 mb-4">Import Excel</h2><div className="border-2 border-dashed border-indigo-100 bg-indigo-50 rounded-xl p-8 mb-6"><input type="file" accept=".csv" onChange={handleFile} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-white file:text-indigo-700 hover:file:bg-indigo-50"/></div>{csvData.length>0 && <button onClick={run} disabled={importing} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">{importing?'Processing...':'Confirm Import'}</button>}<button onClick={onBack} className="block mx-auto mt-4 text-slate-400 hover:text-slate-600">Back</button></div>);
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
