<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM Connect - ระบบส่งต่อผู้ป่วยเบาหวาน</title>
    
    <!-- 1. Import Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tesseract.js สำหรับ OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <!-- Firebase Libraries (Compat versions) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .chk-lg { transform: scale(1.3); margin-right: 8px; cursor: pointer; }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        /* Fix checkbox alignment on mobile */
        input[type="checkbox"] { accent-color: #2563eb; width: 18px; height: 18px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        /* Scanner Overlay */
        .scanner-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; height: 100px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
            pointer-events: none;
        }
        .scanner-line {
            position: absolute;
            top: 50%; left: 5%; right: 5%;
            height: 1px;
            background: rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };

        const initFirebase = () => {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(err => console.log("Persistence disabled:", err.code));
                } catch (e) {
                    console.error("Firebase init error:", e);
                }
            }
        };
        initFirebase();

        const auth = firebase.auth();
        const db = firebase.firestore();

        // [FIXED] ใช้ __app_id แบบ Dynamic เพื่อให้ทำงานใน Canvas ได้ถูกต้อง และลบ/เพิ่มข้อมูลได้จริง
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : "eyedm-production";
        const getCollection = (collectionName) => {
            return db.collection(`artifacts/${APP_ID}/public/data/${collectionName}`);
        };
        
        // --- CONSTANTS ---
        const VA_OPTIONS = [
            "20/20 (6/6) (ปกติ)", "20/25 (6/7.5)", "20/30 (6/9)", "20/40 (6/12)", "20/50 (6/15)", 
            "20/70 (6/21)", "20/100 (6/30)", "20/200 (6/60)", "20/400 (6/120)", 
            "CF (นับนิ้ว)", "HM (โบกมือ)", "PL (เห็นแสง)", "NPL (ไม่เห็นแสง)"
        ];
        
        const DR_STAGES = [
            "No DR", 
            "Mild DR", 
            "Moderate DR", 
            "Severe DR", 
            "PDR", 
            "ไม่พบจอประสาทตา"
        ];

        const defaultFindings = { 
            Normal:{L:true,R:true}, MicroAneurysm:{L:false,R:false}, Hemorrhage:{L:false,R:false}, 
            HardExudate:{L:false,R:false}, Other:{L:false,R:false} 
        };
        const STATIC_PCU_DATA = {
            "03277": "รพ.สต.บ้านคูซอด", "03278": "รพ.สต.บ้านแทง", "03279": "รพ.สต.บ้านหนองคู", "03280": "รพ.สต.ตะดอบ",
            "03281": "รพ.สต.บ้านหนองครกใต้", "03282": "รพ.สต.บ้านกุดโง้ง", "03283": "รพ.สต.บ้านกลาง", "03284": "รพ.สต.บ้านหนองแวง",
            "03285": "รพ.สต.บ้านสร้างเรือง", "03286": "รพ.สต.บ้านโนนแกด", "03287": "รพ.สต.บ้านหนองไฮ", "03288": "รพ.สต.บ้านหนองแก้ว",
            "03289": "รพ.สต.บ้านน้ำคำ", "03290": "รพ.สต.บ้านหนองโน", "03291": "รพ.สต.บ้านโพธิ์", "03292": "รพ.สต.บ้านก้านเหลือง",
            "03293": "รพ.สต.บ้านหนองไผ่", "14422": "ศูนย์บริการสาธารณสุข 2", "15204": "ศูนย์บริการสาธารณสุข 3",
            "21986": "ศูนย์บริการสาธารณสุข 4", "23954": "ศูนย์บริการสาธารณสุข 5", "77475": "ศุนย์สุขภาพชุมชนเขตเมือง รพ.ศรีสะเกษ"
        };
        
        const CSV_HEADERS = [
            'idCard', 'name', 'dob', 'age', 'dxDate', 'dmYears', 'hba1c', 'bp', 'weight', 'height', 
            'vaRight', 'vaLeft', 'priorExam', 'priorExamCount', 'agencyCode', 'referralDate', 'drStageR', 'drStageL', 
            'lastExamDate', 'lastDrStageR', 'lastDrStageL', 
            'lastVaRight', 'lastVaLeft', 'lastHba1c', 'lastBp'
        ];
        const FOOT_RISKS = ["Low Risk (ความเสี่ยงต่ำ)", "Moderate Risk (ปานกลาง)", "High Risk (ความเสี่ยงสูง)", "Very High Risk (ความเสี่ยงสูงมาก)", "Active Ulcer (มีแผลขณะนี้)"];

        // --- UTILS ---
        const getTodayStr = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now.getTime() - offset).toISOString().split('T')[0];
        };

        const getGenderFromName = (name) => {
            if (!name) return '';
            const n = name.trim();
            if (n.startsWith('นาย') || n.startsWith('ด.ช.') || n.startsWith('เด็กชาย') || n.startsWith('พระ') || n.startsWith('สามเณร') || n.startsWith('พลฯ')) return 'ชาย';
            if (n.startsWith('นาง') || n.startsWith('ด.ญ.') || n.startsWith('เด็กหญิง') || n.startsWith('น.ส.') || n.startsWith('ดญ') || n.startsWith('นส.')) return 'หญิง';
            return '';
        };

        const formatDateTh = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20, className = "", color }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className} style={{color}}></i>;
        };

        const MessageModal = ({ modal, setModal }) => {
            if (!modal.visible) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm animate-fade-in p-6">
                        <div className="flex items-center gap-3 mb-4">
                            <Icon name={modal.onConfirm ? "help-circle" : "info"} size={24} className={modal.onConfirm ? "text-orange-500" : "text-blue-500"} />
                            <h3 className="text-xl font-bold">{modal.title || "แจ้งเตือน"}</h3>
                        </div>
                        <p className="text-gray-700 mb-6">{modal.message}</p>
                        <div className="flex justify-end gap-3">
                            {modal.onConfirm && <button onClick={() => setModal({ ...modal, visible: false })} className="px-4 py-2 rounded border bg-gray-100">ยกเลิก</button>}
                            <button onClick={() => { if (modal.onConfirm) modal.onConfirm(); else setModal({ ...modal, visible: false }); }} className={`px-4 py-2 rounded text-white ${modal.onConfirm ? 'bg-red-600' : 'bg-blue-600'}`}>ตกลง</button>
                        </div>
                    </div>
                </div>
            );
        };

        const QueueStatusBar = ({ patients, role, agencyCode, selectedDate }) => {
            const myPatients = useMemo(() => {
                return patients.filter(p => {
                    if (p.isDeleted) return false;
                    if (p.status === 'Imported') return false; 

                    if (role === 'PCU' && p.referringAgencyCode !== agencyCode) return false;
                    
                    if (selectedDate) {
                        const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                        const offset = pDate.getTimezoneOffset() * 60000;
                        const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];
                        if (pDateStr !== selectedDate) return false;
                    }
                    
                    return true;
                });
            }, [patients, role, agencyCode, selectedDate]);

            const totalPatients = myPatients.length;
            const waitingEye = myPatients.filter(p => p.status === 'Waiting').length;
            const waitingFoot = myPatients.filter(p => p.status === 'Waiting' && !p.footExam).length;

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 animate-fade-in">
                      <div className="bg-white border-l-4 border-emerald-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-emerald-100 p-2 rounded-full text-emerald-600"><Icon name="users" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">ผู้ป่วยทั้งหมด (Total)</div><div className="text-xl font-bold text-emerald-700 leading-none">{totalPatients} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                      <div className="bg-white border-l-4 border-blue-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Icon name="eye" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">รอตรวจตา (Eye Queue)</div><div className="text-xl font-bold text-blue-700 leading-none">{waitingEye} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                      <div className="bg-white border-l-4 border-pink-500 shadow-sm rounded-r-xl p-3 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <div className="bg-pink-100 p-2 rounded-full text-pink-600"><Icon name="footprints" size={20}/></div>
                            <div><div className="text-xs text-gray-500 font-bold">รอตรวจเท้า (Foot Queue)</div><div className="text-xl font-bold text-pink-700 leading-none">{waitingFoot} <span className="text-xs font-normal text-gray-400">คน</span></div></div>
                        </div>
                      </div>
                </div>
            );
        };

        const AuthScreen = () => {
            const [agencyCode, setAgencyCode] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                const code = agencyCode.trim();
                if (code.length !== 5) { setError('กรุณากรอกรหัสหน่วยงาน 5 หลัก'); return; }
                if (!password) { setError('กรุณากรอกรหัสผ่าน'); return; }
                
                setLoading(true);
                try {
                    const email = `${code}@eyedm.com`;
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    console.error(err);
                    setError('รหัสหน่วยงานหรือรหัสผ่านไม่ถูกต้อง');
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-cyan-500 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="lock" size={40} /></div>
                            <h1 className="text-3xl font-bold text-gray-800">EyeDM Connect</h1>
                            <p className="text-slate-500 mt-2">ระบบส่งต่อผู้ป่วยเบาหวานเข้าจอประสาทตา</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div><label className="block text-xs font-semibold text-gray-500 mb-1">รหัสหน่วยงาน (User ID)</label><input type="text" inputMode="numeric" maxLength="5" value={agencyCode} onChange={e=>setAgencyCode(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl text-lg font-mono" placeholder="เช่น 10700" required /></div>
                            <div><label className="block text-xs font-semibold text-gray-500 mb-1">รหัสผ่าน (Password)</label><input type="password" placeholder="กรอกรหัสผ่าน..." value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl text-lg" required /></div>
                            {error && <div className="bg-red-100 text-red-700 p-3 rounded-lg text-sm border border-red-300 flex items-center gap-2"><Icon name="alert-circle" size={16}/> {error}</div>}
                            <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-md">{loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ role, patients, onNew, onSelect, onEdit, setModal, agencyCode, agencyName, agenciesMap, selectedDate, setSelectedDate }) => {
            const [term, setTerm] = useState('');
            const [agencyFilter, setAgencyFilter] = useState('All');
            const allAgenciesMap = useMemo(() => ({ ...STATIC_PCU_DATA, ...agenciesMap }), [agenciesMap]);
            
            // ฟังก์ชัน Export CSV สำหรับ PCU
            const exportData = () => {
                const headers = ["Date", "ID Card", "Name", "Gender", "Age", "DM Years", "VA (R)", "VA (L)", "HbA1c", "Foot Risk", "Status", "Result (R)", "Result (L)"];
                const BOM = "\uFEFF"; 
                let csv = BOM + headers.join(",") + "\n";
                
                filtered.forEach(p => {
                    const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString('th-TH') : '-';
                    const safe = (s) => `"${String(s || '').replace(/"/g, '""')}"`;
                    const risk = p.footExam?.riskLevel?.split(' ')[0] || '-';
                    
                    csv += [
                        safe(date),
                        safe(`'${p.part1?.idCard}`), // ใส่ ' นำหน้าเพื่อป้องกัน Excel แปลงเป็นวิทยาศาสตร์
                        safe(p.part1?.name),
                        safe(p.part1?.gender),
                        safe(p.part1?.age),
                        safe(p.part1?.dmYears),
                        safe(p.part1?.vaRight),
                        safe(p.part1?.vaLeft),
                        safe(p.part1?.hba1c),
                        safe(risk),
                        safe(p.status),
                        safe(p.part2?.drStageR || '-'),
                        safe(p.part2?.drStageL || '-')
                    ].join(",") + "\n";
                });
                
                const url = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
                const link = document.createElement("a");
                link.href = url;
                link.download = `pcu_export_${selectedDate}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getFootBadge = (p) => {
                if (!p.footExam) return null;
                const risk = p.footExam.riskLevel || '';
                const isHigh = risk.includes('High') || risk.includes('Ulcer');
                const color = isHigh ? 'text-red-600 bg-red-50 border-red-100' : 'text-emerald-600 bg-emerald-50 border-emerald-100';
                return (
                    <div className={`text-[10px] px-1.5 py-0.5 rounded border ${color} inline-flex items-center gap-1 mt-1 w-fit`}>
                        <Icon name="footprints" size={10}/> 
                        <span className="truncate max-w-[80px]">{risk.split(' ')[0]}</span>
                    </div>
                );
            };
            
            const filtered = useMemo(() => {
                return patients.filter(p => {
                    if (p.isDeleted) return false;
                    
                    // ปรับเงื่อนไข: ถ้ามีการค้นหา (term มีค่า) ให้แสดงข้อมูล Imported/ประวัติเก่าได้ทั้งหมด
                    // แต่ถ้าไม่ได้ค้นหา (ดูรายวันปกติ) ให้ซ่อน Imported ไว้ตามเดิมเพื่อไม่ให้รก
                    if (term.length === 0 && p.status === 'Imported') return false;

                    const searchStr = (p.part1?.idCard || '') + (p.part1?.name || '');
                    const matchesTerm = searchStr.toLowerCase().includes(term.toLowerCase());
                    
                    const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                    const offset = pDate.getTimezoneOffset() * 60000;
                    const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];
                    const matchesDate = pDateStr === selectedDate;

                    let matchesAgency = true;
                    if (role === 'HOSPITAL') {
                        matchesAgency = agencyFilter === 'All' || p.referringAgencyCode === agencyFilter;
                    } else {
                        matchesAgency = p.referringAgencyCode === agencyCode;
                    }
                    
                    if (term.length > 0) {
                        return matchesAgency && matchesTerm;
                    } else {
                        return matchesAgency && matchesDate;
                    }
                });
            }, [patients, term, role, agencyCode, agencyFilter, selectedDate]);

            const getStatusBadge = (status) => {
                switch(status) {
                    case 'Waiting': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">รอตรวจ</span>;
                    case 'Completed': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">เรียบร้อย</span>;
                    case 'Imported': return <span className="px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">ฐานข้อมูล</span>;
                    default: return <span className="bg-gray-100">N/A</span>;
                }
            };
            const formatDate = (dateObj) => {
                if (dateObj && typeof dateObj.toLocaleDateString === 'function') { try { return dateObj.toLocaleDateString('th-TH'); } catch(e) { return '-'; } } return '-';
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3">
                        <div>
                            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon name={role==='PCU'?'home':'building'} className={role==='PCU'?'text-green-600':'text-blue-600'} />{role === 'PCU' ? 'ทะเบียนผู้ป่วย' : 'รายการส่งตัว (Hospital)'}</h2>
                            {role === 'PCU' && <div className="text-sm text-green-700 mt-1 font-semibold">{agencyCode} - {agencyName}</div>}
                        </div>
                        {/* ปรับปุ่มเพิ่มผู้ป่วยให้ใหญ่ เด่นชัด และกดง่ายขึ้น */}
                        {role === 'PCU' && (
                            <button 
                                onClick={() => onNew()} 
                                className="bg-green-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 font-bold text-base hover:bg-green-700 hover:scale-105 transition-all active:scale-95"
                            >
                                <Icon name="plus-circle" size={20}/> เพิ่มผู้ป่วยใหม่
                            </button>
                        )}
                    </div>
                    <div className="bg-white p-2 rounded-xl shadow-sm border flex flex-col sm:flex-row items-center gap-2">
                        <div className={`flex items-center gap-1 border rounded p-1 transition-colors ${term ? 'bg-gray-100 border-gray-200 opacity-50' : 'bg-blue-50 border-blue-100'}`}>
                            <span className="text-xs font-bold text-blue-600 px-2">วันที่:</span>
                            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-transparent border-none rounded p-1 text-sm text-blue-800 font-bold cursor-pointer outline-none" disabled={!!term}/>
                        </div>

                        {role === 'HOSPITAL' && (
                            <select value={agencyFilter} onChange={e => setAgencyFilter(e.target.value)} className="w-full sm:w-auto p-2 border bg-gray-50 rounded text-sm">
                                <option value="All">ทุกหน่วยงาน (All PCU)</option>
                                {Object.keys(allAgenciesMap).sort().map(code => <option key={code} value={code}>{code} - {allAgenciesMap[code]}</option>)}
                            </select>
                        )}
                        <div className="flex-1 flex items-center w-full border rounded px-2 bg-white ring-1 ring-transparent focus-within:ring-blue-500">
                            <Icon name="search" className="text-gray-400"/>
                            {/* ปรับข้อความ Placeholder ให้สื่อถึงการค้นหาประวัติเดิม */}
                            <input type="text" value={term} onChange={e=>setTerm(e.target.value)} placeholder="ค้นหาประวัติ/ชื่อ/เลขบัตร..." className="flex-1 p-2 outline-none text-sm w-full" />
                            {term && <button onClick={()=>setTerm('')} className="text-gray-400 hover:text-gray-600"><Icon name="x" size={14}/></button>}
                        </div>
                        
                        {/* เพิ่มปุ่มเพิ่มผู้ป่วยใหม่ในแถบค้นหา (Quick Add) - ส่ง term ไปด้วย */}
                        {role === 'PCU' && (
                            <div className="flex gap-2">
                                <button onClick={() => onNew(term)} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm hover:bg-green-700 whitespace-nowrap"><Icon name="plus-circle" size={16}/> เพิ่มผู้ป่วย</button>
                                <button onClick={exportData} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm hover:bg-blue-700 whitespace-nowrap"><Icon name="download" size={16}/> Export</button>
                            </div>
                        )}
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-x-auto">
                        <table className="w-full text-sm text-left whitespace-nowrap">
                            <thead className="bg-gray-50 border-b text-gray-500">
                                <tr>
                                    {/* เพิ่มหัวตารางลำดับ */}
                                    <th className="p-3 text-center w-10">#</th>
                                    <th className="p-3">วันที่</th>
                                    <th className="p-3">ผู้ป่วย / ID</th>
                                    <th className="p-3">หน่วยงาน</th>
                                    <th className="p-3 text-center">สถานะ</th>
                                    <th className="p-3 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filtered.map((p, index) => {
                                    const gender = p.part1?.gender || getGenderFromName(p.part1?.name);
                                    return (
                                    <tr key={p.id} className="hover:bg-gray-50">
                                            {/* แสดงลำดับที่ (index + 1) */}
                                            <td className="p-3 text-center align-top text-gray-400 font-bold">{index + 1}</td>
                                            
                                            <td className="p-3 text-gray-500 align-top">{formatDate(p.createdAt)}</td>
                                            <td className="p-3 align-top">
                                                <div className="font-mono text-blue-600 font-bold">{p.part1?.idCard || 'N/A'}</div>
                                                <div className="flex items-center gap-2">
                                                    <span>{p.part1?.name || 'N/A'}</span>
                                                    {gender === 'ชาย' && <Icon name="user" size={14} className="text-blue-500"/>}
                                                    {gender === 'หญิง' && <Icon name="user" size={14} className="text-pink-500"/>}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1 flex gap-2">
                                                     <span>VA: {p.part1?.vaRight || '-'}/{p.part1?.vaLeft || '-'}</span>
                                                     <span className="text-blue-600 font-semibold">HbA1c: {p.part1?.hba1c || '-'}</span>
                                                </div>
                                                {getFootBadge(p)}
                                            </td>
                                            <td className="p-3 align-top text-gray-500">{p.referringAgencyCode ? <div className="flex flex-col"><span className="bg-gray-100 px-2 py-1 rounded text-xs font-mono w-fit mb-1">{p.referringAgencyCode}</span><span className="text-xs truncate max-w-[150px]">{allAgenciesMap[p.referringAgencyCode] || '-'}</span></div> : <span>-</span>}</td>
                                            <td className="p-3 text-center align-top">{getStatusBadge(p.status)}</td>
                                            <td className="p-3 text-right align-top">
                                                <div className="flex justify-end gap-2">
                                                    {p.status !== 'Completed' && <button onClick={()=>onEdit(p)} className="text-blue-500 hover:bg-blue-50 p-2 rounded-lg"><Icon name="pencil" size={16}/></button>}
                                                    {role === 'HOSPITAL' && p.status === 'Waiting' && <button onClick={()=>onSelect(p)} className="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">ตรวจ</button>}
                                                    {p.status === 'Completed' && <button onClick={()=>onSelect(p)} className="bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-xs">ดูผล</button>}
                                                    
                                                    {/* ปุ่มลบแบบ Soft Delete: ไม่ลบข้อมูลจริง แต่ทำเครื่องหมายว่าลบ และบันทึกว่าใครลบ/ลบเมื่อไหร่ */}
                                                    {!(role === 'PCU' && p.status === 'Completed') && <button onClick={() => { 
                                                        setModal({ visible: true, title: "ลบข้อมูล", message: "ยืนยันการลบ? (ข้อมูลจะถูกเก็บไว้ในฐานข้อมูล แต่ซ่อนจากหน้านี้)", onConfirm: async () => { 
                                                            try { 
                                                                await getCollection('patients_referrals').doc(p.id).update({ 
                                                                    isDeleted: true,
                                                                    deletedAt: new Date(), // บันทึกเวลาที่ลบ
                                                                    deletedBy: agencyCode  // บันทึกรหัสหน่วยงานคนที่ลบ
                                                                }); 
                                                                setModal({ visible: false }); 
                                                            } 
                                                            catch(e) { alert(e.message); } 
                                                        } }); 
                                                    }} className="text-red-500 hover:bg-red-50 p-2 rounded-lg"><Icon name="trash-2" size={16}/></button>}
                                                </div>
                                            </td>
                                    </tr>
                                );})}
                                {filtered.length===0 && <tr><td colSpan="6" className="p-6 text-center text-gray-400">ไม่พบข้อมูลในวันที่เลือก</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PCUForm = ({ onBack, existingPatients, setModal, patientToEdit, agencyCode, initialId }) => {
            const isEditing = !!patientToEdit;
            const defaultForm = { idCard: initialId || '', name:'', gender:'', age:'', dob:'', dxDate:'', dmYears:'', hba1c:'', bp:'', weight:'', height:'', vaRight:'', vaLeft:'', priorExam:'No', priorExamCount: 0, wheelchair: false };
            const [form, setForm] = useState(isEditing ? { ...defaultForm, ...patientToEdit.part1 } : defaultForm);
            const [showScanner, setShowScanner] = useState(false);
            const [scanStatus, setScanStatus] = useState('');
            
            // ใช้ ref เพื่อจำว่าเลขนี้ถูกเติม Auto ไปแล้วหรือยัง (ป้องกัน Loop จอขาว)
            const lastAutoFilledId = useRef('');

            const [recordDate, setRecordDate] = useState(() => {
                if (isEditing && patientToEdit.createdAt) {
                    const d = new Date(patientToEdit.createdAt);
                    const offset = d.getTimezoneOffset() * 60000;
                    return new Date(d.getTime() - offset).toISOString().split('T')[0];
                }
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                return new Date(now.getTime() - offset).toISOString().split('T')[0];
            });

            const [saving, setSaving] = useState(false);
            const [foundOld, setFoundOld] = useState(false);
            const [footStatus, setFootStatus] = useState(null);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const validateThaiID = (id) => {
                if (id.length !== 13) return false;
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += parseFloat(id.charAt(i)) * (13 - i);
                }
                const checkDigit = (11 - sum % 11) % 10;
                return checkDigit === parseFloat(id.charAt(12));
            };

            // Scanner Effect: Adaptive OCR
            useEffect(() => {
                if (!showScanner) return;

                let stream = null;
                let scanInterval = null;
                let isScanning = false; 

                const startCamera = async () => {
                    try {
                        // Use high res for better OCR
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
                        });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.onloadedmetadata = () => {
                                videoRef.current.play();
                                setScanStatus('วางเลข 13 หลัก ในกรอบ (ถือนิ่งๆ)...');
                                startScanLoop();
                            };
                        }
                    } catch (err) {
                        console.error("Camera Error", err);
                        alert("ไม่สามารถเปิดกล้องได้: " + err.message);
                        setShowScanner(false);
                    }
                };

                const startScanLoop = () => {
                    scanInterval = setInterval(async () => {
                        if (isScanning || !videoRef.current || !canvasRef.current) return;
                        isScanning = true;

                        try {
                            const video = videoRef.current;
                            const canvas = canvasRef.current;
                            
                            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                const w = video.videoWidth;
                                const h = video.videoHeight;
                                
                                // Crop Logic: Expand to 90% width to handle variable distance/position
                                const cropW = w * 0.90; 
                                const cropH = h * 0.20; 
                                const startX = (w - cropW) / 2;
                                const startY = (h - cropH) / 2;
                                
                                const scale = 2; // Upscale for clearer text
                                canvas.width = cropW * scale;
                                canvas.height = cropH * scale;
                                const ctx = canvas.getContext('2d');
                                
                                ctx.drawImage(video, startX, startY, cropW, cropH, 0, 0, canvas.width, canvas.height);
                                
                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const data = imageData.data;

                                // Adaptive Thresholding
                                let totalBrightness = 0;
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = data[i];
                                    const g = data[i + 1];
                                    const b = data[i + 2];
                                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                    totalBrightness += gray;
                                }
                                const avgBrightness = totalBrightness / (data.length / 4);
                                const threshold = avgBrightness * 0.70; 

                                // Binarization
                                for (let i = 0; i < data.length; i += 4) {
                                    const r = data[i];
                                    const g = data[i + 1];
                                    const b = data[i + 2];
                                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                    const contrast = gray > threshold ? 255 : 0; 
                                    data[i] = contrast; data[i + 1] = contrast; data[i + 2] = contrast;
                                }
                                ctx.putImageData(imageData, 0, 0);

                                const { data: { text } } = await Tesseract.recognize(
                                    canvas, 
                                    'eng',
                                    { 
                                        tessedit_char_whitelist: '0123456789', 
                                        tessedit_pageseg_mode: '6' 
                                    }
                                );
                                
                                const digits = text.replace(/[^0-9]/g, '');
                                
                                if (digits.length >= 13) {
                                    for (let i = 0; i <= digits.length - 13; i++) {
                                        const potentialID = digits.substring(i, i + 13);
                                        if (validateThaiID(potentialID)) {
                                            if (navigator.vibrate) navigator.vibrate(200);
                                            setForm(prev => ({ ...prev, idCard: potentialID }));
                                            
                                            clearInterval(scanInterval);
                                            if (stream) stream.getTracks().forEach(track => track.stop());
                                            setShowScanner(false);
                                            isScanning = false;
                                            return;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            // console.error("OCR Error", e);
                        } finally {
                            isScanning = false;
                        }
                    }, 500); 
                };

                const initScanner = async () => {
                      if (!window.Tesseract) { 
                        await new Promise(r => setTimeout(r, 500));
                        if (!window.Tesseract) {
                            alert("ระบบสแกนยังโหลดไม่เสร็จ"); 
                            setShowScanner(false); 
                            return; 
                        }
                    }
                    startCamera();
                };
                initScanner();

                return () => {
                    if (scanInterval) clearInterval(scanInterval);
                    if (stream) stream.getTracks().forEach(track => track.stop());
                };
            }, [showScanner]);

            const handleNameChange = (e) => {
                const val = e.target.value;
                const detectedGender = getGenderFromName(val);
                setForm(prev => ({ 
                    ...prev, 
                    name: val, 
                    gender: detectedGender !== '' ? detectedGender : prev.gender 
                }));
            };

            useEffect(() => {
                const refDate = new Date(recordDate);
                let newAge = form.age;
                let newDmYears = form.dmYears;
                let hasUpdates = false;

                if (form.dob) {
                    const birthDate = new Date(form.dob);
                    if (!isNaN(birthDate)) {
                        let a = refDate.getFullYear() - birthDate.getFullYear();
                        const m = refDate.getMonth() - birthDate.getMonth();
                        if (m < 0 || (m === 0 && refDate.getDate() < birthDate.getDate())) a--;
                        const calculatedAge = Math.max(0, a);
                        if (Number(calculatedAge) !== Number(form.age)) {
                            newAge = calculatedAge;
                            hasUpdates = true;
                        }
                    }
                }

                if (form.dxDate) {
                    const dxDate = new Date(form.dxDate);
                    if (!isNaN(dxDate)) {
                        let y = refDate.getFullYear() - dxDate.getFullYear();
                        const m = refDate.getMonth() - dxDate.getMonth();
                        if (m < 0 || (m === 0 && refDate.getDate() < dxDate.getDate())) y--;
                        const calculatedDmYears = Math.max(0, y);
                        if (Number(calculatedDmYears) !== Number(form.dmYears)) {
                            newDmYears = calculatedDmYears;
                            hasUpdates = true;
                        }
                    }
                }

                if (hasUpdates) {
                    setForm(prev => ({ ...prev, age: newAge, dmYears: newDmYears }));
                }
            }, [recordDate, form.dob, form.dxDate]);

            // Logic กลับมาเติมข้อมูลอัตโนมัติทันทีเมื่อครบ 13 หลัก (ไม่ต้องถาม) + ป้องกัน Loop
            useEffect(() => {
                if (!isEditing && form.idCard && form.idCard.length === 13 && existingPatients) {
                    // Prevent loop: if we just auto-filled this ID, don't do it again
                    if (form.idCard === lastAutoFilledId.current) return;

                    const historyMatches = existingPatients.filter(p => p.part1?.idCard === form.idCard);
                    
                    if(historyMatches.length > 0) { 
                        setFoundOld(true); 
                        historyMatches.sort((a, b) => b.createdAt - a.createdAt);
                        const latestRecord = historyMatches[0];

                        let loadedPart1 = { ...latestRecord.part1 };
                        
                        if (!loadedPart1.gender && loadedPart1.name) {
                            loadedPart1.gender = getGenderFromName(loadedPart1.name);
                        }

                        setForm(f => ({...f, ...loadedPart1, idCard: form.idCard})); 
                        lastAutoFilledId.current = form.idCard; // Mark as filled
                        
                        if (latestRecord.footExam) setFootStatus(latestRecord.footExam.riskLevel);
                    } else { 
                        setFoundOld(false); 
                        setFootStatus(null);
                    }
                } else if (form.idCard.length < 13) {
                     lastAutoFilledId.current = '';
                     setFoundOld(false);
                }
            }, [form.idCard, existingPatients, isEditing]);

            const save = async () => {
                if(!form.idCard || form.idCard.length !== 13 || !form.name) { setModal({visible:true, message: "กรุณากรอกข้อมูลให้ครบ"}); return; }
                
                const parts = recordDate.split('-');
                const targetDate = new Date(parts[0], parts[1]-1, parts[2]); 
                const now = new Date();
                targetDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

                if (!isEditing && existingPatients) {
                    const duplicate = existingPatients.find(p => {
                        if (p.isDeleted) return false; 
                        if (p.part1?.idCard !== form.idCard) return false; 
                        const pDate = p.createdAt;
                        return pDate.getDate() === targetDate.getDate() &&
                               pDate.getMonth() === targetDate.getMonth() &&
                               pDate.getFullYear() === targetDate.getFullYear();
                    });

                    if (duplicate) {
                        setModal({ 
                            visible: true, 
                            title: "ไม่สามารถบันทึกได้", 
                            message: `ผู้ป่วยรายนี้ (${form.name}) มีรายการส่งตัวในวันที่เลือก (${recordDate}) แล้ว` 
                        });
                        return;
                    }
                }

                setSaving(true);
                try {
                    const collection = getCollection('patients_referrals');
                    const data = { 
                        part1: form, 
                        // [MODIFIED] ถ้าเป็นการแก้ไข (isEditing) ให้ใช้รหัสหน่วยงานเดิม (patientToEdit.referringAgencyCode)
                        // เพื่อป้องกันกรณี Hospital แก้ไขข้อมูลแล้วกลายเป็นของ Hospital เอง
                        referringAgencyCode: isEditing ? patientToEdit.referringAgencyCode : agencyCode, 
                        createdAt: targetDate,
                        ...(isEditing ? {} : { status: 'Waiting', isDeleted: false }) 
                    };
                    if (isEditing) await collection.doc(patientToEdit.id).update(data); else await collection.add(data);
                    setModal({ visible: true, title: "สำเร็จ", message: "บันทึกข้อมูลเรียบร้อย", onConfirm: () => { setModal({ visible: false }); onBack(); } });
                } catch(e) { setModal({visible:true, message: "เกิดข้อผิดพลาด: "+e.message}); }
                setSaving(false);
            };

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-20">
                    <button onClick={onBack} className="text-gray-500 mb-4 flex items-center gap-1"><Icon name="arrow-left" size={16}/> ยกเลิก</button>
                    <div className="bg-white rounded-2xl shadow-xl border border-green-100 overflow-hidden">
                        <div className="bg-green-600 p-4 text-white flex items-center justify-between">
                            <div className="flex items-center gap-2"><Icon name="file-text" className="text-white"/><h2 className="font-bold">{isEditing ? 'แก้ไขข้อมูล' : 'แบบฟอร์มส่งตัว'}</h2></div>
                            {footStatus && <div className="bg-white/20 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><Icon name="footprints" size={12}/> {footStatus.split(' ')[0]}</div>}
                        </div>
                        <div className="p-6 space-y-4">
                            
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                <label className="block text-xs font-bold text-blue-900 mb-1 flex items-center gap-2"><Icon name="calendar" size={16}/> วันที่ส่งตรวจ (Date)</label>
                                <input 
                                    type="date" 
                                    value={recordDate} 
                                    onChange={e => setRecordDate(e.target.value)} 
                                    className="w-full p-2 border rounded-lg text-lg font-semibold text-gray-700 cursor-pointer"
                                />
                            </div>

                            <div className={`p-4 rounded-xl border ${foundOld ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
                                <label className="block text-xs font-bold text-gray-700 mb-1">เลขบัตรประชาชน 13 หลัก *</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type="text" inputMode="numeric" maxLength="13" value={form.idCard} onChange={e=>setForm({...form, idCard:e.target.value})} className="w-full p-2 border rounded-lg text-lg font-mono" disabled={isEditing}/>
                                        {foundOld && !isEditing && <span className="absolute right-2 top-2 text-green-700 text-xs font-bold bg-green-100 px-2 py-1 rounded">มีประวัติเก่า</span>}
                                    </div>
                                    {/* ปุ่มเปิดสแกนเนอร์ */}
                                    <button onClick={() => setShowScanner(true)} className="bg-blue-600 text-white px-3 rounded-lg flex items-center gap-1 text-sm whitespace-nowrap shadow hover:bg-blue-700 transition-all"><Icon name="camera" size={16}/> สแกน/ถ่าย</button>
                                </div>
                            </div>

                            {/* Only OCR Camera Modal */}
                            {showScanner && (
                                <div className="fixed inset-0 z-50 bg-black bg-opacity-95 flex flex-col items-center justify-center p-4">
                                    <div className="relative w-full max-w-md rounded-xl overflow-hidden border-2 border-white/30 shadow-2xl bg-black h-64">
                                        <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover"></video>
                                        <canvas ref={canvasRef} className="hidden"></canvas>
                                        <div className="scanner-overlay"><div className="scanner-line"></div></div>
                                        
                                        <div className="absolute top-2 left-0 w-full text-center text-white text-xs bg-black/50 py-1 z-10">
                                            {scanStatus}
                                        </div>
                                    </div>
                                    <p className="text-white text-sm mt-4 text-center">
                                        วางเฉพาะตัวเลข 13 หลัก ให้อยู่ในกรอบ<br/><span className="text-xs text-gray-400">ระบบจะอ่านเฉพาะตัวเลขเท่านั้น</span>
                                    </p>
                                    <button onClick={() => setShowScanner(false)} className="mt-6 text-white bg-red-600 px-8 py-2 rounded-full font-bold hover:bg-red-700 transition-all">ปิดกล้อง</button>
                                </div>
                            )}
                            
                            <div className="grid grid-cols-1 sm:grid-cols-12 gap-3">
                                <div className="sm:col-span-6">
                                    <label className="text-xs text-gray-500 mb-1">ชื่อ-สกุล</label>
                                    <input type="text" value={form.name || ''} onChange={handleNameChange} className="w-full p-2 border rounded-lg" placeholder="เช่น นายสมชาย ใจดี"/>
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1">เพศ</label>
                                    <select value={form.gender} onChange={e=>setForm({...form, gender:e.target.value})} className="w-full p-2 border rounded-lg bg-white">
                                        <option value="">-</option>
                                        <option value="ชาย">ชาย</option>
                                        <option value="หญิง">หญิง</option>
                                    </select>
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1 text-blue-600">วันเกิด (DOB)</label>
                                    <input type="date" value={form.dob || ''} onChange={e=>setForm({...form, dob: e.target.value})} className="w-full p-2 border rounded-lg text-xs"/>
                                    {form.dob && <div className="text-[10px] text-blue-600 mt-1 text-right font-bold">{formatDateTh(form.dob)}</div>}
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-gray-500 mb-1">อายุ (ปี)</label>
                                    <input type="number" value={form.age || ''} onChange={e=>setForm({...form, age:e.target.value})} className="w-full p-2 border rounded-lg bg-gray-50"/>
                                </div>
                                
                                <div className="sm:col-span-6 sm:col-start-7">
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 mb-1 text-blue-600">วันที่วินิจฉัย (Dx Date)</label>
                                            <input type="date" value={form.dxDate || ''} onChange={e => setForm({...form, dxDate: e.target.value})} className="w-full p-2 border rounded-lg text-xs"/>
                                            {form.dxDate && <div className="text-[10px] text-blue-600 mt-1 text-right font-bold">{formatDateTh(form.dxDate)}</div>}
                                        </div>
                                        <div className="w-1/3">
                                            <label className="text-xs text-gray-500 mb-1">เป็น DM (ปี)</label>
                                            <input type="number" value={form.dmYears || ''} onChange={e=>setForm({...form, dmYears:e.target.value})} className="w-full p-2 border rounded-lg bg-gray-50"/>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div><label className="text-xs text-gray-500 mb-1">HbA1C (%)</label><input type="text" value={form.hba1c || ''} onChange={e=>setForm({...form, hba1c:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">BP (mmHg)</label><input type="text" value={form.bp || ''} onChange={e => { let val = e.target.value.replace(/[^0-9]/g, ''); if (val.length > 3) val = val.slice(0, 3) + '/' + val.slice(3); setForm({...form, bp: val}); }} className="w-full p-2 border rounded-lg" placeholder="120/80"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">น้ำหนัก (kg)</label><input type="number" value={form.weight || ''} onChange={e=>setForm({...form, weight:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                                <div><label className="text-xs text-gray-500 mb-1">ส่วนสูง (cm)</label><input type="number" value={form.height || ''} onChange={e=>setForm({...form, height:e.target.value})} className="w-full p-2 border rounded-lg"/></div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                                <h3 className="text-sm font-bold text-gray-700">ข้อมูลเพิ่มเติม</h3>
                                <div className="flex items-center gap-4">
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded"><input type="checkbox" checked={form.wheelchair || false} onChange={e=>setForm({...form, wheelchair:e.target.checked})} className="scale-125 text-green-600 rounded"/> <span className="text-sm">นั่งรถเข็น</span></label>
                                </div>
                                <div className="flex items-center gap-3 flex-wrap">
                                    <label className="flex items-center gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded"><input type="checkbox" checked={form.priorExam === 'Yes'} onChange={e => { const newVal = e.target.checked ? 'Yes' : 'No'; setForm({...form, priorExam: newVal, priorExamCount: newVal === 'No' ? 0 : form.priorExamCount}); }} className="scale-125 text-green-600 rounded"/> <span className="text-sm">เคยตรวจจอประสาทตา</span></label>
                                    {form.priorExam === 'Yes' && (<div className="flex items-center gap-2 animate-fade-in ml-2"><span className="text-sm text-gray-600">จำนวน:</span><input type="number" value={form.priorExamCount} onChange={e=>setForm({...form, priorExamCount:e.target.value})} className="w-16 p-1 border rounded text-sm text-center"/><span className="text-sm text-gray-600">ครั้ง</span></div>)}
                                </div>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 className="text-sm font-bold text-gray-700 mb-3">ค่าสายตา (Visual Acuity)</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    <select value={form.vaRight || ''} onChange={e=>setForm({...form, vaRight:e.target.value})} className="w-full p-2 border rounded-lg text-sm"><option value="">ขวา (Right)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                    <select value={form.vaLeft || ''} onChange={e=>setForm({...form, vaLeft:e.target.value})} className="w-full p-2 border rounded-lg text-sm"><option value="">ซ้าย (Left)</option>{VA_OPTIONS.map(o=><option key={o}>{o}</option>)}</select>
                                </div>
                            </div>
                            <button onClick={save} disabled={saving} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">{saving ? 'บันทึก...' : 'บันทึกและส่งตัว'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HospitalForm = ({ patient, patients, onBack, setModal, role }) => { 
            const isReadOnly = role === 'PCU';
            const [p2, setP2] = useState({ cataract: false, hearingUnclear: false, cannotSit: false, liftEyelids: false, retinaViewable: true, mydriasis: false, drStageL: 'No DR', drStageR: 'No DR', ...patient.part2 });
            const [findings, setFindings] = useState(patient.findings || JSON.parse(JSON.stringify(defaultFindings)));
            const [saving, setSaving] = useState(false);

            const historyData = useMemo(() => {
                if (!patients || !patient.part1?.idCard) return null;

                const allRecords = patients.filter(p => 
                    p.part1?.idCard === patient.part1.idCard && 
                    p.id !== patient.id && 
                    !p.isDeleted
                );
                allRecords.sort((a, b) => b.createdAt - a.createdAt);

                const completedExam = allRecords.find(p => p.status === 'Completed');
                if (completedExam) {
                    return {
                        type: 'DB',
                        date: completedExam.createdAt,
                        drStageR: completedExam.part2?.drStageR,
                        drStageL: completedExam.part2?.drStageL,
                        findings: completedExam.findings,
                        vaRight: completedExam.part1?.vaRight,
                        vaLeft: completedExam.part1?.vaLeft,
                        hba1c: completedExam.part1?.hba1c,
                        bp: completedExam.part1?.bp
                    };
                }
                
                const curHist = patient.history;
                if (curHist && (curHist.drStageR || curHist.drStageL || curHist.date)) {
                    return {
                        type: 'CSV',
                        date: curHist.date ? new Date(curHist.date) : null,
                        drStageR: curHist.drStageR || '-',
                        drStageL: curHist.drStageL || '-',
                        findings: null,
                        vaRight: curHist.vaRight || '-',
                        vaLeft: curHist.vaLeft || '-',
                        hba1c: curHist.hba1c || '-',
                        bp: curHist.bp || '-'
                    };
                }

                const recordWithHistory = allRecords.find(p => p.history && (p.history.drStageR || p.history.drStageL || p.history.date));
                if (recordWithHistory) {
                    const h = recordWithHistory.history;
                    return {
                        type: 'CSV',
                        date: h.date ? new Date(h.date) : null,
                        drStageR: h.drStageR || '-',
                        drStageL: h.drStageL || '-',
                        findings: null,
                        vaRight: h.vaRight || '-',
                        vaLeft: h.vaLeft || '-',
                        hba1c: h.hba1c || '-',
                        bp: h.bp || '-'
                    };
                }

                return null;
            }, [patient, patients]);

            const save = async () => {
                setSaving(true);
                try {
                    await getCollection('patients_referrals').doc(patient.id).update({ part2: p2, findings, status: 'Completed', examinedAt: new Date() });
                    setModal({ visible: true, title: "สำเร็จ", message: "บันทึกผลเรียบร้อย", onConfirm: () => { setModal({ visible: false }); onBack(); } });
                } catch(e){ setModal({ visible: true, message: e.message }); }
                setSaving(false);
            };
            const toggle = (k,s) => {
                 if (isReadOnly) return;
                 const n = JSON.parse(JSON.stringify(findings)); n[k][s] = !n[k][s];
                 if (k === 'Normal' && n[k][s]) Object.keys(n).forEach(key => { if (key !== 'Normal') n[key][s] = false; });
                 else if (k !== 'Normal' && n[k][s]) n['Normal'][s] = false;
                 setFindings(n);
            };
            const updateP2 = (field, value) => { if(!isReadOnly) setP2(prev => ({...prev, [field]: value})); };
            const toggleP2 = (field) => { if(!isReadOnly) setP2(prev => ({...prev, [field]: !prev[field]})); };

            // [ADDED] ฟังก์ชันพิเศษ: อัปเดต DR Stage พร้อมจัดการ Findings ตามเงื่อนไข (No DR -> Normal)
            const updateDrStage = (side, value) => {
                if(isReadOnly) return;
                
                // 1. อัปเดตค่า DR Stage
                setP2(prev => ({...prev, [`drStage${side}`]: value}));
                
                // 2. อัปเดต Findings อัตโนมัติ
                setFindings(prev => {
                    const n = JSON.parse(JSON.stringify(prev));
                    if (value === "No DR") {
                        // ถ้าเป็น No DR -> ให้ติ๊ก Normal และเอาอันอื่นออก
                        Object.keys(n).forEach(k => { if(n[k]) n[k][side] = (k === 'Normal'); });
                    } else if (value !== "ไม่พบจอประสาทตา") {
                        // ถ้าเป็นความรุนแรงอื่นๆ (Mild, Mod, Sev, PDR) -> เอา Normal ออก เพื่อให้หมอติ๊ก Findings เอง
                        if(n.Normal) n.Normal[side] = false;
                    }
                    return n;
                });
            };

            return (
                <div className="flex flex-col lg:flex-row gap-6 pb-20 animate-fade-in">
                      <div className="w-full lg:w-1/3 space-y-4">
                        <button onClick={onBack} className="text-gray-500 mb-2 flex items-center gap-1"><Icon name="arrow-left" size={16}/> กลับ</button>
                        <div className="bg-white p-5 rounded-xl shadow-lg border border-gray-100 sticky top-20">
                            {isReadOnly && <div className="mb-3 bg-green-100 text-green-800 p-2 rounded text-center font-bold text-sm border border-green-200">สถานะ: ได้รับการตรวจแล้ว</div>}
                            <div className="font-mono text-blue-600 font-bold text-lg">{patient.part1.idCard}</div>
                            <div className="text-2xl font-semibold">{patient.part1.name}</div>
                            <div className="mt-4 space-y-3 text-sm text-gray-600 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <div className="font-bold text-blue-800 border-b border-blue-200 pb-1 mb-2 flex justify-between items-center">
                                    <span>ประวัติจาก PCU</span>
                                    <span className="text-[10px] font-normal bg-blue-100 px-2 py-0.5 rounded-full text-blue-600">ส่งเมื่อ: {new Date(patient.createdAt).toLocaleDateString('th-TH')}</span>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-x-4 gap-y-2">
                                    <div className="col-span-2 flex justify-between border-b border-blue-100 pb-1"><span>วันเกิด:</span> <span className="font-bold text-gray-900">{formatDateTh(patient.part1.dob) || '-'}</span></div>
                                    <div className="flex justify-between"><span>อายุ:</span> <span className="font-bold text-gray-900">{patient.part1.age || '-'} ปี</span></div>
                                    <div className="flex justify-between"><span>วินิจฉัยเมื่อ:</span> <span className="font-bold text-gray-900">{patient.part1.dxDate ? (new Date(patient.part1.dxDate).getFullYear() + 543) : '-'}</span></div>
                                    <div className="flex justify-between"><span>เป็น DM:</span> <span className="font-bold text-gray-900">{patient.part1.dmYears || '-'} ปี</span></div>
                                    <div className="flex justify-between"><span>น้ำหนัก:</span> <span className="font-bold text-gray-900">{patient.part1.weight || '-'} กก.</span></div>
                                    <div className="flex justify-between"><span>ส่วนสูง:</span> <span className="font-bold text-gray-900">{patient.part1.height || '-'} ซม.</span></div>
                                    <div className="flex justify-between"><span>HbA1C:</span> <span className="font-bold text-gray-900">{patient.part1.hba1c || '-'}</span></div>
                                    <div className="flex justify-between"><span>BP:</span> <span className="font-bold text-gray-900">{patient.part1.bp || '-'}</span></div>
                                </div>

                                <div className="flex gap-2 flex-wrap mt-2">
                                    {patient.part1.wheelchair && <span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-1 rounded border border-orange-200 font-bold">นั่งรถเข็น</span>}
                                    {patient.part1.priorExam === 'Yes' && <span className="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200 font-bold">เคยตรวจ {patient.part1.priorExamCount} ครั้ง</span>}
                                </div>

                                <div className="pt-2 border-t border-blue-200 mt-2">
                                    <p className="font-bold text-blue-800 mb-1 text-xs uppercase">ค่าสายตา (VA)</p>
                                    <div className="flex justify-between text-gray-800"><span>ขวา:</span> <b>{patient.part1.vaRight || '-'}</b></div>
                                    <div className="flex justify-between text-gray-800"><span>ซ้าย:</span> <b>{patient.part1.vaLeft || '-'}</b></div>
                                </div>

                                {historyData && (
                                    <div className="pt-2 border-t border-blue-200 mt-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                                         <p className="font-bold text-yellow-800 mb-2 text-xs uppercase flex items-center gap-1">
                                            <Icon name="history" size={12}/> 
                                            ผลตรวจตาปีที่แล้ว {historyData.date && `(${historyData.date.toLocaleDateString('th-TH')})`}
                                            {historyData.type === 'CSV' && <span className="ml-auto text-[10px] bg-yellow-200 px-1 rounded text-yellow-800">CSV</span>}
                                         </p>
                                         
                                         <div className="grid grid-cols-2 gap-2 mb-2 text-[10px] text-gray-600 bg-white/50 p-1 rounded">
                                            <div><span className="font-bold">VA(R):</span> {historyData.vaRight || '-'}</div>
                                            <div><span className="font-bold">VA(L):</span> {historyData.vaLeft || '-'}</div>
                                            <div><span className="font-bold">HbA1c:</span> {historyData.hba1c || '-'}</div>
                                            <div><span className="font-bold">BP:</span> {historyData.bp || '-'}</div>
                                         </div>

                                         <div className="flex justify-between items-center text-xs mb-1">
                                             <span className="text-gray-600">ขวา (OD):</span>
                                             <span className="font-bold text-gray-800">{historyData.drStageR || '-'}</span>
                                         </div>
                                         <div className="flex justify-between items-center text-xs mb-2">
                                             <span className="text-gray-600">ซ้าย (OS):</span>
                                             <span className="font-bold text-gray-800">{historyData.drStageL || '-'}</span>
                                         </div>
                                         
                                         {historyData.findings && (
                                             <div className="text-[10px] text-gray-600 bg-white p-2 rounded border border-yellow-100 shadow-sm">
                                                 <span className="font-bold text-yellow-700">สิ่งที่ตรวจพบ (Findings):</span>
                                                 <div className="mt-1">
                                                     {Object.entries(historyData.findings || {}).map(([key, val]) => {
                                                         const sides = [];
                                                         if (val.L) sides.push('L');
                                                         if (val.R) sides.push('R');
                                                         if (sides.length > 0 && key !== 'Normal') {
                                                             return (
                                                                 <div key={key} className="flex items-center gap-1 mb-0.5">
                                                                     <span className="w-1 h-1 bg-yellow-500 rounded-full"></span>
                                                                     <span>{key} ({sides.join(',')})</span>
                                                                 </div>
                                                             );
                                                         }
                                                         return null;
                                                     })}
                                                     {(!historyData.findings || Object.entries(historyData.findings).every(([k, v]) => k === 'Normal' || (!v.L && !v.R))) && 
                                                         <div className="text-gray-400 italic">- ปกติ / ไม่ระบุ -</div>
                                                     }
                                                 </div>
                                              </div>
                                         )}
                                      </div>
                                )}

                                {patient.footExam && (
                                    <div className="pt-2 border-t border-blue-200 mt-2">
                                         <p className="font-bold text-pink-600 mb-1 text-xs uppercase flex items-center gap-1"><Icon name="footprints" size={12}/> ตรวจเท้า (Foot Risk)</p>
                                         <div className="flex items-center justify-between">
                                             <span className="text-gray-600 text-xs">ระดับความเสี่ยง:</span>
                                             <span className={`font-bold text-sm ${patient.footExam.riskLevel?.includes('High') || patient.footExam.riskLevel?.includes('Ulcer') ? 'text-red-600' : 'text-green-600'}`}>{patient.footExam.riskLevel ? patient.footExam.riskLevel.split(' ')[0] : '-'}</span>
                                         </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <div className="w-full lg:w-2/3 bg-white rounded-xl shadow-lg border overflow-hidden p-6 space-y-6">
                        <fieldset disabled={isReadOnly} className={isReadOnly ? "opacity-80 pointer-events-none" : ""}>
                        <div className="p-4 bg-gray-50 rounded border mb-4">
                            <p className="font-bold mb-3 text-blue-800">การประเมินเบื้องต้น</p>
                            <div className="grid grid-cols-2 gap-3">
                                {['cataract:เป็นต้อกระจก', 'hearingUnclear:การได้ยินไม่ชัดเจน', 'cannotSit:นั่งเก้าอี้ตรวจตาไม่ได้', 'liftEyelids:ต้องช่วยยกหนังตา', 'retinaViewable:พบจอประสาทตา', 'mydriasis:ต้องหยอดยาขยายม่านตา'].map(item => {
                                    const [key, label] = item.split(':');
                                    return (<label key={key} className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={p2[key]} onChange={()=>toggleP2(key)} className="chk-lg text-blue-600 rounded"/> <span>{label}</span></label>);
                                })}
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 rounded border">
                            <p className="font-bold mb-4 text-blue-800 border-b pb-2">ผลการตรวจจอประสาทตา</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {['L:ตาซ้าย (OS):text-blue-600:bg-blue-50', 'R:ตาขวา (OD):text-orange-600:bg-orange-50'].map(side => {
                                    const [s, label, textColor, bgColor] = side.split(':');
                                    return (
                                    <div key={s} className="bg-white p-3 rounded border shadow-sm card-hover">
                                            <h4 className={`font-bold text-center ${textColor} mb-3 ${bgColor} p-1 rounded`}>{label}</h4>
                                            <div className="mb-4">
                                                <label className="text-xs text-gray-500 block mb-1">ระดับความรุนแรง</label>
                                                {/* [MODIFIED] ใช้ updateDrStage แทน updateP2 */}
                                                <select value={p2[`drStage${s}`]} onChange={(e)=>updateDrStage(s, e.target.value)} className="w-full p-2 border rounded text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-50">{DR_STAGES.map(st=><option key={st}>{st}</option>)}</select>
                                            </div>
                                            <div className="space-y-2">
                                                <p className="text-xs text-gray-400 border-b pb-1">Findings</p>
                                                {Object.keys(defaultFindings).map(k => (<label key={`${s}-${k}`} className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" checked={findings[k]?.[s]} onChange={()=>toggle(k,s)} className="chk-lg"/><span className="text-sm">{k}</span></label>))}
                                            </div>
                                    </div>
                                    );
                                })}
                            </div>
                        </div>
                        </fieldset>
                        {!isReadOnly && <button onClick={save} disabled={saving} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg">{saving ? 'กำลังบันทึก...' : 'บันทึกผลการตรวจ'}</button>}
                    </div>
                </div>
            );
        };

        // [MODIFIED] ปรับ AdminHome ให้รับ setModal เพื่อแสดง Pop-up ยืนยันการลบ
        const AdminHome = ({ onNavigate, setModal }) => {
            const handleClearDatabase = () => {
                setModal({
                    visible: true,
                    title: "⚠️ ล้างฐานข้อมูลทั้งหมด",
                    message: "คุณแน่ใจหรือไม่ที่จะลบข้อมูลผู้ป่วยทั้งหมดออกจากระบบ? การกระทำนี้ไม่สามารถย้อนกลับได้!",
                    onConfirm: async () => {
                        try {
                            const collectionRef = getCollection('patients_referrals');
                            const snapshot = await collectionRef.get();
                            
                            if (snapshot.empty) {
                                alert("ไม่มีข้อมูลในฐานข้อมูล");
                                setModal({ visible: false });
                                return;
                            }

                            // ลบข้อมูลทีละ Batch (Firestore จำกัด 500 operation/batch)
                            const BATCH_SIZE = 400;
                            const chunks = [];
                            for (let i = 0; i < snapshot.docs.length; i += BATCH_SIZE) {
                                chunks.push(snapshot.docs.slice(i, i + BATCH_SIZE));
                            }

                            for (const chunk of chunks) {
                                const batch = db.batch();
                                chunk.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                            }

                            setModal({ visible: false });
                            alert(`ล้างข้อมูลเรียบร้อยแล้ว (${snapshot.size} รายการ)`);
                        } catch (error) {
                            console.error("Error clearing DB:", error);
                            alert("เกิดข้อผิดพลาด: " + error.message);
                            setModal({ visible: false });
                        }
                    }
                });
            };

            return (
                <div className="max-w-3xl mx-auto pb-20 animate-fade-in">
                    <button onClick={()=>onNavigate('dashboard')} className="mb-4 text-gray-500 flex gap-1 items-center hover:text-gray-800"><Icon name="arrow-left" size={16}/> กลับ Dashboard</button>
                    <div className="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2 text-gray-800"><Icon name="settings" className="text-blue-600"/> Admin Tools</h2>
                        <div className="space-y-4">
                            <div className="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-100"><div><h3 className="font-bold text-blue-900">จัดการรายชื่อ PCU</h3><p className="text-sm text-blue-700">เพิ่มหน่วยงาน PCU ใหม่ลงในระบบ Firebase</p></div><button onClick={()=>onNavigate('manage_agencies')} className="bg-white border border-blue-200 text-blue-700 px-4 py-2 rounded hover:bg-blue-100 font-bold">จัดการ</button></div>
                            <div className="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-100"><div><h3 className="font-bold text-yellow-900">นำเข้าข้อมูล (CSV / History)</h3><p className="text-sm text-yellow-700">อัปโหลดผู้ป่วยหรือผลตรวจเก่า</p></div><button onClick={()=>onNavigate('import_csv')} className="bg-white border border-yellow-200 text-yellow-700 px-4 py-2 rounded hover:bg-yellow-100 font-bold">นำเข้า</button></div>
                            <div className="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-100"><div><h3 className="font-bold text-green-900">รายงานและสถิติ เลือกได้</h3><p className="text-sm text-green-700">ดูภาพรวมและส่งออกข้อมูล</p></div><button onClick={()=>onNavigate('reports')} className="bg-white border border-green-200 text-green-700 px-4 py-2 rounded hover:bg-green-100 font-bold">ดูรายงาน</button></div>
                            
                            {/* [ADDED] ปุ่มล้างฐานข้อมูล */}
                            <div className="flex items-center justify-between p-4 bg-red-50 rounded-lg border border-red-100">
                                <div><h3 className="font-bold text-red-900">ล้างฐานข้อมูล (Reset Data)</h3><p className="text-sm text-red-700">ลบข้อมูลผู้ป่วยทั้งหมดออกจากระบบ</p></div>
                                <button onClick={handleClearDatabase} className="bg-white border border-red-200 text-red-700 px-4 py-2 rounded hover:bg-red-100 font-bold flex items-center gap-1"><Icon name="trash-2" size={16}/> ล้างข้อมูล</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ManageAgencies = ({ onBack, agenciesMap }) => {
            const [code, setCode] = useState('');
            const [name, setName] = useState('');
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const allAgencies = useMemo(() => {
                const list = [];
                Object.entries(STATIC_PCU_DATA).forEach(([c, n]) => list.push({ code: c, name: n, type: 'Static' }));
                Object.entries(agenciesMap).forEach(([c, n]) => list.push({ code: c, name: n, type: 'Dynamic' }));
                return list.sort((a, b) => a.code.localeCompare(b.code));
            }, [agenciesMap]);

            const handleAdd = async (e) => {
                e.preventDefault(); setError(''); setSuccess('');
                if (code.length !== 5 || !name) { setError("กรุณากรอกรหัส 5 หลักและชื่อหน่วยงาน"); return; }
                setSaving(true);
                try {
                    const collection = getCollection('agencies');
                    await collection.doc(code).set({ name: name, createdAt: new Date() });
                    setSuccess(`เพิ่มหน่วยงาน ${code} - ${name} เรียบร้อยแล้ว`); setCode(''); setName('');
                } catch(err) { setError("บันทึกไม่สำเร็จ: " + err.message); }
                setSaving(false);
            };

            return (
                <div className="max-w-4xl mx-auto pb-20 animate-fade-in">
                    <button onClick={()=>onBack('admin_home')} className="text-gray-500 mb-4 flex items-center gap-1 hover:text-gray-700"><Icon name="arrow-left" size={16}/> กลับสู่หน้า Admin</button>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icon name="plus-circle" className="text-green-600"/> ลงทะเบียน PCU ใหม่</h2>
                        <form onSubmit={handleAdd} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full"><label className="block text-xs text-gray-500 mb-1">รหัส 5 หลัก</label><input type="text" maxLength="5" value={code} onChange={e=>setCode(e.target.value)} className="w-full p-2 border rounded" placeholder="เช่น 99999"/></div>
                            <div className="flex-[2] w-full"><label className="block text-xs text-gray-500 mb-1">ชื่อหน่วยงาน</label><input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full p-2 border rounded" placeholder="เช่น รพ.สต.บ้านใหม่"/></div>
                            <button disabled={saving} className="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 w-full md:w-auto">{saving ? '...' : 'บันทึก'}</button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>} {success && <p className="text-green-500 text-sm mt-2">{success}</p>}
                    </div>
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden"><div className="p-4 bg-gray-50 border-b font-bold text-gray-700">รายชื่อหน่วยงานทั้งหมด ({allAgencies.length})</div><div className="max-h-96 overflow-y-auto"><table className="w-full text-sm"><thead className="bg-gray-100 text-left sticky top-0"><tr><th className="p-3">รหัส</th><th className="p-3">ชื่อหน่วยงาน</th><th className="p-3">ประเภท</th></tr></thead><tbody className="divide-y">{allAgencies.map(a => (<tr key={a.code}><td className="p-3 font-mono font-bold text-blue-600">{a.code}</td><td className="p-3">{a.name}</td><td className="p-3 text-xs text-gray-400">{a.type}</td></tr>))}</tbody></table></div></div>
                </div>
            );
        };

        const HospitalImport = ({ onBack, setModal }) => {
            const [csvData, setCsvData] = useState(null);
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [uploadError, setUploadError] = useState('');
            const [validCount, setValidCount] = useState(0);
            
            // Helper: Parse Thai Date (DD/MM/YYYY, with possible BE year)
            const parseThaiDate = (dateStr) => {
                if (!dateStr) return null;
                let d = new Date(dateStr);
                if (!isNaN(d.getTime())) return d;
                
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    let year = parseInt(parts[2]);
                    if (year > 2400) year -= 543; // Convert BE to AD
                    const month = parseInt(parts[1]) - 1;
                    const day = parseInt(parts[0]);
                    d = new Date(year, month, day);
                    if (!isNaN(d.getTime())) return d;
                }
                return null;
            };

            // [ADDED] ฟังก์ชันแปลงค่าผลตรวจจาก CSV ให้ตรงกับ Dropdown ของระบบ (Normalization)
            const normalizeDR = (val) => {
                if (!val) return '';
                const v = val.toLowerCase().trim();
                if (v.includes('no') || v.includes('normal') || v.includes('ปกติ')) return "No DR";
                if (v.includes('mild')) return "Mild DR";
                if (v.includes('mod')) return "Moderate DR";
                if (v.includes('sev')) return "Severe DR";
                if (v.includes('pdr') || v.includes('proli')) return "PDR";
                if (v.includes('incomp') || v.includes('ชัด') || v.includes('ไม่พบ') || v.includes('image') || v.includes('found')) return "ไม่พบจอประสาทตา";
                return val;
            };
            
            const downloadTemplate = () => {
                const BOM = "\uFEFF"; 
                const csvContent = BOM + CSV_HEADERS.join(",") + "\n";
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "eyedm_import_template.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // ฟังก์ชันช่วยสำหรับการรวมข้อมูล: เติมเฉพาะค่าที่ว่าง (Fill Missing)
            const mergeFillMissing = (target, source) => {
                const result = { ...target };
                for (const key in source) {
                    const sVal = source[key];
                    const tVal = result[key];
                    
                    if (sVal !== undefined && sVal !== null && sVal !== '') {
                        if (tVal === undefined || tVal === null || tVal === '') {
                            result[key] = sVal;
                        } 
                        else if (typeof tVal === 'object' && typeof sVal === 'object' && !Array.isArray(tVal)) {
                            result[key] = mergeFillMissing(tVal, sVal);
                        }
                    }
                }
                return result;
            };

            const parseCSV = (text) => {
                const lines = text.trim().split('\n'); if (lines.length < 2) throw new Error('ไฟล์ต้องมีอย่างน้อย 2 แถว');
                // Remove BOM if present
                const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim());
                const data = []; let validCount = 0; const headerMap = {};
                CSV_HEADERS.forEach(h => headerMap[h] = headers.findIndex(header => header.trim().toLowerCase() === h.toLowerCase()));
                
                // Helper regex to split CSV line respecting quotes
                const splitCSVLine = (line) => {
                    const matches = [];
                    let match;
                    const regex = /(?:^|,)(?:"([^"]*)"|([^,]*))/g;
                    while ((match = regex.exec(line))) {
                        // match[1] is quoted value, match[2] is unquoted value
                        if (match.index === regex.lastIndex) regex.lastIndex++; // Avoid infinite loop
                        let val = match[1] !== undefined ? match[1] : match[2];
                        matches.push(val ? val.trim() : "");
                    }
                    // Remove the last empty match that regex often produces at end of string
                    if (matches.length > headers.length) matches.pop(); 
                    return matches;
                };

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    // Use robust splitter or fallback to simple split
                    let values;
                    if (lines[i].includes('"')) {
                         values = splitCSVLine(lines[i]);
                    } else {
                         values = lines[i].split(',').map(v => v.trim());
                    }

                    const patient = {};
                    CSV_HEADERS.forEach(h => patient[h] = headerMap[h] > -1 ? values[headerMap[h]] : '');
                    
                    if (patient.idCard && patient.idCard.replace(/[^0-9]/g, '').length === 13 && patient.name) { 
                        patient.idCard = patient.idCard.replace(/[^0-9]/g, ''); // Sanitize ID Card
                        
                        // Robust Date Parsing
                        let examDate = new Date();
                        if (patient.referralDate) {
                            const parsed = parseThaiDate(patient.referralDate);
                            if (parsed) examDate = parsed;
                        }
                        
                        // Calculate Age
                        if (patient.dob) {
                            const dobDate = parseThaiDate(patient.dob);
                            if (dobDate) {
                                let age = examDate.getFullYear() - dobDate.getFullYear();
                                const m = examDate.getMonth() - dobDate.getMonth();
                                if (m < 0 || (m === 0 && examDate.getDate() < dobDate.getDate())) age--;
                                patient.age = age.toString();
                            }
                        }

                        // Calculate DM Years
                        if (patient.dxDate) {
                            const dxDate = parseThaiDate(patient.dxDate);
                            if (dxDate) {
                                let years = examDate.getFullYear() - dxDate.getFullYear();
                                const m = examDate.getMonth() - dxDate.getMonth();
                                if (m < 0 || (m === 0 && examDate.getDate() < dxDate.getDate())) years--;
                                patient.dmYears = Math.max(0, years).toString();
                            }
                        }

                        patient.gender = getGenderFromName(patient.name);

                        const normDrR = normalizeDR(patient.drStageR);
                        const normDrL = normalizeDR(patient.drStageL);
                        const normLastDrR = normalizeDR(patient.lastDrStageR);
                        const normLastDrL = normalizeDR(patient.lastDrStageL);

                        const importData = { 
                            part1: {
                                idCard: patient.idCard,
                                name: patient.name,
                                gender: patient.gender,
                                dob: patient.dob || '',
                                age: patient.age,
                                dxDate: patient.dxDate || '',
                                dmYears: patient.dmYears,
                                hba1c: patient.hba1c, 
                                bp: patient.bp,
                                weight: patient.weight,
                                height: patient.height,
                                vaRight: patient.vaRight,
                                vaLeft: patient.vaLeft,
                                priorExam: patient.priorExam,
                                priorExamCount: patient.priorExamCount
                            },
                            referringAgencyCode: patient.agencyCode || 'IMPORT',
                            status: (normDrR || normDrL) ? 'Completed' : 'Imported', 
                            isDeleted: false, 
                            createdAt: examDate,
                            history: {
                                date: patient.lastExamDate || '',
                                drStageR: normLastDrR, 
                                drStageL: normLastDrL,  
                                vaRight: patient.lastVaRight || '',
                                vaLeft: patient.lastVaLeft || '',
                                hba1c: patient.lastHba1c || '',
                                bp: patient.lastBp || ''
                            }
                        };
                        
                        if(importData.status === 'Completed') {
                            importData.examinedAt = examDate;
                            importData.part2 = { 
                                drStageR: normDrR || 'ไม่พบจอประสาทตา', 
                                drStageL: normDrL || 'ไม่พบจอประสาทตา', 
                                cataract: false, hearingUnclear: false, cannotSit: false, liftEyelids: false, retinaViewable: true, mydriasis: false 
                            };
                            importData.findings = JSON.parse(JSON.stringify(defaultFindings));
                        }

                        data.push(importData); 
                        validCount++; 
                    }
                }
                setValidCount(validCount); return data;
            };
            
            const handleParse = () => { if (!file) return; setLoading(true); setUploadError(''); const reader = new FileReader(); reader.onload = (event) => { try { setCsvData(parseCSV(event.target.result)); setLoading(false); } catch (error) { setUploadError(error.message); setLoading(false); } }; reader.readAsText(file, 'UTF-8'); };
            
            const uploadData = async () => { 
                const collection = getCollection('patients_referrals'); 
                setLoading(true); 
                setUploadError(''); 
                try { 
                    // 1. Fetch existing data first (Read Phase)
                    const tasks = csvData.map(async (data) => {
                        const dateStr = data.createdAt.toISOString().split('T')[0];
                        const docId = `${data.part1.idCard}_${dateStr}`;
                        const docRef = collection.doc(docId);
                        const snap = await docRef.get();
                        return { docRef, data: JSON.parse(JSON.stringify(data)), snap };
                    });

                    const results = await Promise.all(tasks);

                    // 2. Batch Write (Chunked to 400 per batch)
                    const BATCH_SIZE = 400;
                    let processedCount = 0;

                    for (let i = 0; i < results.length; i += BATCH_SIZE) {
                        const chunk = results.slice(i, i + BATCH_SIZE);
                        const batch = db.batch();
                        
                        chunk.forEach(({ docRef, data, snap }) => {
                            if (snap.exists) {
                                const existingData = snap.data();
                                // Rules for protecting existing data
                                if (existingData.part1?.dob) { delete data.part1.dob; delete data.part1.age; }
                                if (existingData.part1?.dxDate) { delete data.part1.dxDate; delete data.part1.dmYears; }
                                // Rules for overwriting
                                if (data.part1?.name) {
                                    if (!existingData.part1) existingData.part1 = {};
                                    existingData.part1.name = data.part1.name;
                                }
                                if (data.part1?.idCard) {
                                    if (!existingData.part1) existingData.part1 = {};
                                    existingData.part1.idCard = data.part1.idCard;
                                }
                                const mergedData = mergeFillMissing(existingData, data);
                                batch.set(docRef, mergedData); 
                            } else {
                                batch.set(docRef, data); 
                            }
                            processedCount++;
                        });
                        
                        await batch.commit();
                    }
                    
                    if(processedCount===0) { setUploadError('No valid data'); setLoading(false); return; } 
                    setModal({ visible: true, title: "สำเร็จ", message: `นำเข้าข้อมูลสำเร็จ ${processedCount} รายการ`, onConfirm: () => onBack('admin_home') }); 
                } catch (e) { setUploadError(e.message); } finally { setLoading(false); } 
            };

            return (
                <div className="max-w-3xl mx-auto pb-20 animate-fade-in">
                    <button onClick={() => onBack('admin_home')} className="mb-4 flex items-center gap-1 text-gray-500"><Icon name="arrow-left" size={16}/> กลับ</button>
                    <div className="bg-white p-6 rounded shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="font-bold">Import CSV (History Supported)</h2>
                            <button onClick={downloadTemplate} className="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1"><Icon name="download" size={14}/> โหลดแบบฟอร์ม</button>
                        </div>
                        <input type="file" onChange={e=>{setFile(e.target.files[0]);setCsvData(null);}} className="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700"/>
                        {file && !csvData && <button onClick={handleParse} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded">{loading?'Reading...':'Parse File'}</button>}
                        {csvData && (
                            <div className="mt-4">
                                <p>Found {validCount} valid records.</p>
                                <button onClick={uploadData} disabled={loading} className="bg-green-600 text-white px-4 py-2 rounded mt-2">{loading?'Uploading...':'Confirm Upload'}</button>
                            </div>
                        )}
                        {uploadError && <p className="text-red-500 mt-2">{uploadError}</p>}
                    </div>
                </div>
            );
        };

        const ReportsPage = ({ onBack, patients, agenciesMap }) => {
            // Filter States
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [options, setOptions] = useState({
                general: true, // ข้อมูลทั่วไป (ชื่อ, อายุ, DM, BP)
                eye: true,     // ผลตรวจตา (VA, DR Stage)
                foot: true     // ผลตรวจเท้า (Risk, รายละเอียด)
            });

            // 1. Filter Patients based on Date Range
            const filteredPatients = useMemo(() => {
                return patients.filter(p => {
                    if (p.isDeleted) return false;
                    // ไม่นับ Imported (ข้อมูลดิบที่ยังไม่ได้ทำอะไร) ในรายงานสถิติผลงาน
                    if (p.status === 'Imported') return false; 

                    if (!startDate && !endDate) return true; // ไม่เลือกวันที่ = เอาทั้งหมด

                    const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                    const offset = pDate.getTimezoneOffset() * 60000;
                    const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];

                    if (startDate && pDateStr < startDate) return false;
                    if (endDate && pDateStr > endDate) return false;

                    return true;
                });
            }, [patients, startDate, endDate]);

            // 2. Calculate Statistics (From Filtered Data)
            const stats = useMemo(() => {
                const total = filteredPatients.length;
                const completed = filteredPatients.filter(p => p.status === 'Completed').length;
                const waiting = filteredPatients.filter(p => p.status === 'Waiting').length;
                
                const severityCounts = { 'No DR': 0, 'Mild DR': 0, 'Moderate DR': 0, 'Severe DR': 0, 'PDR': 0, 'ไม่พบจอประสาทตา': 0 };
                const footTotal = filteredPatients.filter(p => p.footExam).length;
                const footRiskCounts = { 'Low Risk': 0, 'Moderate Risk': 0, 'High Risk': 0, 'Very High Risk': 0, 'Active Ulcer': 0 };
                const agencyStats = {};

                filteredPatients.forEach(p => {
                    // Agency Logic
                    const code = p.referringAgencyCode || 'Unknown';
                    const name = agenciesMap[code] || code;
                    if (!agencyStats[code]) agencyStats[code] = { name, total: 0, completed: 0 };
                    agencyStats[code].total++;
                    if (p.status === 'Completed') agencyStats[code].completed++;

                    // Eye Logic
                    if (p.status === 'Completed' && p.part2) {
                        const getScore = (s) => {
                            if (!s || s.includes('No DR')) return 0;
                            if (s.includes('Mild')) return 1;
                            if (s.includes('Moderate')) return 2;
                            if (s.includes('Severe')) return 3;
                            if (s.includes('PDR')) return 4;
                            return -1; 
                        };
                        const scoreL = getScore(p.part2.drStageL);
                        const scoreR = getScore(p.part2.drStageR);
                        const maxScore = Math.max(scoreL, scoreR);
                        
                        if (maxScore === 0) severityCounts['No DR']++;
                        else if (maxScore === 1) severityCounts['Mild DR']++;
                        else if (maxScore === 2) severityCounts['Moderate DR']++;
                        else if (maxScore === 3) severityCounts['Severe DR']++;
                        else if (maxScore === 4) severityCounts['PDR']++;
                        else severityCounts['ไม่พบจอประสาทตา']++;
                    }

                    // Foot Logic
                    if (p.footExam && p.footExam.riskLevel) {
                        const r = p.footExam.riskLevel;
                        if (r.includes('Ulcer')) footRiskCounts['Active Ulcer']++;
                        else if (r.includes('Very High')) footRiskCounts['Very High Risk']++;
                        else if (r.includes('High')) footRiskCounts['High Risk']++;
                        else if (r.includes('Moderate')) footRiskCounts['Moderate Risk']++;
                        else footRiskCounts['Low Risk']++;
                    }
                });

                return { total, completed, waiting, severityCounts, agencyStats, footTotal, footRiskCounts };
            }, [filteredPatients, agenciesMap]);

            // 3. Dynamic Export CSV
            const exportCSV = () => {
                // Build Headers based on options
                let headers = ["Date", "Agency"];
                if (options.general) headers.push("ID Card", "Name", "Gender", "Age", "DM Years", "HbA1C", "BP", "Weight", "Height");
                if (options.eye) headers.push("VA (R)", "VA (L)", "DR Stage (R)", "DR Stage (L)", "Eye Status");
                if (options.foot) headers.push("Foot Risk", "Pulse", "Monofilament", "Deformity/Callus", "Footwear");

                const BOM = "\uFEFF"; 
                let csvContent = BOM + headers.join(",") + "\n";
                
                filteredPatients.forEach(p => {
                    const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString('th-TH') : '-';
                    const agency = agenciesMap[p.referringAgencyCode] || p.referringAgencyCode || '-';
                    const safeStr = (s) => { if (s === null || s === undefined) return '""'; return `"${String(s).replace(/"/g, '""')}"`; };

                    let row = [safeStr(date), safeStr(agency)];

                    if (options.general) {
                        row.push(
                            safeStr(`'${p.part1?.idCard || ''}`), 
                            safeStr(p.part1?.name), 
                            safeStr(p.part1?.gender),
                            safeStr(p.part1?.age),
                            safeStr(p.part1?.dmYears),
                            safeStr(p.part1?.hba1c),
                            safeStr(p.part1?.bp),
                            safeStr(p.part1?.weight),
                            safeStr(p.part1?.height)
                        );
                    }

                    if (options.eye) {
                        row.push(
                            safeStr(p.part1?.vaRight),
                            safeStr(p.part1?.vaLeft),
                            safeStr(p.part2?.drStageR || '-'),
                            safeStr(p.part2?.drStageL || '-'),
                            safeStr(p.status)
                        );
                    }

                    if (options.foot) {
                        const f = p.footExam || {};
                        const deformityStr = (f.deformity ? 'Deformity ' : '') + (f.callus ? 'Callus' : '');
                        row.push(
                            safeStr(f.riskLevel || '-'),
                            safeStr(`L:${f.pulse?.L}/R:${f.pulse?.R}`),
                            safeStr(`L:${f.monofilament?.L}/R:${f.monofilament?.R}`),
                            safeStr(deformityStr),
                            safeStr(f.footwear)
                        );
                    }

                    csvContent += row.join(",") + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `eyedm_report_${startDate||'all'}_to_${endDate||'all'}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const Bar = ({ label, count, total, color }) => {
                const percent = total > 0 ? (count / total) * 100 : 0;
                return (
                    <div className="mb-3">
                        <div className="flex justify-between text-sm mb-1 text-gray-700"><span>{label}</span><span className="font-bold">{count} ({percent.toFixed(1)}%)</span></div>
                        <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className={`h-2.5 rounded-full ${color} transition-all duration-500`} style={{width: `${percent}%`}}></div></div>
                    </div>
                );
            };

            return (
                <div className="max-w-5xl mx-auto pb-20 animate-fade-in">
                    <button onClick={onBack} className="mb-4 flex items-center gap-1 text-gray-500 hover:text-gray-800"><Icon name="arrow-left" size={16}/> กลับ Admin Tools</button>
                    
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm border">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="bar-chart-2" className="text-green-600"/> รายงานและสถิติ</h2>
                            <p className="text-sm text-gray-500">เลือกช่วงเวลาและข้อมูลที่ต้องการ</p>
                        </div>
                        <div className="flex flex-col gap-2 w-full md:w-auto">
                            {/* Date Filter */}
                            <div className="flex gap-2 items-center">
                                <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="border rounded p-1 text-sm"/>
                                <span className="text-gray-400">-</span>
                                <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="border rounded p-1 text-sm"/>
                            </div>
                            {/* Section Toggles */}
                            <div className="flex gap-3 text-sm">
                                <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.general} onChange={e=>setOptions({...options, general:e.target.checked})} className="accent-green-600"/> ข้อมูลทั่วไป</label>
                                <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.eye} onChange={e=>setOptions({...options, eye:e.target.checked})} className="accent-blue-600"/> ตรวจตา</label>
                                <label className="flex items-center gap-1 cursor-pointer"><input type="checkbox" checked={options.foot} onChange={e=>setOptions({...options, foot:e.target.checked})} className="accent-pink-600"/> ตรวจเท้า</label>
                            </div>
                            <button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg shadow flex items-center justify-center gap-2 hover:bg-green-700 text-sm font-bold mt-1"><Icon name="download" size={16}/> Export CSV</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center"><div className="text-gray-500 text-xs uppercase mb-1">ผู้ป่วยในช่วงเวลา</div><div className="text-3xl font-bold text-blue-600">{stats.total}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-green-100 text-center"><div className="text-gray-500 text-xs uppercase mb-1">ตรวจตาแล้ว</div><div className="text-3xl font-bold text-green-600">{stats.completed}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-pink-100 text-center"><div className="text-gray-500 text-xs uppercase mb-1">ตรวจเท้าแล้ว</div><div className="text-3xl font-bold text-pink-600">{stats.footTotal}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 text-center"><div className="text-gray-500 text-xs uppercase mb-1">รอตรวจตา</div><div className="text-3xl font-bold text-orange-600">{stats.waiting}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-red-100 text-center"><div className="text-gray-500 text-xs uppercase mb-1">ตาผิดปกติ (Any DR)</div><div className="text-3xl font-bold text-red-600">{stats.completed - (stats.severityCounts['No DR'] || 0) - (stats.severityCounts['ไม่พบจอประสาทตา'] || 0)}</div></div>
                    </div>
                    
                    {/* Charts */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="eye" size={18}/> ความรุนแรงทางตา (DR Severity)</h3>
                            <div className="space-y-2">
                                <Bar label="No DR" count={stats.severityCounts['No DR']} total={stats.completed} color="bg-green-500" />
                                <Bar label="Mild DR" count={stats.severityCounts['Mild DR']} total={stats.completed} color="bg-yellow-400" />
                                <Bar label="Moderate DR" count={stats.severityCounts['Moderate DR']} total={stats.completed} color="bg-orange-500" />
                                <Bar label="Severe DR" count={stats.severityCounts['Severe DR']} total={stats.completed} color="bg-red-500" />
                                <Bar label="PDR" count={stats.severityCounts['PDR']} total={stats.completed} color="bg-purple-600" />
                                <Bar label="ไม่พบจอประสาทตา" count={stats.severityCounts['ไม่พบจอประสาทตา']} total={stats.completed} color="bg-gray-400" />
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="footprints" size={18}/> ความเสี่ยงเท้า (Foot Risk)</h3>
                            <div className="space-y-2">
                                <Bar label="Low Risk (ความเสี่ยงต่ำ)" count={stats.footRiskCounts['Low Risk']} total={stats.footTotal} color="bg-emerald-500" />
                                <Bar label="Moderate Risk (ปานกลาง)" count={stats.footRiskCounts['Moderate Risk']} total={stats.footTotal} color="bg-yellow-500" />
                                <Bar label="High Risk (ความเสี่ยงสูง)" count={stats.footRiskCounts['High Risk']} total={stats.footTotal} color="bg-orange-500" />
                                <Bar label="Very High Risk (สูงมาก/ประวัติเก่า)" count={stats.footRiskCounts['Very High Risk']} total={stats.footTotal} color="bg-red-500" />
                                <Bar label="Active Ulcer (มีแผลขณะนี้)" count={stats.footRiskCounts['Active Ulcer']} total={stats.footTotal} color="bg-red-800" />
                            </div>
                            {stats.footTotal === 0 && <div className="text-center text-gray-400 py-4">ยังไม่มีข้อมูลการตรวจเท้า</div>}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border flex flex-col h-[400px]">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Icon name="list" size={18}/> สถิติรายหน่วยงาน (PCU)</h3>
                            <div className="overflow-y-auto flex-1 pr-2 custom-scrollbar">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 sticky top-0 z-10"><tr><th className="p-2 text-left rounded-tl-lg">หน่วยงาน</th><th className="p-2 text-center">ส่งมา</th><th className="p-2 text-center rounded-tr-lg">ตรวจตาแล้ว</th></tr></thead>
                                    <tbody className="divide-y">{Object.values(stats.agencyStats).sort((a,b) => b.total - a.total).map((s, i) => (<tr key={i} className="hover:bg-gray-50"><td className="p-3 truncate max-w-[180px]" title={s.name}>{s.name}</td><td className="p-3 text-center font-bold text-gray-700">{s.total}</td><td className="p-3 text-center font-bold text-green-600">{s.completed}</td></tr>))}</tbody>
                                </table>
                            </div>
                    </div>
                </div>
            );
        };

        const FootDashboard = ({ patients, onSelect, agenciesMap, onLogout, selectedDate, setSelectedDate }) => {
            const [term, setTerm] = useState('');
            const [agencyFilter, setAgencyFilter] = useState('All');
            
            const allAgenciesMap = useMemo(() => ({ ...STATIC_PCU_DATA, ...agenciesMap }), [agenciesMap]);

            const filtered = patients.filter(p => {
                if (p.isDeleted) return false;
                if (p.status === 'Imported') return false;

                const searchStr = (p.part1?.idCard || '') + (p.part1?.name || '');
                const matchesTerm = searchStr.includes(term);
                const matchesAgency = agencyFilter === 'All' || p.referringAgencyCode === agencyFilter;
                
                const pDate = p.createdAt ? new Date(p.createdAt) : new Date();
                const offset = pDate.getTimezoneOffset() * 60000;
                const pDateStr = new Date(pDate.getTime() - offset).toISOString().split('T')[0];
                const matchesDate = pDateStr === selectedDate;

                return matchesAgency && matchesDate && (term.length === 0 || matchesTerm);
            });

            const getFootStatus = (p) => {
                if (!p.footExam) return <span className="px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500">ยังไม่ตรวจ</span>;
                
                const risk = p.footExam.riskLevel || 'Unknown';
                
                let color = 'bg-green-100 text-green-700';
                
                if (risk.includes('Ulcer')) color = 'bg-red-800 text-white';
                else if (risk.includes('Very High')) color = 'bg-red-500 text-white';
                else if (risk.includes('High')) color = 'bg-orange-100 text-orange-700';
                else if (risk.includes('Moderate')) color = 'bg-yellow-100 text-yellow-700';
                
                return <span className={`px-2 py-1 rounded-full text-xs font-bold ${color}`}>{risk.split(' ')[0]}</span>;
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="bg-white p-2 rounded-xl shadow-sm border flex flex-col sm:flex-row items-center gap-2">
                        
                        <div className="flex items-center gap-1 bg-pink-50 border border-pink-100 rounded p-1">
                            <span className="text-xs font-bold text-pink-600 px-2">วันที่:</span>
                            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="bg-white border rounded p-1 text-sm text-pink-800 font-bold cursor-pointer"/>
                        </div>

                        <select value={agencyFilter} onChange={e => setAgencyFilter(e.target.value)} className="w-full sm:w-auto p-2 border bg-gray-50 rounded text-sm">
                            <option value="All">ทุกหน่วยงาน (All PCU)</option>
                            {Object.keys(allAgenciesMap).sort().map(code => <option key={code} value={code}>{code} - {allAgenciesMap[code]}</option>)}
                        </select>

                        <div className="flex-1 flex items-center w-full border rounded px-2 bg-white">
                            <Icon name="search" className="text-gray-400"/>
                            <input type="text" value={term} onChange={e=>setTerm(e.target.value)} placeholder="ค้นหาคนไข้ (เลขบัตร/ชื่อ)..." className="flex-1 p-2 outline-none text-sm w-full" />
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="p-3 bg-pink-50 text-pink-800 font-bold text-sm border-b flex justify-between items-center"><span>รายชื่อผู้ป่วย ({filtered.length})</span><span className="text-xs font-normal text-pink-600">*ดึงข้อมูลจากทะเบียนกลาง</span></div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-500 border-b"><tr><th className="p-3">ชื่อ-สกุล / PCU</th><th className="p-3">อายุ/DM</th><th className="p-3 text-center">สถานะเท้า</th><th className="p-3 text-right">Action</th></tr></thead>
                                <tbody className="divide-y">
                                    {filtered.map(p => {
                                        const gender = p.part1?.gender || getGenderFromName(p.part1?.name);
                                        return (
                                        <tr key={p.id} className="hover:bg-gray-50">
                                            <td className="p-3">
                                                <div className="font-bold text-gray-800">{p.part1?.name}</div>
                                                <div className="flex items-center gap-1 mb-1">
                                                    {gender === 'ชาย' && <Icon name="user" size={12} className="text-blue-500"/>}
                                                    {gender === 'หญิง' && <Icon name="user" size={12} className="text-pink-500"/>}
                                                    <div className="text-xs text-gray-400 font-mono">{p.part1?.idCard}</div>
                                                </div>
                                                <span className="bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded text-[10px] border">{allAgenciesMap[p.referringAgencyCode] || p.referringAgencyCode}</span>
                                            </td>
                                            <td className="p-3 text-gray-600 align-top">{p.part1?.age} ปี / DM {p.part1?.dmYears} ปี</td>
                                            <td className="p-3 text-center align-top">{getFootStatus(p)}</td>
                                            <td className="p-3 text-right align-top">
                                                <button onClick={()=>onSelect(p)} className={`px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-1 ml-auto ${p.footExam ? 'bg-blue-50 text-blue-600 hover:bg-blue-100 border border-blue-200' : 'bg-pink-600 text-white hover:bg-pink-700'}`}>
                                                    <Icon name={p.footExam ? "edit-2" : "clipboard-check"} size={14}/> {p.footExam ? 'แก้ไข' : 'ประเมิน'}
                                                </button>
                                            </td>
                                        </tr>
                                    );})}
                                    {filtered.length===0 && <tr><td colSpan="4" className="p-6 text-center text-gray-400">ไม่พบข้อมูลในวันที่เลือก</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const FootForm = ({ patient, onBack, setModal }) => {
            const defaultFoot = { 
                monofilament: { L: 'Normal', R: 'Normal' }, 
                pulse: { L: 'Present', R: 'Present' }, 
                deformity: false,
                callus: false, 
                ulcer: false, 
                historyUlcer: false, 
                riskLevel: 'Low Risk (ความเสี่ยงต่ำ)', 
                remark: '',
                amputation: { toe: false, foot: false, leg: false },
                skin: { color: 'Normal', pain: false, temp: 'Normal', fungal: false },
                deformityType: { claw: false, bunions: false, charcot: false }, 
                footwear: 'Sandal'
            };

            const [form, setForm] = useState({
                ...defaultFoot,
                ...patient.footExam,
                amputation: patient.footExam?.amputation || defaultFoot.amputation,
                skin: patient.footExam?.skin || defaultFoot.skin,
                deformityType: patient.footExam?.deformityType || defaultFoot.deformityType,
                callus: patient.footExam?.callus || patient.footExam?.deformityType?.callus || false
            });
            
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                let risk = 'Low Risk (ความเสี่ยงต่ำ)';
                const hasActiveUlcer = form.ulcer;
                const hasHistory = form.historyUlcer || form.amputation.toe || form.amputation.foot || form.amputation.leg;
                const hasLOPS = form.monofilament.L === 'Abnormal' || form.monofilament.R === 'Abnormal';
                const hasPAD = ['Absent', 'Weak'].includes(form.pulse.L) || ['Absent', 'Weak'].includes(form.pulse.R);
                const hasDeformity = form.deformity || form.callus;

                if (hasActiveUlcer) risk = 'Active Ulcer (มีแผลขณะนี้)';
                else if (hasHistory) risk = 'Very High Risk (ความเสี่ยงสูงมาก)';
                else {
                    let factors = 0;
                    if (hasLOPS) factors++;
                    if (hasPAD) factors++;
                    if (hasDeformity) factors++;

                    if (factors >= 2) risk = 'High Risk (ความเสี่ยงสูง)';
                    else if (factors === 1) risk = 'Moderate Risk (ปานกลาง)';
                    else risk = 'Low Risk (ความเสี่ยงต่ำ)';
                }
                
                setForm(f => ({ ...f, riskLevel: risk }));
            }, [form.monofilament, form.pulse, form.deformity, form.callus, form.ulcer, form.historyUlcer, form.amputation]);

            const save = async () => {
                setSaving(true);
                try {
                    await getCollection('patients_referrals').doc(patient.id).update({ footExam: { ...form, checkedAt: new Date() } });
                    setModal({ visible: true, title: "สำเร็จ", message: "บันทึกการตรวจเท้าเรียบร้อย", onConfirm: () => { setModal({ visible: false }); onBack(); } });
                } catch(e) { setModal({ visible: true, message: e.message }); }
                setSaving(false);
            };

            return (
                <div className="max-w-3xl mx-auto pb-20 animate-fade-in">
                    <button onClick={onBack} className="mb-4 text-gray-500 flex items-center gap-1 hover:text-gray-800"><Icon name="arrow-left" size={16}/> กลับทะเบียน</button>
                    <div className="bg-white rounded-xl shadow-lg border border-pink-100 overflow-hidden">
                        <div className="bg-pink-600 p-6 text-white flex flex-col md:flex-row items-center justify-between gap-4 shadow-md">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/20 p-2 rounded-full"><Icon name="activity" size={32} className="text-white"/></div>
                                <h2 className="font-bold text-2xl">แบบประเมินเท้าเบาหวาน</h2>
                            </div>
                            <div className="text-center md:text-right">
                                <div className="text-3xl font-bold mb-1 tracking-wide">{patient.part1.name}</div>
                                <div className="text-xl font-medium opacity-90 flex flex-col md:flex-row gap-2 md:gap-4 justify-center md:justify-end">
                                    <span className="bg-pink-700/50 px-3 py-1 rounded-lg">อายุ <b>{patient.part1.age}</b> ปี</span>
                                    <span className="bg-pink-700/50 px-3 py-1 rounded-lg">เป็นเบาหวาน <b>{patient.part1.dmYears}</b> ปี</span>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 className="font-bold text-gray-800 mb-3 text-sm flex items-center gap-2"><Icon name="scissors" size={16}/> ประวัติการตัดนิ้ว/ขา/เท้า (History of Amputation)</h3>
                                <div className="flex gap-4 flex-wrap">{[{k:'toe',l:'นิ้วเท้า'}, {k:'foot',l:'เท้า'}, {k:'leg',l:'ขา'}].map(i => (<label key={i.k} className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={form.amputation[i.k]} onChange={e=>setForm({...form, amputation:{...form.amputation, [i.k]:e.target.checked}})} className="chk-lg text-red-600 rounded"/> <span>{i.l}</span></label>))}</div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-pink-50 p-4 rounded-xl border border-pink-100">
                                    <h3 className="font-bold text-pink-800 mb-3 text-sm">การรับความรู้สึก (Monofilament 10g)</h3>
                                    <div className="grid grid-cols-2 gap-4">{['L:เท้าซ้าย', 'R:เท้าขวา'].map(side => { const [s, l] = side.split(':'); return (<div key={s} className="bg-white p-3 rounded border text-center"><div className="font-bold text-gray-500 mb-2">{l}</div><div className="flex justify-center gap-2"><button onClick={()=>setForm({...form, monofilament:{...form.monofilament, [s]:'Normal'}})} className={`px-3 py-1 rounded text-xs border ${form.monofilament[s]==='Normal'?'bg-green-500 text-white border-green-600':'bg-gray-50'}`}>ปกติ</button><button onClick={()=>setForm({...form, monofilament:{...form.monofilament, [s]:'Abnormal'}})} className={`px-3 py-1 rounded text-xs border ${form.monofilament[s]==='Abnormal'?'bg-red-500 text-white border-red-600':'bg-gray-50'}`}>ผิดปกติ</button></div></div>)})}</div>
                                </div>
                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <h3 className="font-bold text-blue-800 mb-3 text-sm">ชีพจรหลังเท้า (Dorsalis Pedis)</h3>
                                    <div className="grid grid-cols-2 gap-4">{['L:เท้าซ้าย', 'R:เท้าขวา'].map(side => { const [s, l] = side.split(':'); return (
                                        <div key={s} className="bg-white p-3 rounded border text-center">
                                            <div className="font-bold text-gray-500 mb-2">{l}</div>
                                            <div className="flex justify-center gap-1">
                                                <button onClick={()=>setForm({...form, pulse:{...form.pulse, [s]:'Normal'}})} className={`px-2 py-1 rounded text-xs border ${form.pulse[s]==='Normal' || form.pulse[s]==='Present'?'bg-green-500 text-white border-green-600':'bg-gray-50'}`}>ปกติ</button>
                                                <button onClick={()=>setForm({...form, pulse:{...form.pulse, [s]:'Weak'}})} className={`px-2 py-1 rounded text-xs border ${form.pulse[s]==='Weak'?'bg-yellow-500 text-white border-yellow-600':'bg-gray-50'}`}>เบา</button>
                                                <button onClick={()=>setForm({...form, pulse:{...form.pulse, [s]:'Absent'}})} className={`px-2 py-1 rounded text-xs border ${form.pulse[s]==='Absent'?'bg-red-500 text-white border-red-600':'bg-gray-50'}`}>คลำไม่ได้</button>
                                            </div>
                                        </div>
                                    )})}</div>
                                </div>
                            </div>
                            <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-100 space-y-4">
                                <h3 className="font-bold text-yellow-800 mb-1 text-sm flex items-center gap-2"><Icon name="search" size={16}/> ผิวหนังและเล็บ (Skin & Nails)</h3>
                                <div><label className="text-xs font-bold text-gray-600 block mb-2">ลักษณะสีผิว (Color)</label><div className="flex gap-3 flex-wrap">{['Normal:ปกติ', 'Red:แดง', 'Pale:ซีด', 'Dark:คล้ำ'].map(c => { const [val, label] = c.split(':'); return (<label key={val} className="flex items-center gap-1 cursor-pointer bg-white px-3 py-1 rounded border"><input type="radio" checked={form.skin.color === val} onChange={()=>setForm({...form, skin:{...form.skin, color:val}})} className="text-yellow-600"/> <span className="text-sm">{label}</span></label>); })}</div></div>
                                <div className="flex gap-6 flex-wrap border-t border-yellow-200 pt-3">
                                    <div><label className="text-xs font-bold text-gray-600 block mb-2">อุณหภูมิ (Temp)</label><div className="flex gap-3">{['Normal:ปกติ', 'Hot:ร้อน', 'Cold:เย็น'].map(t => { const [val, label] = t.split(':'); return (<label key={val} className="flex items-center gap-1 cursor-pointer"><input type="radio" checked={form.skin.temp === val} onChange={()=>setForm({...form, skin:{...form.skin, temp:val}})} className="text-yellow-600"/> <span className="text-sm">{label}</span></label>); })}</div></div>
                                    <div className="flex items-center gap-4"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={form.skin.pain} onChange={e=>setForm({...form, skin:{...form.skin, pain:e.target.checked}})} className="chk-lg text-red-500 rounded"/> <span className="text-sm font-bold text-red-700">มีอาการปวด</span></label><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={form.skin.fungal} onChange={e=>setForm({...form, skin:{...form.skin, fungal:e.target.checked}})} className="chk-lg text-yellow-600 rounded"/> <span className="text-sm">มีเชื้อรา (เล็บ/ผิว)</span></label></div>
                                </div>
                            </div>
                            <div className="space-y-4 border-t pt-4">
                                <div>
                                    <label className="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer bg-gray-50"><input type="checkbox" checked={form.deformity} onChange={e=>setForm({...form, deformity:e.target.checked})} className="chk-lg text-pink-600 rounded"/><span className="font-bold">รูปเท้าผิดปกติ (Deformity)</span></label>
                                    {form.deformity && (<div className="ml-8 grid grid-cols-2 gap-2 animate-fade-in bg-gray-100 p-3 rounded-lg mt-2">{[{k:'claw',l:'Claw Toe'}, {k:'bunions',l:'Bunions'}, {k:'charcot',l:"Charcot's Foot"}].map(d => (<label key={d.k} className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={form.deformityType[d.k]} onChange={e=>setForm({...form, deformityType:{...form.deformityType, [d.k]:e.target.checked}})} className="text-pink-600"/> <span className="text-sm">{d.l}</span></label>))}</div>)}
                                </div>
                                <label className="flex items-center gap-3 p-3 border rounded-lg hover:bg-orange-50 cursor-pointer bg-orange-50 border-orange-200"><input type="checkbox" checked={form.callus} onChange={e=>setForm({...form, callus:e.target.checked})} className="chk-lg text-orange-600 rounded"/><span className="font-bold text-orange-800">หนังด้านแข็ง (Callus)</span></label>
                                <label className="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"><input type="checkbox" checked={form.historyUlcer} onChange={e=>setForm({...form, historyUlcer:e.target.checked})} className="chk-lg text-pink-600 rounded"/><span>ประวัติเคยมีแผล (History of Ulcer)</span></label>
                                <label className="flex items-center gap-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer border-red-200 bg-red-50"><input type="checkbox" checked={form.ulcer} onChange={e=>setForm({...form, ulcer:e.target.checked})} className="chk-lg text-red-600 rounded"/><span className="text-red-700 font-bold">ขณะนี้มีแผล (Active Ulcer)</span></label>
                            </div>
                            <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                <h3 className="font-bold text-green-800 mb-2 text-sm">รองเท้าที่ใช้ในปัจจุบัน (Current Footwear)</h3>
                                <div className="flex gap-4 flex-wrap">{[{v:'Sandal', l:'รองเท้าแตะ/คีบ'}, {v:'Shoe', l:'รองเท้าหุ้มส้น/สวม'}, {v:'DiabetesShoe', l:'รองเท้าเบาหวาน'}].map(fw => (<label key={fw.v} className="flex items-center gap-2 cursor-pointer bg-white px-3 py-2 rounded border shadow-sm"><input type="radio" checked={form.footwear === fw.v} onChange={()=>setForm({...form, footwear:fw.v})} className="text-green-600 scale-125"/> <span className="text-sm">{fw.l}</span></label>))}</div>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h3 className="font-bold text-gray-800 mb-2 text-sm">การลงความเห็นอื่นๆ (Other Comments)</h3>
                                <textarea value={form.remark} onChange={e => setForm({ ...form, remark: e.target.value })} className="w-full p-3 border rounded-lg text-sm h-24 focus:ring-2 focus:ring-pink-500 outline-none" placeholder="ระบุความเห็นเพิ่มเติม..."></textarea>
                            </div>

                            <div className={`p-4 text-white rounded-xl text-center ${form.riskLevel.includes('Active') ? 'bg-red-800' : form.riskLevel.includes('Very') ? 'bg-red-600' : form.riskLevel.includes('High') ? 'bg-orange-500' : form.riskLevel.includes('Moderate') ? 'bg-yellow-500' : 'bg-green-500'}`}>
                                <div className="text-xs text-white/80 mb-1">ผลการประเมิน (คำนวณอัตโนมัติ)</div>
                                <div className="text-2xl font-bold">{form.riskLevel}</div>
                            </div>

                            <button onClick={save} disabled={saving} className="w-full bg-pink-600 text-white py-3 rounded-xl font-bold hover:bg-pink-700 shadow-lg">{saving ? 'กำลังบันทึก...' : 'บันทึกผลการประเมิน'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [agencyCode, setAgencyCode] = useState(null);
            const [agencyName, setAgencyName] = useState(null);
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [agenciesMap, setAgenciesMap] = useState({});
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [modal, setModal] = useState({ visible: false, title: '', message: '', onConfirm: null });
            
            const [currentDate, setCurrentDate] = useState(getTodayStr());

            // [ADDED] Quick Add State for passing search term
            const [quickAddId, setQuickAddId] = useState('');

            // [ADDED] ดึงข้อมูลผู้ป่วยแบบ Real-time จาก ID ที่เลือก เพื่อให้ได้ข้อมูลล่าสุดเสมอ (เช่น history ที่เพิ่ง import)
            const activePatient = useMemo(() => {
                if (!selectedPatient) return null;
                return patients.find(p => p.id === selectedPatient.id) || selectedPatient;
            }, [patients, selectedPatient]);

            useEffect(() => {
                return auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u && u.email) {
                        const code = u.email.split('@')[0];
                        setAgencyCode(code);
                        if (code === '20000') {
                            setRole('FOOT'); setAgencyName('คลินิกเท้าเบาหวาน'); setView('foot_dashboard');
                        } else if (code === '10700') { 
                            setRole('HOSPITAL'); setAgencyName('โรงพยาบาลศรีสะเกษ'); setView('dashboard');
                        } else { 
                            setRole('PCU'); setAgencyName(STATIC_PCU_DATA[code] || `PCU ${code}`); setView('dashboard');
                        }
                    } else { setRole(null); setAgencyCode(null); }
                });
            }, []); 

            useEffect(() => {
                if(!user || !role) return;
                const collection = getCollection('patients_referrals');
                const unsub = collection.onSnapshot(snap => {
                    const newPatients = snap.docs.map(d => { 
                        const data = d.data(); 
                        return { id: d.id, ...data, createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt) }; 
                    });
                    // [MODIFIED] เรียงลำดับจาก "เก่าไปใหม่" (ใครมาก่อนอยู่อันดับ 1, 2, 3...)
                    // ใช้ a - b แทน b - a
                    newPatients.sort((a, b) => (a.createdAt?.getTime() || 0) - (b.createdAt?.getTime() || 0));
                    setPatients(newPatients);
                });
                return () => unsub();
            }, [user, role, agencyCode]);

            useEffect(() => {
                if(!user) return;
                const collection = getCollection('agencies');
                const unsub = collection.onSnapshot(snap => {
                    const map = {}; snap.docs.forEach(d => map[d.id] = d.data().name); setAgenciesMap(map);
                    if (role === 'PCU' && agencyCode && map[agencyCode]) setAgencyName(map[agencyCode]);
                });
                return () => unsub();
            }, [user, role, agencyCode]);

            if(!role) return <AuthScreen />;

            if (role === 'FOOT') {
                return (
                    <div className="max-w-5xl mx-auto p-4">
                        <nav className="flex justify-between items-center mb-6 bg-white p-3 rounded-xl shadow-md sticky top-4 z-10">
                            <h1 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="footprints" size={20} className="text-pink-600"/> EyeDM Foot Clinic</h1>
                            <button onClick={()=>auth.signOut()} className="text-gray-500 hover:text-red-600"><Icon name="log-out" size={18}/></button>
                        </nav>
                        <QueueStatusBar patients={patients} role={role} agencyCode={agencyCode} selectedDate={currentDate} />
                        {/* ใช้ activePatient แทน selectedPatient */}
                        {view === 'foot_dashboard' && <FootDashboard patients={patients} agenciesMap={agenciesMap} onSelect={(p)=>{setSelectedPatient(p);setView('foot_form');}} selectedDate={currentDate} setSelectedDate={setCurrentDate} />}
                        {view === 'foot_form' && activePatient && <FootForm patient={activePatient} onBack={()=>{setSelectedPatient(null);setView('foot_dashboard');}} setModal={setModal} />}
                        <MessageModal modal={modal} setModal={setModal} />
                    </div>
                );
            }

            return (
                <div className="max-w-5xl mx-auto p-4">
                    <nav className="flex justify-between items-center mb-6 bg-white p-3 rounded-xl shadow-md sticky top-4 z-10">
                        <h1 className="font-bold text-gray-700 flex items-center gap-2"><Icon name="activity" size={20} className="text-blue-600"/> EyeDM Connect ({role})</h1>
                        <div className="flex gap-2">{role === 'HOSPITAL' && <button onClick={() => setView('admin_home')} className="text-gray-500 hover:text-blue-600"><Icon name="settings" size={18}/></button>}<button onClick={()=>auth.signOut()} className="text-gray-500 hover:text-red-600"><Icon name="log-out" size={18}/></button></div>
                    </nav>
                    <QueueStatusBar patients={patients} role={role} agencyCode={agencyCode} selectedDate={currentDate} />
                    {view === 'dashboard' && <Dashboard 
                        role={role} 
                        agencyCode={agencyCode} 
                        agencyName={agencyName} 
                        agenciesMap={agenciesMap} 
                        patients={patients} 
                        onNew={(searchTerm) => {
                            // [MODIFIED] รับค่า search term จาก dashboard เพื่อ pre-fill
                            if (typeof searchTerm === 'string' && /^\d{13}$/.test(searchTerm)) {
                                setQuickAddId(searchTerm);
                            } else {
                                setQuickAddId('');
                            }
                            setView('pcu_form');
                            setSelectedPatient(null);
                        }} 
                        onEdit={(p)=>{
                            setQuickAddId(''); // Clear quick add ID when editing
                            setSelectedPatient(p);
                            setView('pcu_form');
                        }} 
                        onSelect={(p)=>{setSelectedPatient(p);setView('hospital');}} 
                        setModal={setModal} 
                        selectedDate={currentDate} 
                        setSelectedDate={setCurrentDate} 
                    />}
                    
                    {/* ใช้ activePatient แทน selectedPatient เพื่อให้ข้อมูล history อัปเดตทันที */}
                    {/* [MODIFIED] Pass quickAddId as initialId */}
                    {view === 'pcu_form' && activePatient && <PCUForm onBack={()=>{setSelectedPatient(null);setView('dashboard');}} existingPatients={patients} setModal={setModal} patientToEdit={activePatient} agencyCode={agencyCode} />}
                    {view === 'pcu_form' && !activePatient && <PCUForm onBack={()=>{setSelectedPatient(null);setView('dashboard');}} existingPatients={patients} setModal={setModal} patientToEdit={null} agencyCode={agencyCode} initialId={quickAddId} />}
                    
                    {view === 'hospital' && activePatient && <HospitalForm patient={activePatient} patients={patients} role={role} onBack={()=>{setSelectedPatient(null);setView('dashboard');}} setModal={setModal} />}
                    
                    {/* [MODIFIED] ส่ง setModal ไปให้ AdminHome ใช้งาน */}
                    {role === 'HOSPITAL' && view === 'admin_home' && <AdminHome onNavigate={setView} setModal={setModal} />}
                    
                    {role === 'HOSPITAL' && view === 'manage_agencies' && <ManageAgencies onBack={setView} agenciesMap={agenciesMap} />}
                    {role === 'HOSPITAL' && view === 'import_csv' && <HospitalImport onBack={setView} setModal={setModal} />}
                    {role === 'HOSPITAL' && view === 'reports' && <ReportsPage onBack={() => setView('admin_home')} patients={patients} agenciesMap={agenciesMap} />}
                    <MessageModal modal={modal} setModal={setModal} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
