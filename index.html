<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - ระบบส่งต่อผู้ป่วย (v18.06 Restored)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };
        
        try { if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ใช้ ID เดิมของช่วงเวลานั้น
        const APP_ID = "sisaket_prod_v7_master"; 
        const COL_QUEUE = "dr_queue";   
        const ADMIN_CODE = "10700";

        const Icon = React.memo(({name, size=18, className}) => {
            React.useEffect(()=>{if(window.lucide)window.lucide.createIcons()},[name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        });

        // --- AUTH SCREEN ---
        const AuthScreen = () => {
            const [pin, setPin] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            
            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true);
                const email = pin + "@sisaket-clinic.org";
                try { await auth.signInWithEmailAndPassword(email, password); } 
                catch (err) { 
                    if(err.code==='auth/user-not-found') {
                        try{await auth.createUserWithEmailAndPassword(email, password);}catch(e2){alert(e2.message);}
                    } else alert("รหัสไม่ถูกต้อง");
                } finally { setLoading(false); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-md shadow-lg text-center">
                        <div className="mx-auto w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 mb-4"><Icon name="database" size={32}/></div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-6">EyeDM System (18.06)</h1>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input className="w-full p-3 border rounded-lg text-center tracking-widest" placeholder="รหัสเจ้าหน้าที่" value={pin} onChange={e=>setPin(e.target.value)} required autoFocus/>
                            <input className="w-full p-3 border rounded-lg text-center" type="password" placeholder="รหัสผ่าน" value={password} onChange={e=>setPassword(e.target.value)} required/>
                            <button disabled={loading} className="w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 disabled:opacity-50">{loading?'Loading...':'เข้าสู่ระบบ'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('PCU');
            const [view, setView] = React.useState('dashboard');
            const [queue, setQueue] = React.useState([]);
            const [editData, setEditData] = React.useState(null);

            React.useEffect(() => auth.onAuthStateChanged(setUser), []);
            
            React.useEffect(() => {
                if (!user) return;
                // Load Queue (No pagination in original 18.06, but adding limit 100 for safety)
                const unsubscribe = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE)
                    .orderBy('createdAt', 'desc').limit(100)
                    .onSnapshot(snapshot => {
                        setQueue(snapshot.docs.map(d => ({ id: d.id, ...d.data(), createdAt: d.data().createdAt?.toDate() || new Date() })));
                        setTimeout(() => window.lucide && window.lucide.createIcons(), 100);
                    });
                return () => unsubscribe();
            }, [user]);

            const handleDelete = async (id) => { if(confirm("ลบข้อมูล?")) await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).delete(); };
            
            const userPin = user?.email ? user.email.split('@')[0] : '';
            const isAdmin = userPin === ADMIN_CODE;

            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen flex flex-col font-sans bg-slate-50">
                    <nav className="bg-white shadow border-b px-4 py-3 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex gap-3 items-center">
                            <div className={`p-2 rounded-lg text-white shadow ${role==='PCU'?'bg-teal-600':'bg-blue-600'}`}><Icon name={role==='PCU'?'home':'hospital'}/></div>
                            <div><h1 className="font-bold text-lg text-gray-800">EyeDM <span className="text-gray-400 text-sm">| v18.06</span></h1><p className="text-xs text-gray-500">User: {userPin}</p></div>
                        </div>
                        <div className="flex gap-2 items-center">
                            {isAdmin && <button onClick={()=>setView('import')} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold gap-1 flex items-center"><Icon name="upload-cloud"/> Import</button>}
                            <div className="hidden md:flex bg-gray-100 p-1 rounded-lg"><button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`px-3 py-1.5 rounded-md text-sm ${role==='PCU'?'bg-white shadow font-bold text-teal-700':'text-gray-500'}`}>PCU</button><button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`px-3 py-1.5 rounded-md text-sm ${role==='HOSPITAL'?'bg-white shadow font-bold text-blue-700':'text-gray-500'}`}>Hospital</button></div>
                            <button onClick={()=>auth.signOut()} className="p-2 text-red-500 hover:bg-red-50 rounded-full"><Icon name="log-out"/></button>
                        </div>
                    </nav>
                    <main className="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
                        <div className="md:hidden flex bg-white p-1 rounded-lg shadow-sm mb-4 text-sm"><button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`flex-1 py-2 rounded-md ${role==='PCU'?'bg-teal-50 text-teal-700 font-bold':'text-gray-500'}`}>PCU</button><button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`flex-1 py-2 rounded-md ${role==='HOSPITAL'?'bg-blue-50 text-blue-700 font-bold':'text-gray-500'}`}>Hospital</button></div>

                        {view === 'dashboard' && <Dashboard role={role} queue={queue} onNew={()=>{setEditData(null);setView('pcu_form')}} onEdit={p=>{setEditData(p);setView('pcu_form')}} onDelete={handleDelete} />}
                        {view === 'pcu_form' && <PCUForm db={db} user={user} appId={APP_ID} initialData={editData} onBack={()=>setView('dashboard')} />}
                        {view === 'hospital_form' && <HospitalForm db={db} user={user} appId={APP_ID} patient={editData} onBack={()=>setView('dashboard')} />} 
                        {/* Note: In 18.06, Edit button usually routed to PCU form for both roles or specific forms based on logic. Here simplified to PCU form for edit based on request context, but Hospital can edit in Hospital Form if selected */}
                        {view === 'import' && isAdmin && <ImportView db={db} user={user} appId={APP_ID} onBack={()=>setView('dashboard')} />}
                    </main>
                </div>
            );
        }

        // --- DASHBOARD ---
        const Dashboard = ({ role, queue, onNew, onEdit, onDelete }) => {
            const [search, setSearch] = React.useState('');
            const filtered = queue.filter(p => (p.part1?.idCard||'').includes(search) || (p.part1?.name||'').includes(search));

            return (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex justify-between items-end gap-4">
                        <div className="relative flex-1 w-full max-w-md"><Icon name="search" className="absolute left-3 top-3 text-gray-400"/><input className="w-full pl-10 pr-4 py-2.5 rounded-xl border shadow-sm outline-none focus:ring-2 focus:ring-teal-500" placeholder="ค้นหา..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
                        {role === 'PCU' && <button onClick={onNew} className="bg-teal-600 text-white px-6 py-2.5 rounded-xl shadow font-bold flex items-center gap-2 hover:bg-teal-700 transition"><Icon name="user-plus"/> ลงทะเบียนใหม่</button>}
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-600 border-b"><tr><th className="p-4">วันที่</th><th className="p-4">ผู้ป่วย</th><th className="p-4">HbA1C</th><th className="p-4">สถานะ</th><th className="p-4 text-right">เครื่องมือ</th></tr></thead>
                                <tbody className="divide-y">
                                    {filtered.map(p => (
                                        <tr key={p.id} className="hover:bg-gray-50 transition">
                                            <td className="p-4 text-gray-500">{p.createdAt.toLocaleDateString('th-TH')}</td>
                                            <td className="p-4"><div className="font-bold text-teal-700 font-mono">{p.part1.idCard}</div><div className="text-gray-700">{p.part1.name}</div></td>
                                            <td className="p-4">{p.part1.hba1c || '-'}</td>
                                            <td className="p-4">
                                                {p.status === 'Waiting' ? <span className="px-2 py-1 rounded bg-yellow-100 text-yellow-800 border border-yellow-200 text-xs">รอตรวจ</span> : <span className="px-2 py-1 rounded bg-green-100 text-green-800 border border-green-200 text-xs">ตรวจแล้ว</span>}
                                            </td>
                                            <td className="p-4 text-right flex justify-end gap-2">
                                                <button onClick={()=>onEdit(p)} className="p-2 border rounded-lg hover:bg-blue-50 text-blue-600"><Icon name="pencil"/></button>
                                                <button onClick={()=>onDelete(p.id)} className="p-2 border rounded-lg hover:bg-red-50 text-red-600"><Icon name="trash-2"/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {filtered.length===0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">ไม่พบข้อมูล</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PCU FORM (Save Directly to Waiting) ---
        const PCUForm = ({ db, user, appId, initialData, onBack }) => {
            const [form, setForm] = React.useState({ idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [suggestions, setSuggestions] = React.useState([]);
            const [saving, setSaving] = React.useState(false);
            const isEdit = !!initialData;

            React.useEffect(()=>{if(initialData)setForm(initialData.part1)},[initialData]);

            const handleId = async (e) => {
                const v = e.target.value; setForm({...form, idCard:v});
                if(v.length>=3 && !isEdit) {
                    try {
                        // Search in Queue (Old Logic)
                        const s = await db.collection('artifacts').doc(appId).collection(COL_QUEUE).where('part1.idCard','>=',v).where('part1.idCard','<=',v+'\uf8ff').limit(5).get();
                        // Filter duplicates by name
                        const unique = []; const map = new Map();
                        s.docs.forEach(d=>{ if(!map.has(d.data().part1.name)){ map.set(d.data().part1.name, true); unique.push(d.data().part1); }});
                        setSuggestions(unique);
                    } catch(e) {}
                } else setSuggestions([]);
            };

            const save = async () => {
                if(!form.idCard) return alert("ระบุเลขบัตร");
                setSaving(true);
                
                // Check Dup Today
                if (!isEdit) {
                    const today = new Date().toDateString();
                    const q = await db.collection('artifacts').doc(appId).collection(COL_QUEUE).where('part1.idCard','==',form.idCard).get();
                    if(q.docs.some(d=>(d.data().createdAt?.toDate?d.data().createdAt.toDate():new Date(d.data().createdAt)).toDateString()===today)) {
                        alert("ข้อมูลซ้ำวันนี้"); setSaving(false); return;
                    }
                }

                const payload = { part1: form, pcuId: user.uid, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                if(isEdit) {
                    await db.collection('artifacts').doc(appId).collection(COL_QUEUE).doc(initialData.id).update(payload);
                } else {
                    payload.status = 'Waiting'; // Direct to Waiting (18.06 logic)
                    payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('artifacts').doc(appId).collection(COL_QUEUE).add(payload);
                }
                onBack(); setSaving(false);
            };

            return (
                <div className="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow border border-teal-100 animate-in zoom-in">
                    <div className="flex justify-between mb-6"><h2 className="font-bold text-xl text-teal-800">{isEdit?'แก้ไข':'ลงทะเบียนใหม่'}</h2><button onClick={onBack}><Icon name="x"/></button></div>
                    <div className="space-y-5">
                        <div className="relative">
                            <label className="text-xs font-bold text-gray-500">เลขบัตรประชาชน</label>
                            <input value={form.idCard} onChange={handleId} className="w-full p-3 border rounded-lg text-lg font-mono" placeholder="13 หลัก" maxLength="13"/>
                            {suggestions.length>0 && <div className="absolute z-10 w-full bg-white border shadow-xl rounded-b-lg mt-1">{suggestions.map((s,i)=><div key={i} onClick={()=>{setForm({...s,idCard:s.idCard});setSuggestions([])}} className="p-2 hover:bg-gray-100 cursor-pointer text-sm">{s.idCard} - {s.name}</div>)}</div>}
                        </div>
                        <div className="grid grid-cols-2 gap-4"><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="p-2 border rounded" placeholder="ชื่อ-สกุล"/><input value={form.hba1c} onChange={e=>setForm({...form,hba1c:e.target.value})} className="p-2 border rounded" placeholder="HbA1C"/></div>
                        <div className="grid grid-cols-3 gap-4"><input value={form.bp} onChange={e=>setForm({...form,bp:e.target.value})} className="p-2 border rounded" placeholder="BP"/><input value={form.weight} onChange={e=>setForm({...form,weight:e.target.value})} className="p-2 border rounded" placeholder="Wt"/><input value={form.height} onChange={e=>setForm({...form,height:e.target.value})} className="p-2 border rounded" placeholder="Ht"/></div>
                        <div className="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded border"><input value={form.vaLeft} onChange={e=>setForm({...form,vaLeft:e.target.value})} className="p-2 border rounded bg-white" placeholder="VA L"/><input value={form.vaRight} onChange={e=>setForm({...form,vaRight:e.target.value})} className="p-2 border rounded bg-white" placeholder="VA R"/></div>
                        <div className="flex gap-3 mt-6"><button onClick={onBack} className="flex-1 border py-3 rounded">ยกเลิก</button><button onClick={save} disabled={saving} className="flex-1 bg-teal-600 text-white py-3 rounded font-bold shadow">{saving?'Saving...':'บันทึกและส่งตัว'}</button></div>
                    </div>
                </div>
            );
        };

        // --- IMPORT VIEW ---
        const ImportView = ({ db, user, appId, onBack }) => {
            const [csvData, setCsvData] = React.useState([]);
            const [encoding, setEncoding] = React.useState('TIS-620');
            const [importing, setImporting] = React.useState(false);
            const handleFile = (e) => { Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, encoding: encoding, complete: (res) => setCsvData(res.data) }); };
            const startImport = async () => {
                if(!csvData.length) return;
                setImporting(true); let count=0;
                for(let row of csvData) {
                    const id = (row['เลข 13 หลัก']||row['pid']||'').toString().replace(/\D/g,'');
                    if(id.length===13) {
                        try {
                            await db.collection('artifacts').doc(appId).collection(COL_QUEUE).add({
                                part1: { idCard: id, name: row['ชื่อสกุล']||row['fullname']||'-', hba1c: row['HbA1C']||'-', bp: row['BP']||'-', source:'Import' },
                                status: 'Waiting', // Direct to Waiting
                                pcuId: 'AdminImport',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                        } catch(e) {}
                    }
                }
                setImporting(false); alert(`Imported ${count}`);
            };
            return (
                <div className="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow"><h2 className="font-bold text-xl mb-4">Import Excel</h2><div className="mb-4"><select value={encoding} onChange={e=>setEncoding(e.target.value)} className="border p-2 mr-2"><option value="TIS-620">TIS-620</option><option value="UTF-8">UTF-8</option></select><input type="file" accept=".csv" onChange={handleFile}/></div>{csvData.length>0 && <button onClick={startImport} disabled={importing} className="bg-green-600 text-white px-6 py-2 rounded font-bold shadow">{importing?'...':'Confirm Import'}</button>}<button onClick={onBack} className="mt-4 text-gray-500 underline">Back</button></div>
            );
        };

        // --- HOSPITAL FORM ---
        const HospitalForm = ({ db, user, appId, patient, onBack }) => {
            const [p2, setP2] = React.useState(patient?.part2 || { cataract:'No', retinaFound:'Yes' });
            const [findings, setFindings] = React.useState(patient?.findings || { Normal:{L:false,R:false} });
            const [saving, setSaving] = React.useState(false);
            const toggle = (k,s) => setFindings(f=>({...f,[k]:{...f[k],[s]:!f[k][s]}}));
            const save = async () => {
                setSaving(true);
                await db.collection('artifacts').doc(appId).collection(COL_QUEUE).doc(patient.id).update({part2: p2, findings, status: 'Completed', doctorName: user.email});
                onBack(); setSaving(false);
            };
            return (
                <div className="flex gap-6"><div className="w-1/3 bg-white p-6 rounded shadow"><h3 className="font-bold mb-4">ข้อมูลผู้ป่วย</h3><p>ID: {patient?.part1?.idCard}</p><p>Name: {patient?.part1?.name}</p><button onClick={onBack} className="mt-4">Back</button></div><div className="w-2/3 bg-white p-6 rounded shadow"><h3 className="font-bold mb-4">ผลตรวจ</h3><div className="flex gap-4 mb-6"><button onClick={()=>setP2({...p2,retinaFound:'Yes'})} className={`px-4 py-1 border ${p2.retinaFound==='Yes'?'bg-blue-600 text-white':''}`}>เจอจอฯ</button><button onClick={()=>setP2({...p2,retinaFound:'No'})} className={`px-4 py-1 border ${p2.retinaFound==='No'?'bg-blue-600 text-white':''}`}>ไม่เจอ</button></div><table className="w-full text-sm border rounded mb-4"><thead className="bg-gray-100"><tr><th className="p-2">Condition</th><th className="p-2 w-10">L</th><th className="p-2 w-10">R</th></tr></thead><tbody>{['Normal','MicroAneurysm','HardExudate'].map(k=>(<tr key={k} className="border-t"><td className="p-2">{k}</td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.L} onChange={()=>toggle(k,'L')}/></td><td className="text-center border-l"><input type="checkbox" checked={findings[k]?.R} onChange={()=>toggle(k,'R')}/></td></tr>))}</tbody></table><button onClick={save} className="bg-blue-600 text-white px-6 py-2 rounded font-bold">{saving?'...':'บันทึกผล'}</button></div></div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
