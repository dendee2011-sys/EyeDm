<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - ระบบตรวจจอประสาทตา (Modern UI)</title>
    
    <!-- 1. Load CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Animate.css for smooth transitions -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- 2. React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- 3. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 4. Utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .hover-card { transition: all 0.2s ease-in-out; }
        .hover-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG (Same as v18.55 Stable) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAARBcx9RDy-cQUeRZwjXQxvLhPGbZ5MNo",
            authDomain: "eyedm-3ebc8-7c029.firebaseapp.com",
            projectId: "eyedm-3ebc8-7c029",
            storageBucket: "eyedm-3ebc8-7c029.firebasestorage.app",
            messagingSenderId: "327117771686",
            appId: "1:327117771686:web:e66c7683e4613d5b8db567",
            measurementId: "G-N48NPP7K9J"
        };
        
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) {}
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "sisaket_prod_v1855_stable"; 
        const COL_QUEUE = "dr_queue";   
        const COL_MASTER = "dr_master"; 
        const ADMIN_CODE = "10700";

        const Icon = ({ name, size = 20, className = "" }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- MODERN AUTH SCREEN ---
        const AuthScreen = () => {
            const [pin, setPin] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true);
                const email = pin + "@sisaket-clinic.org";
                try { await auth.signInWithEmailAndPassword(email, password); } 
                catch (err) { 
                    if(err.code==='auth/user-not-found') {
                        try { await auth.createUserWithEmailAndPassword(email, password); }
                        catch(e2) { alert("ลงทะเบียนไม่สำเร็จ: " + e2.message); }
                    } else alert("เข้าสู่ระบบไม่สำเร็จ: " + err.message);
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&q=80&w=2070')] bg-cover bg-center relative">
                    <div className="absolute inset-0 bg-brand-900/80 backdrop-blur-sm"></div>
                    <div className="relative bg-white/95 p-8 rounded-2xl w-full max-w-md text-center shadow-2xl border border-white/20 animate__animated animate__fadeInUp">
                        <div className="mx-auto w-20 h-20 bg-brand-50 rounded-full flex items-center justify-center text-brand-600 mb-6 shadow-inner border-4 border-white">
                            <Icon name="eye" size={40}/>
                        </div>
                        <h1 className="text-3xl font-bold text-slate-800 mb-2">EyeDM System</h1>
                        <p className="text-slate-500 mb-8 font-medium">ระบบคัดกรองเบาหวานเข้าจอประสาทตา</p>
                        
                        <form onSubmit={handleAuth} className="space-y-5 text-left">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">รหัสเจ้าหน้าที่ (5 หลัก)</label>
                                <div className="relative group">
                                    <Icon name="user" className="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-brand-500 transition-colors"/>
                                    <input 
                                        className="w-full p-3 pl-12 bg-slate-50 border border-slate-200 rounded-xl text-lg font-mono tracking-widest focus:ring-2 focus:ring-brand-500 focus:border-transparent focus:bg-white outline-none transition-all" 
                                        placeholder="xxxxx" 
                                        value={pin} 
                                        onChange={e=>setPin(e.target.value.replace(/[^0-9]/g,'').slice(0,5))} 
                                        required autoFocus 
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">รหัสผ่าน</label>
                                <div className="relative group">
                                    <Icon name="lock" className="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-brand-500 transition-colors"/>
                                    <input 
                                        className="w-full p-3 pl-12 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent focus:bg-white outline-none transition-all" 
                                        type="password" 
                                        placeholder="••••••••" 
                                        value={password} 
                                        onChange={e=>setPassword(e.target.value)} 
                                        required 
                                    />
                                </div>
                            </div>
                            <button disabled={loading} className="w-full bg-gradient-to-r from-brand-600 to-brand-500 text-white py-3.5 rounded-xl font-bold hover:shadow-lg hover:shadow-brand-500/30 active:scale-[0.98] transition-all disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center gap-2 mt-2">
                                {loading ? <div className="loader border-white/30 border-t-white"></div> : <>เข้าสู่ระบบ <Icon name="arrow-right" size={18}/></>}
                            </button>
                        </form>
                        <p className="text-xs text-slate-400 mt-6">สำหรับเจ้าหน้าที่ รพ.สต. และ โรงพยาบาลศรีสะเกษ</p>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState('PCU');
            const [view, setView] = React.useState('dashboard');
            const [queue, setQueue] = React.useState([]);
            const [editingPatient, setEditingPatient] = React.useState(null);
            const [limitCount, setLimitCount] = React.useState(50);

            React.useEffect(() => auth.onAuthStateChanged(setUser), []);
            
            React.useEffect(() => {
                if (!user) return;
                const unsubscribe = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE)
                    .orderBy('createdAt', 'desc')
                    .limit(limitCount)
                    .onSnapshot(snapshot => {
                        setQueue(snapshot.docs.map(d => ({ id: d.id, ...d.data(), createdAt: d.data().createdAt?.toDate() || new Date() })));
                        setTimeout(() => window.lucide && window.lucide.createIcons(), 100);
                    }, err => console.error("Queue Error:", err));
                return () => unsubscribe();
            }, [user, limitCount]);

            const handleSend = async (id, name) => {
                if(confirm(`ยืนยันส่งตัวผู้ป่วย: ${name}?`)) {
                    try { await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).update({ status: 'Waiting', sentAt: firebase.firestore.FieldValue.serverTimestamp() }); } 
                    catch(e) { alert("Error: " + e.message); }
                }
            };
            const handleDelete = async (id) => { 
                if(confirm("ลบรายการนี้ออกจากคิว?")) {
                    await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(id).delete(); 
                }
            };
            
            const userPin = user?.email ? user.email.split('@')[0] : '';
            const isAdmin = userPin === ADMIN_CODE;

            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen flex flex-col font-sans bg-slate-50 text-slate-800">
                    {/* Navbar */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-40 backdrop-blur-md bg-white/80">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16 items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-xl text-white shadow-lg shadow-brand-500/20 ${role==='PCU'?'bg-emerald-500':'bg-brand-600'}`}>
                                        <Icon name={role==='PCU'?'home':'hospital'} size={24}/>
                                    </div>
                                    <div>
                                        <h1 className="font-bold text-xl text-slate-800 leading-none">EyeDM <span className="text-slate-400 font-normal text-sm">| Connect</span></h1>
                                        <div className="flex items-center gap-1.5 mt-1">
                                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                            <p className="text-xs text-slate-500 font-medium">Online • {userPin}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {isAdmin && <button onClick={()=>setView('import')} className="hidden md:flex px-4 py-2 bg-brand-50 text-brand-700 rounded-lg text-sm font-bold hover:bg-brand-100 transition items-center gap-2"><Icon name="upload-cloud" size={18}/> Import</button>}
                                    
                                    <div className="hidden md:flex bg-slate-100 p-1 rounded-lg">
                                        <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${role==='PCU'?'bg-white shadow text-emerald-600':'text-slate-500 hover:text-slate-700'}`}>PCU</button>
                                        <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${role==='HOSPITAL'?'bg-white shadow text-brand-600':'text-slate-500 hover:text-slate-700'}`}>Hospital</button>
                                    </div>
                                    
                                    <button onClick={()=>auth.signOut()} className="p-2.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors" title="ออกจากระบบ"><Icon name="log-out"/></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full animate__animated animate__fadeIn">
                        {/* Mobile Role Switcher */}
                        <div className="md:hidden flex bg-white p-1 rounded-xl shadow-sm mb-6 text-sm border border-slate-100">
                            <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${role==='PCU'?'bg-emerald-50 text-emerald-600 shadow-sm':'text-slate-400'}`}>รพ.สต.</button>
                            <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`flex-1 py-2.5 rounded-lg font-bold transition-all ${role==='HOSPITAL'?'bg-brand-50 text-brand-600 shadow-sm':'text-slate-400'}`}>โรงพยาบาล</button>
                        </div>

                        {view === 'dashboard' && <Dashboard role={role} queue={queue} onNew={()=>{setEditingPatient(null);setView('pcu_form')}} onEdit={p=>{setEditingPatient(p);setView(role==='PCU'?'pcu_form':'hospital_form')}} onDelete={handleDelete} onSend={handleSend} onLoadMore={()=>setLimitCount(c=>c+50)} />}
                        {view === 'pcu_form' && <PCUForm db={db} user={user} appId={APP_ID} initialData={editingPatient} onBack={()=>setView('dashboard')} />}
                        {view === 'hospital_form' && editingPatient && <HospitalForm db={db} user={user} appId={APP_ID} patient={editingPatient} onBack={()=>{setView('dashboard');setEditingPatient(null)}} />}
                        {view === 'import' && isAdmin && <ImportView db={db} user={user} appId={APP_ID} onBack={()=>setView('dashboard')} />}
                    </main>
                </div>
            );
        }

        // --- DASHBOARD ---
        const Dashboard = ({ role, queue, onNew, onEdit, onDelete, onSend, onLoadMore }) => {
            const [search, setSearch] = React.useState('');
            const [tab, setTab] = React.useState('registry'); 
            
            const filtered = React.useMemo(() => {
                return queue.filter(p => {
                    const term = search.toLowerCase();
                    const match = (p.part1?.idCard||'').includes(term) || (p.part1?.name||'').includes(term);
                    if (!match) return false;
                    if (role === 'PCU') return tab === 'registry' ? p.status === 'Registered' : (p.status === 'Waiting' || p.status === 'Completed');
                    return p.status === 'Waiting' || p.status === 'Completed';
                });
            }, [queue, search, tab, role]);

            return (
                <div className="space-y-6">
                    {role === 'PCU' && (
                        <div className="flex space-x-2 border-b border-slate-200 mb-6">
                            <button onClick={()=>setTab('registry')} className={`pb-3 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${tab==='registry'?'border-emerald-500 text-emerald-600':'border-transparent text-slate-500 hover:text-slate-700'}`}>
                                <Icon name="folder-open" size={18}/> ทะเบียนผู้ป่วย <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs ml-1">{queue.filter(p=>p.status==='Registered').length}</span>
                            </button>
                            <button onClick={()=>setTab('sent')} className={`pb-3 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${tab==='sent'?'border-brand-500 text-brand-600':'border-transparent text-slate-500 hover:text-slate-700'}`}>
                                <Icon name="send" size={18}/> ส่งตรวจแล้ว <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs ml-1">{queue.filter(p=>p.status!=='Registered').length}</span>
                            </button>
                        </div>
                    )}

                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div className="relative flex-1 w-full md:max-w-md">
                            <Icon name="search" className="absolute left-4 top-3 text-slate-400" size={20}/>
                            <input className="w-full pl-12 pr-4 py-2.5 rounded-xl bg-slate-50 border-transparent focus:bg-white focus:border-brand-300 focus:ring-4 focus:ring-brand-500/10 transition-all outline-none font-medium" placeholder="ค้นหาด้วยเลขบัตรประชาชน หรือ ชื่อ..." value={search} onChange={e=>setSearch(e.target.value)}/>
                        </div>
                        {role === 'PCU' && tab === 'registry' && (
                            <button onClick={onNew} className="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-emerald-500/30 font-bold flex justify-center items-center gap-2 transition-all hover:scale-105 active:scale-95">
                                <Icon name="user-plus" size={20}/> ลงทะเบียนรายใหม่
                            </button>
                        )}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                                    <tr>
                                        <th className="p-4 pl-6 w-32">วันที่ลงทะเบียน</th>
                                        <th className="p-4">ข้อมูลผู้ป่วย</th>
                                        <th className="p-4">ผลเลือด (HbA1C)</th>
                                        <th className="p-4">สถานะปัจจุบัน</th>
                                        <th className="p-4 pr-6 text-right">ดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filtered.map(p => (
                                        <tr key={p.id} className="hover:bg-slate-50 transition-colors group">
                                            <td className="p-4 pl-6 text-slate-500">{p.createdAt.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}</td>
                                            <td className="p-4">
                                                <div className="font-bold text-slate-700 text-base">{p.part1.name}</div>
                                                <div className="text-slate-400 font-mono text-xs mt-0.5 flex items-center gap-1"><Icon name="credit-card" size={12}/> {p.part1.idCard}</div>
                                            </td>
                                            <td className="p-4">
                                                {p.part1.hba1c ? <span className="font-mono font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded-lg">{p.part1.hba1c}</span> : <span className="text-slate-300">-</span>}
                                            </td>
                                            <td className="p-4">
                                                {p.status === 'Registered' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200"><span className="w-2 h-2 rounded-full bg-slate-400"></span> ลงทะเบียนแล้ว</span>}
                                                {p.status === 'Waiting' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-amber-50 text-amber-700 border border-amber-200"><span className="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> รอตรวจตา</span>}
                                                {p.status === 'Completed' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-200"><span className="w-2 h-2 rounded-full bg-emerald-500"></span> ตรวจเสร็จสิ้น</span>}
                                            </td>
                                            <td className="p-4 pr-6 text-right">
                                                <div className="flex justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    {role === 'PCU' && p.status === 'Registered' && (
                                                        <button onClick={()=>onSend(p.id, p.part1.name)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-md shadow-emerald-500/20 text-xs font-bold flex items-center gap-2 transition-all hover:-translate-y-0.5">
                                                            <Icon name="send" size={14}/> ส่งตรวจ
                                                        </button>
                                                    )}
                                                    <button onClick={()=>onEdit(p)} className={`p-2 border border-slate-200 rounded-lg transition-colors ${role==='HOSPITAL'&&p.status==='Waiting'?'bg-brand-600 text-white border-brand-600 hover:bg-brand-700 shadow-md':'bg-white text-slate-600 hover:bg-slate-50'}`} title="แก้ไข/ตรวจ">
                                                        <Icon name={role==='HOSPITAL'&&p.status==='Waiting'?'stethoscope':'pencil'} size={16}/>
                                                    </button>
                                                    <button onClick={()=>onDelete(p.id)} className="p-2 border border-red-100 text-red-500 rounded-lg hover:bg-red-50 hover:border-red-200 transition-colors" title="ลบ">
                                                        <Icon name="trash-2" size={16}/>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                    {filtered.length===0 && (
                                        <tr>
                                            <td colSpan="5" className="p-12 text-center">
                                                <div className="bg-slate-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300"><Icon name="inbox" size={48}/></div>
                                                <p className="text-slate-500 font-medium">ไม่พบข้อมูลผู้ป่วย</p>
                                                {role==='PCU' && tab==='registry' && <p className="text-slate-400 text-sm mt-1">กดปุ่ม "ลงทะเบียนรายใหม่" เพื่อเริ่มใช้งาน</p>}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                        <div className="p-3 text-center border-t border-slate-100 bg-slate-50/50">
                            <button onClick={onLoadMore} className="text-brand-600 text-xs font-bold hover:underline flex items-center justify-center gap-1 mx-auto">
                                <Icon name="arrow-down-circle" size={14}/> โหลดข้อมูลเก่าเพิ่มเติม...
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PCU FORM (Live Search & Master DB) ---
        const PCUForm = ({ db, user, appId, initialData, onBack }) => {
            const [form, setForm] = React.useState({ idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [suggestions, setSuggestions] = React.useState([]);
            const [loadingMaster, setLoadingMaster] = React.useState(false);
            const [saving, setSaving] = React.useState(false);
            const isEdit = !!initialData;

            React.useEffect(()=>{if(initialData)setForm(initialData.part1)},[initialData]);

            const handleIdChange = async (e) => {
                const val = e.target.value; setForm({...form, idCard: val});
                if(val.length >= 3 && !isEdit) {
                    try {
                        const q = db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).where(firebase.firestore.FieldPath.documentId(), '>=', val).where(firebase.firestore.FieldPath.documentId(), '<=', val + '\uf8ff').limit(5);
                        const snap = await q.get();
                        setSuggestions(snap.docs.map(d => ({ idCard: d.id, ...d.data() })));
                    } catch(e) { console.log(e); }
                } else setSuggestions([]);
            };

            const selectSuggestion = (data) => { setForm(prev => ({...prev, ...data, idCard: data.idCard})); setSuggestions([]); };

            const save = async () => {
                if(!form.idCard || form.idCard.length!==13) return alert("เลขบัตรต้องมี 13 หลัก");
                setSaving(true);
                try {
                    // 1. Save Master
                    await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(form.idCard).set(form, { merge: true });
                    // 2. Check Dup Today
                    if (!isEdit) {
                        const today = new Date().toDateString();
                        const qRef = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE);
                        const snap = await qRef.where('part1.idCard', '==', form.idCard).get();
                        if (snap.docs.some(d => (d.data().createdAt?.toDate ? d.data().createdAt.toDate() : new Date(d.data().createdAt)).toDateString() === today)) throw new Error("ผู้ป่วยรายนี้มีคิวในวันนี้แล้ว");
                    }
                    // 3. Save Queue
                    const qRef = db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE);
                    const pl = { part1: form, pcuId: user.uid, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                    if(isEdit) await qRef.doc(initialData.id).update(pl);
                    else { pl.status = 'Registered'; pl.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await qRef.add(pl); }
                    onBack();
                } catch(e) { alert(e.message); } finally { setSaving(false); }
            };

            return (
                <div className="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100 animate__animated animate__zoomIn">
                    <div className="flex justify-between items-center mb-8 border-b border-slate-100 pb-4">
                        <div>
                            <h2 className="font-bold text-2xl text-slate-800 flex items-center gap-3">
                                <div className={`p-2 rounded-lg ${isEdit?'bg-amber-100 text-amber-600':'bg-emerald-100 text-emerald-600'}`}><Icon name={isEdit?'pencil':'user-plus'} size={24}/></div>
                                {isEdit?'แก้ไขข้อมูลผู้ป่วย':'ลงทะเบียนรายใหม่'}
                            </h2>
                            <p className="text-slate-400 text-sm mt-1 ml-14">กรอกข้อมูลเพื่อบันทึกลงทะเบียนประวัติ</p>
                        </div>
                        <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition"><Icon name="x" size={24}/></button>
                    </div>
                    
                    <div className="space-y-6">
                        <div className="relative bg-brand-50/50 p-6 rounded-xl border border-brand-100">
                            <label className="text-xs font-bold text-brand-700 uppercase tracking-wider mb-2 block">เลขบัตรประชาชน (13 หลัก)</label>
                            <div className="relative">
                                <Icon name="credit-card" className="absolute left-4 top-3.5 text-brand-400"/>
                                <input value={form.idCard} onChange={handleIdChange} className="w-full pl-12 p-3 border border-brand-200 rounded-xl text-lg font-mono tracking-widest focus:ring-4 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition bg-white" placeholder="x-xxxx-xxxxx-xx-x" maxLength="13" disabled={isEdit} autoComplete="off"/>
                                {suggestions.length > 0 && (
                                    <div className="absolute top-full left-0 right-0 bg-white border shadow-2xl rounded-xl mt-2 z-50 overflow-hidden animate__animated animate__fadeInDown small">
                                        <div className="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-500 border-b">ประวัติเก่าที่พบ</div>
                                        {suggestions.map((s,i)=>(
                                            <div key={i} onClick={() => selectSuggestion(s)} className="p-4 border-b last:border-0 hover:bg-brand-50 cursor-pointer flex justify-between items-center group">
                                                <div><span className="font-bold text-slate-700 font-mono group-hover:text-brand-700">{s.idCard}</span><span className="text-slate-500 ml-3">{s.name}</span></div>
                                                <Icon name="chevron-right" size={16} className="text-slate-300 group-hover:text-brand-500"/>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            {!isEdit && <p className="text-xs text-brand-600 mt-2 flex items-center gap-1"><Icon name="info" size={12}/> พิมพ์ 3 ตัวแรกเพื่อค้นหาประวัติเก่า</p>}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Input label="ชื่อ-นามสกุล" val={form.name} set={v=>setForm({...form,name:v})} icon="user"/>
                            <Input label="ระดับน้ำตาลสะสม (HbA1C)" val={form.hba1c} set={v=>setForm({...form,hba1c:v})} icon="activity"/>
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            <Input label="ความดัน (BP)" val={form.bp} set={v=>setForm({...form,bp:v})}/>
                            <Input label="น้ำหนัก (kg)" val={form.weight} set={v=>setForm({...form,weight:v})}/>
                            <Input label="ส่วนสูง (cm)" val={form.height} set={v=>setForm({...form,height:v})}/>
                        </div>
                        <div className="grid grid-cols-2 gap-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                             <Input label="VA ตาซ้าย" val={form.vaLeft} set={v=>setForm({...form,vaLeft:v})} bg="white"/>
                             <Input label="VA ตาขวา" val={form.vaRight} set={v=>setForm({...form,vaRight:v})} bg="white"/>
                        </div>

                        <div className="pt-4 flex gap-4">
                            <button onClick={onBack} className="flex-1 py-3.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition">ยกเลิก</button>
                            <button onClick={save} disabled={saving} className="flex-[2] bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/40 hover:-translate-y-0.5 transition-all disabled:opacity-70 flex justify-center items-center gap-2">
                                {saving ? <div className="loader border-white/30 border-t-white w-5 h-5"></div> : <><Icon name="save"/> บันทึกข้อมูล</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- IMPORT VIEW ---
        const ImportView = ({ db, user, appId, onBack }) => {
            const [csvData, setCsvData] = React.useState([]);
            const [encoding, setEncoding] = React.useState('TIS-620');
            const [importing, setImporting] = React.useState(false);
            const handleFile = (e) => { Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, encoding: encoding, complete: (res) => setCsvData(res.data) }); };
            const startImport = async () => {
                if(!csvData.length) return;
                setImporting(true); let count=0;
                for(let row of csvData) {
                    const id = (row['เลข 13 หลัก']||row['pid']||'').toString().replace(/[^0-9]/g,'');
                    if(id.length===13) {
                        const part1 = { idCard: id, name: row['ชื่อสกุล']||row['fullname']||'-', hba1c: row['HbA1C']||'-', bp: row['BP']||'-', source:'Import' };
                        try {
                            await db.collection('artifacts').doc(APP_ID).collection(COL_MASTER).doc(id).set(part1, {merge: true});
                            await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).add({part1, status: 'Registered', pcuId: 'Admin', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
                            count++;
                        } catch(e) {}
                    }
                }
                setImporting(false); alert(`Imported ${count}`);
            };
            return (
                <div className="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl animate__animated animate__fadeInUp">
                    <h2 className="font-bold text-2xl text-brand-800 mb-6 flex items-center gap-2"><Icon name="file-spreadsheet"/> Import Excel</h2>
                    <div className="p-6 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 text-center space-y-4">
                        <div className="flex justify-center gap-4">
                             <select value={encoding} onChange={e=>setEncoding(e.target.value)} className="p-2 border rounded bg-white text-sm"><option value="TIS-620">TIS-620 (Thai)</option><option value="UTF-8">UTF-8</option></select>
                             <input type="file" accept=".csv" onChange={handleFile} className="text-sm text-slate-500"/>
                        </div>
                        {csvData.length>0 && <p className="text-emerald-600 font-bold">พร้อมนำเข้า {csvData.length} รายการ</p>}
                    </div>
                    <div className="flex gap-3 mt-6">
                         <button onClick={onBack} className="flex-1 py-3 rounded-xl border font-bold text-slate-500 hover:bg-slate-50">กลับ</button>
                         {csvData.length>0 && <button onClick={startImport} disabled={importing} className="flex-1 py-3 rounded-xl bg-brand-600 text-white font-bold shadow-lg hover:bg-brand-700 disabled:opacity-50">{importing?'Processing...':'Confirm Import'}</button>}
                    </div>
                </div>
            );
        };

        // --- HOSPITAL FORM ---
        const HospitalForm = ({ db, user, appId, patient, onBack }) => {
            const [p2, setP2] = React.useState(patient.part2 || { cataract:'No', retinaFound:'Yes', dilation:'No' });
            const [findings, setFindings] = React.useState(patient.findings || { Normal:{L:false,R:false} });
            const [saving, setSaving] = React.useState(false);
            const toggle = (k,s) => setFindings(f=>({...f,[k]:{...f[k],[s]:!f[k][s]}}));
            const save = async () => {
                setSaving(true);
                await db.collection('artifacts').doc(APP_ID).collection(COL_QUEUE).doc(patient.id).update({part2: p2, findings, status: 'Completed', doctorName: user.email});
                onBack(); setSaving(false);
            };
            return (
                <div className="flex flex-col lg:flex-row gap-6 animate__animated animate__fadeIn">
                    <div className="w-full lg:w-1/3 bg-white p-6 rounded-2xl shadow-lg border border-slate-100 h-fit">
                        <h3 className="font-bold text-lg mb-4 pb-4 border-b flex gap-2 items-center text-slate-700"><Icon name="user"/> ข้อมูลผู้ป่วย</h3>
                        <div className="space-y-3 text-sm">
                            <div><span className="text-slate-400 block text-xs">เลขบัตรประชาชน</span><span className="font-mono font-bold text-slate-700 text-base">{patient.part1.idCard}</span></div>
                            <div><span className="text-slate-400 block text-xs">ชื่อ-สกุล</span><span className="font-bold text-slate-700 text-base">{patient.part1.name}</span></div>
                            <div className="grid grid-cols-2 gap-4 pt-2">
                                <div className="bg-slate-50 p-2 rounded"><span className="text-slate-400 text-xs block">HbA1C</span><b>{patient.part1.hba1c||'-'}</b></div>
                                <div className="bg-slate-50 p-2 rounded"><span className="text-slate-400 text-xs block">BP</span><b>{patient.part1.bp||'-'}</b></div>
                            </div>
                        </div>
                        <button onClick={onBack} className="mt-6 w-full py-2 text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-lg transition text-sm font-bold">ย้อนกลับ</button>
                    </div>
                    
                    <div className="w-full lg:w-2/3 bg-white p-8 rounded-2xl shadow-lg border border-brand-100">
                        <h3 className="font-bold text-xl text-brand-800 mb-6 flex gap-2"><Icon name="eye"/> บันทึกผลการตรวจ (Hospital)</h3>
                        
                        <div className="grid grid-cols-2 gap-6 mb-8">
                            <div className="bg-brand-50 p-4 rounded-xl">
                                <span className="text-sm font-bold text-brand-800 mb-3 block">พบจอประสาทตา?</span>
                                <div className="flex gap-2">
                                    <button onClick={()=>setP2({...p2,retinaFound:'Yes'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.retinaFound==='Yes'?'bg-brand-600 text-white shadow-md':'bg-white text-slate-600 hover:bg-brand-50'}`}>เจอ</button>
                                    <button onClick={()=>setP2({...p2,retinaFound:'No'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.retinaFound==='No'?'bg-brand-600 text-white shadow-md':'bg-white text-slate-600 hover:bg-brand-50'}`}>ไม่เจอ</button>
                                </div>
                            </div>
                             <div className="bg-slate-50 p-4 rounded-xl">
                                <span className="text-sm font-bold text-slate-700 mb-3 block">เป็นต้อกระจก?</span>
                                <div className="flex gap-2">
                                    <button onClick={()=>setP2({...p2,cataract:'Yes'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.cataract==='Yes'?'bg-slate-700 text-white shadow-md':'bg-white text-slate-600'}`}>ใช่</button>
                                    <button onClick={()=>setP2({...p2,cataract:'No'})} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${p2.cataract==='No'?'bg-slate-700 text-white shadow-md':'bg-white text-slate-600'}`}>ไม่ใช่</button>
                                </div>
                            </div>
                        </div>

                        <div className="border rounded-xl overflow-hidden mb-8">
                            <table className="w-full text-sm">
                                <thead className="bg-slate-100 text-slate-600"><tr><th className="p-3 text-left pl-6">Diagnosis</th><th className="p-3 text-center w-20">Left</th><th className="p-3 text-center w-20">Right</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {['Normal','MicroAneurysm','HardExudate','FlameHemorrhage','VenousBeading'].map(k=>(
                                        <tr key={k} className="hover:bg-slate-50">
                                            <td className="p-3 pl-6 font-medium text-slate-700">{k}</td>
                                            <td className="p-3 text-center border-l"><input type="checkbox" checked={findings[k]?.L} onChange={()=>toggle(k,'L')} className="w-5 h-5 accent-brand-600 cursor-pointer"/></td>
                                            <td className="p-3 text-center border-l"><input type="checkbox" checked={findings[k]?.R} onChange={()=>toggle(k,'R')} className="w-5 h-5 accent-brand-600 cursor-pointer"/></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        <button onClick={save} className="w-full bg-brand-600 hover:bg-brand-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-brand-500/30 text-lg transition-all hover:-translate-y-0.5 flex justify-center items-center gap-2">
                            {saving ? <div className="loader border-white/30 border-t-white"></div> : <><Icon name="check-circle"/> ยืนยันผลการตรวจ</>}
                        </button>
                    </div>
                </div>
            );
        };

        const Input = ({label, val, set, icon, bg="bg-slate-50"}) => (
            <div>
                <label className="text-xs font-bold text-slate-500 uppercase mb-1 ml-1">{label}</label>
                <div className="relative">
                    {icon && <Icon name={icon} className="absolute left-3 top-3 text-slate-400" size={18}/>}
                    <input value={val||''} onChange={e=>set(e.target.value)} className={`w-full p-2.5 ${icon?'pl-10':''} border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition ${bg}`}/>
                </div>
            </div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

