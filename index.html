<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDM - ระบบส่งต่อผู้ป่วย</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Firebase SDK (Compat Version - เสถียรที่สุดสำหรับ Single File) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <!-- 5. Other Libs -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. FIREBASE CONFIGURATION ---
        // รับค่า Config จากระบบ หรือใช้ค่าว่างเพื่อป้องกัน Error
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('root').innerHTML = `<div class="p-4 text-red-500">Firebase Error: ${e.message}</div>`;
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 2. ICONS COMPONENT ---
        const Icon = ({ name, size = 18, className }) => {
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- 3. COMPONENTS ---
        const ADMIN_CODE = "10700";

        // --- Login Screen ---
        const AuthScreen = ({ onLogin }) => {
            const [pin, setPin] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            
            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                try {
                    // 1. Sign in Anonymously to access DB
                    if (!auth.currentUser) {
                        await auth.signInAnonymously();
                    }
                    // 2. Logical PIN Check
                    if (pin.length >= 3) {
                        onLogin(pin);
                    } else {
                        alert("รหัสเจ้าหน้าที่ต้องมีอย่างน้อย 3 หลัก");
                    }
                } catch (err) {
                    alert("Connection Error: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-md shadow-lg text-center fade-in">
                        <div className="mx-auto w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 mb-4">
                            <Icon name="activity" size={32}/>
                        </div>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">EyeDM System</h1>
                        <p className="text-slate-500 text-sm mb-6">v18.06 (Compat Mode)</p>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input className="w-full p-3 border rounded-lg text-center text-lg tracking-widest" placeholder="รหัสเจ้าหน้าที่" value={pin} onChange={e=>setPin(e.target.value)} required autoFocus type="tel"/>
                            <button disabled={loading} className="w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 disabled:opacity-50">
                                {loading ? 'กำลังเชื่อมต่อ...' : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        function App() {
            const [appUser, setAppUser] = React.useState(null); // PIN User
            const [dbUser, setDbUser] = React.useState(null);   // Firebase User
            const [role, setRole] = React.useState('PCU');
            const [view, setView] = React.useState('dashboard');
            const [queue, setQueue] = React.useState([]);
            const [editData, setEditData] = React.useState(null);

            // Check Authentication State
            React.useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setDbUser(u);
                    // ถ้าไม่มี Custom Token จากระบบ ให้ Auto Anonymous
                    if (!u && !window.__initial_auth_token) {
                        auth.signInAnonymously().catch(console.error);
                    }
                });
                return () => unsub();
            }, []);

            // Fetch Data
            React.useEffect(() => {
                if (!dbUser) return;

                const q = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dr_queue');
                
                const unsubscribe = q.onSnapshot(snapshot => {
                    const items = snapshot.docs.map(d => ({
                        id: d.id,
                        ...d.data(),
                        createdAt: d.data().createdAt?.toDate ? d.data().createdAt.toDate() : new Date()
                    }));
                    // Sort JS Side
                    items.sort((a, b) => b.createdAt - a.createdAt);
                    setQueue(items);
                    setTimeout(() => window.lucide?.createIcons(), 100);
                }, err => console.error("Query Error:", err));

                return () => unsubscribe();
            }, [dbUser]);

            const handleLogin = (pin) => {
                setAppUser({ pin });
                if (pin === ADMIN_CODE) setRole('ADMIN');
                else if (pin.startsWith('2')) setRole('HOSPITAL');
                else setRole('PCU');
            };

            const handleDelete = async (id) => {
                if(confirm("ยืนยันการลบ?")) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dr_queue').doc(id).delete();
                }
            };

            if (!appUser) return <AuthScreen onLogin={handleLogin} />;

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">
                    {/* Navbar */}
                    <nav className="bg-white shadow border-b px-4 py-3 flex justify-between items-center sticky top-0 z-50">
                        <div className="flex gap-3 items-center">
                            <div className={`p-2 rounded-lg text-white ${role==='HOSPITAL'?'bg-blue-600':'bg-teal-600'}`}>
                                <Icon name={role==='HOSPITAL'?'hospital':'home'}/>
                            </div>
                            <div>
                                <h1 className="font-bold text-lg">EyeDM</h1>
                                <p className="text-xs text-slate-500">User: {appUser.pin}</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             {role === 'ADMIN' && <button onClick={()=>setView('import')} className="hidden md:block px-3 py-1 text-sm bg-indigo-50 text-indigo-600 rounded">Import</button>}
                             <button onClick={()=>setAppUser(null)} className="p-2 text-red-500"><Icon name="log-out"/></button>
                        </div>
                    </nav>

                    {/* Mobile Tabs */}
                    <div className="md:hidden p-4 pb-0">
                        <div className="flex bg-white rounded-lg shadow border overflow-hidden">
                            <button onClick={()=>{setRole('PCU');setView('dashboard')}} className={`flex-1 py-2 text-sm font-bold ${role!=='HOSPITAL'?'bg-teal-50 text-teal-700':'text-slate-400'}`}>PCU</button>
                            <button onClick={()=>{setRole('HOSPITAL');setView('dashboard')}} className={`flex-1 py-2 text-sm font-bold ${role==='HOSPITAL'?'bg-blue-50 text-blue-700':'text-slate-400'}`}>Hospital</button>
                        </div>
                    </div>

                    {/* Content */}
                    <main className="flex-1 p-4 max-w-5xl mx-auto w-full">
                        {view === 'dashboard' && (
                            <Dashboard 
                                role={role} 
                                queue={queue} 
                                onNew={()=>{setEditData(null);setView('pcu_form')}} 
                                onEdit={p=>{setEditData(p);setView('pcu_form')}}
                                onDoctorEdit={p=>{setEditData(p);setView('hospital_form')}}
                                onDelete={handleDelete} 
                            />
                        )}
                        {view === 'pcu_form' && <PCUForm db={db} user={appUser} appId={appId} initialData={editData} onBack={()=>setView('dashboard')} />}
                        {view === 'hospital_form' && <HospitalForm db={db} user={appUser} appId={appId} patient={editData} onBack={()=>setView('dashboard')} />}
                        {view === 'import' && <ImportView db={db} appId={appId} onBack={()=>setView('dashboard')} />}
                    </main>
                </div>
            );
        }

        // --- SUB COMPONENTS ---
        const Dashboard = ({ role, queue, onNew, onEdit, onDoctorEdit, onDelete }) => {
            const [search, setSearch] = React.useState('');
            const filtered = queue.filter(p => (p.part1?.idCard||'').includes(search) || (p.part1?.name||'').includes(search));

            return (
                <div className="space-y-4 fade-in">
                    <div className="flex justify-between gap-2">
                        <input className="flex-1 p-2 border rounded-lg" placeholder="ค้นหา..." value={search} onChange={e=>setSearch(e.target.value)}/>
                        {role !== 'HOSPITAL' && (
                            <button onClick={onNew} className="bg-teal-600 text-white px-4 py-2 rounded-lg shadow font-bold flex items-center gap-1">
                                <Icon name="plus" size={16}/> <span className="hidden sm:inline">เพิ่ม</span>
                            </button>
                        )}
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b">
                                <tr>
                                    <th className="p-3">ผู้ป่วย</th>
                                    <th className="p-3">สถานะ</th>
                                    <th className="p-3 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filtered.map(p => (
                                    <tr key={p.id}>
                                        <td className="p-3">
                                            <div className="font-bold">{p.part1.name}</div>
                                            <div className="text-xs text-slate-500">{p.part1.idCard} | HbA1C: {p.part1.hba1c}</div>
                                        </td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded text-xs border ${p.status==='Waiting'?'bg-yellow-50 text-yellow-700 border-yellow-200':'bg-green-50 text-green-700 border-green-200'}`}>
                                                {p.status==='Waiting'?'รอตรวจ':'ตรวจแล้ว'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-right">
                                            {role === 'HOSPITAL' ? (
                                                <button onClick={()=>onDoctorEdit(p)} className="bg-blue-600 text-white px-3 py-1 rounded text-xs">ตรวจ</button>
                                            ) : (
                                                <div className="flex justify-end gap-2">
                                                    <button onClick={()=>onEdit(p)} className="text-blue-600"><Icon name="pencil" size={16}/></button>
                                                    <button onClick={()=>onDelete(p.id)} className="text-red-600"><Icon name="trash" size={16}/></button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400">ไม่พบข้อมูล</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PCUForm = ({ db, user, appId, initialData, onBack }) => {
            const [form, setForm] = React.useState(initialData?.part1 || { idCard:'', name:'', hba1c:'', bp:'', weight:'', height:'', vaLeft:'', vaRight:'' });
            const [saving, setSaving] = React.useState(false);

            const save = async () => {
                if(!form.idCard) return alert("ระบุเลขบัตร");
                setSaving(true);
                const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dr_queue');
                const payload = { 
                    part1: form, 
                    pcuId: user.pin, 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                try {
                    if(initialData) await colRef.doc(initialData.id).update(payload);
                    else {
                        payload.status = 'Waiting';
                        payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await colRef.add(payload);
                    }
                    onBack();
                } catch(e) { alert(e.message); }
                setSaving(false);
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow fade-in space-y-4">
                    <h2 className="font-bold text-lg border-b pb-2">{initialData?'แก้ไข':'ลงทะเบียนใหม่'}</h2>
                    <input className="w-full p-2 border rounded" placeholder="เลขบัตรประชาชน" value={form.idCard} onChange={e=>setForm({...form,idCard:e.target.value})}/>
                    <input className="w-full p-2 border rounded" placeholder="ชื่อ-สกุล" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>
                    <div className="grid grid-cols-2 gap-2">
                        <input className="p-2 border rounded" placeholder="HbA1C" value={form.hba1c} onChange={e=>setForm({...form,hba1c:e.target.value})}/>
                        <input className="p-2 border rounded" placeholder="BP" value={form.bp} onChange={e=>setForm({...form,bp:e.target.value})}/>
                    </div>
                    <div className="grid grid-cols-2 gap-2 bg-slate-50 p-2 rounded">
                        <input className="p-2 border rounded" placeholder="VA Left" value={form.vaLeft} onChange={e=>setForm({...form,vaLeft:e.target.value})}/>
                        <input className="p-2 border rounded" placeholder="VA Right" value={form.vaRight} onChange={e=>setForm({...form,vaRight:e.target.value})}/>
                    </div>
                    <div className="flex gap-2 pt-2">
                        <button onClick={onBack} className="flex-1 py-2 border rounded">ยกเลิก</button>
                        <button onClick={save} disabled={saving} className="flex-1 py-2 bg-teal-600 text-white rounded font-bold">{saving?'Saving...':'บันทึก'}</button>
                    </div>
                </div>
            );
        };

        const HospitalForm = ({ db, user, appId, patient, onBack }) => {
            const [p2, setP2] = React.useState(patient?.part2 || { retinaFound:'Yes' });
            const [findings, setFindings] = React.useState(patient?.findings || {});
            const toggle = (k,s) => setFindings(f=>({...f,[k]:{...f[k],[s]:!f?.[k]?.[s]}}));
            
            const save = async () => {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dr_queue').doc(patient.id).update({
                    part2: p2, findings, status: 'Completed', doctorCode: user.pin
                });
                onBack();
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow fade-in">
                    <h2 className="font-bold text-lg mb-4 text-blue-700">บันทึกผลตรวจ: {patient.part1.name}</h2>
                    <div className="mb-4">
                        <label className="block text-sm font-bold mb-2">จอประสาทตา</label>
                        <div className="flex gap-2">
                            {['Yes','No'].map(o=><button key={o} onClick={()=>setP2({...p2,retinaFound:o})} className={`flex-1 py-2 border rounded ${p2.retinaFound===o?'bg-blue-600 text-white':''}`}>{o==='Yes'?'เห็นชัด':'ไม่เห็น'}</button>)}
                        </div>
                    </div>
                    <div className="space-y-2 mb-6">
                        {['Normal','MicroAneurysm','Hemorrhage','Exudate'].map(k=>(
                            <div key={k} className="flex items-center justify-between border-b pb-2">
                                <span className="text-sm w-1/2">{k}</span>
                                <label className="flex items-center gap-1"><input type="checkbox" checked={findings[k]?.L} onChange={()=>toggle(k,'L')}/> L</label>
                                <label className="flex items-center gap-1"><input type="checkbox" checked={findings[k]?.R} onChange={()=>toggle(k,'R')}/> R</label>
                            </div>
                        ))}
                    </div>
                    <button onClick={save} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold">บันทึกผล</button>
                    <button onClick={onBack} className="w-full py-3 mt-2 text-slate-500">ยกเลิก</button>
                </div>
            );
        };

        const ImportView = ({ db, appId, onBack }) => {
            const [data, setData] = React.useState([]);
            const handle = e => Papa.parse(e.target.files[0], {header:true, complete: r=>setData(r.data)});
            const save = async () => {
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('dr_queue');
                for(let r of data) {
                     if(r['pid']) await col.add({ 
                         part1: { idCard: r['pid'], name: r['name'], hba1c: r['hba1c'] }, 
                         status: 'Waiting', createdAt: new Date() 
                     });
                }
                alert('Done'); onBack();
            };
            return (
                <div className="bg-white p-6 rounded shadow">
                    <h2 className="font-bold mb-4">Import CSV</h2>
                    <input type="file" onChange={handle} className="mb-4 block w-full"/>
                    {data.length>0 && <button onClick={save} className="bg-indigo-600 text-white px-4 py-2 rounded">Import {data.length} items</button>}
                    <button onClick={onBack} className="ml-4">Back</button>
                </div>
            );
        }

        // Start App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
